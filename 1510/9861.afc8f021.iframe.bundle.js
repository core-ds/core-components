"use strict";(self.webpackChunk_alfalab_core_components=self.webpackChunk_alfalab_core_components||[]).push([[9861],{"./node_modules/hls.js/dist/hls.light.mjs":function(__unused_webpack_module,__webpack_exports__,__webpack_require__){let decoder,chromeOrFirefox,now;function getDefaultExportFromCjs(x){return x&&x.__esModule&&Object.prototype.hasOwnProperty.call(x,"default")?x.default:x}__webpack_require__.r(__webpack_exports__),__webpack_require__.d(__webpack_exports__,{AbrController:function(){return AbrController},AttrList:function(){return AttrList},AudioStreamController:function(){return Cues},AudioTrackController:function(){return Cues},BasePlaylistController:function(){return BasePlaylistController},BaseSegment:function(){return BaseSegment},BaseStreamController:function(){return BaseStreamController},BufferController:function(){return BufferController},CMCDController:function(){return Cues},CapLevelController:function(){return CapLevelController},ChunkMetadata:function(){return ChunkMetadata},ContentSteeringController:function(){return ContentSteeringController},DateRange:function(){return DateRange},EMEController:function(){return Cues},ErrorActionFlags:function(){return ErrorActionFlags},ErrorController:function(){return ErrorController},ErrorDetails:function(){return ErrorDetails1},ErrorTypes:function(){return ErrorTypes1},Events:function(){return Events1},FPSController:function(){return FPSController},Fragment:function(){return Fragment},Hls:function(){return Hls},HlsSkip:function(){return HlsSkip},HlsUrlParameters:function(){return HlsUrlParameters},KeySystemFormats:function(){return KeySystemFormats},KeySystems:function(){return KeySystems},Level:function(){return Level},LevelDetails:function(){return LevelDetails},LevelKey:function(){return LevelKey},LoadStats:function(){return LoadStats},MetadataSchema:function(){return MetadataSchema},NetworkErrorAction:function(){return NetworkErrorAction},Part:function(){return Part},PlaylistLevelType:function(){return PlaylistLevelType},SubtitleStreamController:function(){return SubtitleStreamController},SubtitleTrackController:function(){return Cues},TimelineController:function(){return TimelineController},default:function(){return Hls},getMediaSource:function(){return getMediaSource},isMSESupported:function(){return isMSESupported},isSupported:function(){return isSupported}});var URL_REGEX,FIRST_SEGMENT_REGEX,SLASH_DOT_REGEX,SLASH_DOT_DOT_REGEX,URLToolkit,Events,ErrorTypes,ErrorDetails,urlToolkit={exports:{}};URL_REGEX=/^(?=((?:[a-zA-Z0-9+\-.]+:)?))\1(?=((?:\/\/[^\/?#]*)?))\2(?=((?:(?:[^?#\/]*\/)*[^;?#\/]*)?))\3((?:;[^?#]*)?)(\?[^#]*)?(#[^]*)?$/,FIRST_SEGMENT_REGEX=/^(?=([^\/?#]*))\1([^]*)$/,SLASH_DOT_REGEX=/(?:\/|^)\.(?=\/)/g,SLASH_DOT_DOT_REGEX=/(?:\/|^)\.\.\/(?!\.\.\/)[^\/]*(?=\/)/g,URLToolkit={buildAbsoluteURL:function(baseURL,relativeURL,opts){if(opts=opts||{},baseURL=baseURL.trim(),!(relativeURL=relativeURL.trim())){if(!opts.alwaysNormalize)return baseURL;var basePartsForNormalise=URLToolkit.parseURL(baseURL);if(!basePartsForNormalise)throw Error("Error trying to parse base URL.");return basePartsForNormalise.path=URLToolkit.normalizePath(basePartsForNormalise.path),URLToolkit.buildURLFromParts(basePartsForNormalise)}var relativeParts=URLToolkit.parseURL(relativeURL);if(!relativeParts)throw Error("Error trying to parse relative URL.");if(relativeParts.scheme)return opts.alwaysNormalize?(relativeParts.path=URLToolkit.normalizePath(relativeParts.path),URLToolkit.buildURLFromParts(relativeParts)):relativeURL;var baseParts=URLToolkit.parseURL(baseURL);if(!baseParts)throw Error("Error trying to parse base URL.");if(!baseParts.netLoc&&baseParts.path&&"/"!==baseParts.path[0]){var pathParts=FIRST_SEGMENT_REGEX.exec(baseParts.path);baseParts.netLoc=pathParts[1],baseParts.path=pathParts[2]}baseParts.netLoc&&!baseParts.path&&(baseParts.path="/");var builtParts={scheme:baseParts.scheme,netLoc:relativeParts.netLoc,path:null,params:relativeParts.params,query:relativeParts.query,fragment:relativeParts.fragment};if(!relativeParts.netLoc&&(builtParts.netLoc=baseParts.netLoc,"/"!==relativeParts.path[0])){if(relativeParts.path){var baseURLPath=baseParts.path,newPath=baseURLPath.substring(0,baseURLPath.lastIndexOf("/")+1)+relativeParts.path;builtParts.path=URLToolkit.normalizePath(newPath)}else builtParts.path=baseParts.path,relativeParts.params||(builtParts.params=baseParts.params,relativeParts.query||(builtParts.query=baseParts.query))}return null===builtParts.path&&(builtParts.path=opts.alwaysNormalize?URLToolkit.normalizePath(relativeParts.path):relativeParts.path),URLToolkit.buildURLFromParts(builtParts)},parseURL:function(url){var parts=URL_REGEX.exec(url);return parts?{scheme:parts[1]||"",netLoc:parts[2]||"",path:parts[3]||"",params:parts[4]||"",query:parts[5]||"",fragment:parts[6]||""}:null},normalizePath:function(path){for(path=path.split("").reverse().join("").replace(SLASH_DOT_REGEX,"");path.length!==(path=path.replace(SLASH_DOT_DOT_REGEX,"")).length;);return path.split("").reverse().join("")},buildURLFromParts:function(parts){return parts.scheme+parts.netLoc+parts.path+parts.params+parts.query+parts.fragment}},urlToolkit.exports=URLToolkit;var urlToolkitExports=urlToolkit.exports;function ownKeys(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);r&&(o=o.filter(function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable})),t.push.apply(t,o)}return t}function _objectSpread2(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?ownKeys(Object(t),!0).forEach(function(r){_defineProperty(e,r,t[r])}):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):ownKeys(Object(t)).forEach(function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))})}return e}function _toPrimitive(t,r){if("object"!=typeof t||!t)return t;var e=t[Symbol.toPrimitive];if(void 0!==e){var i=e.call(t,r||"default");if("object"!=typeof i)return i;throw TypeError("@@toPrimitive must return a primitive value.")}return("string"===r?String:Number)(t)}function _toPropertyKey(t){var i=_toPrimitive(t,"string");return"symbol"==typeof i?i:String(i)}function _defineProperty(obj,key,value){return(key=_toPropertyKey(key))in obj?Object.defineProperty(obj,key,{value:value,enumerable:!0,configurable:!0,writable:!0}):obj[key]=value,obj}function _extends(){return(_extends=Object.assign?Object.assign.bind():function(target){for(var i=1;i<arguments.length;i++){var source=arguments[i];for(var key in source)Object.prototype.hasOwnProperty.call(source,key)&&(target[key]=source[key])}return target}).apply(this,arguments)}let isFiniteNumber=Number.isFinite||function(value){return"number"==typeof value&&isFinite(value)},isSafeInteger=Number.isSafeInteger||function(value){return"number"==typeof value&&Math.abs(value)<=MAX_SAFE_INTEGER},MAX_SAFE_INTEGER=Number.MAX_SAFE_INTEGER||9007199254740991,Events1=((Events={}).MEDIA_ATTACHING="hlsMediaAttaching",Events.MEDIA_ATTACHED="hlsMediaAttached",Events.MEDIA_DETACHING="hlsMediaDetaching",Events.MEDIA_DETACHED="hlsMediaDetached",Events.BUFFER_RESET="hlsBufferReset",Events.BUFFER_CODECS="hlsBufferCodecs",Events.BUFFER_CREATED="hlsBufferCreated",Events.BUFFER_APPENDING="hlsBufferAppending",Events.BUFFER_APPENDED="hlsBufferAppended",Events.BUFFER_EOS="hlsBufferEos",Events.BUFFER_FLUSHING="hlsBufferFlushing",Events.BUFFER_FLUSHED="hlsBufferFlushed",Events.MANIFEST_LOADING="hlsManifestLoading",Events.MANIFEST_LOADED="hlsManifestLoaded",Events.MANIFEST_PARSED="hlsManifestParsed",Events.LEVEL_SWITCHING="hlsLevelSwitching",Events.LEVEL_SWITCHED="hlsLevelSwitched",Events.LEVEL_LOADING="hlsLevelLoading",Events.LEVEL_LOADED="hlsLevelLoaded",Events.LEVEL_UPDATED="hlsLevelUpdated",Events.LEVEL_PTS_UPDATED="hlsLevelPtsUpdated",Events.LEVELS_UPDATED="hlsLevelsUpdated",Events.AUDIO_TRACKS_UPDATED="hlsAudioTracksUpdated",Events.AUDIO_TRACK_SWITCHING="hlsAudioTrackSwitching",Events.AUDIO_TRACK_SWITCHED="hlsAudioTrackSwitched",Events.AUDIO_TRACK_LOADING="hlsAudioTrackLoading",Events.AUDIO_TRACK_LOADED="hlsAudioTrackLoaded",Events.SUBTITLE_TRACKS_UPDATED="hlsSubtitleTracksUpdated",Events.SUBTITLE_TRACKS_CLEARED="hlsSubtitleTracksCleared",Events.SUBTITLE_TRACK_SWITCH="hlsSubtitleTrackSwitch",Events.SUBTITLE_TRACK_LOADING="hlsSubtitleTrackLoading",Events.SUBTITLE_TRACK_LOADED="hlsSubtitleTrackLoaded",Events.SUBTITLE_FRAG_PROCESSED="hlsSubtitleFragProcessed",Events.CUES_PARSED="hlsCuesParsed",Events.NON_NATIVE_TEXT_TRACKS_FOUND="hlsNonNativeTextTracksFound",Events.INIT_PTS_FOUND="hlsInitPtsFound",Events.FRAG_LOADING="hlsFragLoading",Events.FRAG_LOAD_EMERGENCY_ABORTED="hlsFragLoadEmergencyAborted",Events.FRAG_LOADED="hlsFragLoaded",Events.FRAG_DECRYPTED="hlsFragDecrypted",Events.FRAG_PARSING_INIT_SEGMENT="hlsFragParsingInitSegment",Events.FRAG_PARSING_USERDATA="hlsFragParsingUserdata",Events.FRAG_PARSING_METADATA="hlsFragParsingMetadata",Events.FRAG_PARSED="hlsFragParsed",Events.FRAG_BUFFERED="hlsFragBuffered",Events.FRAG_CHANGED="hlsFragChanged",Events.FPS_DROP="hlsFpsDrop",Events.FPS_DROP_LEVEL_CAPPING="hlsFpsDropLevelCapping",Events.MAX_AUTO_LEVEL_UPDATED="hlsMaxAutoLevelUpdated",Events.ERROR="hlsError",Events.DESTROYING="hlsDestroying",Events.KEY_LOADING="hlsKeyLoading",Events.KEY_LOADED="hlsKeyLoaded",Events.LIVE_BACK_BUFFER_REACHED="hlsLiveBackBufferReached",Events.BACK_BUFFER_REACHED="hlsBackBufferReached",Events.STEERING_MANIFEST_LOADED="hlsSteeringManifestLoaded",Events),ErrorTypes1=((ErrorTypes={}).NETWORK_ERROR="networkError",ErrorTypes.MEDIA_ERROR="mediaError",ErrorTypes.KEY_SYSTEM_ERROR="keySystemError",ErrorTypes.MUX_ERROR="muxError",ErrorTypes.OTHER_ERROR="otherError",ErrorTypes),ErrorDetails1=((ErrorDetails={}).KEY_SYSTEM_NO_KEYS="keySystemNoKeys",ErrorDetails.KEY_SYSTEM_NO_ACCESS="keySystemNoAccess",ErrorDetails.KEY_SYSTEM_NO_SESSION="keySystemNoSession",ErrorDetails.KEY_SYSTEM_NO_CONFIGURED_LICENSE="keySystemNoConfiguredLicense",ErrorDetails.KEY_SYSTEM_LICENSE_REQUEST_FAILED="keySystemLicenseRequestFailed",ErrorDetails.KEY_SYSTEM_SERVER_CERTIFICATE_REQUEST_FAILED="keySystemServerCertificateRequestFailed",ErrorDetails.KEY_SYSTEM_SERVER_CERTIFICATE_UPDATE_FAILED="keySystemServerCertificateUpdateFailed",ErrorDetails.KEY_SYSTEM_SESSION_UPDATE_FAILED="keySystemSessionUpdateFailed",ErrorDetails.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED="keySystemStatusOutputRestricted",ErrorDetails.KEY_SYSTEM_STATUS_INTERNAL_ERROR="keySystemStatusInternalError",ErrorDetails.MANIFEST_LOAD_ERROR="manifestLoadError",ErrorDetails.MANIFEST_LOAD_TIMEOUT="manifestLoadTimeOut",ErrorDetails.MANIFEST_PARSING_ERROR="manifestParsingError",ErrorDetails.MANIFEST_INCOMPATIBLE_CODECS_ERROR="manifestIncompatibleCodecsError",ErrorDetails.LEVEL_EMPTY_ERROR="levelEmptyError",ErrorDetails.LEVEL_LOAD_ERROR="levelLoadError",ErrorDetails.LEVEL_LOAD_TIMEOUT="levelLoadTimeOut",ErrorDetails.LEVEL_PARSING_ERROR="levelParsingError",ErrorDetails.LEVEL_SWITCH_ERROR="levelSwitchError",ErrorDetails.AUDIO_TRACK_LOAD_ERROR="audioTrackLoadError",ErrorDetails.AUDIO_TRACK_LOAD_TIMEOUT="audioTrackLoadTimeOut",ErrorDetails.SUBTITLE_LOAD_ERROR="subtitleTrackLoadError",ErrorDetails.SUBTITLE_TRACK_LOAD_TIMEOUT="subtitleTrackLoadTimeOut",ErrorDetails.FRAG_LOAD_ERROR="fragLoadError",ErrorDetails.FRAG_LOAD_TIMEOUT="fragLoadTimeOut",ErrorDetails.FRAG_DECRYPT_ERROR="fragDecryptError",ErrorDetails.FRAG_PARSING_ERROR="fragParsingError",ErrorDetails.FRAG_GAP="fragGap",ErrorDetails.REMUX_ALLOC_ERROR="remuxAllocError",ErrorDetails.KEY_LOAD_ERROR="keyLoadError",ErrorDetails.KEY_LOAD_TIMEOUT="keyLoadTimeOut",ErrorDetails.BUFFER_ADD_CODEC_ERROR="bufferAddCodecError",ErrorDetails.BUFFER_INCOMPATIBLE_CODECS_ERROR="bufferIncompatibleCodecsError",ErrorDetails.BUFFER_APPEND_ERROR="bufferAppendError",ErrorDetails.BUFFER_APPENDING_ERROR="bufferAppendingError",ErrorDetails.BUFFER_STALLED_ERROR="bufferStalledError",ErrorDetails.BUFFER_FULL_ERROR="bufferFullError",ErrorDetails.BUFFER_SEEK_OVER_HOLE="bufferSeekOverHole",ErrorDetails.BUFFER_NUDGE_ON_STALL="bufferNudgeOnStall",ErrorDetails.INTERNAL_EXCEPTION="internalException",ErrorDetails.INTERNAL_ABORTED="aborted",ErrorDetails.UNKNOWN="unknown",ErrorDetails),noop=function(){},fakeLogger={trace:noop,debug:noop,log:noop,warn:noop,info:noop,error:noop},exportedLogger=fakeLogger;function consolePrintFn(type){let func=self.console[type];return func?func.bind(self.console,`[${type}] >`):noop}function exportLoggerFunctions(debugConfig,...functions){functions.forEach(function(type){exportedLogger[type]=debugConfig[type]?debugConfig[type].bind(debugConfig):consolePrintFn(type)})}function enableLogs(debugConfig,id){if("object"==typeof console&&!0===debugConfig||"object"==typeof debugConfig){exportLoggerFunctions(debugConfig,"debug","log","info","warn","error");try{exportedLogger.log(`Debug logs enabled for "${id}" in hls.js version 1.5.13`)}catch(e){exportedLogger=fakeLogger}}else exportedLogger=fakeLogger}let logger=exportedLogger,DECIMAL_RESOLUTION_REGEX=/^(\d+)x(\d+)$/,ATTR_LIST_REGEX=/(.+?)=(".*?"|.*?)(?:,|$)/g;class AttrList{constructor(attrs){"string"==typeof attrs&&(attrs=AttrList.parseAttrList(attrs)),_extends(this,attrs)}get clientAttrs(){return Object.keys(this).filter(attr=>"X-"===attr.substring(0,2))}decimalInteger(attrName){let intValue=parseInt(this[attrName],10);return intValue>Number.MAX_SAFE_INTEGER?1/0:intValue}hexadecimalInteger(attrName){if(!this[attrName])return null;{let stringValue=(this[attrName]||"0x").slice(2);stringValue=(1&stringValue.length?"0":"")+stringValue;let value=new Uint8Array(stringValue.length/2);for(let i=0;i<stringValue.length/2;i++)value[i]=parseInt(stringValue.slice(2*i,2*i+2),16);return value}}hexadecimalIntegerAsNumber(attrName){let intValue=parseInt(this[attrName],16);return intValue>Number.MAX_SAFE_INTEGER?1/0:intValue}decimalFloatingPoint(attrName){return parseFloat(this[attrName])}optionalFloat(attrName,defaultValue){let value=this[attrName];return value?parseFloat(value):defaultValue}enumeratedString(attrName){return this[attrName]}bool(attrName){return"YES"===this[attrName]}decimalResolution(attrName){let res=DECIMAL_RESOLUTION_REGEX.exec(this[attrName]);if(null!==res)return{width:parseInt(res[1],10),height:parseInt(res[2],10)}}static parseAttrList(input){let match;let attrs={};for(ATTR_LIST_REGEX.lastIndex=0;null!==(match=ATTR_LIST_REGEX.exec(input));){let value=match[2];0===value.indexOf('"')&&value.lastIndexOf('"')===value.length-1&&(value=value.slice(1,-1)),attrs[match[1].trim()]=value}return attrs}}function isDateRangeCueAttribute(attrName){return"ID"!==attrName&&"CLASS"!==attrName&&"START-DATE"!==attrName&&"DURATION"!==attrName&&"END-DATE"!==attrName&&"END-ON-NEXT"!==attrName}function isSCTE35Attribute(attrName){return"SCTE35-OUT"===attrName||"SCTE35-IN"===attrName}class DateRange{constructor(dateRangeAttr,dateRangeWithSameId){if(this.attr=void 0,this._startDate=void 0,this._endDate=void 0,this._badValueForSameId=void 0,dateRangeWithSameId){let previousAttr=dateRangeWithSameId.attr;for(let key in previousAttr)if(Object.prototype.hasOwnProperty.call(dateRangeAttr,key)&&dateRangeAttr[key]!==previousAttr[key]){logger.warn(`DATERANGE tag attribute: "${key}" does not match for tags with ID: "${dateRangeAttr.ID}"`),this._badValueForSameId=key;break}dateRangeAttr=_extends(new AttrList({}),previousAttr,dateRangeAttr)}if(this.attr=dateRangeAttr,this._startDate=new Date(dateRangeAttr["START-DATE"]),"END-DATE"in this.attr){let endDate=new Date(this.attr["END-DATE"]);isFiniteNumber(endDate.getTime())&&(this._endDate=endDate)}}get id(){return this.attr.ID}get class(){return this.attr.CLASS}get startDate(){return this._startDate}get endDate(){if(this._endDate)return this._endDate;let duration=this.duration;return null!==duration?new Date(this._startDate.getTime()+1e3*duration):null}get duration(){if("DURATION"in this.attr){let duration=this.attr.decimalFloatingPoint("DURATION");if(isFiniteNumber(duration))return duration}else if(this._endDate)return(this._endDate.getTime()-this._startDate.getTime())/1e3;return null}get plannedDuration(){return"PLANNED-DURATION"in this.attr?this.attr.decimalFloatingPoint("PLANNED-DURATION"):null}get endOnNext(){return this.attr.bool("END-ON-NEXT")}get isValid(){return!!this.id&&!this._badValueForSameId&&isFiniteNumber(this.startDate.getTime())&&(null===this.duration||this.duration>=0)&&(!this.endOnNext||!!this.class)}}class LoadStats{constructor(){this.aborted=!1,this.loaded=0,this.retry=0,this.total=0,this.chunkCount=0,this.bwEstimate=0,this.loading={start:0,first:0,end:0},this.parsing={start:0,end:0},this.buffering={start:0,first:0,end:0}}}var ElementaryStreamTypes={AUDIO:"audio",VIDEO:"video",AUDIOVIDEO:"audiovideo"};class BaseSegment{constructor(baseurl){this._byteRange=null,this._url=null,this.baseurl=void 0,this.relurl=void 0,this.elementaryStreams={[ElementaryStreamTypes.AUDIO]:null,[ElementaryStreamTypes.VIDEO]:null,[ElementaryStreamTypes.AUDIOVIDEO]:null},this.baseurl=baseurl}setByteRange(value,previous){let start;let params=value.split("@",2);start=1===params.length?(null==previous?void 0:previous.byteRangeEndOffset)||0:parseInt(params[1]),this._byteRange=[start,parseInt(params[0])+start]}get byteRange(){return this._byteRange?this._byteRange:[]}get byteRangeStartOffset(){return this.byteRange[0]}get byteRangeEndOffset(){return this.byteRange[1]}get url(){return!this._url&&this.baseurl&&this.relurl&&(this._url=urlToolkitExports.buildAbsoluteURL(this.baseurl,this.relurl,{alwaysNormalize:!0})),this._url||""}set url(value){this._url=value}}class Fragment extends BaseSegment{constructor(type,baseurl){super(baseurl),this._decryptdata=null,this.rawProgramDateTime=null,this.programDateTime=null,this.tagList=[],this.duration=0,this.sn=0,this.levelkeys=void 0,this.type=void 0,this.loader=null,this.keyLoader=null,this.level=-1,this.cc=0,this.startPTS=void 0,this.endPTS=void 0,this.startDTS=void 0,this.endDTS=void 0,this.start=0,this.deltaPTS=void 0,this.maxStartPTS=void 0,this.minEndPTS=void 0,this.stats=new LoadStats,this.data=void 0,this.bitrateTest=!1,this.title=null,this.initSegment=null,this.endList=void 0,this.gap=void 0,this.urlId=0,this.type=type}get decryptdata(){let{levelkeys}=this;if(!levelkeys&&!this._decryptdata)return null;if(!this._decryptdata&&this.levelkeys&&!this.levelkeys.NONE){let key=this.levelkeys.identity;if(key)this._decryptdata=key.getDecryptData(this.sn);else{let keyFormats=Object.keys(this.levelkeys);if(1===keyFormats.length)return this._decryptdata=this.levelkeys[keyFormats[0]].getDecryptData(this.sn)}}return this._decryptdata}get end(){return this.start+this.duration}get endProgramDateTime(){if(null===this.programDateTime||!isFiniteNumber(this.programDateTime))return null;let duration=isFiniteNumber(this.duration)?this.duration:0;return this.programDateTime+1e3*duration}get encrypted(){var _this$_decryptdata;if(null!=(_this$_decryptdata=this._decryptdata)&&_this$_decryptdata.encrypted)return!0;if(this.levelkeys){let keyFormats=Object.keys(this.levelkeys),len=keyFormats.length;if(len>1||1===len&&this.levelkeys[keyFormats[0]].encrypted)return!0}return!1}setKeyFormat(keyFormat){if(this.levelkeys){let key=this.levelkeys[keyFormat];key&&!this._decryptdata&&(this._decryptdata=key.getDecryptData(this.sn))}}abortRequests(){var _this$loader,_this$keyLoader;null==(_this$loader=this.loader)||_this$loader.abort(),null==(_this$keyLoader=this.keyLoader)||_this$keyLoader.abort()}setElementaryStreamInfo(type,startPTS,endPTS,startDTS,endDTS,partial=!1){let{elementaryStreams}=this,info=elementaryStreams[type];if(!info){elementaryStreams[type]={startPTS,endPTS,startDTS,endDTS,partial};return}info.startPTS=Math.min(info.startPTS,startPTS),info.endPTS=Math.max(info.endPTS,endPTS),info.startDTS=Math.min(info.startDTS,startDTS),info.endDTS=Math.max(info.endDTS,endDTS)}clearElementaryStreamInfo(){let{elementaryStreams}=this;elementaryStreams[ElementaryStreamTypes.AUDIO]=null,elementaryStreams[ElementaryStreamTypes.VIDEO]=null,elementaryStreams[ElementaryStreamTypes.AUDIOVIDEO]=null}}class Part extends BaseSegment{constructor(partAttrs,frag,baseurl,index,previous){super(baseurl),this.fragOffset=0,this.duration=0,this.gap=!1,this.independent=!1,this.relurl=void 0,this.fragment=void 0,this.index=void 0,this.stats=new LoadStats,this.duration=partAttrs.decimalFloatingPoint("DURATION"),this.gap=partAttrs.bool("GAP"),this.independent=partAttrs.bool("INDEPENDENT"),this.relurl=partAttrs.enumeratedString("URI"),this.fragment=frag,this.index=index;let byteRange=partAttrs.enumeratedString("BYTERANGE");byteRange&&this.setByteRange(byteRange,previous),previous&&(this.fragOffset=previous.fragOffset+previous.duration)}get start(){return this.fragment.start+this.fragOffset}get end(){return this.start+this.duration}get loaded(){let{elementaryStreams}=this;return!!(elementaryStreams.audio||elementaryStreams.video||elementaryStreams.audiovideo)}}class LevelDetails{constructor(baseUrl){this.PTSKnown=!1,this.alignedSliding=!1,this.averagetargetduration=void 0,this.endCC=0,this.endSN=0,this.fragments=void 0,this.fragmentHint=void 0,this.partList=null,this.dateRanges=void 0,this.live=!0,this.ageHeader=0,this.advancedDateTime=void 0,this.updated=!0,this.advanced=!0,this.availabilityDelay=void 0,this.misses=0,this.startCC=0,this.startSN=0,this.startTimeOffset=null,this.targetduration=0,this.totalduration=0,this.type=null,this.url=void 0,this.m3u8="",this.version=null,this.canBlockReload=!1,this.canSkipUntil=0,this.canSkipDateRanges=!1,this.skippedSegments=0,this.recentlyRemovedDateranges=void 0,this.partHoldBack=0,this.holdBack=0,this.partTarget=0,this.preloadHint=void 0,this.renditionReports=void 0,this.tuneInGoal=0,this.deltaUpdateFailed=void 0,this.driftStartTime=0,this.driftEndTime=0,this.driftStart=0,this.driftEnd=0,this.encryptedFragments=void 0,this.playlistParsingError=null,this.variableList=null,this.hasVariableRefs=!1,this.fragments=[],this.encryptedFragments=[],this.dateRanges={},this.url=baseUrl}reloaded(previous){if(!previous){this.advanced=!0,this.updated=!0;return}let partSnDiff=this.lastPartSn-previous.lastPartSn,partIndexDiff=this.lastPartIndex-previous.lastPartIndex;this.updated=this.endSN!==previous.endSN||!!partIndexDiff||!!partSnDiff||!this.live,this.advanced=this.endSN>previous.endSN||partSnDiff>0||0===partSnDiff&&partIndexDiff>0,this.updated||this.advanced?this.misses=Math.floor(.6*previous.misses):this.misses=previous.misses+1,this.availabilityDelay=previous.availabilityDelay}get hasProgramDateTime(){return!!this.fragments.length&&isFiniteNumber(this.fragments[this.fragments.length-1].programDateTime)}get levelTargetDuration(){return this.averagetargetduration||this.targetduration||10}get drift(){let runTime=this.driftEndTime-this.driftStartTime;return runTime>0?1e3*(this.driftEnd-this.driftStart)/runTime:1}get edge(){return this.partEnd||this.fragmentEnd}get partEnd(){var _this$partList;return null!=(_this$partList=this.partList)&&_this$partList.length?this.partList[this.partList.length-1].end:this.fragmentEnd}get fragmentEnd(){var _this$fragments;return null!=(_this$fragments=this.fragments)&&_this$fragments.length?this.fragments[this.fragments.length-1].end:0}get age(){return this.advancedDateTime?Math.max(Date.now()-this.advancedDateTime,0)/1e3:0}get lastPartIndex(){var _this$partList2;return null!=(_this$partList2=this.partList)&&_this$partList2.length?this.partList[this.partList.length-1].index:-1}get lastPartSn(){var _this$partList3;return null!=(_this$partList3=this.partList)&&_this$partList3.length?this.partList[this.partList.length-1].fragment.sn:this.endSN}}var emptyEs={},Cues=getDefaultExportFromCjs(emptyEs);function sliceUint8(array,start,end){return Uint8Array.prototype.slice?array.slice(start,end):new Uint8Array(Array.prototype.slice.call(array,start,end))}let isHeader$2=(data,offset)=>offset+10<=data.length&&73===data[offset]&&68===data[offset+1]&&51===data[offset+2]&&data[offset+3]<255&&data[offset+4]<255&&data[offset+6]<128&&data[offset+7]<128&&data[offset+8]<128&&data[offset+9]<128,isFooter=(data,offset)=>offset+10<=data.length&&51===data[offset]&&68===data[offset+1]&&73===data[offset+2]&&data[offset+3]<255&&data[offset+4]<255&&data[offset+6]<128&&data[offset+7]<128&&data[offset+8]<128&&data[offset+9]<128,getID3Data=(data,offset)=>{let front=offset,length=0;for(;isHeader$2(data,offset);)length+=10+readSize(data,offset+6),isFooter(data,offset+10)&&(length+=10),offset+=length;if(length>0)return data.subarray(front,front+length)},readSize=(data,offset)=>(127&data[offset])<<21|(127&data[offset+1])<<14|(127&data[offset+2])<<7|127&data[offset+3],canParse$2=(data,offset)=>isHeader$2(data,offset)&&readSize(data,offset+6)+10<=data.length-offset,getTimeStamp=data=>{let frames=getID3Frames(data);for(let i=0;i<frames.length;i++){let frame=frames[i];if(isTimeStampFrame(frame))return readTimeStamp(frame)}},isTimeStampFrame=frame=>frame&&"PRIV"===frame.key&&"com.apple.streaming.transportStreamTimestamp"===frame.info,getFrameData=data=>{let type=String.fromCharCode(data[0],data[1],data[2],data[3]),size=readSize(data,4);return{type,size,data:data.subarray(10,10+size)}},getID3Frames=id3Data=>{let offset=0,frames=[];for(;isHeader$2(id3Data,offset);){let size=readSize(id3Data,offset+6),end=(offset+=10)+size;for(;offset+8<end;){let frameData=getFrameData(id3Data.subarray(offset)),frame=decodeFrame(frameData);frame&&frames.push(frame),offset+=frameData.size+10}isFooter(id3Data,offset)&&(offset+=10)}return frames},decodeFrame=frame=>"PRIV"===frame.type?decodePrivFrame(frame):"W"===frame.type[0]?decodeURLFrame(frame):decodeTextFrame(frame),decodePrivFrame=frame=>{if(frame.size<2)return;let owner=utf8ArrayToStr(frame.data,!0),privateData=new Uint8Array(frame.data.subarray(owner.length+1));return{key:frame.type,info:owner,data:privateData.buffer}},decodeTextFrame=frame=>{if(frame.size<2)return;if("TXXX"===frame.type){let index=1,description=utf8ArrayToStr(frame.data.subarray(index),!0);index+=description.length+1;let value=utf8ArrayToStr(frame.data.subarray(index));return{key:frame.type,info:description,data:value}}let text=utf8ArrayToStr(frame.data.subarray(1));return{key:frame.type,data:text}},decodeURLFrame=frame=>{if("WXXX"===frame.type){if(frame.size<2)return;let index=1,description=utf8ArrayToStr(frame.data.subarray(index),!0);index+=description.length+1;let value=utf8ArrayToStr(frame.data.subarray(index));return{key:frame.type,info:description,data:value}}let url=utf8ArrayToStr(frame.data);return{key:frame.type,data:url}},readTimeStamp=timeStampFrame=>{if(8===timeStampFrame.data.byteLength){let data=new Uint8Array(timeStampFrame.data),pts33Bit=1&data[3],timestamp=(data[4]<<23)+(data[5]<<15)+(data[6]<<7)+data[7];return timestamp/=45,pts33Bit&&(timestamp+=47721858.84),Math.round(timestamp)}},utf8ArrayToStr=(array,exitOnNull=!1)=>{let c,char2;let decoder=getTextDecoder();if(decoder){let decoded=decoder.decode(array);if(exitOnNull){let idx=decoded.indexOf("\x00");return -1!==idx?decoded.substring(0,idx):decoded}return decoded.replace(/\0/g,"")}let len=array.length,out="",i=0;for(;i<len&&(0!==(c=array[i++])||!exitOnNull);)if(0!==c&&3!==c)switch(c>>4){case 0:case 1:case 2:case 3:case 4:case 5:case 6:case 7:out+=String.fromCharCode(c);break;case 12:case 13:out+=String.fromCharCode((31&c)<<6|63&array[i++]);break;case 14:out+=String.fromCharCode((15&c)<<12|(63&array[i++])<<6|(63&array[i++])<<0)}return out};function getTextDecoder(){if(!navigator.userAgent.includes("PlayStation 4"))return decoder||void 0===self.TextDecoder||(decoder=new self.TextDecoder("utf-8")),decoder}let Hex={hexDump:function(array){let str="";for(let i=0;i<array.length;i++){let h=array[i].toString(16);h.length<2&&(h="0"+h),str+=h}return str}},push=[].push,RemuxerTrackIdConfig={video:1,audio:2,id3:3,text:4};function bin2str(data){return String.fromCharCode.apply(null,data)}function readUint16(buffer,offset){let val=buffer[offset]<<8|buffer[offset+1];return val<0?65536+val:val}function readUint32(buffer,offset){let val=readSint32(buffer,offset);return val<0?4294967296+val:val}function readUint64(buffer,offset){let result=readUint32(buffer,offset);return result*=4294967296,result+=readUint32(buffer,offset+4)}function readSint32(buffer,offset){return buffer[offset]<<24|buffer[offset+1]<<16|buffer[offset+2]<<8|buffer[offset+3]}function writeUint32(buffer,offset,value){buffer[offset]=value>>24,buffer[offset+1]=value>>16&255,buffer[offset+2]=value>>8&255,buffer[offset+3]=255&value}function hasMoofData(data){let end=data.byteLength;for(let i=0;i<end;){let size=readUint32(data,i);if(size>8&&109===data[i+4]&&111===data[i+5]&&111===data[i+6]&&102===data[i+7])return!0;i=size>1?i+size:end}return!1}function findBox(data,path){let results=[];if(!path.length)return results;let end=data.byteLength;for(let i=0;i<end;){let size=readUint32(data,i),type=bin2str(data.subarray(i+4,i+8)),endbox=size>1?i+size:end;if(type===path[0]){if(1===path.length)results.push(data.subarray(i+8,endbox));else{let subresults=findBox(data.subarray(i+8,endbox),path.slice(1));subresults.length&&push.apply(results,subresults)}}i=endbox}return results}function parseSegmentIndex(sidx){let references=[],version=sidx[0],index=8,timescale=readUint32(sidx,8);index+=4;let earliestPresentationTime=0,firstOffset=0;0===version?(earliestPresentationTime=readUint32(sidx,index),firstOffset=readUint32(sidx,index+4),index+=8):(earliestPresentationTime=readUint64(sidx,index),firstOffset=readUint64(sidx,index+8),index+=16),index+=2;let startByte=sidx.length+firstOffset,referencesCount=readUint16(sidx,index);index+=2;for(let i=0;i<referencesCount;i++){let referenceIndex=index,referenceInfo=readUint32(sidx,referenceIndex);referenceIndex+=4;let referenceSize=2147483647&referenceInfo;if(1==(2147483648&referenceInfo)>>>31)return logger.warn("SIDX has hierarchical references (not supported)"),null;let subsegmentDuration=readUint32(sidx,referenceIndex);referenceIndex+=4,references.push({referenceSize,subsegmentDuration,info:{duration:subsegmentDuration/timescale,start:startByte,end:startByte+referenceSize-1}}),startByte+=referenceSize,referenceIndex+=4,index=referenceIndex}return{earliestPresentationTime,timescale,version,referencesCount,references}}function parseInitSegment(initSegment){let result=[],traks=findBox(initSegment,["moov","trak"]);for(let i=0;i<traks.length;i++){let trak=traks[i],tkhd=findBox(trak,["tkhd"])[0];if(tkhd){let version=tkhd[0],trackId=readUint32(tkhd,0===version?12:20),mdhd=findBox(trak,["mdia","mdhd"])[0];if(mdhd){version=mdhd[0];let timescale=readUint32(mdhd,0===version?12:20),hdlr=findBox(trak,["mdia","hdlr"])[0];if(hdlr){let hdlrType=bin2str(hdlr.subarray(8,12)),type={soun:ElementaryStreamTypes.AUDIO,vide:ElementaryStreamTypes.VIDEO}[hdlrType];if(type){let stsdData=parseStsd(findBox(trak,["mdia","minf","stbl","stsd"])[0]);result[trackId]={timescale,type},result[type]=_objectSpread2({timescale,id:trackId},stsdData)}}}}}return findBox(initSegment,["moov","mvex","trex"]).forEach(trex=>{let track=result[readUint32(trex,4)];track&&(track.default={duration:readUint32(trex,12),flags:readUint32(trex,20)})}),result}function parseStsd(stsd){let sampleEntries=stsd.subarray(8),sampleEntriesEnd=sampleEntries.subarray(86),fourCC=bin2str(sampleEntries.subarray(4,8)),codec=fourCC,encrypted="enca"===fourCC||"encv"===fourCC;if(encrypted){let encBoxChildren=findBox(sampleEntries,[fourCC])[0].subarray("enca"===fourCC?28:78);findBox(encBoxChildren,["sinf"]).forEach(sinf=>{let schm=findBox(sinf,["schm"])[0];if(schm){let scheme=bin2str(schm.subarray(4,8));if("cbcs"===scheme||"cenc"===scheme){let frma=findBox(sinf,["frma"])[0];frma&&(codec=bin2str(frma))}}})}switch(codec){case"avc1":case"avc2":case"avc3":case"avc4":{let avcCBox=findBox(sampleEntriesEnd,["avcC"])[0];codec+="."+toHex(avcCBox[1])+toHex(avcCBox[2])+toHex(avcCBox[3]);break}case"mp4a":{let codecBox=findBox(sampleEntries,[fourCC])[0],esdsBox=findBox(codecBox.subarray(28),["esds"])[0];if(esdsBox&&esdsBox.length>12){let i=4;if(3!==esdsBox[i++])break;i=skipBERInteger(esdsBox,i)+2;let flags=esdsBox[i++];if(128&flags&&(i+=2),64&flags&&(i+=esdsBox[i++]),4!==esdsBox[i++])break;i=skipBERInteger(esdsBox,i);let objectType=esdsBox[i++];if(64===objectType)codec+="."+toHex(objectType);else break;if(i+=12,5!==esdsBox[i++])break;i=skipBERInteger(esdsBox,i);let firstByte=esdsBox[i++],audioObjectType=(248&firstByte)>>3;31===audioObjectType&&(audioObjectType+=1+((7&firstByte)<<3)+((224&esdsBox[i])>>5)),codec+="."+audioObjectType}break}case"hvc1":case"hev1":{let hvcCBox=findBox(sampleEntriesEnd,["hvcC"])[0],profileByte=hvcCBox[1],profileSpace=["","A","B","C"][profileByte>>6],profileCompat=readUint32(hvcCBox,2),levelIDC=hvcCBox[12],constraintIndicator=hvcCBox.subarray(6,12);codec+="."+profileSpace+(31&profileByte)+"."+profileCompat.toString(16).toUpperCase()+"."+((32&profileByte)>>5?"H":"L")+levelIDC;let constraintString="";for(let i=constraintIndicator.length;i--;){let byte=constraintIndicator[i];(byte||constraintString)&&(constraintString="."+byte.toString(16).toUpperCase()+constraintString)}codec+=constraintString;break}case"dvh1":case"dvhe":{let dvcCBox=findBox(sampleEntriesEnd,["dvcC"])[0],profile=dvcCBox[2]>>1&127,level=dvcCBox[2]<<5&32|dvcCBox[3]>>3&31;codec+="."+addLeadingZero(profile)+"."+addLeadingZero(level);break}case"vp09":{let vpcCBox=findBox(sampleEntriesEnd,["vpcC"])[0],profile=vpcCBox[4],level=vpcCBox[5],bitDepth=vpcCBox[6]>>4&15;codec+="."+addLeadingZero(profile)+"."+addLeadingZero(level)+"."+addLeadingZero(bitDepth);break}case"av01":{let av1CBox=findBox(sampleEntriesEnd,["av1C"])[0],profile=av1CBox[1]>>>5,level=31&av1CBox[1],tierFlag=av1CBox[2]>>>7?"H":"M",highBitDepth=(64&av1CBox[2])>>6,twelveBit=(32&av1CBox[2])>>5,monochrome=(16&av1CBox[2])>>4,chromaSubsamplingX=(8&av1CBox[2])>>3,chromaSubsamplingY=(4&av1CBox[2])>>2,chromaSamplePosition=3&av1CBox[2];codec+="."+profile+"."+addLeadingZero(level)+tierFlag+"."+addLeadingZero(2===profile&&highBitDepth?twelveBit?12:10:highBitDepth?10:8)+"."+monochrome+"."+chromaSubsamplingX+chromaSubsamplingY+chromaSamplePosition+"."+addLeadingZero(1)+"."+addLeadingZero(1)+"."+addLeadingZero(1)+".0"}}return{codec,encrypted}}function skipBERInteger(bytes,i){let limit=i+5;for(;128&bytes[i++]&&i<limit;);return i}function toHex(x){return("0"+x.toString(16).toUpperCase()).slice(-2)}function addLeadingZero(num){return(num<10?"0":"")+num}function patchEncyptionData(initSegment,decryptdata){if(!initSegment||!decryptdata)return initSegment;let keyId=decryptdata.keyId;return keyId&&decryptdata.isCommonEncryption&&findBox(initSegment,["moov","trak"]).forEach(trak=>{let sampleEntries=findBox(trak,["mdia","minf","stbl","stsd"])[0].subarray(8),encBoxes=findBox(sampleEntries,["enca"]),isAudio=encBoxes.length>0;isAudio||(encBoxes=findBox(sampleEntries,["encv"])),encBoxes.forEach(enc=>{findBox(isAudio?enc.subarray(28):enc.subarray(78),["sinf"]).forEach(sinf=>{let tenc=parseSinf(sinf);if(tenc){let tencKeyId=tenc.subarray(8,24);tencKeyId.some(b=>0!==b)||(logger.log(`[eme] Patching keyId in 'enc${isAudio?"a":"v"}>sinf>>tenc' box: ${Hex.hexDump(tencKeyId)} -> ${Hex.hexDump(keyId)}`),tenc.set(keyId,8))}})})}),initSegment}function parseSinf(sinf){let schm=findBox(sinf,["schm"])[0];if(schm){let scheme=bin2str(schm.subarray(4,8));if("cbcs"===scheme||"cenc"===scheme)return findBox(sinf,["schi","tenc"])[0]}return logger.error("[eme] missing 'schm' box"),null}function getStartDTS(initData,fmp4){return findBox(fmp4,["moof","traf"]).reduce((result,traf)=>{let tfdt=findBox(traf,["tfdt"])[0],version=tfdt[0],start=findBox(traf,["tfhd"]).reduce((result,tfhd)=>{let track=initData[readUint32(tfhd,4)];if(track){let baseTime=readUint32(tfdt,4);if(1===version){if(4294967295===baseTime)return logger.warn("[mp4-demuxer]: Ignoring assumed invalid signed 64-bit track fragment decode time"),result;baseTime*=4294967296,baseTime+=readUint32(tfdt,8)}let startTime=baseTime/(track.timescale||9e4);if(isFiniteNumber(startTime)&&(null===result||startTime<result))return startTime}return result},null);return null!==start&&isFiniteNumber(start)&&(null===result||start<result)?start:result},null)}function getDuration(data,initData){let rawDuration=0,videoDuration=0,audioDuration=0,trafs=findBox(data,["moof","traf"]);for(let i=0;i<trafs.length;i++){let traf=trafs[i],tfhd=findBox(traf,["tfhd"])[0],track=initData[readUint32(tfhd,4)];if(!track)continue;let trackDefault=track.default,tfhdFlags=readUint32(tfhd,0)|(null==trackDefault?void 0:trackDefault.flags),sampleDuration=null==trackDefault?void 0:trackDefault.duration;8&tfhdFlags&&(sampleDuration=2&tfhdFlags?readUint32(tfhd,12):readUint32(tfhd,8));let timescale=track.timescale||9e4,truns=findBox(traf,["trun"]);for(let j=0;j<truns.length;j++)(rawDuration=computeRawDurationFromSamples(truns[j]))||!sampleDuration||(rawDuration=sampleDuration*readUint32(truns[j],4)),track.type===ElementaryStreamTypes.VIDEO?videoDuration+=rawDuration/timescale:track.type===ElementaryStreamTypes.AUDIO&&(audioDuration+=rawDuration/timescale)}if(0===videoDuration&&0===audioDuration){let sidxMinStart=1/0,sidxMaxEnd=0,sidxDuration=0,sidxs=findBox(data,["sidx"]);for(let i=0;i<sidxs.length;i++){let sidx=parseSegmentIndex(sidxs[i]);null!=sidx&&sidx.references&&(sidxMinStart=Math.min(sidxMinStart,sidx.earliestPresentationTime/sidx.timescale),sidxDuration=(sidxMaxEnd=Math.max(sidxMaxEnd,sidx.references.reduce((dur,ref)=>dur+ref.info.duration||0,0)+sidx.earliestPresentationTime/sidx.timescale))-sidxMinStart)}if(sidxDuration&&isFiniteNumber(sidxDuration))return sidxDuration}return videoDuration||audioDuration}function computeRawDurationFromSamples(trun){let flags=readUint32(trun,0),offset=8;1&flags&&(offset+=4),4&flags&&(offset+=4);let duration=0,sampleCount=readUint32(trun,4);for(let i=0;i<sampleCount;i++)256&flags&&(duration+=readUint32(trun,offset),offset+=4),512&flags&&(offset+=4),1024&flags&&(offset+=4),2048&flags&&(offset+=4);return duration}function offsetStartDTS(initData,fmp4,timeOffset){findBox(fmp4,["moof","traf"]).forEach(traf=>{findBox(traf,["tfhd"]).forEach(tfhd=>{let track=initData[readUint32(tfhd,4)];if(!track)return;let timescale=track.timescale||9e4;findBox(traf,["tfdt"]).forEach(tfdt=>{let version=tfdt[0],offset=timeOffset*timescale;if(offset){let baseMediaDecodeTime=readUint32(tfdt,4);if(0===version)baseMediaDecodeTime-=offset,writeUint32(tfdt,4,baseMediaDecodeTime=Math.max(baseMediaDecodeTime,0));else{baseMediaDecodeTime*=4294967296,baseMediaDecodeTime+=readUint32(tfdt,8),baseMediaDecodeTime-=offset;let upper=Math.floor((baseMediaDecodeTime=Math.max(baseMediaDecodeTime,0))/4294967296),lower=Math.floor(baseMediaDecodeTime%4294967296);writeUint32(tfdt,4,upper),writeUint32(tfdt,8,lower)}}})})})}function segmentValidRange(data){let segmentedRange={valid:null,remainder:null},moofs=findBox(data,["moof"]);if(moofs.length<2)return segmentedRange.remainder=data,segmentedRange;let last=moofs[moofs.length-1];return segmentedRange.valid=sliceUint8(data,0,last.byteOffset-8),segmentedRange.remainder=sliceUint8(data,last.byteOffset-8),segmentedRange}function appendUint8Array(data1,data2){let temp=new Uint8Array(data1.length+data2.length);return temp.set(data1),temp.set(data2,data1.length),temp}function parseSamples(timeOffset,track){let seiSamples=[],videoData=track.samples,timescale=track.timescale,trackId=track.id,isHEVCFlavor=!1;return findBox(videoData,["moof"]).map(moof=>{let moofOffset=moof.byteOffset-8;findBox(moof,["traf"]).map(traf=>{let baseTime=findBox(traf,["tfdt"]).map(tfdt=>{let version=tfdt[0],result=readUint32(tfdt,4);return 1===version&&(result*=4294967296,result+=readUint32(tfdt,8)),result/timescale})[0];return void 0!==baseTime&&(timeOffset=baseTime),findBox(traf,["tfhd"]).map(tfhd=>{let id=readUint32(tfhd,4),tfhdFlags=16777215&readUint32(tfhd,0),defaultSampleDuration=0,defaultSampleSize=0,tfhdOffset=8;id===trackId&&((1&tfhdFlags)!=0&&(tfhdOffset+=8),(2&tfhdFlags)!=0&&(tfhdOffset+=4),(8&tfhdFlags)!=0&&(defaultSampleDuration=readUint32(tfhd,tfhdOffset),tfhdOffset+=4),(16&tfhdFlags)!=0&&(defaultSampleSize=readUint32(tfhd,tfhdOffset),tfhdOffset+=4),(32&tfhdFlags)!=0&&(tfhdOffset+=4),"video"===track.type&&(isHEVCFlavor=isHEVC(track.codec)),findBox(traf,["trun"]).map(trun=>{let version=trun[0],flags=16777215&readUint32(trun,0),dataOffset=0,sampleDurationPresent=(256&flags)!=0,sampleDuration=0,sampleSizePresent=(512&flags)!=0,sampleSize=0,sampleFlagsPresent=(1024&flags)!=0,sampleCompositionOffsetsPresent=(2048&flags)!=0,compositionOffset=0,sampleCount=readUint32(trun,4),trunOffset=8;(1&flags)!=0&&(dataOffset=readUint32(trun,trunOffset),trunOffset+=4),(4&flags)!=0&&(trunOffset+=4);let sampleOffset=dataOffset+moofOffset;for(let ix=0;ix<sampleCount;ix++){if(sampleDurationPresent?(sampleDuration=readUint32(trun,trunOffset),trunOffset+=4):sampleDuration=defaultSampleDuration,sampleSizePresent?(sampleSize=readUint32(trun,trunOffset),trunOffset+=4):sampleSize=defaultSampleSize,sampleFlagsPresent&&(trunOffset+=4),sampleCompositionOffsetsPresent&&(compositionOffset=0===version?readUint32(trun,trunOffset):readSint32(trun,trunOffset),trunOffset+=4),track.type===ElementaryStreamTypes.VIDEO){let naluTotalSize=0;for(;naluTotalSize<sampleSize;){let naluSize=readUint32(videoData,sampleOffset);sampleOffset+=4,isSEIMessage(isHEVCFlavor,videoData[sampleOffset])&&parseSEIMessageFromNALu(videoData.subarray(sampleOffset,sampleOffset+naluSize),isHEVCFlavor?2:1,timeOffset+compositionOffset/timescale,seiSamples),sampleOffset+=naluSize,naluTotalSize+=naluSize+4}}timeOffset+=sampleDuration/timescale}}))})})}),seiSamples}function isHEVC(codec){if(!codec)return!1;let delimit=codec.indexOf("."),baseCodec=delimit<0?codec:codec.substring(0,delimit);return"hvc1"===baseCodec||"hev1"===baseCodec||"dvh1"===baseCodec||"dvhe"===baseCodec}function isSEIMessage(isHEVCFlavor,naluHeader){if(!isHEVCFlavor)return 6==(31&naluHeader);{let naluType=naluHeader>>1&63;return 39===naluType||40===naluType}}function parseSEIMessageFromNALu(unescapedData,headerSize,pts,samples){let seiPtr;let data=discardEPB(unescapedData);seiPtr=0+headerSize;let payloadType=0,payloadSize=0,b=0;for(;seiPtr<data.length;){payloadType=0;do{if(seiPtr>=data.length)break;payloadType+=b=data[seiPtr++]}while(255===b);payloadSize=0;do{if(seiPtr>=data.length)break;payloadSize+=b=data[seiPtr++]}while(255===b);let leftOver=data.length-seiPtr,payPtr=seiPtr;if(payloadSize<leftOver)seiPtr+=payloadSize;else if(payloadSize>leftOver){logger.error(`Malformed SEI payload. ${payloadSize} is too small, only ${leftOver} bytes left to parse.`);break}if(4===payloadType){if(181===data[payPtr++]){let providerCode=readUint16(data,payPtr);if(payPtr+=2,49===providerCode){let userStructure=readUint32(data,payPtr);if(payPtr+=4,1195456820===userStructure){let userDataType=data[payPtr++];if(3===userDataType){let firstByte=data[payPtr++],totalCCs=31&firstByte,enabled=64&firstByte,totalBytes=enabled?2+3*totalCCs:0,byteArray=new Uint8Array(totalBytes);if(enabled){byteArray[0]=firstByte;for(let i=1;i<totalBytes;i++)byteArray[i]=data[payPtr++]}samples.push({type:userDataType,payloadType,pts,bytes:byteArray})}}}}}else if(5===payloadType&&payloadSize>16){let uuidStrArray=[];for(let i=0;i<16;i++){let _b=data[payPtr++].toString(16);uuidStrArray.push(1==_b.length?"0"+_b:_b),(3===i||5===i||7===i||9===i)&&uuidStrArray.push("-")}let length=payloadSize-16,userDataBytes=new Uint8Array(length);for(let i=0;i<length;i++)userDataBytes[i]=data[payPtr++];samples.push({payloadType,pts,uuid:uuidStrArray.join(""),userData:utf8ArrayToStr(userDataBytes),userDataBytes})}}}function discardEPB(data){let length=data.byteLength,EPBPositions=[],i=1;for(;i<length-2;)0===data[i]&&0===data[i+1]&&3===data[i+2]?(EPBPositions.push(i+2),i+=2):i++;if(0===EPBPositions.length)return data;let newLength=length-EPBPositions.length,newData=new Uint8Array(newLength),sourceIndex=0;for(i=0;i<newLength;sourceIndex++,i++)sourceIndex===EPBPositions[0]&&(sourceIndex++,EPBPositions.shift()),newData[i]=data[sourceIndex];return newData}function parseEmsg(data){let version=data[0],schemeIdUri="",value="",timeScale=0,presentationTimeDelta=0,presentationTime=0,eventDuration=0,id=0,offset=0;if(0===version){for(;"\x00"!==bin2str(data.subarray(offset,offset+1));)schemeIdUri+=bin2str(data.subarray(offset,offset+1)),offset+=1;for(schemeIdUri+=bin2str(data.subarray(offset,offset+1)),offset+=1;"\x00"!==bin2str(data.subarray(offset,offset+1));)value+=bin2str(data.subarray(offset,offset+1)),offset+=1;value+=bin2str(data.subarray(offset,offset+1)),offset+=1,timeScale=readUint32(data,12),presentationTimeDelta=readUint32(data,16),eventDuration=readUint32(data,20),id=readUint32(data,24),offset=28}else if(1===version){offset+=4,timeScale=readUint32(data,offset);let leftPresentationTime=readUint32(data,offset+=4),rightPresentationTime=readUint32(data,offset+=4);for(offset+=4,isSafeInteger(presentationTime=4294967296*leftPresentationTime+rightPresentationTime)||(presentationTime=Number.MAX_SAFE_INTEGER,logger.warn("Presentation time exceeds safe integer limit and wrapped to max safe integer in parsing emsg box")),eventDuration=readUint32(data,offset),offset+=4,id=readUint32(data,offset),offset+=4;"\x00"!==bin2str(data.subarray(offset,offset+1));)schemeIdUri+=bin2str(data.subarray(offset,offset+1)),offset+=1;for(schemeIdUri+=bin2str(data.subarray(offset,offset+1)),offset+=1;"\x00"!==bin2str(data.subarray(offset,offset+1));)value+=bin2str(data.subarray(offset,offset+1)),offset+=1;value+=bin2str(data.subarray(offset,offset+1)),offset+=1}return{schemeIdUri,value,timeScale,presentationTime,presentationTimeDelta,eventDuration,id,payload:data.subarray(offset,data.byteLength)}}class LevelKey{static clearKeyUriToKeyIdMap(){}constructor(method,uri,format,formatversions=[1],iv=null){this.uri=void 0,this.method=void 0,this.keyFormat=void 0,this.keyFormatVersions=void 0,this.encrypted=void 0,this.isCommonEncryption=void 0,this.iv=null,this.key=null,this.keyId=null,this.pssh=null,this.method=method,this.uri=uri,this.keyFormat=format,this.keyFormatVersions=formatversions,this.iv=iv,this.encrypted=!!method&&"NONE"!==method,this.isCommonEncryption=this.encrypted&&"AES-128"!==method}isSupported(){if(this.method){if("AES-128"===this.method||"NONE"===this.method)return!0;if("identity"===this.keyFormat)return"SAMPLE-AES"===this.method}return!1}getDecryptData(sn){if(!this.encrypted||!this.uri)return null;if("AES-128"===this.method&&this.uri&&!this.iv){"number"!=typeof sn&&("AES-128"!==this.method||this.iv||logger.warn(`missing IV for initialization segment with method="${this.method}" - compliance issue`),sn=0);let iv=createInitializationVector(sn);return new LevelKey(this.method,this.uri,"identity",this.keyFormatVersions,iv)}return this}}function createInitializationVector(segmentNumber){let uint8View=new Uint8Array(16);for(let i=12;i<16;i++)uint8View[i]=segmentNumber>>8*(15-i)&255;return uint8View}function getMediaSource(preferManagedMediaSource=!0){if("undefined"!=typeof self)return(preferManagedMediaSource||!self.MediaSource)&&self.ManagedMediaSource||self.MediaSource||self.WebKitMediaSource}function isManagedMediaSource(source){return"undefined"!=typeof self&&source===self.ManagedMediaSource}let sampleEntryCodesISO={audio:{a3ds:1,"ac-3":.95,"ac-4":1,alac:.9,alaw:1,dra1:1,"dts+":1,"dts-":1,dtsc:1,dtse:1,dtsh:1,"ec-3":.9,enca:1,fLaC:.9,flac:.9,FLAC:.9,g719:1,g726:1,m4ae:1,mha1:1,mha2:1,mhm1:1,mhm2:1,mlpa:1,mp4a:1,"raw ":1,Opus:1,opus:1,samr:1,sawb:1,sawp:1,sevc:1,sqcp:1,ssmv:1,twos:1,ulaw:1},video:{avc1:1,avc2:1,avc3:1,avc4:1,avcp:1,av01:.8,drac:1,dva1:1,dvav:1,dvh1:.7,dvhe:.7,encv:1,hev1:.75,hvc1:.75,mjp2:1,mp4v:1,mvc1:1,mvc2:1,mvc3:1,mvc4:1,resv:1,rv60:1,s263:1,svc1:1,svc2:1,"vc-1":1,vp08:1,vp09:.9},text:{stpp:1,wvtt:1}};function isCodecType(codec,type){let typeCodes=sampleEntryCodesISO[type];return!!typeCodes&&!!typeCodes[codec.slice(0,4)]}function areCodecsMediaSourceSupported(codecs,type,preferManagedMediaSource=!0){return!codecs.split(",").some(codec=>!isCodecMediaSourceSupported(codec,type,preferManagedMediaSource))}function isCodecMediaSourceSupported(codec,type,preferManagedMediaSource=!0){var _MediaSource$isTypeSu;let MediaSource=getMediaSource(preferManagedMediaSource);return null!=(_MediaSource$isTypeSu=null==MediaSource?void 0:MediaSource.isTypeSupported(mimeTypeForCodec(codec,type)))&&_MediaSource$isTypeSu}function mimeTypeForCodec(codec,type){return`${type}/mp4;codecs="${codec}"`}function videoCodecPreferenceValue(videoCodec){if(videoCodec){let fourCC=videoCodec.substring(0,4);return sampleEntryCodesISO.video[fourCC]}return 2}function codecsSetSelectionPreferenceValue(codecSet){return codecSet.split(",").reduce((num,fourCC)=>{let preferenceValue=sampleEntryCodesISO.video[fourCC];return preferenceValue?(2*preferenceValue+num)/(num?3:2):(sampleEntryCodesISO.audio[fourCC]+num)/(num?2:1)},0)}let CODEC_COMPATIBLE_NAMES={};function getCodecCompatibleNameLower(lowerCaseCodec,preferManagedMediaSource=!0){if(CODEC_COMPATIBLE_NAMES[lowerCaseCodec])return CODEC_COMPATIBLE_NAMES[lowerCaseCodec];let codecsToCheck={flac:["flac","fLaC","FLAC"],opus:["opus","Opus"]}[lowerCaseCodec];for(let i=0;i<codecsToCheck.length;i++)if(isCodecMediaSourceSupported(codecsToCheck[i],"audio",preferManagedMediaSource))return CODEC_COMPATIBLE_NAMES[lowerCaseCodec]=codecsToCheck[i],codecsToCheck[i];return lowerCaseCodec}let AUDIO_CODEC_REGEXP=/flac|opus/i;function getCodecCompatibleName(codec,preferManagedMediaSource=!0){return codec.replace(AUDIO_CODEC_REGEXP,m=>getCodecCompatibleNameLower(m.toLowerCase(),preferManagedMediaSource))}function pickMostCompleteCodecName(parsedCodec,levelCodec){return parsedCodec&&"mp4a"!==parsedCodec?parsedCodec:levelCodec?levelCodec.split(",")[0]:levelCodec}function convertAVC1ToAVCOTI(codec){let codecs=codec.split(",");for(let i=0;i<codecs.length;i++){let avcdata=codecs[i].split(".");if(avcdata.length>2){let result=avcdata.shift()+".";result+=parseInt(avcdata.shift()).toString(16)+("000"+parseInt(avcdata.shift()).toString(16)).slice(-4),codecs[i]=result}}return codecs.join(",")}let MASTER_PLAYLIST_REGEX=/#EXT-X-STREAM-INF:([^\r\n]*)(?:[\r\n](?:#[^\r\n]*)?)*([^\r\n]+)|#EXT-X-(SESSION-DATA|SESSION-KEY|DEFINE|CONTENT-STEERING|START):([^\r\n]*)[\r\n]+/g,MASTER_PLAYLIST_MEDIA_REGEX=/#EXT-X-MEDIA:(.*)/g,IS_MEDIA_PLAYLIST=/^#EXT(?:INF|-X-TARGETDURATION):/m,LEVEL_PLAYLIST_REGEX_FAST=RegExp([/#EXTINF:\s*(\d*(?:\.\d+)?)(?:,(.*)\s+)?/.source,/(?!#) *(\S[^\r\n]*)/.source,/#EXT-X-BYTERANGE:*(.+)/.source,/#EXT-X-PROGRAM-DATE-TIME:(.+)/.source,/#.*/.source].join("|"),"g"),LEVEL_PLAYLIST_REGEX_SLOW=new RegExp([/#(EXTM3U)/.source,/#EXT-X-(DATERANGE|DEFINE|KEY|MAP|PART|PART-INF|PLAYLIST-TYPE|PRELOAD-HINT|RENDITION-REPORT|SERVER-CONTROL|SKIP|START):(.+)/.source,/#EXT-X-(BITRATE|DISCONTINUITY-SEQUENCE|MEDIA-SEQUENCE|TARGETDURATION|VERSION): *(\d+)/.source,/#EXT-X-(DISCONTINUITY|ENDLIST|GAP|INDEPENDENT-SEGMENTS)/.source,/(#)([^:]*):(.*)/.source,/(#)(.*)(?:.*)\r?\n?/.source].join("|"));class M3U8Parser{static findGroup(groups,mediaGroupId){for(let i=0;i<groups.length;i++){let group=groups[i];if(group.id===mediaGroupId)return group}}static resolve(url,baseUrl){return urlToolkitExports.buildAbsoluteURL(baseUrl,url,{alwaysNormalize:!0})}static isMediaPlaylist(str){return IS_MEDIA_PLAYLIST.test(str)}static parseMasterPlaylist(string,baseurl){let result;let parsed={contentSteering:null,levels:[],playlistParsingError:null,sessionData:null,sessionKeys:null,startTimeOffset:null,variableList:null,hasVariableRefs:!1},levelsWithKnownCodecs=[];for(MASTER_PLAYLIST_REGEX.lastIndex=0;null!=(result=MASTER_PLAYLIST_REGEX.exec(string));)if(result[1]){var _level$unknownCodecs;let attrs=new AttrList(result[1]),uri=result[2],level={attrs,bitrate:attrs.decimalInteger("BANDWIDTH")||attrs.decimalInteger("AVERAGE-BANDWIDTH"),name:attrs.NAME,url:M3U8Parser.resolve(uri,baseurl)},resolution=attrs.decimalResolution("RESOLUTION");resolution&&(level.width=resolution.width,level.height=resolution.height),setCodecs(attrs.CODECS,level),null!=(_level$unknownCodecs=level.unknownCodecs)&&_level$unknownCodecs.length||levelsWithKnownCodecs.push(level),parsed.levels.push(level)}else if(result[3]){let tag=result[3],attributes=result[4];switch(tag){case"SESSION-DATA":{let sessionAttrs=new AttrList(attributes),dataId=sessionAttrs["DATA-ID"];dataId&&(null===parsed.sessionData&&(parsed.sessionData={}),parsed.sessionData[dataId]=sessionAttrs);break}case"SESSION-KEY":{let sessionKey=parseKey(attributes,baseurl);sessionKey.encrypted&&sessionKey.isSupported()?(null===parsed.sessionKeys&&(parsed.sessionKeys=[]),parsed.sessionKeys.push(sessionKey)):logger.warn(`[Keys] Ignoring invalid EXT-X-SESSION-KEY tag: "${attributes}"`);break}case"DEFINE":break;case"CONTENT-STEERING":{let contentSteeringAttributes=new AttrList(attributes);parsed.contentSteering={uri:M3U8Parser.resolve(contentSteeringAttributes["SERVER-URI"],baseurl),pathwayId:contentSteeringAttributes["PATHWAY-ID"]||"."};break}case"START":parsed.startTimeOffset=parseStartTimeOffset(attributes)}}let stripUnknownCodecLevels=levelsWithKnownCodecs.length>0&&levelsWithKnownCodecs.length<parsed.levels.length;return parsed.levels=stripUnknownCodecLevels?levelsWithKnownCodecs:parsed.levels,0===parsed.levels.length&&(parsed.playlistParsingError=Error("no levels found in manifest")),parsed}static parseMasterPlaylistMedia(string,baseurl,parsed){let result;let results={},levels=parsed.levels,groupsByType={AUDIO:levels.map(level=>({id:level.attrs.AUDIO,audioCodec:level.audioCodec})),SUBTITLES:levels.map(level=>({id:level.attrs.SUBTITLES,textCodec:level.textCodec})),"CLOSED-CAPTIONS":[]},id=0;for(MASTER_PLAYLIST_MEDIA_REGEX.lastIndex=0;null!==(result=MASTER_PLAYLIST_MEDIA_REGEX.exec(string));){let attrs=new AttrList(result[1]),type=attrs.TYPE;if(type){let groups=groupsByType[type],medias=results[type]||[];results[type]=medias;let lang=attrs.LANGUAGE,assocLang=attrs["ASSOC-LANGUAGE"],channels=attrs.CHANNELS,characteristics=attrs.CHARACTERISTICS,instreamId=attrs["INSTREAM-ID"],media={attrs,bitrate:0,id:id++,groupId:attrs["GROUP-ID"]||"",name:attrs.NAME||lang||"",type,default:attrs.bool("DEFAULT"),autoselect:attrs.bool("AUTOSELECT"),forced:attrs.bool("FORCED"),lang,url:attrs.URI?M3U8Parser.resolve(attrs.URI,baseurl):""};if(assocLang&&(media.assocLang=assocLang),channels&&(media.channels=channels),characteristics&&(media.characteristics=characteristics),instreamId&&(media.instreamId=instreamId),null!=groups&&groups.length){let groupCodec=M3U8Parser.findGroup(groups,media.groupId)||groups[0];assignCodec(media,groupCodec,"audioCodec"),assignCodec(media,groupCodec,"textCodec")}medias.push(media)}}return results}static parseLevelPlaylist(string,baseurl,id,type,levelUrlId,multivariantVariableList){let result,i,levelkeys;let level=new LevelDetails(baseurl),fragments=level.fragments,currentInitSegment=null,currentSN=0,currentPart=0,totalduration=0,discontinuityCounter=0,prevFrag=null,frag=new Fragment(type,baseurl),firstPdtIndex=-1,createNextFrag=!1,nextByteRange=null;for(LEVEL_PLAYLIST_REGEX_FAST.lastIndex=0,level.m3u8=string,level.hasVariableRefs=!1;null!==(result=LEVEL_PLAYLIST_REGEX_FAST.exec(string));){createNextFrag&&(createNextFrag=!1,(frag=new Fragment(type,baseurl)).start=totalduration,frag.sn=currentSN,frag.cc=discontinuityCounter,frag.level=id,currentInitSegment&&(frag.initSegment=currentInitSegment,frag.rawProgramDateTime=currentInitSegment.rawProgramDateTime,currentInitSegment.rawProgramDateTime=null,nextByteRange&&(frag.setByteRange(nextByteRange),nextByteRange=null)));let duration=result[1];if(duration){frag.duration=parseFloat(duration);let title=(" "+result[2]).slice(1);frag.title=title||null,frag.tagList.push(title?["INF",duration,title]:["INF",duration])}else if(result[3]){if(isFiniteNumber(frag.duration)){frag.start=totalduration,levelkeys&&setFragLevelKeys(frag,levelkeys,level),frag.sn=currentSN,frag.level=id,frag.cc=discontinuityCounter,fragments.push(frag);let uri=(" "+result[3]).slice(1);frag.relurl=uri,assignProgramDateTime(frag,prevFrag),prevFrag=frag,totalduration+=frag.duration,currentSN++,currentPart=0,createNextFrag=!0}}else if(result[4]){let data=(" "+result[4]).slice(1);prevFrag?frag.setByteRange(data,prevFrag):frag.setByteRange(data)}else if(result[5])frag.rawProgramDateTime=(" "+result[5]).slice(1),frag.tagList.push(["PROGRAM-DATE-TIME",frag.rawProgramDateTime]),-1===firstPdtIndex&&(firstPdtIndex=fragments.length);else{if(!(result=result[0].match(LEVEL_PLAYLIST_REGEX_SLOW))){logger.warn("No matches on slow regex match for level playlist!");continue}for(i=1;i<result.length&&void 0===result[i];i++);let tag=(" "+result[i]).slice(1),value1=(" "+result[i+1]).slice(1),value2=result[i+2]?(" "+result[i+2]).slice(1):"";switch(tag){case"PLAYLIST-TYPE":level.type=value1.toUpperCase();break;case"MEDIA-SEQUENCE":currentSN=level.startSN=parseInt(value1);break;case"SKIP":{let skipAttrs=new AttrList(value1),skippedSegments=skipAttrs.decimalInteger("SKIPPED-SEGMENTS");if(isFiniteNumber(skippedSegments)){level.skippedSegments=skippedSegments;for(let _i=skippedSegments;_i--;)fragments.unshift(null);currentSN+=skippedSegments}let recentlyRemovedDateranges=skipAttrs.enumeratedString("RECENTLY-REMOVED-DATERANGES");recentlyRemovedDateranges&&(level.recentlyRemovedDateranges=recentlyRemovedDateranges.split("	"));break}case"TARGETDURATION":level.targetduration=Math.max(parseInt(value1),1);break;case"VERSION":level.version=parseInt(value1);break;case"INDEPENDENT-SEGMENTS":case"EXTM3U":case"DEFINE":break;case"ENDLIST":level.live=!1;break;case"#":(value1||value2)&&frag.tagList.push(value2?[value1,value2]:[value1]);break;case"DISCONTINUITY":discontinuityCounter++,frag.tagList.push(["DIS"]);break;case"GAP":frag.gap=!0,frag.tagList.push([tag]);break;case"BITRATE":frag.tagList.push([tag,value1]);break;case"DATERANGE":{let dateRangeAttr=new AttrList(value1),dateRange=new DateRange(dateRangeAttr,level.dateRanges[dateRangeAttr.ID]);dateRange.isValid||level.skippedSegments?level.dateRanges[dateRange.id]=dateRange:logger.warn(`Ignoring invalid DATERANGE tag: "${value1}"`),frag.tagList.push(["EXT-X-DATERANGE",value1]);break}case"DISCONTINUITY-SEQUENCE":discontinuityCounter=parseInt(value1);break;case"KEY":{let levelKey=parseKey(value1,baseurl);if(levelKey.isSupported()){if("NONE"===levelKey.method){levelkeys=void 0;break}levelkeys||(levelkeys={}),levelkeys[levelKey.keyFormat]&&(levelkeys=_extends({},levelkeys)),levelkeys[levelKey.keyFormat]=levelKey}else logger.warn(`[Keys] Ignoring invalid EXT-X-KEY tag: "${value1}"`);break}case"START":level.startTimeOffset=parseStartTimeOffset(value1);break;case"MAP":{let mapAttrs=new AttrList(value1);if(frag.duration){let init=new Fragment(type,baseurl);setInitSegment(init,mapAttrs,id,levelkeys),currentInitSegment=init,frag.initSegment=currentInitSegment,currentInitSegment.rawProgramDateTime&&!frag.rawProgramDateTime&&(frag.rawProgramDateTime=currentInitSegment.rawProgramDateTime)}else{let end=frag.byteRangeEndOffset;if(end){let start=frag.byteRangeStartOffset;nextByteRange=`${end-start}@${start}`}else nextByteRange=null;setInitSegment(frag,mapAttrs,id,levelkeys),currentInitSegment=frag,createNextFrag=!0}break}case"SERVER-CONTROL":{let serverControlAttrs=new AttrList(value1);level.canBlockReload=serverControlAttrs.bool("CAN-BLOCK-RELOAD"),level.canSkipUntil=serverControlAttrs.optionalFloat("CAN-SKIP-UNTIL",0),level.canSkipDateRanges=level.canSkipUntil>0&&serverControlAttrs.bool("CAN-SKIP-DATERANGES"),level.partHoldBack=serverControlAttrs.optionalFloat("PART-HOLD-BACK",0),level.holdBack=serverControlAttrs.optionalFloat("HOLD-BACK",0);break}case"PART-INF":{let partInfAttrs=new AttrList(value1);level.partTarget=partInfAttrs.decimalFloatingPoint("PART-TARGET");break}case"PART":{let partList=level.partList;partList||(partList=level.partList=[]);let previousFragmentPart=currentPart>0?partList[partList.length-1]:void 0,index=currentPart++,part=new Part(new AttrList(value1),frag,baseurl,index,previousFragmentPart);partList.push(part),frag.duration+=part.duration;break}case"PRELOAD-HINT":{let preloadHintAttrs=new AttrList(value1);level.preloadHint=preloadHintAttrs;break}case"RENDITION-REPORT":{let renditionReportAttrs=new AttrList(value1);level.renditionReports=level.renditionReports||[],level.renditionReports.push(renditionReportAttrs);break}default:logger.warn(`line parsed but not handled: ${result}`)}}}prevFrag&&!prevFrag.relurl?(fragments.pop(),totalduration-=prevFrag.duration,level.partList&&(level.fragmentHint=prevFrag)):level.partList&&(assignProgramDateTime(frag,prevFrag),frag.cc=discontinuityCounter,level.fragmentHint=frag,levelkeys&&setFragLevelKeys(frag,levelkeys,level));let fragmentLength=fragments.length,firstFragment=fragments[0],lastFragment=fragments[fragmentLength-1];if((totalduration+=level.skippedSegments*level.targetduration)>0&&fragmentLength&&lastFragment){level.averagetargetduration=totalduration/fragmentLength;let lastSn=lastFragment.sn;level.endSN="initSegment"!==lastSn?lastSn:0,level.live||(lastFragment.endList=!0),firstFragment&&(level.startCC=firstFragment.cc)}else level.endSN=0,level.startCC=0;return level.fragmentHint&&(totalduration+=level.fragmentHint.duration),level.totalduration=totalduration,level.endCC=discontinuityCounter,firstPdtIndex>0&&backfillProgramDateTimes(fragments,firstPdtIndex),level}}function parseKey(keyTagAttributes,baseurl,parsed){var _keyAttrs$METHOD,_keyAttrs$KEYFORMAT;let keyAttrs=new AttrList(keyTagAttributes),decryptmethod=null!=(_keyAttrs$METHOD=keyAttrs.METHOD)?_keyAttrs$METHOD:"",decrypturi=keyAttrs.URI,decryptiv=keyAttrs.hexadecimalInteger("IV"),decryptkeyformatversions=keyAttrs.KEYFORMATVERSIONS,decryptkeyformat=null!=(_keyAttrs$KEYFORMAT=keyAttrs.KEYFORMAT)?_keyAttrs$KEYFORMAT:"identity";return decrypturi&&keyAttrs.IV&&!decryptiv&&logger.error(`Invalid IV: ${keyAttrs.IV}`),new LevelKey(decryptmethod,decrypturi?M3U8Parser.resolve(decrypturi,baseurl):"",decryptkeyformat,(decryptkeyformatversions||"1").split("/").map(Number).filter(Number.isFinite),decryptiv)}function parseStartTimeOffset(startAttributes){let startTimeOffset=new AttrList(startAttributes).decimalFloatingPoint("TIME-OFFSET");return isFiniteNumber(startTimeOffset)?startTimeOffset:null}function setCodecs(codecsAttributeValue,level){let codecs=(codecsAttributeValue||"").split(/[ ,]+/).filter(c=>c);["video","audio","text"].forEach(type=>{let filtered=codecs.filter(codec=>isCodecType(codec,type));filtered.length&&(level[`${type}Codec`]=filtered.join(","),codecs=codecs.filter(codec=>-1===filtered.indexOf(codec)))}),level.unknownCodecs=codecs}function assignCodec(media,groupItem,codecProperty){let codecValue=groupItem[codecProperty];codecValue&&(media[codecProperty]=codecValue)}function backfillProgramDateTimes(fragments,firstPdtIndex){let fragPrev=fragments[firstPdtIndex];for(let i=firstPdtIndex;i--;){let frag=fragments[i];if(!frag)return;frag.programDateTime=fragPrev.programDateTime-1e3*frag.duration,fragPrev=frag}}function assignProgramDateTime(frag,prevFrag){frag.rawProgramDateTime?frag.programDateTime=Date.parse(frag.rawProgramDateTime):null!=prevFrag&&prevFrag.programDateTime&&(frag.programDateTime=prevFrag.endProgramDateTime),isFiniteNumber(frag.programDateTime)||(frag.programDateTime=null,frag.rawProgramDateTime=null)}function setInitSegment(frag,mapAttrs,id,levelkeys){frag.relurl=mapAttrs.URI,mapAttrs.BYTERANGE&&frag.setByteRange(mapAttrs.BYTERANGE),frag.level=id,frag.sn="initSegment",levelkeys&&(frag.levelkeys=levelkeys),frag.initSegment=null}function setFragLevelKeys(frag,levelkeys,level){frag.levelkeys=levelkeys;let{encryptedFragments}=level;(!encryptedFragments.length||encryptedFragments[encryptedFragments.length-1].levelkeys!==levelkeys)&&Object.keys(levelkeys).some(format=>levelkeys[format].isCommonEncryption)&&encryptedFragments.push(frag)}var PlaylistContextType={MANIFEST:"manifest",LEVEL:"level",AUDIO_TRACK:"audioTrack",SUBTITLE_TRACK:"subtitleTrack"},PlaylistLevelType={MAIN:"main",AUDIO:"audio",SUBTITLE:"subtitle"};function mapContextToLevelType(context){let{type}=context;switch(type){case PlaylistContextType.AUDIO_TRACK:return PlaylistLevelType.AUDIO;case PlaylistContextType.SUBTITLE_TRACK:return PlaylistLevelType.SUBTITLE;default:return PlaylistLevelType.MAIN}}function getResponseUrl(response,context){let url=response.url;return(void 0===url||0===url.indexOf("data:"))&&(url=context.url),url}class PlaylistLoader{constructor(hls){this.hls=void 0,this.loaders=Object.create(null),this.variableList=null,this.hls=hls,this.registerListeners()}startLoad(startPosition){}stopLoad(){this.destroyInternalLoaders()}registerListeners(){let{hls}=this;hls.on(Events1.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events1.LEVEL_LOADING,this.onLevelLoading,this),hls.on(Events1.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),hls.on(Events1.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}unregisterListeners(){let{hls}=this;hls.off(Events1.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events1.LEVEL_LOADING,this.onLevelLoading,this),hls.off(Events1.AUDIO_TRACK_LOADING,this.onAudioTrackLoading,this),hls.off(Events1.SUBTITLE_TRACK_LOADING,this.onSubtitleTrackLoading,this)}createInternalLoader(context){let config=this.hls.config,PLoader=config.pLoader,Loader=config.loader,loader=new(PLoader||Loader)(config);return this.loaders[context.type]=loader,loader}getInternalLoader(context){return this.loaders[context.type]}resetInternalLoader(contextType){this.loaders[contextType]&&delete this.loaders[contextType]}destroyInternalLoaders(){for(let contextType in this.loaders){let loader=this.loaders[contextType];loader&&loader.destroy(),this.resetInternalLoader(contextType)}}destroy(){this.variableList=null,this.unregisterListeners(),this.destroyInternalLoaders()}onManifestLoading(event,data){let{url}=data;this.variableList=null,this.load({id:null,level:0,responseType:"text",type:PlaylistContextType.MANIFEST,url,deliveryDirectives:null})}onLevelLoading(event,data){let{id,level,pathwayId,url,deliveryDirectives}=data;this.load({id,level,pathwayId,responseType:"text",type:PlaylistContextType.LEVEL,url,deliveryDirectives})}onAudioTrackLoading(event,data){let{id,groupId,url,deliveryDirectives}=data;this.load({id,groupId,level:null,responseType:"text",type:PlaylistContextType.AUDIO_TRACK,url,deliveryDirectives})}onSubtitleTrackLoading(event,data){let{id,groupId,url,deliveryDirectives}=data;this.load({id,groupId,level:null,responseType:"text",type:PlaylistContextType.SUBTITLE_TRACK,url,deliveryDirectives})}load(context){var _context$deliveryDire;let loadPolicy;let config=this.hls.config,loader=this.getInternalLoader(context);if(loader){let loaderContext=loader.context;if(loaderContext&&loaderContext.url===context.url&&loaderContext.level===context.level){logger.trace("[playlist-loader]: playlist request ongoing");return}logger.log(`[playlist-loader]: aborting previous loader for type: ${context.type}`),loader.abort()}if(loadPolicy=context.type===PlaylistContextType.MANIFEST?config.manifestLoadPolicy.default:_extends({},config.playlistLoadPolicy.default,{timeoutRetry:null,errorRetry:null}),loader=this.createInternalLoader(context),isFiniteNumber(null==(_context$deliveryDire=context.deliveryDirectives)?void 0:_context$deliveryDire.part)){let levelDetails;if(context.type===PlaylistContextType.LEVEL&&null!==context.level?levelDetails=this.hls.levels[context.level].details:context.type===PlaylistContextType.AUDIO_TRACK&&null!==context.id?levelDetails=this.hls.audioTracks[context.id].details:context.type===PlaylistContextType.SUBTITLE_TRACK&&null!==context.id&&(levelDetails=this.hls.subtitleTracks[context.id].details),levelDetails){let partTarget=levelDetails.partTarget,targetDuration=levelDetails.targetduration;if(partTarget&&targetDuration){let maxLowLatencyPlaylistRefresh=1e3*Math.max(3*partTarget,.8*targetDuration);loadPolicy=_extends({},loadPolicy,{maxTimeToFirstByteMs:Math.min(maxLowLatencyPlaylistRefresh,loadPolicy.maxTimeToFirstByteMs),maxLoadTimeMs:Math.min(maxLowLatencyPlaylistRefresh,loadPolicy.maxTimeToFirstByteMs)})}}}let legacyRetryCompatibility=loadPolicy.errorRetry||loadPolicy.timeoutRetry||{},loaderConfig={loadPolicy,timeout:loadPolicy.maxLoadTimeMs,maxRetry:legacyRetryCompatibility.maxNumRetry||0,retryDelay:legacyRetryCompatibility.retryDelayMs||0,maxRetryDelay:legacyRetryCompatibility.maxRetryDelayMs||0};loader.load(context,loaderConfig,{onSuccess:(response,stats,context,networkDetails)=>{let loader=this.getInternalLoader(context);this.resetInternalLoader(context.type);let string=response.data;if(0!==string.indexOf("#EXTM3U")){this.handleManifestParsingError(response,context,Error("no EXTM3U delimiter"),networkDetails||null,stats);return}stats.parsing.start=performance.now(),M3U8Parser.isMediaPlaylist(string)?this.handleTrackOrLevelPlaylist(response,stats,context,networkDetails||null,loader):this.handleMasterPlaylist(response,stats,context,networkDetails)},onError:(response,context,networkDetails,stats)=>{this.handleNetworkError(context,networkDetails,!1,response,stats)},onTimeout:(stats,context,networkDetails)=>{this.handleNetworkError(context,networkDetails,!0,void 0,stats)}})}handleMasterPlaylist(response,stats,context,networkDetails){let hls=this.hls,string=response.data,url=getResponseUrl(response,context),parsedResult=M3U8Parser.parseMasterPlaylist(string,url);if(parsedResult.playlistParsingError){this.handleManifestParsingError(response,context,parsedResult.playlistParsingError,networkDetails,stats);return}let{contentSteering,levels,sessionData,sessionKeys,startTimeOffset,variableList}=parsedResult;this.variableList=variableList;let{AUDIO:audioTracks=[],SUBTITLES:subtitles,"CLOSED-CAPTIONS":captions}=M3U8Parser.parseMasterPlaylistMedia(string,url,parsedResult);audioTracks.length&&!audioTracks.some(audioTrack=>!audioTrack.url)&&levels[0].audioCodec&&!levels[0].attrs.AUDIO&&(logger.log("[playlist-loader]: audio codec signaled in quality level, but no embedded audio track signaled, create one"),audioTracks.unshift({type:"main",name:"main",groupId:"main",default:!1,autoselect:!1,forced:!1,id:-1,attrs:new AttrList({}),bitrate:0,url:""})),hls.trigger(Events1.MANIFEST_LOADED,{levels,audioTracks,subtitles,captions,contentSteering,url,stats,networkDetails,sessionData,sessionKeys,startTimeOffset,variableList})}handleTrackOrLevelPlaylist(response,stats,context,networkDetails,loader){let hls=this.hls,{id,level,type}=context,url=getResponseUrl(response,context),levelId=isFiniteNumber(level)?level:isFiniteNumber(id)?id:0,levelType=mapContextToLevelType(context),levelDetails=M3U8Parser.parseLevelPlaylist(response.data,url,levelId,levelType,0,this.variableList);if(type===PlaylistContextType.MANIFEST){let singleLevel={attrs:new AttrList({}),bitrate:0,details:levelDetails,name:"",url};hls.trigger(Events1.MANIFEST_LOADED,{levels:[singleLevel],audioTracks:[],url,stats,networkDetails,sessionData:null,sessionKeys:null,contentSteering:null,startTimeOffset:null,variableList:null})}stats.parsing.end=performance.now(),context.levelDetails=levelDetails,this.handlePlaylistLoaded(levelDetails,response,stats,context,networkDetails,loader)}handleManifestParsingError(response,context,error,networkDetails,stats){this.hls.trigger(Events1.ERROR,{type:ErrorTypes1.NETWORK_ERROR,details:ErrorDetails1.MANIFEST_PARSING_ERROR,fatal:context.type===PlaylistContextType.MANIFEST,url:response.url,err:error,error,reason:error.message,response,context,networkDetails,stats})}handleNetworkError(context,networkDetails,timeout=!1,response,stats){let message=`A network ${timeout?"timeout":"error"+(response?" (status "+response.code+")":"")} occurred while loading ${context.type}`;context.type===PlaylistContextType.LEVEL?message+=`: ${context.level} id: ${context.id}`:(context.type===PlaylistContextType.AUDIO_TRACK||context.type===PlaylistContextType.SUBTITLE_TRACK)&&(message+=` id: ${context.id} group-id: "${context.groupId}"`);let error=Error(message);logger.warn(`[playlist-loader]: ${message}`);let details=ErrorDetails1.UNKNOWN,fatal=!1,loader=this.getInternalLoader(context);switch(context.type){case PlaylistContextType.MANIFEST:details=timeout?ErrorDetails1.MANIFEST_LOAD_TIMEOUT:ErrorDetails1.MANIFEST_LOAD_ERROR,fatal=!0;break;case PlaylistContextType.LEVEL:details=timeout?ErrorDetails1.LEVEL_LOAD_TIMEOUT:ErrorDetails1.LEVEL_LOAD_ERROR,fatal=!1;break;case PlaylistContextType.AUDIO_TRACK:details=timeout?ErrorDetails1.AUDIO_TRACK_LOAD_TIMEOUT:ErrorDetails1.AUDIO_TRACK_LOAD_ERROR,fatal=!1;break;case PlaylistContextType.SUBTITLE_TRACK:details=timeout?ErrorDetails1.SUBTITLE_TRACK_LOAD_TIMEOUT:ErrorDetails1.SUBTITLE_LOAD_ERROR,fatal=!1}loader&&this.resetInternalLoader(context.type);let errorData={type:ErrorTypes1.NETWORK_ERROR,details,fatal,url:context.url,loader,context,error,networkDetails,stats};if(response){let url=(null==networkDetails?void 0:networkDetails.url)||context.url;errorData.response=_objectSpread2({url,data:void 0},response)}this.hls.trigger(Events1.ERROR,errorData)}handlePlaylistLoaded(levelDetails,response,stats,context,networkDetails,loader){let hls=this.hls,{type,level,id,groupId,deliveryDirectives}=context,url=getResponseUrl(response,context),parent=mapContextToLevelType(context),levelIndex="number"==typeof context.level&&parent===PlaylistLevelType.MAIN?level:void 0;if(!levelDetails.fragments.length){let _error=Error("No Segments found in Playlist");hls.trigger(Events1.ERROR,{type:ErrorTypes1.NETWORK_ERROR,details:ErrorDetails1.LEVEL_EMPTY_ERROR,fatal:!1,url,error:_error,reason:_error.message,response,context,level:levelIndex,parent,networkDetails,stats});return}levelDetails.targetduration||(levelDetails.playlistParsingError=Error("Missing Target Duration"));let error=levelDetails.playlistParsingError;if(error){hls.trigger(Events1.ERROR,{type:ErrorTypes1.NETWORK_ERROR,details:ErrorDetails1.LEVEL_PARSING_ERROR,fatal:!1,url,error,reason:error.message,response,context,level:levelIndex,parent,networkDetails,stats});return}switch(levelDetails.live&&loader&&(loader.getCacheAge&&(levelDetails.ageHeader=loader.getCacheAge()||0),(!loader.getCacheAge||isNaN(levelDetails.ageHeader))&&(levelDetails.ageHeader=0)),type){case PlaylistContextType.MANIFEST:case PlaylistContextType.LEVEL:hls.trigger(Events1.LEVEL_LOADED,{details:levelDetails,level:levelIndex||0,id:id||0,stats,networkDetails,deliveryDirectives});break;case PlaylistContextType.AUDIO_TRACK:hls.trigger(Events1.AUDIO_TRACK_LOADED,{details:levelDetails,id:id||0,groupId:groupId||"",stats,networkDetails,deliveryDirectives});break;case PlaylistContextType.SUBTITLE_TRACK:hls.trigger(Events1.SUBTITLE_TRACK_LOADED,{details:levelDetails,id:id||0,groupId:groupId||"",stats,networkDetails,deliveryDirectives})}}}function sendAddTrackEvent(track,videoEl){let event;try{event=new Event("addtrack")}catch(err){(event=document.createEvent("Event")).initEvent("addtrack",!1,!1)}event.track=track,videoEl.dispatchEvent(event)}function clearCurrentCues(track){let mode=track.mode;if("disabled"===mode&&(track.mode="hidden"),track.cues)for(let i=track.cues.length;i--;)track.removeCue(track.cues[i]);"disabled"===mode&&(track.mode=mode)}function removeCuesInRange(track,start,end,predicate){let mode=track.mode;if("disabled"===mode&&(track.mode="hidden"),track.cues&&track.cues.length>0){let cues=getCuesInRange(track.cues,start,end);for(let i=0;i<cues.length;i++)(!predicate||predicate(cues[i]))&&track.removeCue(cues[i])}"disabled"===mode&&(track.mode=mode)}function getFirstCueIndexAfterTime(cues,time){if(time<cues[0].startTime)return 0;let len=cues.length-1;if(time>cues[len].endTime)return -1;let left=0,right=len;for(;left<=right;){let mid=Math.floor((right+left)/2);if(time<cues[mid].startTime)right=mid-1;else{if(!(time>cues[mid].startTime)||!(left<len))return mid;left=mid+1}}return cues[left].startTime-time<time-cues[right].startTime?left:right}function getCuesInRange(cues,start,end){let cuesFound=[],firstCueInRange=getFirstCueIndexAfterTime(cues,start);if(firstCueInRange>-1)for(let i=firstCueInRange,len=cues.length;i<len;i++){let cue=cues[i];if(cue.startTime>=start&&cue.endTime<=end)cuesFound.push(cue);else if(cue.startTime>end)break}return cuesFound}var MetadataSchema={audioId3:"org.id3",dateRange:"com.apple.quicktime.HLS",emsg:"https://aomedia.org/emsg/ID3"};function getCueClass(){if("undefined"!=typeof self)return self.VTTCue||self.TextTrackCue}function createCueWithDataFields(Cue,startTime,endTime,data,type){let cue=new Cue(startTime,endTime,"");try{cue.value=data,type&&(cue.type=type)}catch(e){cue=new Cue(startTime,endTime,JSON.stringify(type?_objectSpread2({type},data):data))}return cue}let MAX_CUE_ENDTIME=(()=>{let Cue=getCueClass();try{Cue&&new Cue(0,Number.POSITIVE_INFINITY,"")}catch(e){return Number.MAX_VALUE}return Number.POSITIVE_INFINITY})();function dateRangeDateToTimelineSeconds(date,offset){return date.getTime()/1e3-offset}function hexToArrayBuffer(str){return Uint8Array.from(str.replace(/^0x/,"").replace(/([\da-fA-F]{2}) ?/g,"0x$1 ").replace(/ +$/,"").split(" ")).buffer}class ID3TrackController{constructor(hls){this.hls=void 0,this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=hls,this._registerListeners()}destroy(){this._unregisterListeners(),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={},this.hls=null}_registerListeners(){let{hls}=this;hls.on(Events1.MEDIA_ATTACHED,this.onMediaAttached,this),hls.on(Events1.MEDIA_DETACHING,this.onMediaDetaching,this),hls.on(Events1.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events1.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),hls.on(Events1.BUFFER_FLUSHING,this.onBufferFlushing,this),hls.on(Events1.LEVEL_UPDATED,this.onLevelUpdated,this)}_unregisterListeners(){let{hls}=this;hls.off(Events1.MEDIA_ATTACHED,this.onMediaAttached,this),hls.off(Events1.MEDIA_DETACHING,this.onMediaDetaching,this),hls.off(Events1.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events1.FRAG_PARSING_METADATA,this.onFragParsingMetadata,this),hls.off(Events1.BUFFER_FLUSHING,this.onBufferFlushing,this),hls.off(Events1.LEVEL_UPDATED,this.onLevelUpdated,this)}onMediaAttached(event,data){this.media=data.media}onMediaDetaching(){this.id3Track&&(clearCurrentCues(this.id3Track),this.id3Track=null,this.media=null,this.dateRangeCuesAppended={})}onManifestLoading(){this.dateRangeCuesAppended={}}createTrack(media){let track=this.getID3Track(media.textTracks);return track.mode="hidden",track}getID3Track(textTracks){if(this.media){for(let i=0;i<textTracks.length;i++){let textTrack=textTracks[i];if("metadata"===textTrack.kind&&"id3"===textTrack.label)return sendAddTrackEvent(textTrack,this.media),textTrack}return this.media.addTextTrack("metadata","id3")}}onFragParsingMetadata(event,data){if(!this.media)return;let{hls:{config:{enableEmsgMetadataCues,enableID3MetadataCues}}}=this;if(!enableEmsgMetadataCues&&!enableID3MetadataCues)return;let{samples}=data;this.id3Track||(this.id3Track=this.createTrack(this.media));let Cue=getCueClass();if(Cue)for(let i=0;i<samples.length;i++){let type=samples[i].type;if(type===MetadataSchema.emsg&&!enableEmsgMetadataCues||!enableID3MetadataCues)continue;let frames=getID3Frames(samples[i].data);if(frames){let startTime=samples[i].pts,endTime=startTime+samples[i].duration;endTime>MAX_CUE_ENDTIME&&(endTime=MAX_CUE_ENDTIME),endTime-startTime<=0&&(endTime=startTime+.25);for(let j=0;j<frames.length;j++){let frame=frames[j];if(!isTimeStampFrame(frame)){this.updateId3CueEnds(startTime,type);let cue=createCueWithDataFields(Cue,startTime,endTime,frame,type);cue&&this.id3Track.addCue(cue)}}}}}updateId3CueEnds(startTime,type){var _this$id3Track;let cues=null==(_this$id3Track=this.id3Track)?void 0:_this$id3Track.cues;if(cues)for(let i=cues.length;i--;){let cue=cues[i];cue.type===type&&cue.startTime<startTime&&cue.endTime===MAX_CUE_ENDTIME&&(cue.endTime=startTime)}}onBufferFlushing(event,{startOffset,endOffset,type}){let{id3Track,hls}=this;if(!hls)return;let{config:{enableEmsgMetadataCues,enableID3MetadataCues}}=hls;id3Track&&(enableEmsgMetadataCues||enableID3MetadataCues)&&removeCuesInRange(id3Track,startOffset,endOffset,"audio"===type?cue=>cue.type===MetadataSchema.audioId3&&enableID3MetadataCues:"video"===type?cue=>cue.type===MetadataSchema.emsg&&enableEmsgMetadataCues:cue=>cue.type===MetadataSchema.audioId3&&enableID3MetadataCues||cue.type===MetadataSchema.emsg&&enableEmsgMetadataCues)}onLevelUpdated(event,{details}){if(!this.media||!details.hasProgramDateTime||!this.hls.config.enableDateRangeMetadataCues)return;let{dateRangeCuesAppended,id3Track}=this,{dateRanges}=details,ids=Object.keys(dateRanges);if(id3Track){let idsToRemove=Object.keys(dateRangeCuesAppended).filter(id=>!ids.includes(id));for(let i=idsToRemove.length;i--;){let id=idsToRemove[i];Object.keys(dateRangeCuesAppended[id].cues).forEach(key=>{id3Track.removeCue(dateRangeCuesAppended[id].cues[key])}),delete dateRangeCuesAppended[id]}}let lastFragment=details.fragments[details.fragments.length-1];if(0===ids.length||!isFiniteNumber(null==lastFragment?void 0:lastFragment.programDateTime))return;this.id3Track||(this.id3Track=this.createTrack(this.media));let dateTimeOffset=lastFragment.programDateTime/1e3-lastFragment.start,Cue=getCueClass();for(let i=0;i<ids.length;i++){let id=ids[i],dateRange=dateRanges[id],startTime=dateRangeDateToTimelineSeconds(dateRange.startDate,dateTimeOffset),appendedDateRangeCues=dateRangeCuesAppended[id],cues=(null==appendedDateRangeCues?void 0:appendedDateRangeCues.cues)||{},durationKnown=(null==appendedDateRangeCues?void 0:appendedDateRangeCues.durationKnown)||!1,endTime=MAX_CUE_ENDTIME,endDate=dateRange.endDate;if(endDate)endTime=dateRangeDateToTimelineSeconds(endDate,dateTimeOffset),durationKnown=!0;else if(dateRange.endOnNext&&!durationKnown){let nextDateRangeWithSameClass=ids.reduce((candidateDateRange,id)=>{if(id!==dateRange.id){let otherDateRange=dateRanges[id];if(otherDateRange.class===dateRange.class&&otherDateRange.startDate>dateRange.startDate&&(!candidateDateRange||dateRange.startDate<candidateDateRange.startDate))return otherDateRange}return candidateDateRange},null);nextDateRangeWithSameClass&&(endTime=dateRangeDateToTimelineSeconds(nextDateRangeWithSameClass.startDate,dateTimeOffset),durationKnown=!0)}let attributes=Object.keys(dateRange.attr);for(let j=0;j<attributes.length;j++){let key=attributes[j];if(!isDateRangeCueAttribute(key))continue;let cue=cues[key];if(cue)durationKnown&&!appendedDateRangeCues.durationKnown&&(cue.endTime=endTime);else if(Cue){let data=dateRange.attr[key];isSCTE35Attribute(key)&&(data=hexToArrayBuffer(data));let _cue=createCueWithDataFields(Cue,startTime,endTime,{key,data},MetadataSchema.dateRange);_cue&&(_cue.id=id,this.id3Track.addCue(_cue),cues[key]=_cue)}}dateRangeCuesAppended[id]={cues,dateRange,durationKnown}}}}class LatencyController{constructor(hls){this.hls=void 0,this.config=void 0,this.media=null,this.levelDetails=null,this.currentTime=0,this.stallCount=0,this._latency=null,this.timeupdateHandler=()=>this.timeupdate(),this.hls=hls,this.config=hls.config,this.registerListeners()}get latency(){return this._latency||0}get maxLatency(){let{config,levelDetails}=this;return void 0!==config.liveMaxLatencyDuration?config.liveMaxLatencyDuration:levelDetails?config.liveMaxLatencyDurationCount*levelDetails.targetduration:0}get targetLatency(){let{levelDetails}=this;if(null===levelDetails)return null;let{holdBack,partHoldBack,targetduration}=levelDetails,{liveSyncDuration,liveSyncDurationCount,lowLatencyMode}=this.config,userConfig=this.hls.userConfig,targetLatency=lowLatencyMode&&partHoldBack||holdBack;return(userConfig.liveSyncDuration||userConfig.liveSyncDurationCount||0===targetLatency)&&(targetLatency=void 0!==liveSyncDuration?liveSyncDuration:liveSyncDurationCount*targetduration),targetLatency+Math.min(1*this.stallCount,targetduration)}get liveSyncPosition(){let liveEdge=this.estimateLiveEdge(),targetLatency=this.targetLatency,levelDetails=this.levelDetails;if(null===liveEdge||null===targetLatency||null===levelDetails)return null;let edge=levelDetails.edge,syncPosition=liveEdge-targetLatency-this.edgeStalled;return Math.min(Math.max(edge-levelDetails.totalduration,syncPosition),edge-(this.config.lowLatencyMode&&levelDetails.partTarget||levelDetails.targetduration))}get drift(){let{levelDetails}=this;return null===levelDetails?1:levelDetails.drift}get edgeStalled(){let{levelDetails}=this;if(null===levelDetails)return 0;let maxLevelUpdateAge=3*(this.config.lowLatencyMode&&levelDetails.partTarget||levelDetails.targetduration);return Math.max(levelDetails.age-maxLevelUpdateAge,0)}get forwardBufferLength(){let{media,levelDetails}=this;if(!media||!levelDetails)return 0;let bufferedRanges=media.buffered.length;return(bufferedRanges?media.buffered.end(bufferedRanges-1):levelDetails.edge)-this.currentTime}destroy(){this.unregisterListeners(),this.onMediaDetaching(),this.levelDetails=null,this.hls=this.timeupdateHandler=null}registerListeners(){this.hls.on(Events1.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.on(Events1.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.on(Events1.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.on(Events1.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.on(Events1.ERROR,this.onError,this)}unregisterListeners(){this.hls.off(Events1.MEDIA_ATTACHED,this.onMediaAttached,this),this.hls.off(Events1.MEDIA_DETACHING,this.onMediaDetaching,this),this.hls.off(Events1.MANIFEST_LOADING,this.onManifestLoading,this),this.hls.off(Events1.LEVEL_UPDATED,this.onLevelUpdated,this),this.hls.off(Events1.ERROR,this.onError,this)}onMediaAttached(event,data){this.media=data.media,this.media.addEventListener("timeupdate",this.timeupdateHandler)}onMediaDetaching(){this.media&&(this.media.removeEventListener("timeupdate",this.timeupdateHandler),this.media=null)}onManifestLoading(){this.levelDetails=null,this._latency=null,this.stallCount=0}onLevelUpdated(event,{details}){this.levelDetails=details,details.advanced&&this.timeupdate(),!details.live&&this.media&&this.media.removeEventListener("timeupdate",this.timeupdateHandler)}onError(event,data){var _this$levelDetails;data.details===ErrorDetails1.BUFFER_STALLED_ERROR&&(this.stallCount++,null!=(_this$levelDetails=this.levelDetails)&&_this$levelDetails.live&&logger.warn("[playback-rate-controller]: Stall detected, adjusting target latency"))}timeupdate(){let{media,levelDetails}=this;if(!media||!levelDetails)return;this.currentTime=media.currentTime;let latency=this.computeLatency();if(null===latency)return;this._latency=latency;let{lowLatencyMode,maxLiveSyncPlaybackRate}=this.config;if(!lowLatencyMode||1===maxLiveSyncPlaybackRate||!levelDetails.live)return;let targetLatency=this.targetLatency;if(null===targetLatency)return;let distanceFromTarget=latency-targetLatency;if(distanceFromTarget<Math.min(this.maxLatency,targetLatency+levelDetails.targetduration)&&distanceFromTarget>.05&&this.forwardBufferLength>1){let rate=Math.round(2/(1+Math.exp(-.75*distanceFromTarget-this.edgeStalled))*20)/20;media.playbackRate=Math.min(Math.min(2,Math.max(1,maxLiveSyncPlaybackRate)),Math.max(1,rate))}else 1!==media.playbackRate&&0!==media.playbackRate&&(media.playbackRate=1)}estimateLiveEdge(){let{levelDetails}=this;return null===levelDetails?null:levelDetails.edge+levelDetails.age}computeLatency(){let liveEdge=this.estimateLiveEdge();return null===liveEdge?null:liveEdge-this.currentTime}}let HdcpLevels=["NONE","TYPE-0","TYPE-1",null];function isHdcpLevel(value){return HdcpLevels.indexOf(value)>-1}let VideoRangeValues=["SDR","PQ","HLG"];function isVideoRange(value){return!!value&&VideoRangeValues.indexOf(value)>-1}var HlsSkip={No:"",Yes:"YES",v2:"v2"};function getSkipValue(details){let{canSkipUntil,canSkipDateRanges,age}=details;return canSkipUntil&&age<canSkipUntil/2?canSkipDateRanges?HlsSkip.v2:HlsSkip.Yes:HlsSkip.No}class HlsUrlParameters{constructor(msn,part,skip){this.msn=void 0,this.part=void 0,this.skip=void 0,this.msn=msn,this.part=part,this.skip=skip}addDirectives(uri){let url=new self.URL(uri);return void 0!==this.msn&&url.searchParams.set("_HLS_msn",this.msn.toString()),void 0!==this.part&&url.searchParams.set("_HLS_part",this.part.toString()),this.skip&&url.searchParams.set("_HLS_skip",this.skip),url.href}}class Level{constructor(data){this._attrs=void 0,this.audioCodec=void 0,this.bitrate=void 0,this.codecSet=void 0,this.url=void 0,this.frameRate=void 0,this.height=void 0,this.id=void 0,this.name=void 0,this.videoCodec=void 0,this.width=void 0,this.details=void 0,this.fragmentError=0,this.loadError=0,this.loaded=void 0,this.realBitrate=0,this.supportedPromise=void 0,this.supportedResult=void 0,this._avgBitrate=0,this._audioGroups=void 0,this._subtitleGroups=void 0,this._urlId=0,this.url=[data.url],this._attrs=[data.attrs],this.bitrate=data.bitrate,data.details&&(this.details=data.details),this.id=data.id||0,this.name=data.name,this.width=data.width||0,this.height=data.height||0,this.frameRate=data.attrs.optionalFloat("FRAME-RATE",0),this._avgBitrate=data.attrs.decimalInteger("AVERAGE-BANDWIDTH"),this.audioCodec=data.audioCodec,this.videoCodec=data.videoCodec,this.codecSet=[data.videoCodec,data.audioCodec].filter(c=>!!c).map(s=>s.substring(0,4)).join(","),this.addGroupId("audio",data.attrs.AUDIO),this.addGroupId("text",data.attrs.SUBTITLES)}get maxBitrate(){return Math.max(this.realBitrate,this.bitrate)}get averageBitrate(){return this._avgBitrate||this.realBitrate||this.bitrate}get attrs(){return this._attrs[0]}get codecs(){return this.attrs.CODECS||""}get pathwayId(){return this.attrs["PATHWAY-ID"]||"."}get videoRange(){return this.attrs["VIDEO-RANGE"]||"SDR"}get score(){return this.attrs.optionalFloat("SCORE",0)}get uri(){return this.url[0]||""}hasAudioGroup(groupId){return hasGroup(this._audioGroups,groupId)}hasSubtitleGroup(groupId){return hasGroup(this._subtitleGroups,groupId)}get audioGroups(){return this._audioGroups}get subtitleGroups(){return this._subtitleGroups}addGroupId(type,groupId){if(groupId){if("audio"===type){let audioGroups=this._audioGroups;audioGroups||(audioGroups=this._audioGroups=[]),-1===audioGroups.indexOf(groupId)&&audioGroups.push(groupId)}else if("text"===type){let subtitleGroups=this._subtitleGroups;subtitleGroups||(subtitleGroups=this._subtitleGroups=[]),-1===subtitleGroups.indexOf(groupId)&&subtitleGroups.push(groupId)}}}get urlId(){return 0}set urlId(value){}get audioGroupIds(){return this.audioGroups?[this.audioGroupId]:void 0}get textGroupIds(){return this.subtitleGroups?[this.textGroupId]:void 0}get audioGroupId(){var _this$audioGroups;return null==(_this$audioGroups=this.audioGroups)?void 0:_this$audioGroups[0]}get textGroupId(){var _this$subtitleGroups;return null==(_this$subtitleGroups=this.subtitleGroups)?void 0:_this$subtitleGroups[0]}addFallback(){}}function hasGroup(groups,groupId){return!!groupId&&!!groups&&-1!==groups.indexOf(groupId)}function updateFromToPTS(fragFrom,fragTo){let fragToPTS=fragTo.startPTS;if(isFiniteNumber(fragToPTS)){let frag,duration=0;fragTo.sn>fragFrom.sn?(duration=fragToPTS-fragFrom.start,frag=fragFrom):(duration=fragFrom.start-fragToPTS,frag=fragTo),frag.duration!==duration&&(frag.duration=duration)}else fragTo.sn>fragFrom.sn?fragFrom.cc===fragTo.cc&&fragFrom.minEndPTS?fragTo.start=fragFrom.start+(fragFrom.minEndPTS-fragFrom.start):fragTo.start=fragFrom.start+fragFrom.duration:fragTo.start=Math.max(fragFrom.start-fragTo.duration,0)}function updateFragPTSDTS(details,frag,startPTS,endPTS,startDTS,endDTS){let i;endPTS-startPTS<=0&&(logger.warn("Fragment should have a positive duration",frag),endPTS=startPTS+frag.duration,endDTS=startDTS+frag.duration);let maxStartPTS=startPTS,minEndPTS=endPTS,fragStartPts=frag.startPTS,fragEndPts=frag.endPTS;if(isFiniteNumber(fragStartPts)){let deltaPTS=Math.abs(fragStartPts-startPTS);isFiniteNumber(frag.deltaPTS)?frag.deltaPTS=Math.max(deltaPTS,frag.deltaPTS):frag.deltaPTS=deltaPTS,maxStartPTS=Math.max(startPTS,fragStartPts),startPTS=Math.min(startPTS,fragStartPts),startDTS=Math.min(startDTS,frag.startDTS),minEndPTS=Math.min(endPTS,fragEndPts),endPTS=Math.max(endPTS,fragEndPts),endDTS=Math.max(endDTS,frag.endDTS)}let drift=startPTS-frag.start;0!==frag.start&&(frag.start=startPTS),frag.duration=endPTS-frag.start,frag.startPTS=startPTS,frag.maxStartPTS=maxStartPTS,frag.startDTS=startDTS,frag.endPTS=endPTS,frag.minEndPTS=minEndPTS,frag.endDTS=endDTS;let sn=frag.sn;if(!details||sn<details.startSN||sn>details.endSN)return 0;let fragIdx=sn-details.startSN,fragments=details.fragments;for(fragments[fragIdx]=frag,i=fragIdx;i>0;i--)updateFromToPTS(fragments[i],fragments[i-1]);for(i=fragIdx;i<fragments.length-1;i++)updateFromToPTS(fragments[i],fragments[i+1]);return details.fragmentHint&&updateFromToPTS(fragments[fragments.length-1],details.fragmentHint),details.PTSKnown=details.alignedSliding=!0,drift}function mergeDetails(oldDetails,newDetails){let PTSFrag,currentInitSegment=null,oldFragments=oldDetails.fragments;for(let i=oldFragments.length-1;i>=0;i--){let oldInit=oldFragments[i].initSegment;if(oldInit){currentInitSegment=oldInit;break}}oldDetails.fragmentHint&&delete oldDetails.fragmentHint.endPTS;let ccOffset=0;if(mapFragmentIntersection(oldDetails,newDetails,(oldFrag,newFrag)=>{oldFrag.relurl&&(ccOffset=oldFrag.cc-newFrag.cc),isFiniteNumber(oldFrag.startPTS)&&isFiniteNumber(oldFrag.endPTS)&&(newFrag.start=newFrag.startPTS=oldFrag.startPTS,newFrag.startDTS=oldFrag.startDTS,newFrag.maxStartPTS=oldFrag.maxStartPTS,newFrag.endPTS=oldFrag.endPTS,newFrag.endDTS=oldFrag.endDTS,newFrag.minEndPTS=oldFrag.minEndPTS,newFrag.duration=oldFrag.endPTS-oldFrag.startPTS,newFrag.duration&&(PTSFrag=newFrag),newDetails.PTSKnown=newDetails.alignedSliding=!0),newFrag.elementaryStreams=oldFrag.elementaryStreams,newFrag.loader=oldFrag.loader,newFrag.stats=oldFrag.stats,oldFrag.initSegment&&(newFrag.initSegment=oldFrag.initSegment,currentInitSegment=oldFrag.initSegment)}),currentInitSegment&&(newDetails.fragmentHint?newDetails.fragments.concat(newDetails.fragmentHint):newDetails.fragments).forEach(frag=>{var _currentInitSegment;frag&&(!frag.initSegment||frag.initSegment.relurl===(null==(_currentInitSegment=currentInitSegment)?void 0:_currentInitSegment.relurl))&&(frag.initSegment=currentInitSegment)}),newDetails.skippedSegments){if(newDetails.deltaUpdateFailed=newDetails.fragments.some(frag=>!frag),newDetails.deltaUpdateFailed){logger.warn("[level-helper] Previous playlist missing segments skipped in delta playlist");for(let i=newDetails.skippedSegments;i--;)newDetails.fragments.shift();newDetails.startSN=newDetails.fragments[0].sn,newDetails.startCC=newDetails.fragments[0].cc}else newDetails.canSkipDateRanges&&(newDetails.dateRanges=mergeDateRanges(oldDetails.dateRanges,newDetails.dateRanges,newDetails.recentlyRemovedDateranges))}let newFragments=newDetails.fragments;if(ccOffset){logger.warn("discontinuity sliding from playlist, take drift into account");for(let i=0;i<newFragments.length;i++)newFragments[i].cc+=ccOffset}newDetails.skippedSegments&&(newDetails.startCC=newDetails.fragments[0].cc),mapPartIntersection(oldDetails.partList,newDetails.partList,(oldPart,newPart)=>{newPart.elementaryStreams=oldPart.elementaryStreams,newPart.stats=oldPart.stats}),PTSFrag?updateFragPTSDTS(newDetails,PTSFrag,PTSFrag.startPTS,PTSFrag.endPTS,PTSFrag.startDTS,PTSFrag.endDTS):adjustSliding(oldDetails,newDetails),newFragments.length&&(newDetails.totalduration=newDetails.edge-newFragments[0].start),newDetails.driftStartTime=oldDetails.driftStartTime,newDetails.driftStart=oldDetails.driftStart;let advancedDateTime=newDetails.advancedDateTime;if(newDetails.advanced&&advancedDateTime){let edge=newDetails.edge;newDetails.driftStart||(newDetails.driftStartTime=advancedDateTime,newDetails.driftStart=edge),newDetails.driftEndTime=advancedDateTime,newDetails.driftEnd=edge}else newDetails.driftEndTime=oldDetails.driftEndTime,newDetails.driftEnd=oldDetails.driftEnd,newDetails.advancedDateTime=oldDetails.advancedDateTime}function mergeDateRanges(oldDateRanges,deltaDateRanges,recentlyRemovedDateranges){let dateRanges=_extends({},oldDateRanges);return recentlyRemovedDateranges&&recentlyRemovedDateranges.forEach(id=>{delete dateRanges[id]}),Object.keys(deltaDateRanges).forEach(id=>{let dateRange=new DateRange(deltaDateRanges[id].attr,dateRanges[id]);dateRange.isValid?dateRanges[id]=dateRange:logger.warn(`Ignoring invalid Playlist Delta Update DATERANGE tag: "${JSON.stringify(deltaDateRanges[id].attr)}"`)}),dateRanges}function mapPartIntersection(oldParts,newParts,intersectionFn){if(oldParts&&newParts){let delta=0;for(let i=0,len=oldParts.length;i<=len;i++){let oldPart=oldParts[i],newPart=newParts[i+delta];oldPart&&newPart&&oldPart.index===newPart.index&&oldPart.fragment.sn===newPart.fragment.sn?intersectionFn(oldPart,newPart):delta--}}}function mapFragmentIntersection(oldDetails,newDetails,intersectionFn){let skippedSegments=newDetails.skippedSegments,start=Math.max(oldDetails.startSN,newDetails.startSN)-newDetails.startSN,end=(oldDetails.fragmentHint?1:0)+(skippedSegments?newDetails.endSN:Math.min(oldDetails.endSN,newDetails.endSN))-newDetails.startSN,delta=newDetails.startSN-oldDetails.startSN,newFrags=newDetails.fragmentHint?newDetails.fragments.concat(newDetails.fragmentHint):newDetails.fragments,oldFrags=oldDetails.fragmentHint?oldDetails.fragments.concat(oldDetails.fragmentHint):oldDetails.fragments;for(let i=start;i<=end;i++){let oldFrag=oldFrags[delta+i],newFrag=newFrags[i];skippedSegments&&!newFrag&&i<skippedSegments&&(newFrag=newDetails.fragments[i]=oldFrag),oldFrag&&newFrag&&intersectionFn(oldFrag,newFrag)}}function adjustSliding(oldDetails,newDetails){let delta=newDetails.startSN+newDetails.skippedSegments-oldDetails.startSN,oldFragments=oldDetails.fragments;delta<0||delta>=oldFragments.length||addSliding(newDetails,oldFragments[delta].start)}function addSliding(details,start){if(start){let fragments=details.fragments;for(let i=details.skippedSegments;i<fragments.length;i++)fragments[i].start+=start;details.fragmentHint&&(details.fragmentHint.start+=start)}}function computeReloadInterval(newDetails,distanceToLiveEdgeMs=1/0){let reloadInterval=1e3*newDetails.targetduration;if(newDetails.updated){let fragments=newDetails.fragments;if(fragments.length&&4*reloadInterval>distanceToLiveEdgeMs){let lastSegmentDuration=1e3*fragments[fragments.length-1].duration;lastSegmentDuration<reloadInterval&&(reloadInterval=lastSegmentDuration)}}else reloadInterval/=2;return Math.round(reloadInterval)}function getFragmentWithSN(level,sn,fragCurrent){if(!(null!=level&&level.details))return null;let levelDetails=level.details,fragment=levelDetails.fragments[sn-levelDetails.startSN];return fragment||(fragment=levelDetails.fragmentHint)&&fragment.sn===sn?fragment:sn<levelDetails.startSN&&fragCurrent&&fragCurrent.sn===sn?fragCurrent:null}function getPartWith(level,sn,partIndex){var _level$details;return null!=level&&level.details?findPart(null==(_level$details=level.details)?void 0:_level$details.partList,sn,partIndex):null}function findPart(partList,sn,partIndex){if(partList)for(let i=partList.length;i--;){let part=partList[i];if(part.index===partIndex&&part.fragment.sn===sn)return part}return null}function reassignFragmentLevelIndexes(levels){levels.forEach((level,index)=>{let{details}=level;null!=details&&details.fragments&&details.fragments.forEach(fragment=>{fragment.level=index})})}function isTimeoutError(error){switch(error.details){case ErrorDetails1.FRAG_LOAD_TIMEOUT:case ErrorDetails1.KEY_LOAD_TIMEOUT:case ErrorDetails1.LEVEL_LOAD_TIMEOUT:case ErrorDetails1.MANIFEST_LOAD_TIMEOUT:return!0}return!1}function getRetryConfig(loadPolicy,error){let isTimeout=isTimeoutError(error);return loadPolicy.default[`${isTimeout?"timeout":"error"}Retry`]}function getRetryDelay(retryConfig,retryCount){return Math.min(("linear"===retryConfig.backoff?1:Math.pow(2,retryCount))*retryConfig.retryDelayMs,retryConfig.maxRetryDelayMs)}function getLoaderConfigWithoutReties(loderConfig){return _objectSpread2(_objectSpread2({},loderConfig),{errorRetry:null,timeoutRetry:null})}function shouldRetry(retryConfig,retryCount,isTimeout,loaderResponse){if(!retryConfig)return!1;let httpStatus=null==loaderResponse?void 0:loaderResponse.code,retry=retryCount<retryConfig.maxNumRetry&&(retryForHttpStatus(httpStatus)||!!isTimeout);return retryConfig.shouldRetry?retryConfig.shouldRetry(retryConfig,retryCount,isTimeout,loaderResponse,retry):retry}function retryForHttpStatus(httpStatus){return 0===httpStatus&&!1===navigator.onLine||!!httpStatus&&(httpStatus<400||httpStatus>499)}let BinarySearch={search:function(list,comparisonFn){let minIndex=0,maxIndex=list.length-1,currentIndex=null,currentElement=null;for(;minIndex<=maxIndex;){let comparisonResult=comparisonFn(currentElement=list[currentIndex=(minIndex+maxIndex)/2|0]);if(comparisonResult>0)minIndex=currentIndex+1;else{if(!(comparisonResult<0))return currentElement;maxIndex=currentIndex-1}}return null}};function findFragmentByPDT(fragments,PDTValue,maxFragLookUpTolerance){if(null===PDTValue||!Array.isArray(fragments)||!fragments.length||!isFiniteNumber(PDTValue)||PDTValue<(fragments[0].programDateTime||0)||PDTValue>=(fragments[fragments.length-1].endProgramDateTime||0))return null;maxFragLookUpTolerance=maxFragLookUpTolerance||0;for(let seg=0;seg<fragments.length;++seg){let frag=fragments[seg];if(pdtWithinToleranceTest(PDTValue,maxFragLookUpTolerance,frag))return frag}return null}function findFragmentByPTS(fragPrevious,fragments,bufferEnd=0,maxFragLookUpTolerance=0,nextFragLookupTolerance=.005){let fragNext=null;if(fragPrevious){fragNext=fragments[fragPrevious.sn-fragments[0].sn+1]||null;let bufferEdgeError=fragPrevious.endDTS-bufferEnd;bufferEdgeError>0&&bufferEdgeError<15e-7&&(bufferEnd+=15e-7)}else 0===bufferEnd&&0===fragments[0].start&&(fragNext=fragments[0]);if(fragNext&&((!fragPrevious||fragPrevious.level===fragNext.level)&&0===fragmentWithinToleranceTest(bufferEnd,maxFragLookUpTolerance,fragNext)||fragmentWithinFastStartSwitch(fragNext,fragPrevious,Math.min(nextFragLookupTolerance,maxFragLookUpTolerance))))return fragNext;let foundFragment=BinarySearch.search(fragments,fragmentWithinToleranceTest.bind(null,bufferEnd,maxFragLookUpTolerance));return foundFragment&&(foundFragment!==fragPrevious||!fragNext)?foundFragment:fragNext}function fragmentWithinFastStartSwitch(fragNext,fragPrevious,nextFragLookupTolerance){if(fragPrevious&&0===fragPrevious.start&&fragPrevious.level<fragNext.level&&(fragPrevious.endPTS||0)>0){let firstDuration=fragPrevious.tagList.reduce((duration,tag)=>("INF"===tag[0]&&(duration+=parseFloat(tag[1])),duration),nextFragLookupTolerance);return fragNext.start<=firstDuration}return!1}function fragmentWithinToleranceTest(bufferEnd=0,maxFragLookUpTolerance=0,candidate){if(candidate.start<=bufferEnd&&candidate.start+candidate.duration>bufferEnd)return 0;let candidateLookupTolerance=Math.min(maxFragLookUpTolerance,candidate.duration+(candidate.deltaPTS?candidate.deltaPTS:0));return candidate.start+candidate.duration-candidateLookupTolerance<=bufferEnd?1:candidate.start-candidateLookupTolerance>bufferEnd&&candidate.start?-1:0}function pdtWithinToleranceTest(pdtBufferEnd,maxFragLookUpTolerance,candidate){let candidateLookupTolerance=1e3*Math.min(maxFragLookUpTolerance,candidate.duration+(candidate.deltaPTS?candidate.deltaPTS:0));return(candidate.endProgramDateTime||0)-candidateLookupTolerance>pdtBufferEnd}function findFragWithCC(fragments,cc){return BinarySearch.search(fragments,candidate=>candidate.cc<cc?1:candidate.cc>cc?-1:0)}var NetworkErrorAction={DoNothing:0,SendEndCallback:1,SendAlternateToPenaltyBox:2,RemoveAlternatePermanently:3,InsertDiscontinuity:4,RetryRequest:5},ErrorActionFlags={None:0,MoveAllAlternatesMatchingHost:1,MoveAllAlternatesMatchingHDCP:2,SwitchToSDR:4};class ErrorController{constructor(hls){this.hls=void 0,this.playlistError=0,this.penalizedRenditions={},this.log=void 0,this.warn=void 0,this.error=void 0,this.hls=hls,this.log=logger.log.bind(logger,"[info]:"),this.warn=logger.warn.bind(logger,"[warning]:"),this.error=logger.error.bind(logger,"[error]:"),this.registerListeners()}registerListeners(){let hls=this.hls;hls.on(Events1.ERROR,this.onError,this),hls.on(Events1.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events1.LEVEL_UPDATED,this.onLevelUpdated,this)}unregisterListeners(){let hls=this.hls;hls&&(hls.off(Events1.ERROR,this.onError,this),hls.off(Events1.ERROR,this.onErrorOut,this),hls.off(Events1.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events1.LEVEL_UPDATED,this.onLevelUpdated,this))}destroy(){this.unregisterListeners(),this.hls=null,this.penalizedRenditions={}}startLoad(startPosition){}stopLoad(){this.playlistError=0}getVariantLevelIndex(frag){return(null==frag?void 0:frag.type)===PlaylistLevelType.MAIN?frag.level:this.hls.loadLevel}onManifestLoading(){this.playlistError=0,this.penalizedRenditions={}}onLevelUpdated(){this.playlistError=0}onError(event,data){var _data$frag,_data$level,_data$context,_data$context$levelDe;if(data.fatal)return;let hls=this.hls,context=data.context;switch(data.details){case ErrorDetails1.FRAG_LOAD_ERROR:case ErrorDetails1.FRAG_LOAD_TIMEOUT:case ErrorDetails1.KEY_LOAD_ERROR:case ErrorDetails1.KEY_LOAD_TIMEOUT:data.errorAction=this.getFragRetryOrSwitchAction(data);return;case ErrorDetails1.FRAG_PARSING_ERROR:if(null!=(_data$frag=data.frag)&&_data$frag.gap){data.errorAction={action:NetworkErrorAction.DoNothing,flags:ErrorActionFlags.None};return}case ErrorDetails1.FRAG_GAP:case ErrorDetails1.FRAG_DECRYPT_ERROR:data.errorAction=this.getFragRetryOrSwitchAction(data),data.errorAction.action=NetworkErrorAction.SendAlternateToPenaltyBox;return;case ErrorDetails1.LEVEL_EMPTY_ERROR:case ErrorDetails1.LEVEL_PARSING_ERROR:{let levelIndex=data.parent===PlaylistLevelType.MAIN?data.level:hls.loadLevel;data.details===ErrorDetails1.LEVEL_EMPTY_ERROR&&null!=(_data$context=data.context)&&null!=(_data$context$levelDe=_data$context.levelDetails)&&_data$context$levelDe.live?data.errorAction=this.getPlaylistRetryOrSwitchAction(data,levelIndex):(data.levelRetry=!1,data.errorAction=this.getLevelSwitchAction(data,levelIndex))}return;case ErrorDetails1.LEVEL_LOAD_ERROR:case ErrorDetails1.LEVEL_LOAD_TIMEOUT:"number"==typeof(null==context?void 0:context.level)&&(data.errorAction=this.getPlaylistRetryOrSwitchAction(data,context.level));return;case ErrorDetails1.AUDIO_TRACK_LOAD_ERROR:case ErrorDetails1.AUDIO_TRACK_LOAD_TIMEOUT:case ErrorDetails1.SUBTITLE_LOAD_ERROR:case ErrorDetails1.SUBTITLE_TRACK_LOAD_TIMEOUT:if(context){let level=hls.levels[hls.loadLevel];level&&(context.type===PlaylistContextType.AUDIO_TRACK&&level.hasAudioGroup(context.groupId)||context.type===PlaylistContextType.SUBTITLE_TRACK&&level.hasSubtitleGroup(context.groupId))&&(data.errorAction=this.getPlaylistRetryOrSwitchAction(data,hls.loadLevel),data.errorAction.action=NetworkErrorAction.SendAlternateToPenaltyBox,data.errorAction.flags=ErrorActionFlags.MoveAllAlternatesMatchingHost)}return;case ErrorDetails1.KEY_SYSTEM_STATUS_OUTPUT_RESTRICTED:{let level=hls.levels[hls.loadLevel],restrictedHdcpLevel=null==level?void 0:level.attrs["HDCP-LEVEL"];restrictedHdcpLevel?data.errorAction={action:NetworkErrorAction.SendAlternateToPenaltyBox,flags:ErrorActionFlags.MoveAllAlternatesMatchingHDCP,hdcpLevel:restrictedHdcpLevel}:this.keySystemError(data)}return;case ErrorDetails1.BUFFER_ADD_CODEC_ERROR:case ErrorDetails1.REMUX_ALLOC_ERROR:case ErrorDetails1.BUFFER_APPEND_ERROR:data.errorAction=this.getLevelSwitchAction(data,null!=(_data$level=data.level)?_data$level:hls.loadLevel);return;case ErrorDetails1.INTERNAL_EXCEPTION:case ErrorDetails1.BUFFER_APPENDING_ERROR:case ErrorDetails1.BUFFER_FULL_ERROR:case ErrorDetails1.LEVEL_SWITCH_ERROR:case ErrorDetails1.BUFFER_STALLED_ERROR:case ErrorDetails1.BUFFER_SEEK_OVER_HOLE:case ErrorDetails1.BUFFER_NUDGE_ON_STALL:data.errorAction={action:NetworkErrorAction.DoNothing,flags:ErrorActionFlags.None};return}data.type===ErrorTypes1.KEY_SYSTEM_ERROR&&this.keySystemError(data)}keySystemError(data){let levelIndex=this.getVariantLevelIndex(data.frag);data.levelRetry=!1,data.errorAction=this.getLevelSwitchAction(data,levelIndex)}getPlaylistRetryOrSwitchAction(data,levelIndex){let retryConfig=getRetryConfig(this.hls.config.playlistLoadPolicy,data),retryCount=this.playlistError++;if(shouldRetry(retryConfig,retryCount,isTimeoutError(data),data.response))return{action:NetworkErrorAction.RetryRequest,flags:ErrorActionFlags.None,retryConfig,retryCount};let errorAction=this.getLevelSwitchAction(data,levelIndex);return retryConfig&&(errorAction.retryConfig=retryConfig,errorAction.retryCount=retryCount),errorAction}getFragRetryOrSwitchAction(data){let hls=this.hls,variantLevelIndex=this.getVariantLevelIndex(data.frag),level=hls.levels[variantLevelIndex],{fragLoadPolicy,keyLoadPolicy}=hls.config,retryConfig=getRetryConfig(data.details.startsWith("key")?keyLoadPolicy:fragLoadPolicy,data),fragmentErrors=hls.levels.reduce((acc,level)=>acc+level.fragmentError,0);if(level&&(data.details!==ErrorDetails1.FRAG_GAP&&level.fragmentError++,shouldRetry(retryConfig,fragmentErrors,isTimeoutError(data),data.response)))return{action:NetworkErrorAction.RetryRequest,flags:ErrorActionFlags.None,retryConfig,retryCount:fragmentErrors};let errorAction=this.getLevelSwitchAction(data,variantLevelIndex);return retryConfig&&(errorAction.retryConfig=retryConfig,errorAction.retryCount=fragmentErrors),errorAction}getLevelSwitchAction(data,levelIndex){let hls=this.hls;null==levelIndex&&(levelIndex=hls.loadLevel);let level=this.hls.levels[levelIndex];if(level){var _data$frag2,_data$context2,_level$audioGroups,_level$subtitleGroups;let errorDetails=data.details;level.loadError++,errorDetails===ErrorDetails1.BUFFER_APPEND_ERROR&&level.fragmentError++;let nextLevel=-1,{levels,loadLevel,minAutoLevel,maxAutoLevel}=hls;hls.autoLevelEnabled||(hls.loadLevel=-1);let fragErrorType=null==(_data$frag2=data.frag)?void 0:_data$frag2.type,findAudioCodecAlternate=(fragErrorType===PlaylistLevelType.AUDIO&&errorDetails===ErrorDetails1.FRAG_PARSING_ERROR||"audio"===data.sourceBufferName&&(errorDetails===ErrorDetails1.BUFFER_ADD_CODEC_ERROR||errorDetails===ErrorDetails1.BUFFER_APPEND_ERROR))&&levels.some(({audioCodec})=>level.audioCodec!==audioCodec),findVideoCodecAlternate="video"===data.sourceBufferName&&(errorDetails===ErrorDetails1.BUFFER_ADD_CODEC_ERROR||errorDetails===ErrorDetails1.BUFFER_APPEND_ERROR)&&levels.some(({codecSet,audioCodec})=>level.codecSet!==codecSet&&level.audioCodec===audioCodec),{type:playlistErrorType,groupId:playlistErrorGroupId}=null!=(_data$context2=data.context)?_data$context2:{};for(let i=levels.length;i--;){let candidate=(i+loadLevel)%levels.length;if(candidate!==loadLevel&&candidate>=minAutoLevel&&candidate<=maxAutoLevel&&0===levels[candidate].loadError){let levelCandidate=levels[candidate];if(errorDetails===ErrorDetails1.FRAG_GAP&&fragErrorType===PlaylistLevelType.MAIN&&data.frag){let levelDetails=levels[candidate].details;if(levelDetails){let fragCandidate=findFragmentByPTS(data.frag,levelDetails.fragments,data.frag.start);if(null!=fragCandidate&&fragCandidate.gap)continue}}else if(playlistErrorType===PlaylistContextType.AUDIO_TRACK&&levelCandidate.hasAudioGroup(playlistErrorGroupId)||playlistErrorType===PlaylistContextType.SUBTITLE_TRACK&&levelCandidate.hasSubtitleGroup(playlistErrorGroupId))continue;else if(fragErrorType===PlaylistLevelType.AUDIO&&null!=(_level$audioGroups=level.audioGroups)&&_level$audioGroups.some(groupId=>levelCandidate.hasAudioGroup(groupId))||fragErrorType===PlaylistLevelType.SUBTITLE&&null!=(_level$subtitleGroups=level.subtitleGroups)&&_level$subtitleGroups.some(groupId=>levelCandidate.hasSubtitleGroup(groupId))||findAudioCodecAlternate&&level.audioCodec===levelCandidate.audioCodec||!findAudioCodecAlternate&&level.audioCodec!==levelCandidate.audioCodec||findVideoCodecAlternate&&level.codecSet===levelCandidate.codecSet)continue;nextLevel=candidate;break}}if(nextLevel>-1&&hls.loadLevel!==nextLevel)return data.levelRetry=!0,this.playlistError=0,{action:NetworkErrorAction.SendAlternateToPenaltyBox,flags:ErrorActionFlags.None,nextAutoLevel:nextLevel}}return{action:NetworkErrorAction.SendAlternateToPenaltyBox,flags:ErrorActionFlags.MoveAllAlternatesMatchingHost}}onErrorOut(event,data){var _data$errorAction;switch(null==(_data$errorAction=data.errorAction)?void 0:_data$errorAction.action){case NetworkErrorAction.DoNothing:break;case NetworkErrorAction.SendAlternateToPenaltyBox:this.sendAlternateToPenaltyBox(data),data.errorAction.resolved||data.details===ErrorDetails1.FRAG_GAP?/MediaSource readyState: ended/.test(data.error.message)&&(this.warn(`MediaSource ended after "${data.sourceBufferName}" sourceBuffer append error. Attempting to recover from media error.`),this.hls.recoverMediaError()):data.fatal=!0;case NetworkErrorAction.RetryRequest:}if(data.fatal){this.hls.stopLoad();return}}sendAlternateToPenaltyBox(data){let hls=this.hls,errorAction=data.errorAction;if(!errorAction)return;let{flags,hdcpLevel,nextAutoLevel}=errorAction;switch(flags){case ErrorActionFlags.None:this.switchLevel(data,nextAutoLevel);break;case ErrorActionFlags.MoveAllAlternatesMatchingHDCP:hdcpLevel&&(hls.maxHdcpLevel=HdcpLevels[HdcpLevels.indexOf(hdcpLevel)-1],errorAction.resolved=!0),this.warn(`Restricting playback to HDCP-LEVEL of "${hls.maxHdcpLevel}" or lower`)}errorAction.resolved||this.switchLevel(data,nextAutoLevel)}switchLevel(data,levelIndex){void 0!==levelIndex&&data.errorAction&&(this.warn(`switching to level ${levelIndex} after ${data.details}`),this.hls.nextAutoLevel=levelIndex,data.errorAction.resolved=!0,this.hls.nextLoadLevel=this.hls.nextAutoLevel)}}class BasePlaylistController{constructor(hls,logPrefix){this.hls=void 0,this.timer=-1,this.requestScheduled=-1,this.canLoad=!1,this.log=void 0,this.warn=void 0,this.log=logger.log.bind(logger,`${logPrefix}:`),this.warn=logger.warn.bind(logger,`${logPrefix}:`),this.hls=hls}destroy(){this.clearTimer(),this.hls=this.log=this.warn=null}clearTimer(){-1!==this.timer&&(self.clearTimeout(this.timer),this.timer=-1)}startLoad(){this.canLoad=!0,this.requestScheduled=-1,this.loadPlaylist()}stopLoad(){this.canLoad=!1,this.clearTimer()}switchParams(playlistUri,previous,current){let renditionReports=null==previous?void 0:previous.renditionReports;if(renditionReports){let foundIndex=-1;for(let i=0;i<renditionReports.length;i++){let uri;let attr=renditionReports[i];try{uri=new self.URL(attr.URI,previous.url).href}catch(error){logger.warn(`Could not construct new URL for Rendition Report: ${error}`),uri=attr.URI||""}if(uri===playlistUri){foundIndex=i;break}uri===playlistUri.substring(0,uri.length)&&(foundIndex=i)}if(-1!==foundIndex){let attr=renditionReports[foundIndex],msn=parseInt(attr["LAST-MSN"])||(null==previous?void 0:previous.lastPartSn),part=parseInt(attr["LAST-PART"])||(null==previous?void 0:previous.lastPartIndex);if(this.hls.config.lowLatencyMode){let currentGoal=Math.min(previous.age-previous.partTarget,previous.targetduration);part>=0&&currentGoal>previous.partTarget&&(part+=1)}return new HlsUrlParameters(msn,part>=0?part:void 0,current&&getSkipValue(current))}}}loadPlaylist(hlsUrlParameters){-1===this.requestScheduled&&(this.requestScheduled=self.performance.now())}shouldLoadPlaylist(playlist){return this.canLoad&&!!playlist&&!!playlist.url&&(!playlist.details||playlist.details.live)}shouldReloadPlaylist(playlist){return -1===this.timer&&-1===this.requestScheduled&&this.shouldLoadPlaylist(playlist)}playlistLoaded(index,data,previousDetails){let{details,stats}=data,now=self.performance.now(),elapsed=stats.loading.first?Math.max(0,now-stats.loading.first):0;if(details.advancedDateTime=Date.now()-elapsed,details.live||null!=previousDetails&&previousDetails.live){let deliveryDirectives,msn,part;if(details.reloaded(previousDetails),previousDetails&&this.log(`live playlist ${index} ${details.advanced?"REFRESHED "+details.lastPartSn+"-"+details.lastPartIndex:details.updated?"UPDATED":"MISSED"}`),previousDetails&&details.fragments.length>0&&mergeDetails(previousDetails,details),!this.canLoad||!details.live)return;if(details.canBlockReload&&details.endSN&&details.advanced){let lowLatencyMode=this.hls.config.lowLatencyMode,lastPartSn=details.lastPartSn,endSn=details.endSN,lastPartIndex=details.lastPartIndex,lastPart=lastPartSn===endSn;-1!==lastPartIndex?(msn=lastPart?endSn+1:lastPartSn,part=lastPart?lowLatencyMode?0:lastPartIndex:lastPartIndex+1):msn=endSn+1;let lastAdvanced=details.age,currentGoal=Math.min(lastAdvanced+details.ageHeader-details.partTarget,1.5*details.targetduration);if(currentGoal>0){if(previousDetails&&currentGoal>previousDetails.tuneInGoal)this.warn(`CDN Tune-in goal increased from: ${previousDetails.tuneInGoal} to: ${currentGoal} with playlist age: ${details.age}`),currentGoal=0;else{let segments=Math.floor(currentGoal/details.targetduration);msn+=segments,void 0!==part&&(part+=Math.round(currentGoal%details.targetduration/details.partTarget)),this.log(`CDN Tune-in age: ${details.ageHeader}s last advanced ${lastAdvanced.toFixed(2)}s goal: ${currentGoal} skip sn ${segments} to part ${part}`)}details.tuneInGoal=currentGoal}if(deliveryDirectives=this.getDeliveryDirectives(details,data.deliveryDirectives,msn,part),lowLatencyMode||!lastPart){this.loadPlaylist(deliveryDirectives);return}}else(details.canBlockReload||details.canSkipUntil)&&(deliveryDirectives=this.getDeliveryDirectives(details,data.deliveryDirectives,msn,part));let bufferInfo=this.hls.mainForwardBufferInfo,position=bufferInfo?bufferInfo.end-bufferInfo.len:0,distanceToLiveEdgeMs=(details.edge-position)*1e3,reloadInterval=computeReloadInterval(details,distanceToLiveEdgeMs);details.updated&&now>this.requestScheduled+reloadInterval&&(this.requestScheduled=stats.loading.start),void 0!==msn&&details.canBlockReload?this.requestScheduled=stats.loading.first+reloadInterval-(1e3*details.partTarget||1e3):-1===this.requestScheduled||this.requestScheduled+reloadInterval<now?this.requestScheduled=now:this.requestScheduled-now<=0&&(this.requestScheduled+=reloadInterval);let estimatedTimeUntilUpdate=this.requestScheduled-now;estimatedTimeUntilUpdate=Math.max(0,estimatedTimeUntilUpdate),this.log(`reload live playlist ${index} in ${Math.round(estimatedTimeUntilUpdate)} ms`),this.timer=self.setTimeout(()=>this.loadPlaylist(deliveryDirectives),estimatedTimeUntilUpdate)}else this.clearTimer()}getDeliveryDirectives(details,previousDeliveryDirectives,msn,part){let skip=getSkipValue(details);return null!=previousDeliveryDirectives&&previousDeliveryDirectives.skip&&details.deltaUpdateFailed&&(msn=previousDeliveryDirectives.msn,part=previousDeliveryDirectives.part,skip=HlsSkip.No),new HlsUrlParameters(msn,part,skip)}checkRetry(errorEvent){let errorDetails=errorEvent.details,isTimeout=isTimeoutError(errorEvent),errorAction=errorEvent.errorAction,{action,retryCount=0,retryConfig}=errorAction||{},retry=!!errorAction&&!!retryConfig&&(action===NetworkErrorAction.RetryRequest||!errorAction.resolved&&action===NetworkErrorAction.SendAlternateToPenaltyBox);if(retry){var _errorEvent$context;if(this.requestScheduled=-1,retryCount>=retryConfig.maxNumRetry)return!1;if(isTimeout&&null!=(_errorEvent$context=errorEvent.context)&&_errorEvent$context.deliveryDirectives)this.warn(`Retrying playlist loading ${retryCount+1}/${retryConfig.maxNumRetry} after "${errorDetails}" without delivery-directives`),this.loadPlaylist();else{let delay=getRetryDelay(retryConfig,retryCount);this.timer=self.setTimeout(()=>this.loadPlaylist(),delay),this.warn(`Retrying playlist loading ${retryCount+1}/${retryConfig.maxNumRetry} after "${errorDetails}" in ${delay}ms`)}errorEvent.levelRetry=!0,errorAction.resolved=!0}return retry}}class EWMA{constructor(halfLife,estimate=0,weight=0){this.halfLife=void 0,this.alpha_=void 0,this.estimate_=void 0,this.totalWeight_=void 0,this.halfLife=halfLife,this.alpha_=halfLife?Math.exp(Math.log(.5)/halfLife):0,this.estimate_=estimate,this.totalWeight_=weight}sample(weight,value){let adjAlpha=Math.pow(this.alpha_,weight);this.estimate_=value*(1-adjAlpha)+adjAlpha*this.estimate_,this.totalWeight_+=weight}getTotalWeight(){return this.totalWeight_}getEstimate(){if(this.alpha_){let zeroFactor=1-Math.pow(this.alpha_,this.totalWeight_);if(zeroFactor)return this.estimate_/zeroFactor}return this.estimate_}}class EwmaBandWidthEstimator{constructor(slow,fast,defaultEstimate,defaultTTFB=100){this.defaultEstimate_=void 0,this.minWeight_=void 0,this.minDelayMs_=void 0,this.slow_=void 0,this.fast_=void 0,this.defaultTTFB_=void 0,this.ttfb_=void 0,this.defaultEstimate_=defaultEstimate,this.minWeight_=.001,this.minDelayMs_=50,this.slow_=new EWMA(slow),this.fast_=new EWMA(fast),this.defaultTTFB_=defaultTTFB,this.ttfb_=new EWMA(slow)}update(slow,fast){let{slow_,fast_,ttfb_}=this;slow_.halfLife!==slow&&(this.slow_=new EWMA(slow,slow_.getEstimate(),slow_.getTotalWeight())),fast_.halfLife!==fast&&(this.fast_=new EWMA(fast,fast_.getEstimate(),fast_.getTotalWeight())),ttfb_.halfLife!==slow&&(this.ttfb_=new EWMA(slow,ttfb_.getEstimate(),ttfb_.getTotalWeight()))}sample(durationMs,numBytes){let durationS=(durationMs=Math.max(durationMs,this.minDelayMs_))/1e3,bandwidthInBps=8*numBytes/durationS;this.fast_.sample(durationS,bandwidthInBps),this.slow_.sample(durationS,bandwidthInBps)}sampleTTFB(ttfb){this.ttfb_.sample(Math.sqrt(2)*Math.exp(-Math.pow(ttfb/1e3,2)/2),Math.max(ttfb,5))}canEstimate(){return this.fast_.getTotalWeight()>=this.minWeight_}getEstimate(){return this.canEstimate()?Math.min(this.fast_.getEstimate(),this.slow_.getEstimate()):this.defaultEstimate_}getEstimateTTFB(){return this.ttfb_.getTotalWeight()>=this.minWeight_?this.ttfb_.getEstimate():this.defaultTTFB_}destroy(){}}function isHdrSupported(){if("function"==typeof matchMedia){let mediaQueryList=matchMedia("(dynamic-range: high)"),badQuery=matchMedia("bad query");if(mediaQueryList.media!==badQuery.media)return!0===mediaQueryList.matches}return!1}function getVideoSelectionOptions(currentVideoRange,videoPreference){let preferHDR=!1,allowedVideoRanges=[];return currentVideoRange&&(preferHDR="SDR"!==currentVideoRange,allowedVideoRanges=[currentVideoRange]),videoPreference&&(allowedVideoRanges=videoPreference.allowedVideoRanges||VideoRangeValues.slice(0),allowedVideoRanges=(preferHDR=void 0!==videoPreference.preferHDR?videoPreference.preferHDR:isHdrSupported())?allowedVideoRanges.filter(range=>"SDR"!==range):["SDR"]),{preferHDR,allowedVideoRanges}}function getStartCodecTier(codecTiers,currentVideoRange,currentBw,audioPreference,videoPreference){let codecSets=Object.keys(codecTiers),channelsPreference=null==audioPreference?void 0:audioPreference.channels,audioCodecPreference=null==audioPreference?void 0:audioPreference.audioCodec,preferStereo=channelsPreference&&2===parseInt(channelsPreference),hasStereo=!0,hasCurrentVideoRange=!1,minHeight=1/0,minFramerate=1/0,minBitrate=1/0,selectedScore=0,videoRanges=[],{preferHDR,allowedVideoRanges}=getVideoSelectionOptions(currentVideoRange,videoPreference);for(let i=codecSets.length;i--;){let tier=codecTiers[codecSets[i]];hasStereo=tier.channels[2]>0,minHeight=Math.min(minHeight,tier.minHeight),minFramerate=Math.min(minFramerate,tier.minFramerate),minBitrate=Math.min(minBitrate,tier.minBitrate);let matchingVideoRanges=allowedVideoRanges.filter(range=>tier.videoRanges[range]>0);matchingVideoRanges.length>0&&(hasCurrentVideoRange=!0,videoRanges=matchingVideoRanges)}minHeight=isFiniteNumber(minHeight)?minHeight:0,minFramerate=isFiniteNumber(minFramerate)?minFramerate:0;let maxHeight=Math.max(1080,minHeight),maxFramerate=Math.max(30,minFramerate);return currentBw=Math.max(minBitrate=isFiniteNumber(minBitrate)?minBitrate:currentBw,currentBw),hasCurrentVideoRange||(currentVideoRange=void 0,videoRanges=[]),{codecSet:codecSets.reduce((selected,candidate)=>{let candidateTier=codecTiers[candidate];if(candidate===selected)return selected;if(candidateTier.minBitrate>currentBw)return logStartCodecCandidateIgnored(candidate,`min bitrate of ${candidateTier.minBitrate} > current estimate of ${currentBw}`),selected;if(!candidateTier.hasDefaultAudio)return logStartCodecCandidateIgnored(candidate,"no renditions with default or auto-select sound found"),selected;if(audioCodecPreference&&candidate.indexOf(audioCodecPreference.substring(0,4))%5!=0)return logStartCodecCandidateIgnored(candidate,`audio codec preference "${audioCodecPreference}" not found`),selected;if(channelsPreference&&!preferStereo){if(!candidateTier.channels[channelsPreference])return logStartCodecCandidateIgnored(candidate,`no renditions with ${channelsPreference} channel sound found (channels options: ${Object.keys(candidateTier.channels)})`),selected}else if((!audioCodecPreference||preferStereo)&&hasStereo&&0===candidateTier.channels["2"])return logStartCodecCandidateIgnored(candidate,"no renditions with stereo sound found"),selected;return candidateTier.minHeight>maxHeight?(logStartCodecCandidateIgnored(candidate,`min resolution of ${candidateTier.minHeight} > maximum of ${maxHeight}`),selected):candidateTier.minFramerate>maxFramerate?(logStartCodecCandidateIgnored(candidate,`min framerate of ${candidateTier.minFramerate} > maximum of ${maxFramerate}`),selected):videoRanges.some(range=>candidateTier.videoRanges[range]>0)?candidateTier.maxScore<selectedScore?(logStartCodecCandidateIgnored(candidate,`max score of ${candidateTier.maxScore} < selected max of ${selectedScore}`),selected):selected&&(codecsSetSelectionPreferenceValue(candidate)>=codecsSetSelectionPreferenceValue(selected)||candidateTier.fragmentError>codecTiers[selected].fragmentError)?selected:(selectedScore=candidateTier.maxScore,candidate):(logStartCodecCandidateIgnored(candidate,`no variants with VIDEO-RANGE of ${JSON.stringify(videoRanges)} found`),selected)},void 0),videoRanges,preferHDR,minFramerate,minBitrate}}function logStartCodecCandidateIgnored(codeSet,reason){logger.log(`[abr] start candidates with "${codeSet}" ignored because ${reason}`)}function getAudioTracksByGroup(allAudioTracks){return allAudioTracks.reduce((audioTracksByGroup,track)=>{let trackGroup=audioTracksByGroup.groups[track.groupId];trackGroup||(trackGroup=audioTracksByGroup.groups[track.groupId]={tracks:[],channels:{2:0},hasDefault:!1,hasAutoSelect:!1}),trackGroup.tracks.push(track);let channelsKey=track.channels||"2";return trackGroup.channels[channelsKey]=(trackGroup.channels[channelsKey]||0)+1,trackGroup.hasDefault=trackGroup.hasDefault||track.default,trackGroup.hasAutoSelect=trackGroup.hasAutoSelect||track.autoselect,trackGroup.hasDefault&&(audioTracksByGroup.hasDefaultAudio=!0),trackGroup.hasAutoSelect&&(audioTracksByGroup.hasAutoSelectAudio=!0),audioTracksByGroup},{hasDefaultAudio:!1,hasAutoSelectAudio:!1,groups:{}})}function getCodecTiers(levels,audioTracksByGroup,minAutoLevel,maxAutoLevel){return levels.slice(minAutoLevel,maxAutoLevel+1).reduce((tiers,level)=>{if(!level.codecSet)return tiers;let audioGroups=level.audioGroups,tier=tiers[level.codecSet];tier||(tiers[level.codecSet]=tier={minBitrate:1/0,minHeight:1/0,minFramerate:1/0,maxScore:0,videoRanges:{SDR:0},channels:{2:0},hasDefaultAudio:!audioGroups,fragmentError:0}),tier.minBitrate=Math.min(tier.minBitrate,level.bitrate);let lesserWidthOrHeight=Math.min(level.height,level.width);return tier.minHeight=Math.min(tier.minHeight,lesserWidthOrHeight),tier.minFramerate=Math.min(tier.minFramerate,level.frameRate),tier.maxScore=Math.max(tier.maxScore,level.score),tier.fragmentError+=level.fragmentError,tier.videoRanges[level.videoRange]=(tier.videoRanges[level.videoRange]||0)+1,tiers},{})}class AbrController{constructor(_hls){this.hls=void 0,this.lastLevelLoadSec=0,this.lastLoadedFragLevel=-1,this.firstSelection=-1,this._nextAutoLevel=-1,this.nextAutoLevelKey="",this.audioTracksByGroup=null,this.codecTiers=null,this.timer=-1,this.fragCurrent=null,this.partCurrent=null,this.bitrateTestDelay=0,this.bwEstimator=void 0,this._abandonRulesCheck=()=>{let nextLoadLevel;let{fragCurrent:frag,partCurrent:part,hls}=this,{autoLevelEnabled,media}=hls;if(!frag||!media)return;let now=performance.now(),stats=part?part.stats:frag.stats,duration=part?part.duration:frag.duration,timeLoading=now-stats.loading.start,minAutoLevel=hls.minAutoLevel;if(stats.aborted||stats.loaded&&stats.loaded===stats.total||frag.level<=minAutoLevel){this.clearTimer(),this._nextAutoLevel=-1;return}if(!autoLevelEnabled||media.paused||!media.playbackRate||!media.readyState)return;let bufferInfo=hls.mainForwardBufferInfo;if(null===bufferInfo)return;let ttfbEstimate=this.bwEstimator.getEstimateTTFB(),playbackRate=Math.abs(media.playbackRate);if(timeLoading<=Math.max(ttfbEstimate,duration/(2*playbackRate)*1e3))return;let bufferStarvationDelay=bufferInfo.len/playbackRate,ttfb=stats.loading.first?stats.loading.first-stats.loading.start:-1,loadedFirstByte=stats.loaded&&ttfb>-1,bwEstimate=this.getBwEstimate(),levels=hls.levels,level=levels[frag.level],expectedLen=stats.total||Math.max(stats.loaded,Math.round(duration*level.averageBitrate/8)),timeStreaming=loadedFirstByte?timeLoading-ttfb:timeLoading;timeStreaming<1&&loadedFirstByte&&(timeStreaming=Math.min(timeLoading,8*stats.loaded/bwEstimate));let loadRate=loadedFirstByte?1e3*stats.loaded/timeStreaming:0,fragLoadedDelay=loadRate?(expectedLen-stats.loaded)/loadRate:8*expectedLen/bwEstimate+ttfbEstimate/1e3;if(fragLoadedDelay<=bufferStarvationDelay)return;let bwe=loadRate?8*loadRate:bwEstimate,fragLevelNextLoadedDelay=Number.POSITIVE_INFINITY;for(nextLoadLevel=frag.level-1;nextLoadLevel>minAutoLevel;nextLoadLevel--){let levelNextBitrate=levels[nextLoadLevel].maxBitrate;if((fragLevelNextLoadedDelay=this.getTimeToLoadFrag(ttfbEstimate/1e3,bwe,duration*levelNextBitrate,!levels[nextLoadLevel].details))<bufferStarvationDelay)break}if(fragLevelNextLoadedDelay>=fragLoadedDelay||fragLevelNextLoadedDelay>10*duration)return;hls.nextLoadLevel=hls.nextAutoLevel=nextLoadLevel,loadedFirstByte?this.bwEstimator.sample(timeLoading-Math.min(ttfbEstimate,ttfb),stats.loaded):this.bwEstimator.sampleTTFB(timeLoading);let nextLoadLevelBitrate=levels[nextLoadLevel].maxBitrate;this.getBwEstimate()*this.hls.config.abrBandWidthUpFactor>nextLoadLevelBitrate&&this.resetEstimator(nextLoadLevelBitrate),this.clearTimer(),logger.warn(`[abr] Fragment ${frag.sn}${part?" part "+part.index:""} of level ${frag.level} is loading too slowly;
      Time to underbuffer: ${bufferStarvationDelay.toFixed(3)} s
      Estimated load time for current fragment: ${fragLoadedDelay.toFixed(3)} s
      Estimated load time for down switch fragment: ${fragLevelNextLoadedDelay.toFixed(3)} s
      TTFB estimate: ${0|ttfb} ms
      Current BW estimate: ${isFiniteNumber(bwEstimate)?0|bwEstimate:"Unknown"} bps
      New BW estimate: ${0|this.getBwEstimate()} bps
      Switching to level ${nextLoadLevel} @ ${0|nextLoadLevelBitrate} bps`),hls.trigger(Events1.FRAG_LOAD_EMERGENCY_ABORTED,{frag,part,stats})},this.hls=_hls,this.bwEstimator=this.initEstimator(),this.registerListeners()}resetEstimator(abrEwmaDefaultEstimate){abrEwmaDefaultEstimate&&(logger.log(`setting initial bwe to ${abrEwmaDefaultEstimate}`),this.hls.config.abrEwmaDefaultEstimate=abrEwmaDefaultEstimate),this.firstSelection=-1,this.bwEstimator=this.initEstimator()}initEstimator(){let config=this.hls.config;return new EwmaBandWidthEstimator(config.abrEwmaSlowVoD,config.abrEwmaFastVoD,config.abrEwmaDefaultEstimate)}registerListeners(){let{hls}=this;hls.on(Events1.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events1.FRAG_LOADING,this.onFragLoading,this),hls.on(Events1.FRAG_LOADED,this.onFragLoaded,this),hls.on(Events1.FRAG_BUFFERED,this.onFragBuffered,this),hls.on(Events1.LEVEL_SWITCHING,this.onLevelSwitching,this),hls.on(Events1.LEVEL_LOADED,this.onLevelLoaded,this),hls.on(Events1.LEVELS_UPDATED,this.onLevelsUpdated,this),hls.on(Events1.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),hls.on(Events1.ERROR,this.onError,this)}unregisterListeners(){let{hls}=this;hls&&(hls.off(Events1.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events1.FRAG_LOADING,this.onFragLoading,this),hls.off(Events1.FRAG_LOADED,this.onFragLoaded,this),hls.off(Events1.FRAG_BUFFERED,this.onFragBuffered,this),hls.off(Events1.LEVEL_SWITCHING,this.onLevelSwitching,this),hls.off(Events1.LEVEL_LOADED,this.onLevelLoaded,this),hls.off(Events1.LEVELS_UPDATED,this.onLevelsUpdated,this),hls.off(Events1.MAX_AUTO_LEVEL_UPDATED,this.onMaxAutoLevelUpdated,this),hls.off(Events1.ERROR,this.onError,this))}destroy(){this.unregisterListeners(),this.clearTimer(),this.hls=this._abandonRulesCheck=null,this.fragCurrent=this.partCurrent=null}onManifestLoading(event,data){this.lastLoadedFragLevel=-1,this.firstSelection=-1,this.lastLevelLoadSec=0,this.fragCurrent=this.partCurrent=null,this.onLevelsUpdated(),this.clearTimer()}onLevelsUpdated(){this.lastLoadedFragLevel>-1&&this.fragCurrent&&(this.lastLoadedFragLevel=this.fragCurrent.level),this._nextAutoLevel=-1,this.onMaxAutoLevelUpdated(),this.codecTiers=null,this.audioTracksByGroup=null}onMaxAutoLevelUpdated(){this.firstSelection=-1,this.nextAutoLevelKey=""}onFragLoading(event,data){let frag=data.frag;if(!this.ignoreFragment(frag)){if(!frag.bitrateTest){var _data$part;this.fragCurrent=frag,this.partCurrent=null!=(_data$part=data.part)?_data$part:null}this.clearTimer(),this.timer=self.setInterval(this._abandonRulesCheck,100)}}onLevelSwitching(event,data){this.clearTimer()}onError(event,data){if(!data.fatal)switch(data.details){case ErrorDetails1.BUFFER_ADD_CODEC_ERROR:case ErrorDetails1.BUFFER_APPEND_ERROR:this.lastLoadedFragLevel=-1,this.firstSelection=-1;break;case ErrorDetails1.FRAG_LOAD_TIMEOUT:{let frag=data.frag,{fragCurrent,partCurrent:part}=this;if(frag&&fragCurrent&&frag.sn===fragCurrent.sn&&frag.level===fragCurrent.level){let now=performance.now(),stats=part?part.stats:frag.stats,timeLoading=now-stats.loading.start,ttfb=stats.loading.first?stats.loading.first-stats.loading.start:-1;if(stats.loaded&&ttfb>-1){let ttfbEstimate=this.bwEstimator.getEstimateTTFB();this.bwEstimator.sample(timeLoading-Math.min(ttfbEstimate,ttfb),stats.loaded)}else this.bwEstimator.sampleTTFB(timeLoading)}}}}getTimeToLoadFrag(timeToFirstByteSec,bandwidth,fragSizeBits,isSwitch){return timeToFirstByteSec+fragSizeBits/bandwidth+(isSwitch?this.lastLevelLoadSec:0)}onLevelLoaded(event,data){let config=this.hls.config,{loading}=data.stats,timeLoadingMs=loading.end-loading.start;isFiniteNumber(timeLoadingMs)&&(this.lastLevelLoadSec=timeLoadingMs/1e3),data.details.live?this.bwEstimator.update(config.abrEwmaSlowLive,config.abrEwmaFastLive):this.bwEstimator.update(config.abrEwmaSlowVoD,config.abrEwmaFastVoD)}onFragLoaded(event,{frag,part}){let stats=part?part.stats:frag.stats;if(frag.type===PlaylistLevelType.MAIN&&this.bwEstimator.sampleTTFB(stats.loading.first-stats.loading.start),!this.ignoreFragment(frag)){if(this.clearTimer(),frag.level===this._nextAutoLevel&&(this._nextAutoLevel=-1),this.firstSelection=-1,this.hls.config.abrMaxWithRealBitrate){let duration=part?part.duration:frag.duration,level=this.hls.levels[frag.level],loadedBytes=(level.loaded?level.loaded.bytes:0)+stats.loaded,loadedDuration=(level.loaded?level.loaded.duration:0)+duration;level.loaded={bytes:loadedBytes,duration:loadedDuration},level.realBitrate=Math.round(8*loadedBytes/loadedDuration)}if(frag.bitrateTest){let fragBufferedData={stats,frag,part,id:frag.type};this.onFragBuffered(Events1.FRAG_BUFFERED,fragBufferedData),frag.bitrateTest=!1}else this.lastLoadedFragLevel=frag.level}}onFragBuffered(event,data){let{frag,part}=data,stats=null!=part&&part.stats.loaded?part.stats:frag.stats;if(stats.aborted||this.ignoreFragment(frag))return;let processingMs=stats.parsing.end-stats.loading.start-Math.min(stats.loading.first-stats.loading.start,this.bwEstimator.getEstimateTTFB());this.bwEstimator.sample(processingMs,stats.loaded),stats.bwEstimate=this.getBwEstimate(),frag.bitrateTest?this.bitrateTestDelay=processingMs/1e3:this.bitrateTestDelay=0}ignoreFragment(frag){return frag.type!==PlaylistLevelType.MAIN||"initSegment"===frag.sn}clearTimer(){this.timer>-1&&(self.clearInterval(this.timer),this.timer=-1)}get firstAutoLevel(){let{maxAutoLevel,minAutoLevel}=this.hls,bwEstimate=this.getBwEstimate(),maxStartDelay=this.hls.config.maxStarvationDelay,abrAutoLevel=this.findBestLevel(bwEstimate,minAutoLevel,maxAutoLevel,0,maxStartDelay,1,1);if(abrAutoLevel>-1)return abrAutoLevel;let firstLevel=this.hls.firstLevel,clamped=Math.min(Math.max(firstLevel,minAutoLevel),maxAutoLevel);return logger.warn(`[abr] Could not find best starting auto level. Defaulting to first in playlist ${firstLevel} clamped to ${clamped}`),clamped}get forcedAutoLevel(){return this.nextAutoLevelKey?-1:this._nextAutoLevel}get nextAutoLevel(){let forcedAutoLevel=this.forcedAutoLevel,useEstimate=this.bwEstimator.canEstimate(),loadedFirstFrag=this.lastLoadedFragLevel>-1;if(-1!==forcedAutoLevel&&(!useEstimate||!loadedFirstFrag||this.nextAutoLevelKey===this.getAutoLevelKey()))return forcedAutoLevel;let nextABRAutoLevel=useEstimate&&loadedFirstFrag?this.getNextABRAutoLevel():this.firstAutoLevel;if(-1!==forcedAutoLevel){let levels=this.hls.levels;if(levels.length>Math.max(forcedAutoLevel,nextABRAutoLevel)&&levels[forcedAutoLevel].loadError<=levels[nextABRAutoLevel].loadError)return forcedAutoLevel}return this._nextAutoLevel=nextABRAutoLevel,this.nextAutoLevelKey=this.getAutoLevelKey(),nextABRAutoLevel}getAutoLevelKey(){return`${this.getBwEstimate()}_${this.getStarvationDelay().toFixed(2)}`}getNextABRAutoLevel(){let{fragCurrent,partCurrent,hls}=this,{maxAutoLevel,config,minAutoLevel}=hls,currentFragDuration=partCurrent?partCurrent.duration:fragCurrent?fragCurrent.duration:0,avgbw=this.getBwEstimate(),bufferStarvationDelay=this.getStarvationDelay(),bwFactor=config.abrBandWidthFactor,bwUpFactor=config.abrBandWidthUpFactor;if(bufferStarvationDelay){let _bestLevel=this.findBestLevel(avgbw,minAutoLevel,maxAutoLevel,bufferStarvationDelay,0,bwFactor,bwUpFactor);if(_bestLevel>=0)return _bestLevel}let maxStarvationDelay=currentFragDuration?Math.min(currentFragDuration,config.maxStarvationDelay):config.maxStarvationDelay;if(!bufferStarvationDelay){let bitrateTestDelay=this.bitrateTestDelay;bitrateTestDelay&&(maxStarvationDelay=(currentFragDuration?Math.min(currentFragDuration,config.maxLoadingDelay):config.maxLoadingDelay)-bitrateTestDelay,logger.info(`[abr] bitrate test took ${Math.round(1e3*bitrateTestDelay)}ms, set first fragment max fetchDuration to ${Math.round(1e3*maxStarvationDelay)} ms`),bwFactor=bwUpFactor=1)}let bestLevel=this.findBestLevel(avgbw,minAutoLevel,maxAutoLevel,bufferStarvationDelay,maxStarvationDelay,bwFactor,bwUpFactor);if(logger.info(`[abr] ${bufferStarvationDelay?"rebuffering expected":"buffer is empty"}, optimal quality level ${bestLevel}`),bestLevel>-1)return bestLevel;let minLevel=hls.levels[minAutoLevel],autoLevel=hls.levels[hls.loadLevel];return(null==minLevel?void 0:minLevel.bitrate)<(null==autoLevel?void 0:autoLevel.bitrate)?minAutoLevel:hls.loadLevel}getStarvationDelay(){let hls=this.hls,media=hls.media;if(!media)return 1/0;let playbackRate=media&&0!==media.playbackRate?Math.abs(media.playbackRate):1,bufferInfo=hls.mainForwardBufferInfo;return(bufferInfo?bufferInfo.len:0)/playbackRate}getBwEstimate(){return this.bwEstimator.canEstimate()?this.bwEstimator.getEstimate():this.hls.config.abrEwmaDefaultEstimate}findBestLevel(currentBw,minAutoLevel,maxAutoLevel,bufferStarvationDelay,maxStarvationDelay,bwFactor,bwUpFactor){var _level$details,_levelInfo$supportedR;let currentCodecSet;let maxFetchDuration=bufferStarvationDelay+maxStarvationDelay,lastLoadedFragLevel=this.lastLoadedFragLevel,selectionBaseLevel=-1===lastLoadedFragLevel?this.hls.firstLevel:lastLoadedFragLevel,{fragCurrent,partCurrent}=this,{levels,allAudioTracks,loadLevel,config}=this.hls;if(1===levels.length)return 0;let level=levels[selectionBaseLevel],live=!!(null!=level&&null!=(_level$details=level.details)&&_level$details.live),firstSelection=-1===loadLevel||-1===lastLoadedFragLevel,currentVideoRange="SDR",currentFrameRate=(null==level?void 0:level.frameRate)||0,{audioPreference,videoPreference}=config,audioTracksByGroup=this.audioTracksByGroup||(this.audioTracksByGroup=getAudioTracksByGroup(allAudioTracks));if(firstSelection){if(-1!==this.firstSelection)return this.firstSelection;let startTier=getStartCodecTier(this.codecTiers||(this.codecTiers=getCodecTiers(levels,audioTracksByGroup,minAutoLevel,maxAutoLevel)),currentVideoRange,currentBw,audioPreference,videoPreference),{codecSet,videoRanges,minFramerate,minBitrate,preferHDR}=startTier;currentCodecSet=codecSet,currentVideoRange=preferHDR?videoRanges[videoRanges.length-1]:videoRanges[0],currentFrameRate=minFramerate,currentBw=Math.max(currentBw,minBitrate),logger.log(`[abr] picked start tier ${JSON.stringify(startTier)}`)}else currentCodecSet=null==level?void 0:level.codecSet,currentVideoRange=null==level?void 0:level.videoRange;let currentFragDuration=partCurrent?partCurrent.duration:fragCurrent?fragCurrent.duration:0,ttfbEstimateSec=this.bwEstimator.getEstimateTTFB()/1e3,levelsSkipped=[];for(let i=maxAutoLevel;i>=minAutoLevel;i--){let adjustedbw;let levelInfo=levels[i],upSwitch=i>selectionBaseLevel;if(!levelInfo)continue;if(currentCodecSet&&levelInfo.codecSet!==currentCodecSet||currentVideoRange&&levelInfo.videoRange!==currentVideoRange||upSwitch&&currentFrameRate>levelInfo.frameRate||!upSwitch&&currentFrameRate>0&&currentFrameRate<levelInfo.frameRate||levelInfo.supportedResult&&!(null!=(_levelInfo$supportedR=levelInfo.supportedResult.decodingInfoResults)&&_levelInfo$supportedR[0].smooth)){levelsSkipped.push(i);continue}let levelDetails=levelInfo.details,avgDuration=(partCurrent?null==levelDetails?void 0:levelDetails.partTarget:null==levelDetails?void 0:levelDetails.averagetargetduration)||currentFragDuration;adjustedbw=upSwitch?bwUpFactor*currentBw:bwFactor*currentBw;let bitrate=currentFragDuration&&bufferStarvationDelay>=2*currentFragDuration&&0===maxStarvationDelay?levels[i].averageBitrate:levels[i].maxBitrate,fetchDuration=this.getTimeToLoadFrag(ttfbEstimateSec,adjustedbw,bitrate*avgDuration,void 0===levelDetails);if(adjustedbw>=bitrate&&(i===lastLoadedFragLevel||0===levelInfo.loadError&&0===levelInfo.fragmentError)&&(fetchDuration<=ttfbEstimateSec||!isFiniteNumber(fetchDuration)||live&&!this.bitrateTestDelay||fetchDuration<maxFetchDuration)){let forcedAutoLevel=this.forcedAutoLevel;return i!==loadLevel&&(-1===forcedAutoLevel||forcedAutoLevel!==loadLevel)&&(levelsSkipped.length&&logger.trace(`[abr] Skipped level(s) ${levelsSkipped.join(",")} of ${maxAutoLevel} max with CODECS and VIDEO-RANGE:"${levels[levelsSkipped[0]].codecs}" ${levels[levelsSkipped[0]].videoRange}; not compatible with "${level.codecs}" ${currentVideoRange}`),logger.info(`[abr] switch candidate:${selectionBaseLevel}->${i} adjustedbw(${Math.round(adjustedbw)})-bitrate=${Math.round(adjustedbw-bitrate)} ttfb:${ttfbEstimateSec.toFixed(1)} avgDuration:${avgDuration.toFixed(1)} maxFetchDuration:${maxFetchDuration.toFixed(1)} fetchDuration:${fetchDuration.toFixed(1)} firstSelection:${firstSelection} codecSet:${currentCodecSet} videoRange:${currentVideoRange} hls.loadLevel:${loadLevel}`)),firstSelection&&(this.firstSelection=i),i}}return -1}set nextAutoLevel(nextLevel){let{maxAutoLevel,minAutoLevel}=this.hls,value=Math.min(Math.max(nextLevel,minAutoLevel),maxAutoLevel);this._nextAutoLevel!==value&&(this.nextAutoLevelKey="",this._nextAutoLevel=value)}}let noopBuffered={length:0,start:()=>0,end:()=>0};class BufferHelper{static isBuffered(media,position){try{if(media){let buffered=BufferHelper.getBuffered(media);for(let i=0;i<buffered.length;i++)if(position>=buffered.start(i)&&position<=buffered.end(i))return!0}}catch(error){}return!1}static bufferInfo(media,pos,maxHoleDuration){try{if(media){let i;let vbuffered=BufferHelper.getBuffered(media),buffered=[];for(i=0;i<vbuffered.length;i++)buffered.push({start:vbuffered.start(i),end:vbuffered.end(i)});return this.bufferedInfo(buffered,pos,maxHoleDuration)}}catch(error){}return{len:0,start:pos,end:pos,nextStart:void 0}}static bufferedInfo(buffered,pos,maxHoleDuration){let bufferStartNext;pos=Math.max(0,pos),buffered.sort(function(a,b){return a.start-b.start||b.end-a.end});let buffered2=[];if(maxHoleDuration)for(let i=0;i<buffered.length;i++){let buf2len=buffered2.length;if(buf2len){let buf2end=buffered2[buf2len-1].end;buffered[i].start-buf2end<maxHoleDuration?buffered[i].end>buf2end&&(buffered2[buf2len-1].end=buffered[i].end):buffered2.push(buffered[i])}else buffered2.push(buffered[i])}else buffered2=buffered;let bufferLen=0,bufferStart=pos,bufferEnd=pos;for(let i=0;i<buffered2.length;i++){let start=buffered2[i].start,end=buffered2[i].end;if(pos+maxHoleDuration>=start&&pos<end)bufferStart=start,bufferLen=(bufferEnd=end)-pos;else if(pos+maxHoleDuration<start){bufferStartNext=start;break}}return{len:bufferLen,start:bufferStart||0,end:bufferEnd||0,nextStart:bufferStartNext}}static getBuffered(media){try{return media.buffered}catch(e){return logger.log("failed to get media.buffered",e),noopBuffered}}}class BufferOperationQueue{constructor(sourceBufferReference){this.buffers=void 0,this.queues={video:[],audio:[],audiovideo:[]},this.buffers=sourceBufferReference}append(operation,type,pending){let queue=this.queues[type];queue.push(operation),1!==queue.length||pending||this.executeNext(type)}insertAbort(operation,type){this.queues[type].unshift(operation),this.executeNext(type)}appendBlocker(type){let execute;let promise=new Promise(resolve=>{execute=resolve}),operation={execute,onStart:()=>{},onComplete:()=>{},onError:()=>{}};return this.append(operation,type),promise}executeNext(type){let queue=this.queues[type];if(queue.length){let operation=queue[0];try{operation.execute()}catch(error){logger.warn(`[buffer-operation-queue]: Exception executing "${type}" SourceBuffer operation: ${error}`),operation.onError(error);let sb=this.buffers[type];null!=sb&&sb.updating||this.shiftAndExecuteNext(type)}}}shiftAndExecuteNext(type){this.queues[type].shift(),this.executeNext(type)}current(type){return this.queues[type][0]}}let VIDEO_CODEC_PROFILE_REPLACE=/(avc[1234]|hvc1|hev1|dvh[1e]|vp09|av01)(?:\.[^.,]+)+/;class BufferController{constructor(hls){this.details=null,this._objectUrl=null,this.operationQueue=void 0,this.listeners=void 0,this.hls=void 0,this.bufferCodecEventsExpected=0,this._bufferCodecEventsTotal=0,this.media=null,this.mediaSource=null,this.lastMpegAudioChunk=null,this.appendSource=void 0,this.appendErrors={audio:0,video:0,audiovideo:0},this.tracks={},this.pendingTracks={},this.sourceBuffer=void 0,this.log=void 0,this.warn=void 0,this.error=void 0,this._onEndStreaming=event=>{this.hls&&this.hls.pauseBuffering()},this._onStartStreaming=event=>{this.hls&&this.hls.resumeBuffering()},this._onMediaSourceOpen=()=>{let{media,mediaSource}=this;this.log("Media source opened"),media&&(media.removeEventListener("emptied",this._onMediaEmptied),this.updateMediaElementDuration(),this.hls.trigger(Events1.MEDIA_ATTACHED,{media,mediaSource:mediaSource})),mediaSource&&mediaSource.removeEventListener("sourceopen",this._onMediaSourceOpen),this.checkPendingTracks()},this._onMediaSourceClose=()=>{this.log("Media source closed")},this._onMediaSourceEnded=()=>{this.log("Media source ended")},this._onMediaEmptied=()=>{let{mediaSrc,_objectUrl}=this;mediaSrc!==_objectUrl&&logger.error(`Media element src was set while attaching MediaSource (${_objectUrl} > ${mediaSrc})`)},this.hls=hls;let logPrefix="[buffer-controller]";this.appendSource=isManagedMediaSource(getMediaSource(hls.config.preferManagedMediaSource)),this.log=logger.log.bind(logger,logPrefix),this.warn=logger.warn.bind(logger,logPrefix),this.error=logger.error.bind(logger,logPrefix),this._initSourceBuffer(),this.registerListeners()}hasSourceTypes(){return this.getSourceBufferTypes().length>0||Object.keys(this.pendingTracks).length>0}destroy(){this.unregisterListeners(),this.details=null,this.lastMpegAudioChunk=null,this.hls=null}registerListeners(){let{hls}=this;hls.on(Events1.MEDIA_ATTACHING,this.onMediaAttaching,this),hls.on(Events1.MEDIA_DETACHING,this.onMediaDetaching,this),hls.on(Events1.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events1.MANIFEST_PARSED,this.onManifestParsed,this),hls.on(Events1.BUFFER_RESET,this.onBufferReset,this),hls.on(Events1.BUFFER_APPENDING,this.onBufferAppending,this),hls.on(Events1.BUFFER_CODECS,this.onBufferCodecs,this),hls.on(Events1.BUFFER_EOS,this.onBufferEos,this),hls.on(Events1.BUFFER_FLUSHING,this.onBufferFlushing,this),hls.on(Events1.LEVEL_UPDATED,this.onLevelUpdated,this),hls.on(Events1.FRAG_PARSED,this.onFragParsed,this),hls.on(Events1.FRAG_CHANGED,this.onFragChanged,this)}unregisterListeners(){let{hls}=this;hls.off(Events1.MEDIA_ATTACHING,this.onMediaAttaching,this),hls.off(Events1.MEDIA_DETACHING,this.onMediaDetaching,this),hls.off(Events1.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events1.MANIFEST_PARSED,this.onManifestParsed,this),hls.off(Events1.BUFFER_RESET,this.onBufferReset,this),hls.off(Events1.BUFFER_APPENDING,this.onBufferAppending,this),hls.off(Events1.BUFFER_CODECS,this.onBufferCodecs,this),hls.off(Events1.BUFFER_EOS,this.onBufferEos,this),hls.off(Events1.BUFFER_FLUSHING,this.onBufferFlushing,this),hls.off(Events1.LEVEL_UPDATED,this.onLevelUpdated,this),hls.off(Events1.FRAG_PARSED,this.onFragParsed,this),hls.off(Events1.FRAG_CHANGED,this.onFragChanged,this)}_initSourceBuffer(){this.sourceBuffer={},this.operationQueue=new BufferOperationQueue(this.sourceBuffer),this.listeners={audio:[],video:[],audiovideo:[]},this.appendErrors={audio:0,video:0,audiovideo:0},this.lastMpegAudioChunk=null}onManifestLoading(){this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=0,this.details=null}onManifestParsed(event,data){let codecEvents=2;(!data.audio||data.video)&&data.altAudio,codecEvents=1,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal=codecEvents,this.log(`${this.bufferCodecEventsExpected} bufferCodec event(s) expected`)}onMediaAttaching(event,data){let media=this.media=data.media,MediaSource=getMediaSource(this.appendSource);if(media&&MediaSource){var _ms$constructor;let ms=this.mediaSource=new MediaSource;this.log(`created media source: ${null==(_ms$constructor=ms.constructor)?void 0:_ms$constructor.name}`),ms.addEventListener("sourceopen",this._onMediaSourceOpen),ms.addEventListener("sourceended",this._onMediaSourceEnded),ms.addEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(ms.addEventListener("startstreaming",this._onStartStreaming),ms.addEventListener("endstreaming",this._onEndStreaming));let objectUrl=this._objectUrl=self.URL.createObjectURL(ms);if(this.appendSource)try{media.removeAttribute("src");let MMS=self.ManagedMediaSource;media.disableRemotePlayback=media.disableRemotePlayback||MMS&&ms instanceof MMS,removeSourceChildren(media),addSource(media,objectUrl),media.load()}catch(error){media.src=objectUrl}else media.src=objectUrl;media.addEventListener("emptied",this._onMediaEmptied)}}onMediaDetaching(){let{media,mediaSource,_objectUrl}=this;if(mediaSource){if(this.log("media source detaching"),"open"===mediaSource.readyState)try{mediaSource.endOfStream()}catch(err){this.warn(`onMediaDetaching: ${err.message} while calling endOfStream`)}this.onBufferReset(),mediaSource.removeEventListener("sourceopen",this._onMediaSourceOpen),mediaSource.removeEventListener("sourceended",this._onMediaSourceEnded),mediaSource.removeEventListener("sourceclose",this._onMediaSourceClose),this.appendSource&&(mediaSource.removeEventListener("startstreaming",this._onStartStreaming),mediaSource.removeEventListener("endstreaming",this._onEndStreaming)),media&&(media.removeEventListener("emptied",this._onMediaEmptied),_objectUrl&&self.URL.revokeObjectURL(_objectUrl),this.mediaSrc===_objectUrl?(media.removeAttribute("src"),this.appendSource&&removeSourceChildren(media),media.load()):this.warn("media|source.src was changed by a third party - skip cleanup")),this.mediaSource=null,this.media=null,this._objectUrl=null,this.bufferCodecEventsExpected=this._bufferCodecEventsTotal,this.pendingTracks={},this.tracks={}}this.hls.trigger(Events1.MEDIA_DETACHED,void 0)}onBufferReset(){this.getSourceBufferTypes().forEach(type=>{this.resetBuffer(type)}),this._initSourceBuffer()}resetBuffer(type){let sb=this.sourceBuffer[type];try{if(sb){var _this$mediaSource;this.removeBufferListeners(type),this.sourceBuffer[type]=void 0,null!=(_this$mediaSource=this.mediaSource)&&_this$mediaSource.sourceBuffers.length&&this.mediaSource.removeSourceBuffer(sb)}}catch(err){this.warn(`onBufferReset ${type}`,err)}}onBufferCodecs(event,data){let sourceBufferCount=this.getSourceBufferTypes().length,trackNames=Object.keys(data);if(trackNames.forEach(trackName=>{if(sourceBufferCount){let track=this.tracks[trackName];if(track&&"function"==typeof track.buffer.changeType){var _trackCodec;let{id,codec,levelCodec,container,metadata}=data[trackName],currentCodecFull=pickMostCompleteCodecName(track.codec,track.levelCodec),currentCodec=null==currentCodecFull?void 0:currentCodecFull.replace(VIDEO_CODEC_PROFILE_REPLACE,"$1"),trackCodec=pickMostCompleteCodecName(codec,levelCodec),nextCodec=null==(_trackCodec=trackCodec)?void 0:_trackCodec.replace(VIDEO_CODEC_PROFILE_REPLACE,"$1");if(trackCodec&&currentCodec!==nextCodec){"audio"===trackName.slice(0,5)&&(trackCodec=getCodecCompatibleName(trackCodec,this.appendSource));let mimeType=`${container};codecs=${trackCodec}`;this.appendChangeType(trackName,mimeType),this.log(`switching codec ${currentCodecFull} to ${trackCodec}`),this.tracks[trackName]={buffer:track.buffer,codec,container,levelCodec,metadata,id}}}}else this.pendingTracks[trackName]=data[trackName]}),sourceBufferCount)return;let bufferCodecEventsExpected=Math.max(this.bufferCodecEventsExpected-1,0);this.bufferCodecEventsExpected!==bufferCodecEventsExpected&&(this.log(`${bufferCodecEventsExpected} bufferCodec event(s) expected ${trackNames.join(",")}`),this.bufferCodecEventsExpected=bufferCodecEventsExpected),this.mediaSource&&"open"===this.mediaSource.readyState&&this.checkPendingTracks()}appendChangeType(type,mimeType){let{operationQueue}=this;operationQueue.append({execute:()=>{let sb=this.sourceBuffer[type];sb&&(this.log(`changing ${type} sourceBuffer type to ${mimeType}`),sb.changeType(mimeType)),operationQueue.shiftAndExecuteNext(type)},onStart:()=>{},onComplete:()=>{},onError:error=>{this.warn(`Failed to change ${type} SourceBuffer type`,error)}},type,!!this.pendingTracks[type])}onBufferAppending(event,eventData){let{hls,operationQueue,tracks}=this,{data,type,frag,part,chunkMeta}=eventData,chunkStats=chunkMeta.buffering[type],bufferAppendingStart=self.performance.now();chunkStats.start=bufferAppendingStart;let fragBuffering=frag.stats.buffering,partBuffering=part?part.stats.buffering:null;0===fragBuffering.start&&(fragBuffering.start=bufferAppendingStart),partBuffering&&0===partBuffering.start&&(partBuffering.start=bufferAppendingStart);let audioTrack=tracks.audio,checkTimestampOffset=!1;"audio"===type&&(null==audioTrack?void 0:audioTrack.container)==="audio/mpeg"&&(checkTimestampOffset=!this.lastMpegAudioChunk||1===chunkMeta.id||this.lastMpegAudioChunk.sn!==chunkMeta.sn,this.lastMpegAudioChunk=chunkMeta);let fragStart=frag.start;operationQueue.append({execute:()=>{if(chunkStats.executeStart=self.performance.now(),checkTimestampOffset){let sb=this.sourceBuffer[type];if(sb){let delta=fragStart-sb.timestampOffset;Math.abs(delta)>=.1&&(this.log(`Updating audio SourceBuffer timestampOffset to ${fragStart} (delta: ${delta}) sn: ${frag.sn})`),sb.timestampOffset=fragStart)}}this.appendExecutor(data,type)},onStart:()=>{},onComplete:()=>{let end=self.performance.now();chunkStats.executeEnd=chunkStats.end=end,0===fragBuffering.first&&(fragBuffering.first=end),partBuffering&&0===partBuffering.first&&(partBuffering.first=end);let{sourceBuffer}=this,timeRanges={};for(let type in sourceBuffer)timeRanges[type]=BufferHelper.getBuffered(sourceBuffer[type]);this.appendErrors[type]=0,"audio"===type||"video"===type?this.appendErrors.audiovideo=0:(this.appendErrors.audio=0,this.appendErrors.video=0),this.hls.trigger(Events1.BUFFER_APPENDED,{type,frag,part,chunkMeta,parent:frag.type,timeRanges})},onError:error=>{let event={type:ErrorTypes1.MEDIA_ERROR,parent:frag.type,details:ErrorDetails1.BUFFER_APPEND_ERROR,sourceBufferName:type,frag,part,chunkMeta,error,err:error,fatal:!1};if(error.code===DOMException.QUOTA_EXCEEDED_ERR)event.details=ErrorDetails1.BUFFER_FULL_ERROR;else{let appendErrorCount=++this.appendErrors[type];event.details=ErrorDetails1.BUFFER_APPEND_ERROR,this.warn(`Failed ${appendErrorCount}/${hls.config.appendErrorMaxRetry} times to append segment in "${type}" sourceBuffer`),appendErrorCount>=hls.config.appendErrorMaxRetry&&(event.fatal=!0)}hls.trigger(Events1.ERROR,event)}},type,!!this.pendingTracks[type])}onBufferFlushing(event,data){let{operationQueue}=this,flushOperation=type=>({execute:this.removeExecutor.bind(this,type,data.startOffset,data.endOffset),onStart:()=>{},onComplete:()=>{this.hls.trigger(Events1.BUFFER_FLUSHED,{type})},onError:error=>{this.warn(`Failed to remove from ${type} SourceBuffer`,error)}});data.type?operationQueue.append(flushOperation(data.type),data.type):this.getSourceBufferTypes().forEach(type=>{operationQueue.append(flushOperation(type),type)})}onFragParsed(event,data){let{frag,part}=data,buffersAppendedTo=[],elementaryStreams=part?part.elementaryStreams:frag.elementaryStreams;elementaryStreams[ElementaryStreamTypes.AUDIOVIDEO]?buffersAppendedTo.push("audiovideo"):(elementaryStreams[ElementaryStreamTypes.AUDIO]&&buffersAppendedTo.push("audio"),elementaryStreams[ElementaryStreamTypes.VIDEO]&&buffersAppendedTo.push("video")),0===buffersAppendedTo.length&&this.warn(`Fragments must have at least one ElementaryStreamType set. type: ${frag.type} level: ${frag.level} sn: ${frag.sn}`),this.blockBuffers(()=>{let now=self.performance.now();frag.stats.buffering.end=now,part&&(part.stats.buffering.end=now);let stats=part?part.stats:frag.stats;this.hls.trigger(Events1.FRAG_BUFFERED,{frag,part,stats,id:frag.type})},buffersAppendedTo)}onFragChanged(event,data){this.trimBuffers()}onBufferEos(event,data){this.getSourceBufferTypes().reduce((acc,type)=>{let sb=this.sourceBuffer[type];return!sb||data.type&&data.type!==type||(sb.ending=!0,sb.ended||(sb.ended=!0,this.log(`${type} sourceBuffer now EOS`))),acc&&!!(!sb||sb.ended)},!0)&&(this.log("Queueing mediaSource.endOfStream()"),this.blockBuffers(()=>{this.getSourceBufferTypes().forEach(type=>{let sb=this.sourceBuffer[type];sb&&(sb.ending=!1)});let{mediaSource}=this;if(!mediaSource||"open"!==mediaSource.readyState){mediaSource&&this.log(`Could not call mediaSource.endOfStream(). mediaSource.readyState: ${mediaSource.readyState}`);return}this.log("Calling mediaSource.endOfStream()"),mediaSource.endOfStream()}))}onLevelUpdated(event,{details}){details.fragments.length&&(this.details=details,this.getSourceBufferTypes().length?this.blockBuffers(this.updateMediaElementDuration.bind(this)):this.updateMediaElementDuration())}trimBuffers(){let{hls,details,media}=this;if(!media||null===details||!this.getSourceBufferTypes().length)return;let config=hls.config,currentTime=media.currentTime,targetDuration=details.levelTargetDuration,backBufferLength=details.live&&null!==config.liveBackBufferLength?config.liveBackBufferLength:config.backBufferLength;if(isFiniteNumber(backBufferLength)&&backBufferLength>0){let maxBackBufferLength=Math.max(backBufferLength,targetDuration);this.flushBackBuffer(currentTime,targetDuration,Math.floor(currentTime/targetDuration)*targetDuration-maxBackBufferLength)}if(isFiniteNumber(config.frontBufferFlushThreshold)&&config.frontBufferFlushThreshold>0){let maxFrontBufferLength=Math.max(Math.max(config.maxBufferLength,config.frontBufferFlushThreshold),targetDuration);this.flushFrontBuffer(currentTime,targetDuration,Math.floor(currentTime/targetDuration)*targetDuration+maxFrontBufferLength)}}flushBackBuffer(currentTime,targetDuration,targetBackBufferPosition){let{details,sourceBuffer}=this;this.getSourceBufferTypes().forEach(type=>{let sb=sourceBuffer[type];if(sb){let buffered=BufferHelper.getBuffered(sb);if(buffered.length>0&&targetBackBufferPosition>buffered.start(0)){if(this.hls.trigger(Events1.BACK_BUFFER_REACHED,{bufferEnd:targetBackBufferPosition}),null!=details&&details.live)this.hls.trigger(Events1.LIVE_BACK_BUFFER_REACHED,{bufferEnd:targetBackBufferPosition});else if(sb.ended&&buffered.end(buffered.length-1)-currentTime<2*targetDuration){this.log(`Cannot flush ${type} back buffer while SourceBuffer is in ended state`);return}this.hls.trigger(Events1.BUFFER_FLUSHING,{startOffset:0,endOffset:targetBackBufferPosition,type})}}})}flushFrontBuffer(currentTime,targetDuration,targetFrontBufferPosition){let{sourceBuffer}=this;this.getSourceBufferTypes().forEach(type=>{let sb=sourceBuffer[type];if(sb){let buffered=BufferHelper.getBuffered(sb),numBufferedRanges=buffered.length;if(numBufferedRanges<2)return;let bufferStart=buffered.start(numBufferedRanges-1),bufferEnd=buffered.end(numBufferedRanges-1);if(targetFrontBufferPosition>bufferStart||currentTime>=bufferStart&&currentTime<=bufferEnd)return;if(sb.ended&&currentTime-bufferEnd<2*targetDuration){this.log(`Cannot flush ${type} front buffer while SourceBuffer is in ended state`);return}this.hls.trigger(Events1.BUFFER_FLUSHING,{startOffset:bufferStart,endOffset:1/0,type})}})}updateMediaElementDuration(){if(!this.details||!this.media||!this.mediaSource||"open"!==this.mediaSource.readyState)return;let{details,hls,media,mediaSource}=this,levelDuration=details.fragments[0].start+details.totalduration,mediaDuration=media.duration,msDuration=isFiniteNumber(mediaSource.duration)?mediaSource.duration:0;details.live&&hls.config.liveDurationInfinity?(mediaSource.duration=1/0,this.updateSeekableRange(details)):(levelDuration>msDuration&&levelDuration>mediaDuration||!isFiniteNumber(mediaDuration))&&(this.log(`Updating Media Source duration to ${levelDuration.toFixed(3)}`),mediaSource.duration=levelDuration)}updateSeekableRange(levelDetails){let mediaSource=this.mediaSource,fragments=levelDetails.fragments;if(fragments.length&&levelDetails.live&&null!=mediaSource&&mediaSource.setLiveSeekableRange){let start=Math.max(0,fragments[0].start),end=Math.max(start,start+levelDetails.totalduration);this.log(`Media Source duration is set to ${mediaSource.duration}. Setting seekable range to ${start}-${end}.`),mediaSource.setLiveSeekableRange(start,end)}}checkPendingTracks(){let{bufferCodecEventsExpected,operationQueue,pendingTracks}=this,pendingTracksCount=Object.keys(pendingTracks).length;if(pendingTracksCount&&(!bufferCodecEventsExpected||2===pendingTracksCount||"audiovideo"in pendingTracks)){this.createSourceBuffers(pendingTracks),this.pendingTracks={};let buffers=this.getSourceBufferTypes();if(buffers.length)this.hls.trigger(Events1.BUFFER_CREATED,{tracks:this.tracks}),buffers.forEach(type=>{operationQueue.executeNext(type)});else{let error=Error("could not create source buffer for media codec(s)");this.hls.trigger(Events1.ERROR,{type:ErrorTypes1.MEDIA_ERROR,details:ErrorDetails1.BUFFER_INCOMPATIBLE_CODECS_ERROR,fatal:!0,error,reason:error.message})}}}createSourceBuffers(tracks){let{sourceBuffer,mediaSource}=this;if(!mediaSource)throw Error("createSourceBuffers called when mediaSource was null");for(let trackName in tracks)if(!sourceBuffer[trackName]){var _track$levelCodec;let track=tracks[trackName];if(!track)throw Error(`source buffer exists for track ${trackName}, however track does not`);let codec=(null==(_track$levelCodec=track.levelCodec)?void 0:_track$levelCodec.indexOf(","))===-1?track.levelCodec:track.codec;codec&&"audio"===trackName.slice(0,5)&&(codec=getCodecCompatibleName(codec,this.appendSource));let mimeType=`${track.container};codecs=${codec}`;this.log(`creating sourceBuffer(${mimeType})`);try{let sb=sourceBuffer[trackName]=mediaSource.addSourceBuffer(mimeType);this.addBufferListener(trackName,"updatestart",this._onSBUpdateStart),this.addBufferListener(trackName,"updateend",this._onSBUpdateEnd),this.addBufferListener(trackName,"error",this._onSBUpdateError),this.appendSource&&this.addBufferListener(trackName,"bufferedchange",(type,event)=>{let removedRanges=event.removedRanges;null!=removedRanges&&removedRanges.length&&this.hls.trigger(Events1.BUFFER_FLUSHED,{type:trackName})}),this.tracks[trackName]={buffer:sb,codec:codec,container:track.container,levelCodec:track.levelCodec,metadata:track.metadata,id:track.id}}catch(err){this.error(`error while trying to add sourceBuffer: ${err.message}`),this.hls.trigger(Events1.ERROR,{type:ErrorTypes1.MEDIA_ERROR,details:ErrorDetails1.BUFFER_ADD_CODEC_ERROR,fatal:!1,error:err,sourceBufferName:trackName,mimeType:mimeType})}}}get mediaSrc(){var _this$media;let media=(null==(_this$media=this.media)?void 0:_this$media.firstChild)||this.media;return null==media?void 0:media.src}_onSBUpdateStart(type){let{operationQueue}=this;operationQueue.current(type).onStart()}_onSBUpdateEnd(type){var _this$mediaSource2;if((null==(_this$mediaSource2=this.mediaSource)?void 0:_this$mediaSource2.readyState)==="closed"){this.resetBuffer(type);return}let{operationQueue}=this;operationQueue.current(type).onComplete(),operationQueue.shiftAndExecuteNext(type)}_onSBUpdateError(type,event){var _this$mediaSource3;let error=Error(`${type} SourceBuffer error. MediaSource readyState: ${null==(_this$mediaSource3=this.mediaSource)?void 0:_this$mediaSource3.readyState}`);this.error(`${error}`,event),this.hls.trigger(Events1.ERROR,{type:ErrorTypes1.MEDIA_ERROR,details:ErrorDetails1.BUFFER_APPENDING_ERROR,sourceBufferName:type,error,fatal:!1});let operation=this.operationQueue.current(type);operation&&operation.onError(error)}removeExecutor(type,startOffset,endOffset){let{media,mediaSource,operationQueue,sourceBuffer}=this,sb=sourceBuffer[type];if(!media||!mediaSource||!sb){this.warn(`Attempting to remove from the ${type} SourceBuffer, but it does not exist`),operationQueue.shiftAndExecuteNext(type);return}let mediaDuration=isFiniteNumber(media.duration)?media.duration:1/0,msDuration=isFiniteNumber(mediaSource.duration)?mediaSource.duration:1/0,removeStart=Math.max(0,startOffset),removeEnd=Math.min(endOffset,mediaDuration,msDuration);removeEnd>removeStart&&(!sb.ending||sb.ended)?(sb.ended=!1,this.log(`Removing [${removeStart},${removeEnd}] from the ${type} SourceBuffer`),sb.remove(removeStart,removeEnd)):operationQueue.shiftAndExecuteNext(type)}appendExecutor(data,type){let sb=this.sourceBuffer[type];if(!sb){if(!this.pendingTracks[type])throw Error(`Attempting to append to the ${type} SourceBuffer, but it does not exist`);return}sb.ended=!1,sb.appendBuffer(data)}blockBuffers(onUnblocked,buffers=this.getSourceBufferTypes()){if(!buffers.length){this.log("Blocking operation requested, but no SourceBuffers exist"),Promise.resolve().then(onUnblocked);return}let{operationQueue}=this;Promise.all(buffers.map(type=>operationQueue.appendBlocker(type))).then(()=>{onUnblocked(),buffers.forEach(type=>{let sb=this.sourceBuffer[type];null!=sb&&sb.updating||operationQueue.shiftAndExecuteNext(type)})})}getSourceBufferTypes(){return Object.keys(this.sourceBuffer)}addBufferListener(type,event,fn){let buffer=this.sourceBuffer[type];if(!buffer)return;let listener=fn.bind(this,type);this.listeners[type].push({event,listener}),buffer.addEventListener(event,listener)}removeBufferListeners(type){let buffer=this.sourceBuffer[type];buffer&&this.listeners[type].forEach(l=>{buffer.removeEventListener(l.event,l.listener)})}}function removeSourceChildren(node){let sourceChildren=node.querySelectorAll("source");[].slice.call(sourceChildren).forEach(source=>{node.removeChild(source)})}function addSource(media,url){let source=self.document.createElement("source");source.type="video/mp4",source.src=url,media.appendChild(source)}class CapLevelController{constructor(hls){this.hls=void 0,this.autoLevelCapping=void 0,this.firstLevel=void 0,this.media=void 0,this.restrictedLevels=void 0,this.timer=void 0,this.clientRect=void 0,this.streamController=void 0,this.hls=hls,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.firstLevel=-1,this.media=null,this.restrictedLevels=[],this.timer=void 0,this.clientRect=null,this.registerListeners()}setStreamController(streamController){this.streamController=streamController}destroy(){this.hls&&this.unregisterListener(),this.timer&&this.stopCapping(),this.media=null,this.clientRect=null,this.hls=this.streamController=null}registerListeners(){let{hls}=this;hls.on(Events1.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),hls.on(Events1.MEDIA_ATTACHING,this.onMediaAttaching,this),hls.on(Events1.MANIFEST_PARSED,this.onManifestParsed,this),hls.on(Events1.LEVELS_UPDATED,this.onLevelsUpdated,this),hls.on(Events1.BUFFER_CODECS,this.onBufferCodecs,this),hls.on(Events1.MEDIA_DETACHING,this.onMediaDetaching,this)}unregisterListener(){let{hls}=this;hls.off(Events1.FPS_DROP_LEVEL_CAPPING,this.onFpsDropLevelCapping,this),hls.off(Events1.MEDIA_ATTACHING,this.onMediaAttaching,this),hls.off(Events1.MANIFEST_PARSED,this.onManifestParsed,this),hls.off(Events1.LEVELS_UPDATED,this.onLevelsUpdated,this),hls.off(Events1.BUFFER_CODECS,this.onBufferCodecs,this),hls.off(Events1.MEDIA_DETACHING,this.onMediaDetaching,this)}onFpsDropLevelCapping(event,data){let level=this.hls.levels[data.droppedLevel];this.isLevelAllowed(level)&&this.restrictedLevels.push({bitrate:level.bitrate,height:level.height,width:level.width})}onMediaAttaching(event,data){this.media=data.media instanceof HTMLVideoElement?data.media:null,this.clientRect=null,this.timer&&this.hls.levels.length&&this.detectPlayerSize()}onManifestParsed(event,data){let hls=this.hls;this.restrictedLevels=[],this.firstLevel=data.firstLevel,hls.config.capLevelToPlayerSize&&data.video&&this.startCapping()}onLevelsUpdated(event,data){this.timer&&isFiniteNumber(this.autoLevelCapping)&&this.detectPlayerSize()}onBufferCodecs(event,data){this.hls.config.capLevelToPlayerSize&&data.video&&this.startCapping()}onMediaDetaching(){this.stopCapping()}detectPlayerSize(){if(this.media){if(this.mediaHeight<=0||this.mediaWidth<=0){this.clientRect=null;return}let levels=this.hls.levels;if(levels.length){let hls=this.hls,maxLevel=this.getMaxLevel(levels.length-1);maxLevel!==this.autoLevelCapping&&logger.log(`Setting autoLevelCapping to ${maxLevel}: ${levels[maxLevel].height}p@${levels[maxLevel].bitrate} for media ${this.mediaWidth}x${this.mediaHeight}`),hls.autoLevelCapping=maxLevel,hls.autoLevelCapping>this.autoLevelCapping&&this.streamController&&this.streamController.nextLevelSwitch(),this.autoLevelCapping=hls.autoLevelCapping}}}getMaxLevel(capLevelIndex){let levels=this.hls.levels;if(!levels.length)return -1;let validLevels=levels.filter((level,index)=>this.isLevelAllowed(level)&&index<=capLevelIndex);return this.clientRect=null,CapLevelController.getMaxLevelByMediaSize(validLevels,this.mediaWidth,this.mediaHeight)}startCapping(){this.timer||(this.autoLevelCapping=Number.POSITIVE_INFINITY,self.clearInterval(this.timer),this.timer=self.setInterval(this.detectPlayerSize.bind(this),1e3),this.detectPlayerSize())}stopCapping(){this.restrictedLevels=[],this.firstLevel=-1,this.autoLevelCapping=Number.POSITIVE_INFINITY,this.timer&&(self.clearInterval(this.timer),this.timer=void 0)}getDimensions(){if(this.clientRect)return this.clientRect;let media=this.media,boundsRect={width:0,height:0};if(media){let clientRect=media.getBoundingClientRect();boundsRect.width=clientRect.width,boundsRect.height=clientRect.height,boundsRect.width||boundsRect.height||(boundsRect.width=clientRect.right-clientRect.left||media.width||0,boundsRect.height=clientRect.bottom-clientRect.top||media.height||0)}return this.clientRect=boundsRect,boundsRect}get mediaWidth(){return this.getDimensions().width*this.contentScaleFactor}get mediaHeight(){return this.getDimensions().height*this.contentScaleFactor}get contentScaleFactor(){let pixelRatio=1;if(!this.hls.config.ignoreDevicePixelRatio)try{pixelRatio=self.devicePixelRatio}catch(e){}return pixelRatio}isLevelAllowed(level){return!this.restrictedLevels.some(restrictedLevel=>level.bitrate===restrictedLevel.bitrate&&level.width===restrictedLevel.width&&level.height===restrictedLevel.height)}static getMaxLevelByMediaSize(levels,width,height){if(!(null!=levels&&levels.length))return -1;let atGreatestBandwidth=(curLevel,nextLevel)=>!nextLevel||curLevel.width!==nextLevel.width||curLevel.height!==nextLevel.height,maxLevelIndex=levels.length-1,squareSize=Math.max(width,height);for(let i=0;i<levels.length;i+=1){let level=levels[i];if((level.width>=squareSize||level.height>=squareSize)&&atGreatestBandwidth(level,levels[i+1])){maxLevelIndex=i;break}}return maxLevelIndex}}class FPSController{constructor(hls){this.hls=void 0,this.isVideoPlaybackQualityAvailable=!1,this.timer=void 0,this.media=null,this.lastTime=void 0,this.lastDroppedFrames=0,this.lastDecodedFrames=0,this.streamController=void 0,this.hls=hls,this.registerListeners()}setStreamController(streamController){this.streamController=streamController}registerListeners(){this.hls.on(Events1.MEDIA_ATTACHING,this.onMediaAttaching,this)}unregisterListeners(){this.hls.off(Events1.MEDIA_ATTACHING,this.onMediaAttaching,this)}destroy(){this.timer&&clearInterval(this.timer),this.unregisterListeners(),this.isVideoPlaybackQualityAvailable=!1,this.media=null}onMediaAttaching(event,data){let config=this.hls.config;if(config.capLevelOnFPSDrop){let media=data.media instanceof self.HTMLVideoElement?data.media:null;this.media=media,media&&"function"==typeof media.getVideoPlaybackQuality&&(this.isVideoPlaybackQualityAvailable=!0),self.clearInterval(this.timer),this.timer=self.setInterval(this.checkFPSInterval.bind(this),config.fpsDroppedMonitoringPeriod)}}checkFPS(video,decodedFrames,droppedFrames){let currentTime=performance.now();if(decodedFrames){if(this.lastTime){let currentPeriod=currentTime-this.lastTime,currentDropped=droppedFrames-this.lastDroppedFrames,currentDecoded=decodedFrames-this.lastDecodedFrames,droppedFPS=1e3*currentDropped/currentPeriod,hls=this.hls;if(hls.trigger(Events1.FPS_DROP,{currentDropped:currentDropped,currentDecoded:currentDecoded,totalDroppedFrames:droppedFrames}),droppedFPS>0&&currentDropped>hls.config.fpsDroppedMonitoringThreshold*currentDecoded){let currentLevel=hls.currentLevel;logger.warn("drop FPS ratio greater than max allowed value for currentLevel: "+currentLevel),currentLevel>0&&(-1===hls.autoLevelCapping||hls.autoLevelCapping>=currentLevel)&&(currentLevel-=1,hls.trigger(Events1.FPS_DROP_LEVEL_CAPPING,{level:currentLevel,droppedLevel:hls.currentLevel}),hls.autoLevelCapping=currentLevel,this.streamController.nextLevelSwitch())}}this.lastTime=currentTime,this.lastDroppedFrames=droppedFrames,this.lastDecodedFrames=decodedFrames}}checkFPSInterval(){let video=this.media;if(video){if(this.isVideoPlaybackQualityAvailable){let videoPlaybackQuality=video.getVideoPlaybackQuality();this.checkFPS(video,videoPlaybackQuality.totalVideoFrames,videoPlaybackQuality.droppedVideoFrames)}else this.checkFPS(video,video.webkitDecodedFrameCount,video.webkitDroppedFrameCount)}}}class ContentSteeringController{constructor(hls){this.hls=void 0,this.log=void 0,this.loader=null,this.uri=null,this.pathwayId=".",this.pathwayPriority=null,this.timeToLoad=300,this.reloadTimer=-1,this.updated=0,this.started=!1,this.enabled=!0,this.levels=null,this.audioTracks=null,this.subtitleTracks=null,this.penalizedPathways={},this.hls=hls,this.log=logger.log.bind(logger,"[content-steering]:"),this.registerListeners()}registerListeners(){let hls=this.hls;hls.on(Events1.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events1.MANIFEST_LOADED,this.onManifestLoaded,this),hls.on(Events1.MANIFEST_PARSED,this.onManifestParsed,this),hls.on(Events1.ERROR,this.onError,this)}unregisterListeners(){let hls=this.hls;hls&&(hls.off(Events1.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events1.MANIFEST_LOADED,this.onManifestLoaded,this),hls.off(Events1.MANIFEST_PARSED,this.onManifestParsed,this),hls.off(Events1.ERROR,this.onError,this))}startLoad(){if(this.started=!0,this.clearTimeout(),this.enabled&&this.uri){if(this.updated){let ttl=1e3*this.timeToLoad-(performance.now()-this.updated);if(ttl>0){this.scheduleRefresh(this.uri,ttl);return}}this.loadSteeringManifest(this.uri)}}stopLoad(){this.started=!1,this.loader&&(this.loader.destroy(),this.loader=null),this.clearTimeout()}clearTimeout(){-1!==this.reloadTimer&&(self.clearTimeout(this.reloadTimer),this.reloadTimer=-1)}destroy(){this.unregisterListeners(),this.stopLoad(),this.hls=null,this.levels=this.audioTracks=this.subtitleTracks=null}removeLevel(levelToRemove){let levels=this.levels;levels&&(this.levels=levels.filter(level=>level!==levelToRemove))}onManifestLoading(){this.stopLoad(),this.enabled=!0,this.timeToLoad=300,this.updated=0,this.uri=null,this.pathwayId=".",this.levels=this.audioTracks=this.subtitleTracks=null}onManifestLoaded(event,data){let{contentSteering}=data;null!==contentSteering&&(this.pathwayId=contentSteering.pathwayId,this.uri=contentSteering.uri,this.started&&this.startLoad())}onManifestParsed(event,data){this.audioTracks=data.audioTracks,this.subtitleTracks=data.subtitleTracks}onError(event,data){let{errorAction}=data;if((null==errorAction?void 0:errorAction.action)===NetworkErrorAction.SendAlternateToPenaltyBox&&errorAction.flags===ErrorActionFlags.MoveAllAlternatesMatchingHost){let levels=this.levels,pathwayPriority=this.pathwayPriority,errorPathway=this.pathwayId;if(data.context){let{groupId,pathwayId,type}=data.context;groupId&&levels?errorPathway=this.getPathwayForGroupId(groupId,type,errorPathway):pathwayId&&(errorPathway=pathwayId)}errorPathway in this.penalizedPathways||(this.penalizedPathways[errorPathway]=performance.now()),!pathwayPriority&&levels&&(pathwayPriority=levels.reduce((pathways,level)=>(-1===pathways.indexOf(level.pathwayId)&&pathways.push(level.pathwayId),pathways),[])),pathwayPriority&&pathwayPriority.length>1&&(this.updatePathwayPriority(pathwayPriority),errorAction.resolved=this.pathwayId!==errorPathway),errorAction.resolved||logger.warn(`Could not resolve ${data.details} ("${data.error.message}") with content-steering for Pathway: ${errorPathway} levels: ${levels?levels.length:levels} priorities: ${JSON.stringify(pathwayPriority)} penalized: ${JSON.stringify(this.penalizedPathways)}`)}}filterParsedLevels(levels){this.levels=levels;let pathwayLevels=this.getLevelsForPathway(this.pathwayId);if(0===pathwayLevels.length){let pathwayId=levels[0].pathwayId;this.log(`No levels found in Pathway ${this.pathwayId}. Setting initial Pathway to "${pathwayId}"`),pathwayLevels=this.getLevelsForPathway(pathwayId),this.pathwayId=pathwayId}return pathwayLevels.length!==levels.length?(this.log(`Found ${pathwayLevels.length}/${levels.length} levels in Pathway "${this.pathwayId}"`),pathwayLevels):levels}getLevelsForPathway(pathwayId){return null===this.levels?[]:this.levels.filter(level=>pathwayId===level.pathwayId)}updatePathwayPriority(pathwayPriority){let levels;this.pathwayPriority=pathwayPriority;let penalizedPathways=this.penalizedPathways,now=performance.now();Object.keys(penalizedPathways).forEach(pathwayId=>{now-penalizedPathways[pathwayId]>3e5&&delete penalizedPathways[pathwayId]});for(let i=0;i<pathwayPriority.length;i++){let pathwayId=pathwayPriority[i];if(pathwayId in penalizedPathways)continue;if(pathwayId===this.pathwayId)return;let selectedIndex=this.hls.nextLoadLevel,selectedLevel=this.hls.levels[selectedIndex];if((levels=this.getLevelsForPathway(pathwayId)).length>0){this.log(`Setting Pathway to "${pathwayId}"`),this.pathwayId=pathwayId,reassignFragmentLevelIndexes(levels),this.hls.trigger(Events1.LEVELS_UPDATED,{levels});let levelAfterChange=this.hls.levels[selectedIndex];selectedLevel&&levelAfterChange&&this.levels&&(levelAfterChange.attrs["STABLE-VARIANT-ID"]!==selectedLevel.attrs["STABLE-VARIANT-ID"]&&levelAfterChange.bitrate!==selectedLevel.bitrate&&this.log(`Unstable Pathways change from bitrate ${selectedLevel.bitrate} to ${levelAfterChange.bitrate}`),this.hls.nextLoadLevel=selectedIndex);break}}}getPathwayForGroupId(groupId,type,defaultPathway){let levels=this.getLevelsForPathway(defaultPathway).concat(this.levels||[]);for(let i=0;i<levels.length;i++)if(type===PlaylistContextType.AUDIO_TRACK&&levels[i].hasAudioGroup(groupId)||type===PlaylistContextType.SUBTITLE_TRACK&&levels[i].hasSubtitleGroup(groupId))return levels[i].pathwayId;return defaultPathway}clonePathways(pathwayClones){let levels=this.levels;if(!levels)return;let audioGroupCloneMap={},subtitleGroupCloneMap={};pathwayClones.forEach(pathwayClone=>{let{ID:cloneId,"BASE-ID":baseId,"URI-REPLACEMENT":uriReplacement}=pathwayClone;if(levels.some(level=>level.pathwayId===cloneId))return;let clonedVariants=this.getLevelsForPathway(baseId).map(baseLevel=>{let attributes=new AttrList(baseLevel.attrs);attributes["PATHWAY-ID"]=cloneId;let clonedAudioGroupId=attributes.AUDIO&&`${attributes.AUDIO}_clone_${cloneId}`,clonedSubtitleGroupId=attributes.SUBTITLES&&`${attributes.SUBTITLES}_clone_${cloneId}`;clonedAudioGroupId&&(audioGroupCloneMap[attributes.AUDIO]=clonedAudioGroupId,attributes.AUDIO=clonedAudioGroupId),clonedSubtitleGroupId&&(subtitleGroupCloneMap[attributes.SUBTITLES]=clonedSubtitleGroupId,attributes.SUBTITLES=clonedSubtitleGroupId);let url=performUriReplacement(baseLevel.uri,attributes["STABLE-VARIANT-ID"],"PER-VARIANT-URIS",uriReplacement),clonedLevel=new Level({attrs:attributes,audioCodec:baseLevel.audioCodec,bitrate:baseLevel.bitrate,height:baseLevel.height,name:baseLevel.name,url,videoCodec:baseLevel.videoCodec,width:baseLevel.width});if(baseLevel.audioGroups)for(let i=1;i<baseLevel.audioGroups.length;i++)clonedLevel.addGroupId("audio",`${baseLevel.audioGroups[i]}_clone_${cloneId}`);if(baseLevel.subtitleGroups)for(let i=1;i<baseLevel.subtitleGroups.length;i++)clonedLevel.addGroupId("text",`${baseLevel.subtitleGroups[i]}_clone_${cloneId}`);return clonedLevel});levels.push(...clonedVariants),cloneRenditionGroups(this.audioTracks,audioGroupCloneMap,uriReplacement,cloneId),cloneRenditionGroups(this.subtitleTracks,subtitleGroupCloneMap,uriReplacement,cloneId)})}loadSteeringManifest(uri){let url;let config=this.hls.config,Loader=config.loader;this.loader&&this.loader.destroy(),this.loader=new Loader(config);try{url=new self.URL(uri)}catch(error){this.enabled=!1,this.log(`Failed to parse Steering Manifest URI: ${uri}`);return}if("data:"!==url.protocol){let throughput=0|(this.hls.bandwidthEstimate||config.abrEwmaDefaultEstimate);url.searchParams.set("_HLS_pathway",this.pathwayId),url.searchParams.set("_HLS_throughput",""+throughput)}let context={responseType:"json",url:url.href},loadPolicy=config.steeringManifestLoadPolicy.default,legacyRetryCompatibility=loadPolicy.errorRetry||loadPolicy.timeoutRetry||{},loaderConfig={loadPolicy,timeout:loadPolicy.maxLoadTimeMs,maxRetry:legacyRetryCompatibility.maxNumRetry||0,retryDelay:legacyRetryCompatibility.retryDelayMs||0,maxRetryDelay:legacyRetryCompatibility.maxRetryDelayMs||0};this.log(`Requesting steering manifest: ${url}`),this.loader.load(context,loaderConfig,{onSuccess:(response,stats,context,networkDetails)=>{this.log(`Loaded steering manifest: "${url}"`);let steeringData=response.data;if(1!==steeringData.VERSION){this.log(`Steering VERSION ${steeringData.VERSION} not supported!`);return}this.updated=performance.now(),this.timeToLoad=steeringData.TTL;let{"RELOAD-URI":reloadUri,"PATHWAY-CLONES":pathwayClones,"PATHWAY-PRIORITY":pathwayPriority}=steeringData;if(reloadUri)try{this.uri=new self.URL(reloadUri,url).href}catch(error){this.enabled=!1,this.log(`Failed to parse Steering Manifest RELOAD-URI: ${reloadUri}`);return}this.scheduleRefresh(this.uri||context.url),pathwayClones&&this.clonePathways(pathwayClones);let loadedSteeringData={steeringManifest:steeringData,url:url.toString()};this.hls.trigger(Events1.STEERING_MANIFEST_LOADED,loadedSteeringData),pathwayPriority&&this.updatePathwayPriority(pathwayPriority)},onError:(error,context,networkDetails,stats)=>{if(this.log(`Error loading steering manifest: ${error.code} ${error.text} (${context.url})`),this.stopLoad(),410===error.code){this.enabled=!1,this.log(`Steering manifest ${context.url} no longer available`);return}let ttl=1e3*this.timeToLoad;if(429===error.code){let loader=this.loader;if("function"==typeof(null==loader?void 0:loader.getResponseHeader)){let retryAfter=loader.getResponseHeader("Retry-After");retryAfter&&(ttl=1e3*parseFloat(retryAfter))}this.log(`Steering manifest ${context.url} rate limited`);return}this.scheduleRefresh(this.uri||context.url,ttl)},onTimeout:(stats,context,networkDetails)=>{this.log(`Timeout loading steering manifest (${context.url})`),this.scheduleRefresh(this.uri||context.url)}})}scheduleRefresh(uri,ttlMs=1e3*this.timeToLoad){this.clearTimeout(),this.reloadTimer=self.setTimeout(()=>{var _this$hls;let media=null==(_this$hls=this.hls)?void 0:_this$hls.media;if(media&&!media.ended){this.loadSteeringManifest(uri);return}this.scheduleRefresh(uri,1e3*this.timeToLoad)},ttlMs)}}function cloneRenditionGroups(tracks,groupCloneMap,uriReplacement,cloneId){tracks&&Object.keys(groupCloneMap).forEach(audioGroupId=>{let clonedTracks=tracks.filter(track=>track.groupId===audioGroupId).map(track=>{let clonedTrack=_extends({},track);return clonedTrack.details=void 0,clonedTrack.attrs=new AttrList(clonedTrack.attrs),clonedTrack.url=clonedTrack.attrs.URI=performUriReplacement(track.url,track.attrs["STABLE-RENDITION-ID"],"PER-RENDITION-URIS",uriReplacement),clonedTrack.groupId=clonedTrack.attrs["GROUP-ID"]=groupCloneMap[audioGroupId],clonedTrack.attrs["PATHWAY-ID"]=cloneId,clonedTrack});tracks.push(...clonedTracks)})}function performUriReplacement(uri,stableId,perOptionKey,uriReplacement){let perVariantUri;let{HOST:host,PARAMS:params,[perOptionKey]:perOptionUris}=uriReplacement;stableId&&(perVariantUri=null==perOptionUris?void 0:perOptionUris[stableId])&&(uri=perVariantUri);let url=new self.URL(uri);return host&&!perVariantUri&&(url.host=host),params&&Object.keys(params).sort().forEach(key=>{key&&url.searchParams.set(key,params[key])}),url.href}let AGE_HEADER_LINE_REGEX=/^age:\s*[\d.]+\s*$/im;class XhrLoader{constructor(config){this.xhrSetup=void 0,this.requestTimeout=void 0,this.retryTimeout=void 0,this.retryDelay=void 0,this.config=null,this.callbacks=null,this.context=null,this.loader=null,this.stats=void 0,this.xhrSetup=config&&config.xhrSetup||null,this.stats=new LoadStats,this.retryDelay=0}destroy(){this.callbacks=null,this.abortInternal(),this.loader=null,this.config=null,this.context=null,this.xhrSetup=null}abortInternal(){let loader=this.loader;self.clearTimeout(this.requestTimeout),self.clearTimeout(this.retryTimeout),loader&&(loader.onreadystatechange=null,loader.onprogress=null,4!==loader.readyState&&(this.stats.aborted=!0,loader.abort()))}abort(){var _this$callbacks;this.abortInternal(),null!=(_this$callbacks=this.callbacks)&&_this$callbacks.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.loader)}load(context,config,callbacks){if(this.stats.loading.start)throw Error("Loader can only be used once.");this.stats.loading.start=self.performance.now(),this.context=context,this.config=config,this.callbacks=callbacks,this.loadInternal()}loadInternal(){let{config,context}=this;if(!config||!context)return;let xhr=this.loader=new self.XMLHttpRequest,stats=this.stats;stats.loading.first=0,stats.loaded=0,stats.aborted=!1;let xhrSetup=this.xhrSetup;xhrSetup?Promise.resolve().then(()=>{if(this.loader===xhr&&!this.stats.aborted)return xhrSetup(xhr,context.url)}).catch(error=>{if(this.loader===xhr&&!this.stats.aborted)return xhr.open("GET",context.url,!0),xhrSetup(xhr,context.url)}).then(()=>{this.loader!==xhr||this.stats.aborted||this.openAndSendXhr(xhr,context,config)}).catch(error=>{this.callbacks.onError({code:xhr.status,text:error.message},context,xhr,stats)}):this.openAndSendXhr(xhr,context,config)}openAndSendXhr(xhr,context,config){xhr.readyState||xhr.open("GET",context.url,!0);let headers=context.headers,{maxTimeToFirstByteMs,maxLoadTimeMs}=config.loadPolicy;if(headers)for(let header in headers)xhr.setRequestHeader(header,headers[header]);context.rangeEnd&&xhr.setRequestHeader("Range","bytes="+context.rangeStart+"-"+(context.rangeEnd-1)),xhr.onreadystatechange=this.readystatechange.bind(this),xhr.onprogress=this.loadprogress.bind(this),xhr.responseType=context.responseType,self.clearTimeout(this.requestTimeout),config.timeout=maxTimeToFirstByteMs&&isFiniteNumber(maxTimeToFirstByteMs)?maxTimeToFirstByteMs:maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),config.timeout),xhr.send()}readystatechange(){let{context,loader:xhr,stats}=this;if(!context||!xhr)return;let readyState=xhr.readyState,config=this.config;if(!stats.aborted&&readyState>=2&&(0===stats.loading.first&&(stats.loading.first=Math.max(self.performance.now(),stats.loading.start),config.timeout!==config.loadPolicy.maxLoadTimeMs&&(self.clearTimeout(this.requestTimeout),config.timeout=config.loadPolicy.maxLoadTimeMs,this.requestTimeout=self.setTimeout(this.loadtimeout.bind(this),config.loadPolicy.maxLoadTimeMs-(stats.loading.first-stats.loading.start)))),4===readyState)){self.clearTimeout(this.requestTimeout),xhr.onreadystatechange=null,xhr.onprogress=null;let status1=xhr.status,useResponse="text"!==xhr.responseType;if(status1>=200&&status1<300&&(useResponse&&xhr.response||null!==xhr.responseText)){stats.loading.end=Math.max(self.performance.now(),stats.loading.first);let data=useResponse?xhr.response:xhr.responseText,len="arraybuffer"===xhr.responseType?data.byteLength:data.length;if(stats.loaded=stats.total=len,stats.bwEstimate=8e3*stats.total/(stats.loading.end-stats.loading.first),!this.callbacks)return;let onProgress=this.callbacks.onProgress;if(onProgress&&onProgress(stats,context,data,xhr),!this.callbacks)return;let response={url:xhr.responseURL,data:data,code:status1};this.callbacks.onSuccess(response,stats,context,xhr)}else{let retryConfig=config.loadPolicy.errorRetry;shouldRetry(retryConfig,stats.retry,!1,{url:context.url,data:void 0,code:status1})?this.retry(retryConfig):(logger.error(`${status1} while loading ${context.url}`),this.callbacks.onError({code:status1,text:xhr.statusText},context,xhr,stats))}}}loadtimeout(){if(!this.config)return;let retryConfig=this.config.loadPolicy.timeoutRetry;if(shouldRetry(retryConfig,this.stats.retry,!0))this.retry(retryConfig);else{var _this$context;logger.warn(`timeout while loading ${null==(_this$context=this.context)?void 0:_this$context.url}`);let callbacks=this.callbacks;callbacks&&(this.abortInternal(),callbacks.onTimeout(this.stats,this.context,this.loader))}}retry(retryConfig){let{context,stats}=this;this.retryDelay=getRetryDelay(retryConfig,stats.retry),stats.retry++,logger.warn(`${status?"HTTP Status "+status:"Timeout"} while loading ${null==context?void 0:context.url}, retrying ${stats.retry}/${retryConfig.maxNumRetry} in ${this.retryDelay}ms`),this.abortInternal(),this.loader=null,self.clearTimeout(this.retryTimeout),this.retryTimeout=self.setTimeout(this.loadInternal.bind(this),this.retryDelay)}loadprogress(event){let stats=this.stats;stats.loaded=event.loaded,event.lengthComputable&&(stats.total=event.total)}getCacheAge(){let result=null;if(this.loader&&AGE_HEADER_LINE_REGEX.test(this.loader.getAllResponseHeaders())){let ageHeader=this.loader.getResponseHeader("age");result=ageHeader?parseFloat(ageHeader):null}return result}getResponseHeader(name){return this.loader&&RegExp(`^${name}:\\s*[\\d.]+\\s*$`,"im").test(this.loader.getAllResponseHeaders())?this.loader.getResponseHeader(name):null}}class ChunkCache{constructor(){this.chunks=[],this.dataLength=0}push(chunk){this.chunks.push(chunk),this.dataLength+=chunk.length}flush(){let result;let{chunks,dataLength}=this;return chunks.length?(result=1===chunks.length?chunks[0]:concatUint8Arrays(chunks,dataLength),this.reset(),result):new Uint8Array(0)}reset(){this.chunks.length=0,this.dataLength=0}}function concatUint8Arrays(chunks,dataLength){let result=new Uint8Array(dataLength),offset=0;for(let i=0;i<chunks.length;i++){let chunk=chunks[i];result.set(chunk,offset),offset+=chunk.length}return result}function fetchSupported(){if(self.fetch&&self.AbortController&&self.ReadableStream&&self.Request)try{return new self.ReadableStream({}),!0}catch(e){}return!1}let BYTERANGE=/(\d+)-(\d+)\/(\d+)/;class FetchLoader{constructor(config){this.fetchSetup=void 0,this.requestTimeout=void 0,this.request=null,this.response=null,this.controller=void 0,this.context=null,this.config=null,this.callbacks=null,this.stats=void 0,this.loader=null,this.fetchSetup=config.fetchSetup||getRequest,this.controller=new self.AbortController,this.stats=new LoadStats}destroy(){this.loader=this.callbacks=this.context=this.config=this.request=null,this.abortInternal(),this.response=null,this.fetchSetup=this.controller=this.stats=null}abortInternal(){this.controller&&!this.stats.loading.end&&(this.stats.aborted=!0,this.controller.abort())}abort(){var _this$callbacks;this.abortInternal(),null!=(_this$callbacks=this.callbacks)&&_this$callbacks.onAbort&&this.callbacks.onAbort(this.stats,this.context,this.response)}load(context,config,callbacks){let stats=this.stats;if(stats.loading.start)throw Error("Loader can only be used once.");stats.loading.start=self.performance.now();let initParams=getRequestParameters(context,this.controller.signal),onProgress=callbacks.onProgress,isArrayBuffer="arraybuffer"===context.responseType,LENGTH=isArrayBuffer?"byteLength":"length",{maxTimeToFirstByteMs,maxLoadTimeMs}=config.loadPolicy;this.context=context,this.config=config,this.callbacks=callbacks,this.request=this.fetchSetup(context,initParams),self.clearTimeout(this.requestTimeout),config.timeout=maxTimeToFirstByteMs&&isFiniteNumber(maxTimeToFirstByteMs)?maxTimeToFirstByteMs:maxLoadTimeMs,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),callbacks.onTimeout(stats,context,this.response)},config.timeout),self.fetch(this.request).then(response=>{this.response=this.loader=response;let first=Math.max(self.performance.now(),stats.loading.start);if(self.clearTimeout(this.requestTimeout),config.timeout=maxLoadTimeMs,this.requestTimeout=self.setTimeout(()=>{this.abortInternal(),callbacks.onTimeout(stats,context,this.response)},maxLoadTimeMs-(first-stats.loading.start)),!response.ok){let{status:status1,statusText}=response;throw new FetchError(statusText||"fetch, bad network response",status1,response)}return(stats.loading.first=first,stats.total=getContentLength(response.headers)||stats.total,onProgress&&isFiniteNumber(config.highWaterMark))?this.loadProgressively(response,stats,context,config.highWaterMark,onProgress):isArrayBuffer?response.arrayBuffer():"json"===context.responseType?response.json():response.text()}).then(responseData=>{let response=this.response;if(!response)throw Error("loader destroyed");self.clearTimeout(this.requestTimeout),stats.loading.end=Math.max(self.performance.now(),stats.loading.first);let total=responseData[LENGTH];total&&(stats.loaded=stats.total=total);let loaderResponse={url:response.url,data:responseData,code:response.status};onProgress&&!isFiniteNumber(config.highWaterMark)&&onProgress(stats,context,responseData,response),callbacks.onSuccess(loaderResponse,stats,context,response)}).catch(error=>{if(self.clearTimeout(this.requestTimeout),stats.aborted)return;let code=error&&error.code||0,text=error?error.message:null;callbacks.onError({code,text},context,error?error.details:null,stats)})}getCacheAge(){let result=null;if(this.response){let ageHeader=this.response.headers.get("age");result=ageHeader?parseFloat(ageHeader):null}return result}getResponseHeader(name){return this.response?this.response.headers.get(name):null}loadProgressively(response,stats,context,highWaterMark=0,onProgress){let chunkCache=new ChunkCache,reader=response.body.getReader(),pump=()=>reader.read().then(data=>{if(data.done)return chunkCache.dataLength&&onProgress(stats,context,chunkCache.flush(),response),Promise.resolve(new ArrayBuffer(0));let chunk=data.value,len=chunk.length;return stats.loaded+=len,len<highWaterMark||chunkCache.dataLength?(chunkCache.push(chunk),chunkCache.dataLength>=highWaterMark&&onProgress(stats,context,chunkCache.flush(),response)):onProgress(stats,context,chunk,response),pump()}).catch(()=>Promise.reject());return pump()}}function getRequestParameters(context,signal){let initParams={method:"GET",mode:"cors",credentials:"same-origin",signal,headers:new self.Headers(_extends({},context.headers))};return context.rangeEnd&&initParams.headers.set("Range","bytes="+context.rangeStart+"-"+String(context.rangeEnd-1)),initParams}function getByteRangeLength(byteRangeHeader){let result=BYTERANGE.exec(byteRangeHeader);if(result)return parseInt(result[2])-parseInt(result[1])+1}function getContentLength(headers){let contentRange=headers.get("Content-Range");if(contentRange){let byteRangeLength=getByteRangeLength(contentRange);if(isFiniteNumber(byteRangeLength))return byteRangeLength}let contentLength=headers.get("Content-Length");if(contentLength)return parseInt(contentLength)}function getRequest(context,initParams){return new self.Request(context.url,initParams)}class FetchError extends Error{constructor(message,code,details){super(message),this.code=void 0,this.details=void 0,this.code=code,this.details=details}}let hlsDefaultConfig=_objectSpread2(_objectSpread2({autoStartLoad:!0,startPosition:-1,defaultAudioCodec:void 0,debug:!1,capLevelOnFPSDrop:!1,capLevelToPlayerSize:!1,ignoreDevicePixelRatio:!1,preferManagedMediaSource:!0,initialLiveManifestSize:1,maxBufferLength:30,backBufferLength:1/0,frontBufferFlushThreshold:1/0,maxBufferSize:6e7,maxBufferHole:.1,highBufferWatchdogPeriod:2,nudgeOffset:.1,nudgeMaxRetry:3,maxFragLookUpTolerance:.25,liveSyncDurationCount:3,liveMaxLatencyDurationCount:1/0,liveSyncDuration:void 0,liveMaxLatencyDuration:void 0,maxLiveSyncPlaybackRate:1,liveDurationInfinity:!1,liveBackBufferLength:null,maxMaxBufferLength:600,enableWorker:!0,workerPath:null,enableSoftwareAES:!0,startLevel:void 0,startFragPrefetch:!1,fpsDroppedMonitoringPeriod:5e3,fpsDroppedMonitoringThreshold:.2,appendErrorMaxRetry:3,loader:XhrLoader,fLoader:void 0,pLoader:void 0,xhrSetup:void 0,licenseXhrSetup:void 0,licenseResponseCallback:void 0,abrController:AbrController,bufferController:BufferController,capLevelController:CapLevelController,errorController:ErrorController,fpsController:FPSController,stretchShortVideoTrack:!1,maxAudioFramesDrift:1,forceKeyFrameOnDiscontinuity:!0,abrEwmaFastLive:3,abrEwmaSlowLive:9,abrEwmaFastVoD:3,abrEwmaSlowVoD:9,abrEwmaDefaultEstimate:5e5,abrEwmaDefaultEstimateMax:5e6,abrBandWidthFactor:.95,abrBandWidthUpFactor:.7,abrMaxWithRealBitrate:!1,maxStarvationDelay:4,maxLoadingDelay:4,minAutoBitrate:0,emeEnabled:!1,widevineLicenseUrl:void 0,drmSystems:{},drmSystemOptions:{},requestMediaKeySystemAccessFunc:null,testBandwidth:!0,progressive:!1,lowLatencyMode:!0,cmcd:void 0,enableDateRangeMetadataCues:!0,enableEmsgMetadataCues:!0,enableID3MetadataCues:!0,useMediaCapabilities:!1,certLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:null,errorRetry:null}},keyLoadPolicy:{default:{maxTimeToFirstByteMs:8e3,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"},errorRetry:{maxNumRetry:8,retryDelayMs:1e3,maxRetryDelayMs:2e4,backoff:"linear"}}},manifestLoadPolicy:{default:{maxTimeToFirstByteMs:1/0,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},playlistLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:2,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},fragLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:12e4,timeoutRetry:{maxNumRetry:4,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:6,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},steeringManifestLoadPolicy:{default:{maxTimeToFirstByteMs:1e4,maxLoadTimeMs:2e4,timeoutRetry:{maxNumRetry:2,retryDelayMs:0,maxRetryDelayMs:0},errorRetry:{maxNumRetry:1,retryDelayMs:1e3,maxRetryDelayMs:8e3}}},manifestLoadingTimeOut:1e4,manifestLoadingMaxRetry:1,manifestLoadingRetryDelay:1e3,manifestLoadingMaxRetryTimeout:64e3,levelLoadingTimeOut:1e4,levelLoadingMaxRetry:4,levelLoadingRetryDelay:1e3,levelLoadingMaxRetryTimeout:64e3,fragLoadingTimeOut:2e4,fragLoadingMaxRetry:6,fragLoadingRetryDelay:1e3,fragLoadingMaxRetryTimeout:64e3},timelineConfig()),{},{subtitleStreamController:void 0,subtitleTrackController:void 0,timelineController:void 0,audioStreamController:void 0,audioTrackController:void 0,emeController:void 0,cmcdController:void 0,contentSteeringController:ContentSteeringController});function timelineConfig(){return{cueHandler:Cues,enableWebVTT:!1,enableIMSC1:!1,enableCEA708Captions:!1,captionsTextTrack1Label:"English",captionsTextTrack1LanguageCode:"en",captionsTextTrack2Label:"Spanish",captionsTextTrack2LanguageCode:"es",captionsTextTrack3Label:"Unknown CC",captionsTextTrack3LanguageCode:"",captionsTextTrack4Label:"Unknown CC",captionsTextTrack4LanguageCode:"",renderTextTracksNatively:!0}}function mergeConfig(defaultConfig,userConfig){if((userConfig.liveSyncDurationCount||userConfig.liveMaxLatencyDurationCount)&&(userConfig.liveSyncDuration||userConfig.liveMaxLatencyDuration))throw Error("Illegal hls.js config: don't mix up liveSyncDurationCount/liveMaxLatencyDurationCount and liveSyncDuration/liveMaxLatencyDuration");if(void 0!==userConfig.liveMaxLatencyDurationCount&&(void 0===userConfig.liveSyncDurationCount||userConfig.liveMaxLatencyDurationCount<=userConfig.liveSyncDurationCount))throw Error('Illegal hls.js config: "liveMaxLatencyDurationCount" must be greater than "liveSyncDurationCount"');if(void 0!==userConfig.liveMaxLatencyDuration&&(void 0===userConfig.liveSyncDuration||userConfig.liveMaxLatencyDuration<=userConfig.liveSyncDuration))throw Error('Illegal hls.js config: "liveMaxLatencyDuration" must be greater than "liveSyncDuration"');let defaultsCopy=deepCpy(defaultConfig),deprecatedSettings=["TimeOut","MaxRetry","RetryDelay","MaxRetryTimeout"];return["manifest","level","frag"].forEach(type=>{let policyName=`${"level"===type?"playlist":type}LoadPolicy`,policyNotSet=void 0===userConfig[policyName],report=[];deprecatedSettings.forEach(setting=>{let deprecatedSetting=`${type}Loading${setting}`,value=userConfig[deprecatedSetting];if(void 0!==value&&policyNotSet){report.push(deprecatedSetting);let settings=defaultsCopy[policyName].default;switch(userConfig[policyName]={default:settings},setting){case"TimeOut":settings.maxLoadTimeMs=value,settings.maxTimeToFirstByteMs=value;break;case"MaxRetry":settings.errorRetry.maxNumRetry=value,settings.timeoutRetry.maxNumRetry=value;break;case"RetryDelay":settings.errorRetry.retryDelayMs=value,settings.timeoutRetry.retryDelayMs=value;break;case"MaxRetryTimeout":settings.errorRetry.maxRetryDelayMs=value,settings.timeoutRetry.maxRetryDelayMs=value}}}),report.length&&logger.warn(`hls.js config: "${report.join('", "')}" setting(s) are deprecated, use "${policyName}": ${JSON.stringify(userConfig[policyName])}`)}),_objectSpread2(_objectSpread2({},defaultsCopy),userConfig)}function deepCpy(obj){return obj&&"object"==typeof obj?Array.isArray(obj)?obj.map(deepCpy):Object.keys(obj).reduce((result,key)=>(result[key]=deepCpy(obj[key]),result),{}):obj}function enableStreamingMode(config){let currentLoader=config.loader;currentLoader!==FetchLoader&&currentLoader!==XhrLoader?(logger.log("[config]: Custom loader detected, cannot enable progressive streaming"),config.progressive=!1):fetchSupported()&&(config.loader=FetchLoader,config.progressive=!0,config.enableSoftwareAES=!0,logger.log("[config]: Progressive streaming enabled, using FetchLoader"))}class LevelController extends BasePlaylistController{constructor(hls,contentSteeringController){super(hls,"[level-controller]"),this._levels=[],this._firstLevel=-1,this._maxAutoLevel=-1,this._startLevel=void 0,this.currentLevel=null,this.currentLevelIndex=-1,this.manualLevelIndex=-1,this.steering=void 0,this.onParsedComplete=void 0,this.steering=contentSteeringController,this._registerListeners()}_registerListeners(){let{hls}=this;hls.on(Events1.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events1.MANIFEST_LOADED,this.onManifestLoaded,this),hls.on(Events1.LEVEL_LOADED,this.onLevelLoaded,this),hls.on(Events1.LEVELS_UPDATED,this.onLevelsUpdated,this),hls.on(Events1.FRAG_BUFFERED,this.onFragBuffered,this),hls.on(Events1.ERROR,this.onError,this)}_unregisterListeners(){let{hls}=this;hls.off(Events1.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events1.MANIFEST_LOADED,this.onManifestLoaded,this),hls.off(Events1.LEVEL_LOADED,this.onLevelLoaded,this),hls.off(Events1.LEVELS_UPDATED,this.onLevelsUpdated,this),hls.off(Events1.FRAG_BUFFERED,this.onFragBuffered,this),hls.off(Events1.ERROR,this.onError,this)}destroy(){this._unregisterListeners(),this.steering=null,this.resetLevels(),super.destroy()}stopLoad(){this._levels.forEach(level=>{level.loadError=0,level.fragmentError=0}),super.stopLoad()}resetLevels(){this._startLevel=void 0,this.manualLevelIndex=-1,this.currentLevelIndex=-1,this.currentLevel=null,this._levels=[],this._maxAutoLevel=-1}onManifestLoading(event,data){this.resetLevels()}onManifestLoaded(event,data){let preferManagedMediaSource=this.hls.config.preferManagedMediaSource,levels=[],redundantSet={},generatePathwaySet={},resolutionFound=!1,videoCodecFound=!1,audioCodecFound=!1;data.levels.forEach(levelParsed=>{var _audioCodec,_videoCodec;let attributes=levelParsed.attrs,{audioCodec,videoCodec}=levelParsed;(null==(_audioCodec=audioCodec)?void 0:_audioCodec.indexOf("mp4a.40.34"))!==-1&&(chromeOrFirefox||(chromeOrFirefox=/chrome|firefox/i.test(navigator.userAgent)),chromeOrFirefox&&(levelParsed.audioCodec=audioCodec=void 0)),audioCodec&&(levelParsed.audioCodec=audioCodec=getCodecCompatibleName(audioCodec,preferManagedMediaSource)),(null==(_videoCodec=videoCodec)?void 0:_videoCodec.indexOf("avc1"))===0&&(videoCodec=levelParsed.videoCodec=convertAVC1ToAVCOTI(videoCodec));let{width,height,unknownCodecs}=levelParsed;if(resolutionFound||(resolutionFound=!!(width&&height)),videoCodecFound||(videoCodecFound=!!videoCodec),audioCodecFound||(audioCodecFound=!!audioCodec),null!=unknownCodecs&&unknownCodecs.length||audioCodec&&!areCodecsMediaSourceSupported(audioCodec,"audio",preferManagedMediaSource)||videoCodec&&!areCodecsMediaSourceSupported(videoCodec,"video",preferManagedMediaSource))return;let{CODECS,"FRAME-RATE":FRAMERATE,"HDCP-LEVEL":HDCP,"PATHWAY-ID":PATHWAY,RESOLUTION,"VIDEO-RANGE":VIDEO_RANGE}=attributes,contentSteeringPrefix=`${PATHWAY||"."}-`,levelKey=`${contentSteeringPrefix}${levelParsed.bitrate}-${RESOLUTION}-${FRAMERATE}-${CODECS}-${VIDEO_RANGE}-${HDCP}`;if(redundantSet[levelKey]){if(redundantSet[levelKey].uri===levelParsed.url||levelParsed.attrs["PATHWAY-ID"])redundantSet[levelKey].addGroupId("audio",attributes.AUDIO),redundantSet[levelKey].addGroupId("text",attributes.SUBTITLES);else{let pathwayCount=generatePathwaySet[levelKey]+=1;levelParsed.attrs["PATHWAY-ID"]=Array(pathwayCount+1).join(".");let level=new Level(levelParsed);redundantSet[levelKey]=level,levels.push(level)}}else{let level=new Level(levelParsed);redundantSet[levelKey]=level,generatePathwaySet[levelKey]=1,levels.push(level)}}),this.filterAndSortMediaOptions(levels,data,resolutionFound,videoCodecFound,audioCodecFound)}filterAndSortMediaOptions(filteredLevels,data,resolutionFound,videoCodecFound,audioCodecFound){let audioTracks=[],subtitleTracks=[],levels=filteredLevels;if((resolutionFound||videoCodecFound)&&audioCodecFound&&(levels=levels.filter(({videoCodec,videoRange,width,height})=>(!!videoCodec||!!(width&&height))&&isVideoRange(videoRange))),0===levels.length){Promise.resolve().then(()=>{if(this.hls){data.levels.length&&this.warn(`One or more CODECS in variant not supported: ${JSON.stringify(data.levels[0].attrs)}`);let error=Error("no level with compatible codecs found in manifest");this.hls.trigger(Events1.ERROR,{type:ErrorTypes1.MEDIA_ERROR,details:ErrorDetails1.MANIFEST_INCOMPATIBLE_CODECS_ERROR,fatal:!0,url:data.url,error,reason:error.message})}});return}if(data.audioTracks){let{preferManagedMediaSource}=this.hls.config;assignTrackIdsByGroup(audioTracks=data.audioTracks.filter(track=>!track.audioCodec||areCodecsMediaSourceSupported(track.audioCodec,"audio",preferManagedMediaSource)))}data.subtitles&&assignTrackIdsByGroup(subtitleTracks=data.subtitles);let unsortedLevels=levels.slice(0);levels.sort((a,b)=>{if(a.attrs["HDCP-LEVEL"]!==b.attrs["HDCP-LEVEL"])return(a.attrs["HDCP-LEVEL"]||"")>(b.attrs["HDCP-LEVEL"]||"")?1:-1;if(resolutionFound&&a.height!==b.height)return a.height-b.height;if(a.frameRate!==b.frameRate)return a.frameRate-b.frameRate;if(a.videoRange!==b.videoRange)return VideoRangeValues.indexOf(a.videoRange)-VideoRangeValues.indexOf(b.videoRange);if(a.videoCodec!==b.videoCodec){let valueA=videoCodecPreferenceValue(a.videoCodec),valueB=videoCodecPreferenceValue(b.videoCodec);if(valueA!==valueB)return valueB-valueA}if(a.uri===b.uri&&a.codecSet!==b.codecSet){let valueA=codecsSetSelectionPreferenceValue(a.codecSet),valueB=codecsSetSelectionPreferenceValue(b.codecSet);if(valueA!==valueB)return valueB-valueA}return a.averageBitrate!==b.averageBitrate?a.averageBitrate-b.averageBitrate:0});let firstLevelInPlaylist=unsortedLevels[0];if(this.steering&&(levels=this.steering.filterParsedLevels(levels)).length!==unsortedLevels.length){for(let i=0;i<unsortedLevels.length;i++)if(unsortedLevels[i].pathwayId===levels[0].pathwayId){firstLevelInPlaylist=unsortedLevels[i];break}}this._levels=levels;for(let i=0;i<levels.length;i++)if(levels[i]===firstLevelInPlaylist){var _this$hls$userConfig;this._firstLevel=i;let firstLevelBitrate=firstLevelInPlaylist.bitrate,bandwidthEstimate=this.hls.bandwidthEstimate;if(this.log(`manifest loaded, ${levels.length} level(s) found, first bitrate: ${firstLevelBitrate}`),(null==(_this$hls$userConfig=this.hls.userConfig)?void 0:_this$hls$userConfig.abrEwmaDefaultEstimate)===void 0){let startingBwEstimate=Math.min(firstLevelBitrate,this.hls.config.abrEwmaDefaultEstimateMax);startingBwEstimate>bandwidthEstimate&&bandwidthEstimate===hlsDefaultConfig.abrEwmaDefaultEstimate&&(this.hls.bandwidthEstimate=startingBwEstimate)}break}let audioOnly=audioCodecFound&&!videoCodecFound,edata={levels,audioTracks,subtitleTracks,sessionData:data.sessionData,sessionKeys:data.sessionKeys,firstLevel:this._firstLevel,stats:data.stats,audio:audioCodecFound,video:videoCodecFound,altAudio:!audioOnly&&audioTracks.some(t=>!!t.url)};this.hls.trigger(Events1.MANIFEST_PARSED,edata),(this.hls.config.autoStartLoad||this.hls.forceStartLoad)&&this.hls.startLoad(this.hls.config.startPosition)}get levels(){return 0===this._levels.length?null:this._levels}get level(){return this.currentLevelIndex}set level(newLevel){let levels=this._levels;if(0===levels.length)return;if(newLevel<0||newLevel>=levels.length){let error=Error("invalid level idx"),fatal=newLevel<0;if(this.hls.trigger(Events1.ERROR,{type:ErrorTypes1.OTHER_ERROR,details:ErrorDetails1.LEVEL_SWITCH_ERROR,level:newLevel,fatal,error,reason:error.message}),fatal)return;newLevel=Math.min(newLevel,levels.length-1)}let lastLevelIndex=this.currentLevelIndex,lastLevel=this.currentLevel,lastPathwayId=lastLevel?lastLevel.attrs["PATHWAY-ID"]:void 0,level=levels[newLevel],pathwayId=level.attrs["PATHWAY-ID"];if(this.currentLevelIndex=newLevel,this.currentLevel=level,lastLevelIndex===newLevel&&level.details&&lastLevel&&lastPathwayId===pathwayId)return;this.log(`Switching to level ${newLevel} (${level.height?level.height+"p ":""}${level.videoRange?level.videoRange+" ":""}${level.codecSet?level.codecSet+" ":""}@${level.bitrate})${pathwayId?" with Pathway "+pathwayId:""} from level ${lastLevelIndex}${lastPathwayId?" with Pathway "+lastPathwayId:""}`);let levelSwitchingData={level:newLevel,attrs:level.attrs,details:level.details,bitrate:level.bitrate,averageBitrate:level.averageBitrate,maxBitrate:level.maxBitrate,realBitrate:level.realBitrate,width:level.width,height:level.height,codecSet:level.codecSet,audioCodec:level.audioCodec,videoCodec:level.videoCodec,audioGroups:level.audioGroups,subtitleGroups:level.subtitleGroups,loaded:level.loaded,loadError:level.loadError,fragmentError:level.fragmentError,name:level.name,id:level.id,uri:level.uri,url:level.url,urlId:0,audioGroupIds:level.audioGroupIds,textGroupIds:level.textGroupIds};this.hls.trigger(Events1.LEVEL_SWITCHING,levelSwitchingData);let levelDetails=level.details;if(!levelDetails||levelDetails.live){let hlsUrlParameters=this.switchParams(level.uri,null==lastLevel?void 0:lastLevel.details,levelDetails);this.loadPlaylist(hlsUrlParameters)}}get manualLevel(){return this.manualLevelIndex}set manualLevel(newLevel){this.manualLevelIndex=newLevel,void 0===this._startLevel&&(this._startLevel=newLevel),-1!==newLevel&&(this.level=newLevel)}get firstLevel(){return this._firstLevel}set firstLevel(newLevel){this._firstLevel=newLevel}get startLevel(){if(void 0===this._startLevel){let configStartLevel=this.hls.config.startLevel;return void 0!==configStartLevel?configStartLevel:this.hls.firstAutoLevel}return this._startLevel}set startLevel(newLevel){this._startLevel=newLevel}onError(event,data){!data.fatal&&data.context&&data.context.type===PlaylistContextType.LEVEL&&data.context.level===this.level&&this.checkRetry(data)}onFragBuffered(event,{frag}){if(void 0!==frag&&frag.type===PlaylistLevelType.MAIN){let el=frag.elementaryStreams;if(!Object.keys(el).some(type=>!!el[type]))return;let level=this._levels[frag.level];null!=level&&level.loadError&&(this.log(`Resetting level error count of ${level.loadError} on frag buffered`),level.loadError=0)}}onLevelLoaded(event,data){var _data$deliveryDirecti2,_data$deliveryDirecti;let{level,details}=data,curLevel=this._levels[level];if(!curLevel){this.warn(`Invalid level index ${level}`),null!=(_data$deliveryDirecti=data.deliveryDirectives)&&_data$deliveryDirecti.skip&&(details.deltaUpdateFailed=!0);return}level===this.currentLevelIndex?(0===curLevel.fragmentError&&(curLevel.loadError=0),this.playlistLoaded(level,data,curLevel.details)):null!=(_data$deliveryDirecti2=data.deliveryDirectives)&&_data$deliveryDirecti2.skip&&(details.deltaUpdateFailed=!0)}loadPlaylist(hlsUrlParameters){super.loadPlaylist();let currentLevelIndex=this.currentLevelIndex,currentLevel=this.currentLevel;if(currentLevel&&this.shouldLoadPlaylist(currentLevel)){let url=currentLevel.uri;if(hlsUrlParameters)try{url=hlsUrlParameters.addDirectives(url)}catch(error){this.warn(`Could not construct new URL with HLS Delivery Directives: ${error}`)}let pathwayId=currentLevel.attrs["PATHWAY-ID"];this.log(`Loading level index ${currentLevelIndex}${(null==hlsUrlParameters?void 0:hlsUrlParameters.msn)!==void 0?" at sn "+hlsUrlParameters.msn+" part "+hlsUrlParameters.part:""} with${pathwayId?" Pathway "+pathwayId:""} ${url}`),this.clearTimer(),this.hls.trigger(Events1.LEVEL_LOADING,{url,level:currentLevelIndex,pathwayId:currentLevel.attrs["PATHWAY-ID"],id:0,deliveryDirectives:hlsUrlParameters||null})}}get nextLoadLevel(){return -1!==this.manualLevelIndex?this.manualLevelIndex:this.hls.nextAutoLevel}set nextLoadLevel(nextLevel){this.level=nextLevel,-1===this.manualLevelIndex&&(this.hls.nextAutoLevel=nextLevel)}removeLevel(levelIndex){var _this$currentLevel;let levels=this._levels.filter((level,index)=>index!==levelIndex||(this.steering&&this.steering.removeLevel(level),level===this.currentLevel&&(this.currentLevel=null,this.currentLevelIndex=-1,level.details&&level.details.fragments.forEach(f=>f.level=-1)),!1));reassignFragmentLevelIndexes(levels),this._levels=levels,this.currentLevelIndex>-1&&null!=(_this$currentLevel=this.currentLevel)&&_this$currentLevel.details&&(this.currentLevelIndex=this.currentLevel.details.fragments[0].level),this.hls.trigger(Events1.LEVELS_UPDATED,{levels})}onLevelsUpdated(event,{levels}){this._levels=levels}checkMaxAutoUpdated(){let{autoLevelCapping,maxAutoLevel,maxHdcpLevel}=this.hls;this._maxAutoLevel!==maxAutoLevel&&(this._maxAutoLevel=maxAutoLevel,this.hls.trigger(Events1.MAX_AUTO_LEVEL_UPDATED,{autoLevelCapping,levels:this.levels,maxAutoLevel,minAutoLevel:this.hls.minAutoLevel,maxHdcpLevel}))}}function assignTrackIdsByGroup(tracks){let groups={};tracks.forEach(track=>{let groupId=track.groupId||"";track.id=groups[groupId]=groups[groupId]||0,groups[groupId]++})}var FragmentState={NOT_LOADED:"NOT_LOADED",APPENDING:"APPENDING",PARTIAL:"PARTIAL",OK:"OK"};class FragmentTracker{constructor(hls){this.activePartLists=Object.create(null),this.endListFragments=Object.create(null),this.fragments=Object.create(null),this.timeRanges=Object.create(null),this.bufferPadding=.2,this.hls=void 0,this.hasGaps=!1,this.hls=hls,this._registerListeners()}_registerListeners(){let{hls}=this;hls.on(Events1.BUFFER_APPENDED,this.onBufferAppended,this),hls.on(Events1.FRAG_BUFFERED,this.onFragBuffered,this),hls.on(Events1.FRAG_LOADED,this.onFragLoaded,this)}_unregisterListeners(){let{hls}=this;hls.off(Events1.BUFFER_APPENDED,this.onBufferAppended,this),hls.off(Events1.FRAG_BUFFERED,this.onFragBuffered,this),hls.off(Events1.FRAG_LOADED,this.onFragLoaded,this)}destroy(){this._unregisterListeners(),this.fragments=this.activePartLists=this.endListFragments=this.timeRanges=null}getAppendedFrag(position,levelType){let activeParts=this.activePartLists[levelType];if(activeParts)for(let i=activeParts.length;i--;){let activePart=activeParts[i];if(!activePart)break;let appendedPTS=activePart.end;if(activePart.start<=position&&null!==appendedPTS&&position<=appendedPTS)return activePart}return this.getBufferedFrag(position,levelType)}getBufferedFrag(position,levelType){let{fragments}=this,keys=Object.keys(fragments);for(let i=keys.length;i--;){let fragmentEntity=fragments[keys[i]];if((null==fragmentEntity?void 0:fragmentEntity.body.type)===levelType&&fragmentEntity.buffered){let frag=fragmentEntity.body;if(frag.start<=position&&position<=frag.end)return frag}}return null}detectEvictedFragments(elementaryStream,timeRange,playlistType,appendedPart){this.timeRanges&&(this.timeRanges[elementaryStream]=timeRange);let appendedPartSn=(null==appendedPart?void 0:appendedPart.fragment.sn)||-1;Object.keys(this.fragments).forEach(key=>{let fragmentEntity=this.fragments[key];if(!fragmentEntity||appendedPartSn>=fragmentEntity.body.sn)return;if(!fragmentEntity.buffered&&!fragmentEntity.loaded){fragmentEntity.body.type===playlistType&&this.removeFragment(fragmentEntity.body);return}let esData=fragmentEntity.range[elementaryStream];esData&&esData.time.some(time=>{let isNotBuffered=!this.isTimeBuffered(time.startPTS,time.endPTS,timeRange);return isNotBuffered&&this.removeFragment(fragmentEntity.body),isNotBuffered})})}detectPartialFragments(data){let timeRanges=this.timeRanges,{frag,part}=data;if(!timeRanges||"initSegment"===frag.sn)return;let fragKey=getFragmentKey(frag),fragmentEntity=this.fragments[fragKey];if(!fragmentEntity||fragmentEntity.buffered&&frag.gap)return;let isFragHint=!frag.relurl;Object.keys(timeRanges).forEach(elementaryStream=>{let streamInfo=frag.elementaryStreams[elementaryStream];if(!streamInfo)return;let timeRange=timeRanges[elementaryStream],partial=isFragHint||!0===streamInfo.partial;fragmentEntity.range[elementaryStream]=this.getBufferedTimes(frag,part,partial,timeRange)}),fragmentEntity.loaded=null,Object.keys(fragmentEntity.range).length?(fragmentEntity.buffered=!0,(fragmentEntity.body.endList=frag.endList||fragmentEntity.body.endList)&&(this.endListFragments[fragmentEntity.body.type]=fragmentEntity),isPartial(fragmentEntity)||this.removeParts(frag.sn-1,frag.type)):this.removeFragment(fragmentEntity.body)}removeParts(snToKeep,levelType){let activeParts=this.activePartLists[levelType];activeParts&&(this.activePartLists[levelType]=activeParts.filter(part=>part.fragment.sn>=snToKeep))}fragBuffered(frag,force){let fragKey=getFragmentKey(frag),fragmentEntity=this.fragments[fragKey];!fragmentEntity&&force&&(fragmentEntity=this.fragments[fragKey]={body:frag,appendedPTS:null,loaded:null,buffered:!1,range:Object.create(null)},frag.gap&&(this.hasGaps=!0)),fragmentEntity&&(fragmentEntity.loaded=null,fragmentEntity.buffered=!0)}getBufferedTimes(fragment,part,partial,timeRange){let buffered={time:[],partial},startPTS=fragment.start,endPTS=fragment.end,minEndPTS=fragment.minEndPTS||endPTS,maxStartPTS=fragment.maxStartPTS||startPTS;for(let i=0;i<timeRange.length;i++){let startTime=timeRange.start(i)-this.bufferPadding,endTime=timeRange.end(i)+this.bufferPadding;if(maxStartPTS>=startTime&&minEndPTS<=endTime){buffered.time.push({startPTS:Math.max(startPTS,timeRange.start(i)),endPTS:Math.min(endPTS,timeRange.end(i))});break}if(startPTS<endTime&&endPTS>startTime){let start=Math.max(startPTS,timeRange.start(i)),end=Math.min(endPTS,timeRange.end(i));end>start&&(buffered.partial=!0,buffered.time.push({startPTS:start,endPTS:end}))}else if(endPTS<=startTime)break}return buffered}getPartialFragment(time){let timePadding,startTime,endTime,bestFragment=null,bestOverlap=0,{bufferPadding,fragments}=this;return Object.keys(fragments).forEach(key=>{let fragmentEntity=fragments[key];fragmentEntity&&isPartial(fragmentEntity)&&(startTime=fragmentEntity.body.start-bufferPadding,endTime=fragmentEntity.body.end+bufferPadding,time>=startTime&&time<=endTime&&bestOverlap<=(timePadding=Math.min(time-startTime,endTime-time))&&(bestFragment=fragmentEntity.body,bestOverlap=timePadding))}),bestFragment}isEndListAppended(type){let lastFragmentEntity=this.endListFragments[type];return void 0!==lastFragmentEntity&&(lastFragmentEntity.buffered||isPartial(lastFragmentEntity))}getState(fragment){let fragKey=getFragmentKey(fragment),fragmentEntity=this.fragments[fragKey];return fragmentEntity?fragmentEntity.buffered?isPartial(fragmentEntity)?FragmentState.PARTIAL:FragmentState.OK:FragmentState.APPENDING:FragmentState.NOT_LOADED}isTimeBuffered(startPTS,endPTS,timeRange){let startTime,endTime;for(let i=0;i<timeRange.length;i++){if(startTime=timeRange.start(i)-this.bufferPadding,endTime=timeRange.end(i)+this.bufferPadding,startPTS>=startTime&&endPTS<=endTime)return!0;if(endPTS<=startTime)break}return!1}onFragLoaded(event,data){let{frag,part}=data;if("initSegment"===frag.sn||frag.bitrateTest)return;let fragKey=getFragmentKey(frag);this.fragments[fragKey]={body:frag,appendedPTS:null,loaded:part?null:data,buffered:!1,range:Object.create(null)}}onBufferAppended(event,data){let{frag,part,timeRanges}=data;if("initSegment"===frag.sn)return;let playlistType=frag.type;if(part){let activeParts=this.activePartLists[playlistType];activeParts||(this.activePartLists[playlistType]=activeParts=[]),activeParts.push(part)}this.timeRanges=timeRanges,Object.keys(timeRanges).forEach(elementaryStream=>{let timeRange=timeRanges[elementaryStream];this.detectEvictedFragments(elementaryStream,timeRange,playlistType,part)})}onFragBuffered(event,data){this.detectPartialFragments(data)}hasFragment(fragment){let fragKey=getFragmentKey(fragment);return!!this.fragments[fragKey]}hasParts(type){var _this$activePartLists;return!!(null!=(_this$activePartLists=this.activePartLists[type])&&_this$activePartLists.length)}removeFragmentsInRange(start,end,playlistType,withGapOnly,unbufferedOnly){(!withGapOnly||this.hasGaps)&&Object.keys(this.fragments).forEach(key=>{let fragmentEntity=this.fragments[key];if(!fragmentEntity)return;let frag=fragmentEntity.body;frag.type===playlistType&&(!withGapOnly||frag.gap)&&frag.start<end&&frag.end>start&&(fragmentEntity.buffered||unbufferedOnly)&&this.removeFragment(frag)})}removeFragment(fragment){let fragKey=getFragmentKey(fragment);fragment.stats.loaded=0,fragment.clearElementaryStreamInfo();let activeParts=this.activePartLists[fragment.type];if(activeParts){let snToRemove=fragment.sn;this.activePartLists[fragment.type]=activeParts.filter(part=>part.fragment.sn!==snToRemove)}delete this.fragments[fragKey],fragment.endList&&delete this.endListFragments[fragment.type]}removeAllFragments(){this.fragments=Object.create(null),this.endListFragments=Object.create(null),this.activePartLists=Object.create(null),this.hasGaps=!1}}function isPartial(fragmentEntity){var _fragmentEntity$range,_fragmentEntity$range2,_fragmentEntity$range3;return fragmentEntity.buffered&&(fragmentEntity.body.gap||(null==(_fragmentEntity$range=fragmentEntity.range.video)?void 0:_fragmentEntity$range.partial)||(null==(_fragmentEntity$range2=fragmentEntity.range.audio)?void 0:_fragmentEntity$range2.partial)||(null==(_fragmentEntity$range3=fragmentEntity.range.audiovideo)?void 0:_fragmentEntity$range3.partial))}function getFragmentKey(fragment){return`${fragment.type}_${fragment.level}_${fragment.sn}`}class FragmentLoader{constructor(config){this.config=void 0,this.loader=null,this.partLoadTimeout=-1,this.config=config}destroy(){this.loader&&(this.loader.destroy(),this.loader=null)}abort(){this.loader&&this.loader.abort()}load(frag,onProgress){let url=frag.url;if(!url)return Promise.reject(new LoadError({type:ErrorTypes1.NETWORK_ERROR,details:ErrorDetails1.FRAG_LOAD_ERROR,fatal:!1,frag,error:Error(`Fragment does not have a ${url?"part list":"url"}`),networkDetails:null}));this.abort();let config=this.config,FragmentILoader=config.fLoader,DefaultILoader=config.loader;return new Promise((resolve,reject)=>{if(this.loader&&this.loader.destroy(),frag.gap){if(frag.tagList.some(tags=>"GAP"===tags[0])){reject(createGapLoadError(frag));return}frag.gap=!1}let loader=this.loader=frag.loader=FragmentILoader?new FragmentILoader(config):new DefaultILoader(config),loaderContext=createLoaderContext(frag),loadPolicy=getLoaderConfigWithoutReties(config.fragLoadPolicy.default),loaderConfig={loadPolicy,timeout:loadPolicy.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:"initSegment"===frag.sn?1/0:131072};frag.stats=loader.stats,loader.load(loaderContext,loaderConfig,{onSuccess:(response,stats,context,networkDetails)=>{this.resetLoader(frag,loader);let payload=response.data;context.resetIV&&frag.decryptdata&&(frag.decryptdata.iv=new Uint8Array(payload.slice(0,16)),payload=payload.slice(16)),resolve({frag,part:null,payload,networkDetails})},onError:(response,context,networkDetails,stats)=>{this.resetLoader(frag,loader),reject(new LoadError({type:ErrorTypes1.NETWORK_ERROR,details:ErrorDetails1.FRAG_LOAD_ERROR,fatal:!1,frag,response:_objectSpread2({url,data:void 0},response),error:Error(`HTTP Error ${response.code} ${response.text}`),networkDetails,stats}))},onAbort:(stats,context,networkDetails)=>{this.resetLoader(frag,loader),reject(new LoadError({type:ErrorTypes1.NETWORK_ERROR,details:ErrorDetails1.INTERNAL_ABORTED,fatal:!1,frag,error:Error("Aborted"),networkDetails,stats}))},onTimeout:(stats,context,networkDetails)=>{this.resetLoader(frag,loader),reject(new LoadError({type:ErrorTypes1.NETWORK_ERROR,details:ErrorDetails1.FRAG_LOAD_TIMEOUT,fatal:!1,frag,error:Error(`Timeout after ${loaderConfig.timeout}ms`),networkDetails,stats}))},onProgress:(stats,context,data,networkDetails)=>{onProgress&&onProgress({frag,part:null,payload:data,networkDetails})}})})}loadPart(frag,part,onProgress){this.abort();let config=this.config,FragmentILoader=config.fLoader,DefaultILoader=config.loader;return new Promise((resolve,reject)=>{if(this.loader&&this.loader.destroy(),frag.gap||part.gap){reject(createGapLoadError(frag,part));return}let loader=this.loader=frag.loader=FragmentILoader?new FragmentILoader(config):new DefaultILoader(config),loaderContext=createLoaderContext(frag,part),loadPolicy=getLoaderConfigWithoutReties(config.fragLoadPolicy.default),loaderConfig={loadPolicy,timeout:loadPolicy.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0,highWaterMark:131072};part.stats=loader.stats,loader.load(loaderContext,loaderConfig,{onSuccess:(response,stats,context,networkDetails)=>{this.resetLoader(frag,loader),this.updateStatsFromPart(frag,part);let partLoadedData={frag,part,payload:response.data,networkDetails};onProgress(partLoadedData),resolve(partLoadedData)},onError:(response,context,networkDetails,stats)=>{this.resetLoader(frag,loader),reject(new LoadError({type:ErrorTypes1.NETWORK_ERROR,details:ErrorDetails1.FRAG_LOAD_ERROR,fatal:!1,frag,part,response:_objectSpread2({url:loaderContext.url,data:void 0},response),error:Error(`HTTP Error ${response.code} ${response.text}`),networkDetails,stats}))},onAbort:(stats,context,networkDetails)=>{frag.stats.aborted=part.stats.aborted,this.resetLoader(frag,loader),reject(new LoadError({type:ErrorTypes1.NETWORK_ERROR,details:ErrorDetails1.INTERNAL_ABORTED,fatal:!1,frag,part,error:Error("Aborted"),networkDetails,stats}))},onTimeout:(stats,context,networkDetails)=>{this.resetLoader(frag,loader),reject(new LoadError({type:ErrorTypes1.NETWORK_ERROR,details:ErrorDetails1.FRAG_LOAD_TIMEOUT,fatal:!1,frag,part,error:Error(`Timeout after ${loaderConfig.timeout}ms`),networkDetails,stats}))}})})}updateStatsFromPart(frag,part){let fragStats=frag.stats,partStats=part.stats,partTotal=partStats.total;if(fragStats.loaded+=partStats.loaded,partTotal){let estTotalParts=Math.round(frag.duration/part.duration),estLoadedParts=Math.min(Math.round(fragStats.loaded/partTotal),estTotalParts),estRemainingBytes=(estTotalParts-estLoadedParts)*Math.round(fragStats.loaded/estLoadedParts);fragStats.total=fragStats.loaded+estRemainingBytes}else fragStats.total=Math.max(fragStats.loaded,fragStats.total);let fragLoading=fragStats.loading,partLoading=partStats.loading;fragLoading.start?fragLoading.first+=partLoading.first-partLoading.start:(fragLoading.start=partLoading.start,fragLoading.first=partLoading.first),fragLoading.end=partLoading.end}resetLoader(frag,loader){frag.loader=null,this.loader===loader&&(self.clearTimeout(this.partLoadTimeout),this.loader=null),loader.destroy()}}function createLoaderContext(frag,part=null){let segment=part||frag,loaderContext={frag,part,responseType:"arraybuffer",url:segment.url,headers:{},rangeStart:0,rangeEnd:0},start=segment.byteRangeStartOffset,end=segment.byteRangeEndOffset;if(isFiniteNumber(start)&&isFiniteNumber(end)){var _frag$decryptdata;let byteRangeStart=start,byteRangeEnd=end;if("initSegment"===frag.sn&&(null==(_frag$decryptdata=frag.decryptdata)?void 0:_frag$decryptdata.method)==="AES-128"){let fragmentLen=end-start;fragmentLen%16&&(byteRangeEnd=end+(16-fragmentLen%16)),0!==start&&(loaderContext.resetIV=!0,byteRangeStart=start-16)}loaderContext.rangeStart=byteRangeStart,loaderContext.rangeEnd=byteRangeEnd}return loaderContext}function createGapLoadError(frag,part){let error=Error(`GAP ${frag.gap?"tag":"attribute"} found`),errorData={type:ErrorTypes1.MEDIA_ERROR,details:ErrorDetails1.FRAG_GAP,fatal:!1,frag,error,networkDetails:null};return part&&(errorData.part=part),(part||frag).stats.aborted=!0,new LoadError(errorData)}class LoadError extends Error{constructor(data){super(data.error.message),this.data=void 0,this.data=data}}class KeyLoader{constructor(config){this.config=void 0,this.keyUriToKeyInfo={},this.emeController=null,this.config=config}abort(type){for(let uri in this.keyUriToKeyInfo){let loader=this.keyUriToKeyInfo[uri].loader;if(loader){var _loader$context;if(type&&type!==(null==(_loader$context=loader.context)?void 0:_loader$context.frag.type))return;loader.abort()}}}detach(){for(let uri in this.keyUriToKeyInfo){let keyInfo=this.keyUriToKeyInfo[uri];(keyInfo.mediaKeySessionContext||keyInfo.decryptdata.isCommonEncryption)&&delete this.keyUriToKeyInfo[uri]}}destroy(){for(let uri in this.detach(),this.keyUriToKeyInfo){let loader=this.keyUriToKeyInfo[uri].loader;loader&&loader.destroy()}this.keyUriToKeyInfo={}}createKeyLoadError(frag,details=ErrorDetails1.KEY_LOAD_ERROR,error,networkDetails,response){return new LoadError({type:ErrorTypes1.NETWORK_ERROR,details,fatal:!1,frag,response,error,networkDetails})}loadClear(loadingFrag,encryptedFragments){if(this.emeController&&this.config.emeEnabled){let{sn,cc}=loadingFrag;for(let i=0;i<encryptedFragments.length;i++){let frag=encryptedFragments[i];if(cc<=frag.cc&&("initSegment"===sn||"initSegment"===frag.sn||sn<frag.sn)){this.emeController.selectKeySystemFormat(frag).then(keySystemFormat=>{frag.setKeyFormat(keySystemFormat)});break}}}}load(frag){return!frag.decryptdata&&frag.encrypted&&this.emeController?this.emeController.selectKeySystemFormat(frag).then(keySystemFormat=>this.loadInternal(frag,keySystemFormat)):this.loadInternal(frag)}loadInternal(frag,keySystemFormat){var _keyInfo,_keyInfo2,_keyInfo$mediaKeySess;keySystemFormat&&frag.setKeyFormat(keySystemFormat);let decryptdata=frag.decryptdata;if(!decryptdata){let error=Error(keySystemFormat?`Expected frag.decryptdata to be defined after setting format ${keySystemFormat}`:"Missing decryption data on fragment in onKeyLoading");return Promise.reject(this.createKeyLoadError(frag,ErrorDetails1.KEY_LOAD_ERROR,error))}let uri=decryptdata.uri;if(!uri)return Promise.reject(this.createKeyLoadError(frag,ErrorDetails1.KEY_LOAD_ERROR,Error(`Invalid key URI: "${uri}"`)));let keyInfo=this.keyUriToKeyInfo[uri];if(null!=(_keyInfo=keyInfo)&&_keyInfo.decryptdata.key)return decryptdata.key=keyInfo.decryptdata.key,Promise.resolve({frag,keyInfo});if(null!=(_keyInfo2=keyInfo)&&_keyInfo2.keyLoadPromise)switch(null==(_keyInfo$mediaKeySess=keyInfo.mediaKeySessionContext)?void 0:_keyInfo$mediaKeySess.keyStatus){case void 0:case"status-pending":case"usable":case"usable-in-future":return keyInfo.keyLoadPromise.then(keyLoadedData=>(decryptdata.key=keyLoadedData.keyInfo.decryptdata.key,{frag,keyInfo}))}switch(keyInfo=this.keyUriToKeyInfo[uri]={decryptdata,keyLoadPromise:null,loader:null,mediaKeySessionContext:null},decryptdata.method){case"ISO-23001-7":case"SAMPLE-AES":case"SAMPLE-AES-CENC":case"SAMPLE-AES-CTR":if("identity"===decryptdata.keyFormat)return this.loadKeyHTTP(keyInfo,frag);return this.loadKeyEME(keyInfo,frag);case"AES-128":return this.loadKeyHTTP(keyInfo,frag);default:return Promise.reject(this.createKeyLoadError(frag,ErrorDetails1.KEY_LOAD_ERROR,Error(`Key supplied with unsupported METHOD: "${decryptdata.method}"`)))}}loadKeyEME(keyInfo,frag){let keyLoadedData={frag,keyInfo};if(this.emeController&&this.config.emeEnabled){let keySessionContextPromise=this.emeController.loadKey(keyLoadedData);if(keySessionContextPromise)return(keyInfo.keyLoadPromise=keySessionContextPromise.then(keySessionContext=>(keyInfo.mediaKeySessionContext=keySessionContext,keyLoadedData))).catch(error=>{throw keyInfo.keyLoadPromise=null,error})}return Promise.resolve(keyLoadedData)}loadKeyHTTP(keyInfo,frag){let config=this.config,keyLoader=new config.loader(config);return frag.keyLoader=keyInfo.loader=keyLoader,keyInfo.keyLoadPromise=new Promise((resolve,reject)=>{let loaderContext={keyInfo,frag,responseType:"arraybuffer",url:keyInfo.decryptdata.uri},loadPolicy=config.keyLoadPolicy.default,loaderConfig={loadPolicy,timeout:loadPolicy.maxLoadTimeMs,maxRetry:0,retryDelay:0,maxRetryDelay:0};keyLoader.load(loaderContext,loaderConfig,{onSuccess:(response,stats,context,networkDetails)=>{let{frag,keyInfo,url:uri}=context;if(!frag.decryptdata||keyInfo!==this.keyUriToKeyInfo[uri])return reject(this.createKeyLoadError(frag,ErrorDetails1.KEY_LOAD_ERROR,Error("after key load, decryptdata unset or changed"),networkDetails));keyInfo.decryptdata.key=frag.decryptdata.key=new Uint8Array(response.data),frag.keyLoader=null,keyInfo.loader=null,resolve({frag,keyInfo})},onError:(response,context,networkDetails,stats)=>{this.resetLoader(context),reject(this.createKeyLoadError(frag,ErrorDetails1.KEY_LOAD_ERROR,Error(`HTTP Error ${response.code} loading key ${response.text}`),networkDetails,_objectSpread2({url:loaderContext.url,data:void 0},response)))},onTimeout:(stats,context,networkDetails)=>{this.resetLoader(context),reject(this.createKeyLoadError(frag,ErrorDetails1.KEY_LOAD_TIMEOUT,Error("key loading timed out"),networkDetails))},onAbort:(stats,context,networkDetails)=>{this.resetLoader(context),reject(this.createKeyLoadError(frag,ErrorDetails1.INTERNAL_ABORTED,Error("key loading aborted"),networkDetails))}})})}resetLoader(context){let{frag,keyInfo,url:uri}=context,loader=keyInfo.loader;frag.keyLoader===loader&&(frag.keyLoader=null,keyInfo.loader=null),delete this.keyUriToKeyInfo[uri],loader&&loader.destroy()}}class TaskLoop{constructor(){this._boundTick=void 0,this._tickTimer=null,this._tickInterval=null,this._tickCallCount=0,this._boundTick=this.tick.bind(this)}destroy(){this.onHandlerDestroying(),this.onHandlerDestroyed()}onHandlerDestroying(){this.clearNextTick(),this.clearInterval()}onHandlerDestroyed(){}hasInterval(){return!!this._tickInterval}hasNextTick(){return!!this._tickTimer}setInterval(millis){return!this._tickInterval&&(this._tickCallCount=0,this._tickInterval=self.setInterval(this._boundTick,millis),!0)}clearInterval(){return!!this._tickInterval&&(self.clearInterval(this._tickInterval),this._tickInterval=null,!0)}clearNextTick(){return!!this._tickTimer&&(self.clearTimeout(this._tickTimer),this._tickTimer=null,!0)}tick(){this._tickCallCount++,1===this._tickCallCount&&(this.doTick(),this._tickCallCount>1&&this.tickImmediate(),this._tickCallCount=0)}tickImmediate(){this.clearNextTick(),this._tickTimer=self.setTimeout(this._boundTick,0)}doTick(){}}class ChunkMetadata{constructor(level,sn,id,size=0,part=-1,partial=!1){this.level=void 0,this.sn=void 0,this.part=void 0,this.id=void 0,this.size=void 0,this.partial=void 0,this.transmuxing=getNewPerformanceTiming(),this.buffering={audio:getNewPerformanceTiming(),video:getNewPerformanceTiming(),audiovideo:getNewPerformanceTiming()},this.level=level,this.sn=sn,this.id=id,this.size=size,this.part=part,this.partial=partial}}function getNewPerformanceTiming(){return{start:0,executeStart:0,executeEnd:0,end:0}}function findFirstFragWithCC(fragments,cc){for(let i=0,len=fragments.length;i<len;i++){var _fragments$i;if((null==(_fragments$i=fragments[i])?void 0:_fragments$i.cc)===cc)return fragments[i]}return null}function shouldAlignOnDiscontinuities(lastFrag,switchDetails,details){return!!switchDetails&&(details.endCC>details.startCC||!!lastFrag&&lastFrag.cc<details.startCC)}function findDiscontinuousReferenceFrag(prevDetails,curDetails){let prevFrags=prevDetails.fragments,curFrags=curDetails.fragments;if(!curFrags.length||!prevFrags.length){logger.log("No fragments to align");return}let prevStartFrag=findFirstFragWithCC(prevFrags,curFrags[0].cc);if(!prevStartFrag||prevStartFrag&&!prevStartFrag.startPTS){logger.log("No frag in previous level to align on");return}return prevStartFrag}function adjustFragmentStart(frag,sliding){if(frag){let start=frag.start+sliding;frag.start=frag.startPTS=start,frag.endPTS=start+frag.duration}}function adjustSlidingStart(sliding,details){let fragments=details.fragments;for(let i=0,len=fragments.length;i<len;i++)adjustFragmentStart(fragments[i],sliding);details.fragmentHint&&adjustFragmentStart(details.fragmentHint,sliding),details.alignedSliding=!0}function alignStream(lastFrag,switchDetails,details){switchDetails&&(alignDiscontinuities(lastFrag,details,switchDetails),!details.alignedSliding&&switchDetails&&alignMediaPlaylistByPDT(details,switchDetails),details.alignedSliding||!switchDetails||details.skippedSegments||adjustSliding(switchDetails,details))}function alignDiscontinuities(lastFrag,details,switchDetails){if(shouldAlignOnDiscontinuities(lastFrag,switchDetails,details)){let referenceFrag=findDiscontinuousReferenceFrag(switchDetails,details);referenceFrag&&isFiniteNumber(referenceFrag.start)&&(logger.log(`Adjusting PTS using last level due to CC increase within current level ${details.url}`),adjustSlidingStart(referenceFrag.start,details))}}function alignMediaPlaylistByPDT(details,refDetails){let refFrag,frag;if(!details.hasProgramDateTime||!refDetails.hasProgramDateTime)return;let fragments=details.fragments,refFragments=refDetails.fragments;if(!fragments.length||!refFragments.length)return;let targetCC=Math.min(refDetails.endCC,details.endCC);refDetails.startCC<targetCC&&details.startCC<targetCC&&(refFrag=findFirstFragWithCC(refFragments,targetCC),frag=findFirstFragWithCC(fragments,targetCC)),refFrag&&frag||(frag=findFirstFragWithCC(fragments,(refFrag=refFragments[Math.floor(refFragments.length/2)]).cc)||fragments[Math.floor(fragments.length/2)]);let refPDT=refFrag.programDateTime,targetPDT=frag.programDateTime;refPDT&&targetPDT&&adjustSlidingStart((targetPDT-refPDT)/1e3-(frag.start-refFrag.start),details)}class AESCrypto{constructor(subtle,iv){this.subtle=void 0,this.aesIV=void 0,this.subtle=subtle,this.aesIV=iv}decrypt(data,key){return this.subtle.decrypt({name:"AES-CBC",iv:this.aesIV},key,data)}}class FastAESKey{constructor(subtle,key){this.subtle=void 0,this.key=void 0,this.subtle=subtle,this.key=key}expandKey(){return this.subtle.importKey("raw",this.key,{name:"AES-CBC"},!1,["encrypt","decrypt"])}}function removePadding(array){let outputBytes=array.byteLength,paddingBytes=outputBytes&&new DataView(array.buffer).getUint8(outputBytes-1);return paddingBytes?sliceUint8(array,0,outputBytes-paddingBytes):array}class AESDecryptor{constructor(){this.rcon=[0,1,2,4,8,16,32,64,128,27,54],this.subMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.invSubMix=[new Uint32Array(256),new Uint32Array(256),new Uint32Array(256),new Uint32Array(256)],this.sBox=new Uint32Array(256),this.invSBox=new Uint32Array(256),this.key=new Uint32Array(0),this.ksRows=0,this.keySize=0,this.keySchedule=void 0,this.invKeySchedule=void 0,this.initTable()}uint8ArrayToUint32Array_(arrayBuffer){let view=new DataView(arrayBuffer),newArray=new Uint32Array(4);for(let i=0;i<4;i++)newArray[i]=view.getUint32(4*i);return newArray}initTable(){let sBox=this.sBox,invSBox=this.invSBox,subMix=this.subMix,subMix0=subMix[0],subMix1=subMix[1],subMix2=subMix[2],subMix3=subMix[3],invSubMix=this.invSubMix,invSubMix0=invSubMix[0],invSubMix1=invSubMix[1],invSubMix2=invSubMix[2],invSubMix3=invSubMix[3],d=new Uint32Array(256),x=0,xi=0,i=0;for(i=0;i<256;i++)i<128?d[i]=i<<1:d[i]=i<<1^283;for(i=0;i<256;i++){let sx=xi^xi<<1^xi<<2^xi<<3^xi<<4;sx=sx>>>8^255&sx^99,sBox[x]=sx,invSBox[sx]=x;let x2=d[x],x4=d[x2],x8=d[x4],t=257*d[sx]^16843008*sx;subMix0[x]=t<<24|t>>>8,subMix1[x]=t<<16|t>>>16,subMix2[x]=t<<8|t>>>24,subMix3[x]=t,t=16843009*x8^65537*x4^257*x2^16843008*x,invSubMix0[sx]=t<<24|t>>>8,invSubMix1[sx]=t<<16|t>>>16,invSubMix2[sx]=t<<8|t>>>24,invSubMix3[sx]=t,x?(x=x2^d[d[d[x8^x2]]],xi^=d[d[xi]]):x=xi=1}}expandKey(keyBuffer){let ksRow,invKsRow,prev,t;let key=this.uint8ArrayToUint32Array_(keyBuffer),sameKey=!0,offset=0;for(;offset<key.length&&sameKey;)sameKey=key[offset]===this.key[offset],offset++;if(sameKey)return;this.key=key;let keySize=this.keySize=key.length;if(4!==keySize&&6!==keySize&&8!==keySize)throw Error("Invalid aes key size="+keySize);let ksRows=this.ksRows=(keySize+6+1)*4,keySchedule=this.keySchedule=new Uint32Array(ksRows),invKeySchedule=this.invKeySchedule=new Uint32Array(ksRows),sbox=this.sBox,rcon=this.rcon,invSubMix=this.invSubMix,invSubMix0=invSubMix[0],invSubMix1=invSubMix[1],invSubMix2=invSubMix[2],invSubMix3=invSubMix[3];for(ksRow=0;ksRow<ksRows;ksRow++){if(ksRow<keySize){prev=keySchedule[ksRow]=key[ksRow];continue}t=prev,ksRow%keySize==0?t=(sbox[(t=t<<8|t>>>24)>>>24]<<24|sbox[t>>>16&255]<<16|sbox[t>>>8&255]<<8|sbox[255&t])^rcon[ksRow/keySize|0]<<24:keySize>6&&ksRow%keySize==4&&(t=sbox[t>>>24]<<24|sbox[t>>>16&255]<<16|sbox[t>>>8&255]<<8|sbox[255&t]),keySchedule[ksRow]=prev=(keySchedule[ksRow-keySize]^t)>>>0}for(invKsRow=0;invKsRow<ksRows;invKsRow++)ksRow=ksRows-invKsRow,t=3&invKsRow?keySchedule[ksRow]:keySchedule[ksRow-4],invKsRow<4||ksRow<=4?invKeySchedule[invKsRow]=t:invKeySchedule[invKsRow]=invSubMix0[sbox[t>>>24]]^invSubMix1[sbox[t>>>16&255]]^invSubMix2[sbox[t>>>8&255]]^invSubMix3[sbox[255&t]],invKeySchedule[invKsRow]=invKeySchedule[invKsRow]>>>0}networkToHostOrderSwap(word){return word<<24|(65280&word)<<8|(16711680&word)>>8|word>>>24}decrypt(inputArrayBuffer,offset,aesIV){let t0,t1,t2,t3,s0,s1,s2,s3,inputWords0,inputWords1,inputWords2,inputWords3,ksRow,i;let nRounds=this.keySize+6,invKeySchedule=this.invKeySchedule,invSBOX=this.invSBox,invSubMix=this.invSubMix,invSubMix0=invSubMix[0],invSubMix1=invSubMix[1],invSubMix2=invSubMix[2],invSubMix3=invSubMix[3],initVector=this.uint8ArrayToUint32Array_(aesIV),initVector0=initVector[0],initVector1=initVector[1],initVector2=initVector[2],initVector3=initVector[3],inputInt32=new Int32Array(inputArrayBuffer),outputInt32=new Int32Array(inputInt32.length),swapWord=this.networkToHostOrderSwap;for(;offset<inputInt32.length;){for(i=1,inputWords0=swapWord(inputInt32[offset]),inputWords1=swapWord(inputInt32[offset+1]),inputWords2=swapWord(inputInt32[offset+2]),inputWords3=swapWord(inputInt32[offset+3]),s0=inputWords0^invKeySchedule[0],s1=inputWords3^invKeySchedule[1],s2=inputWords2^invKeySchedule[2],s3=inputWords1^invKeySchedule[3],ksRow=4;i<nRounds;i++)t0=invSubMix0[s0>>>24]^invSubMix1[s1>>16&255]^invSubMix2[s2>>8&255]^invSubMix3[255&s3]^invKeySchedule[ksRow],t1=invSubMix0[s1>>>24]^invSubMix1[s2>>16&255]^invSubMix2[s3>>8&255]^invSubMix3[255&s0]^invKeySchedule[ksRow+1],t2=invSubMix0[s2>>>24]^invSubMix1[s3>>16&255]^invSubMix2[s0>>8&255]^invSubMix3[255&s1]^invKeySchedule[ksRow+2],t3=invSubMix0[s3>>>24]^invSubMix1[s0>>16&255]^invSubMix2[s1>>8&255]^invSubMix3[255&s2]^invKeySchedule[ksRow+3],s0=t0,s1=t1,s2=t2,s3=t3,ksRow+=4;t0=invSBOX[s0>>>24]<<24^invSBOX[s1>>16&255]<<16^invSBOX[s2>>8&255]<<8^invSBOX[255&s3]^invKeySchedule[ksRow],t1=invSBOX[s1>>>24]<<24^invSBOX[s2>>16&255]<<16^invSBOX[s3>>8&255]<<8^invSBOX[255&s0]^invKeySchedule[ksRow+1],t2=invSBOX[s2>>>24]<<24^invSBOX[s3>>16&255]<<16^invSBOX[s0>>8&255]<<8^invSBOX[255&s1]^invKeySchedule[ksRow+2],t3=invSBOX[s3>>>24]<<24^invSBOX[s0>>16&255]<<16^invSBOX[s1>>8&255]<<8^invSBOX[255&s2]^invKeySchedule[ksRow+3],outputInt32[offset]=swapWord(t0^initVector0),outputInt32[offset+1]=swapWord(t3^initVector1),outputInt32[offset+2]=swapWord(t2^initVector2),outputInt32[offset+3]=swapWord(t1^initVector3),initVector0=inputWords0,initVector1=inputWords1,initVector2=inputWords2,initVector3=inputWords3,offset+=4}return outputInt32.buffer}}class Decrypter{constructor(config,{removePKCS7Padding=!0}={}){if(this.logEnabled=!0,this.removePKCS7Padding=void 0,this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null,this.useSoftware=void 0,this.useSoftware=config.enableSoftwareAES,this.removePKCS7Padding=removePKCS7Padding,removePKCS7Padding)try{let browserCrypto=self.crypto;browserCrypto&&(this.subtle=browserCrypto.subtle||browserCrypto.webkitSubtle)}catch(e){}this.useSoftware=!this.subtle}destroy(){this.subtle=null,this.softwareDecrypter=null,this.key=null,this.fastAesKey=null,this.remainderData=null,this.currentIV=null,this.currentResult=null}isSync(){return this.useSoftware}flush(){let{currentResult,remainderData}=this;if(!currentResult||remainderData)return this.reset(),null;let data=new Uint8Array(currentResult);return(this.reset(),this.removePKCS7Padding)?removePadding(data):data}reset(){this.currentResult=null,this.currentIV=null,this.remainderData=null,this.softwareDecrypter&&(this.softwareDecrypter=null)}decrypt(data,key,iv){return this.useSoftware?new Promise((resolve,reject)=>{this.softwareDecrypt(new Uint8Array(data),key,iv);let decryptResult=this.flush();decryptResult?resolve(decryptResult.buffer):reject(Error("[softwareDecrypt] Failed to decrypt data"))}):this.webCryptoDecrypt(new Uint8Array(data),key,iv)}softwareDecrypt(data,key,iv){let{currentIV,currentResult,remainderData}=this;this.logOnce("JS AES decrypt"),remainderData&&(data=appendUint8Array(remainderData,data),this.remainderData=null);let currentChunk=this.getValidChunk(data);if(!currentChunk.length)return null;currentIV&&(iv=currentIV);let softwareDecrypter=this.softwareDecrypter;return(softwareDecrypter||(softwareDecrypter=this.softwareDecrypter=new AESDecryptor),softwareDecrypter.expandKey(key),this.currentResult=softwareDecrypter.decrypt(currentChunk.buffer,0,iv),this.currentIV=sliceUint8(currentChunk,-16).buffer,currentResult)?currentResult:null}webCryptoDecrypt(data,key,iv){if(this.key!==key||!this.fastAesKey){if(!this.subtle)return Promise.resolve(this.onWebCryptoError(data,key,iv));this.key=key,this.fastAesKey=new FastAESKey(this.subtle,key)}return this.fastAesKey.expandKey().then(aesKey=>this.subtle?(this.logOnce("WebCrypto AES decrypt"),new AESCrypto(this.subtle,new Uint8Array(iv)).decrypt(data.buffer,aesKey)):Promise.reject(Error("web crypto not initialized"))).catch(err=>(logger.warn(`[decrypter]: WebCrypto Error, disable WebCrypto API, ${err.name}: ${err.message}`),this.onWebCryptoError(data,key,iv)))}onWebCryptoError(data,key,iv){this.useSoftware=!0,this.logEnabled=!0,this.softwareDecrypt(data,key,iv);let decryptResult=this.flush();if(decryptResult)return decryptResult.buffer;throw Error("WebCrypto and softwareDecrypt: failed to decrypt data")}getValidChunk(data){let currentChunk=data,splitPoint=data.length-data.length%16;return splitPoint!==data.length&&(currentChunk=sliceUint8(data,0,splitPoint),this.remainderData=sliceUint8(data,splitPoint)),currentChunk}logOnce(msg){this.logEnabled&&(logger.log(`[decrypter]: ${msg}`),this.logEnabled=!1)}}let TimeRanges={toString:function(r){let log="",len=r.length;for(let i=0;i<len;i++)log+=`[${r.start(i).toFixed(3)}-${r.end(i).toFixed(3)}]`;return log}},State={STOPPED:"STOPPED",IDLE:"IDLE",KEY_LOADING:"KEY_LOADING",FRAG_LOADING:"FRAG_LOADING",FRAG_LOADING_WAITING_RETRY:"FRAG_LOADING_WAITING_RETRY",PARSING:"PARSING",PARSED:"PARSED",ENDED:"ENDED",ERROR:"ERROR",WAITING_LEVEL:"WAITING_LEVEL"};class BaseStreamController extends TaskLoop{constructor(hls,fragmentTracker,keyLoader,logPrefix,playlistType){super(),this.hls=void 0,this.fragPrevious=null,this.fragCurrent=null,this.fragmentTracker=void 0,this.transmuxer=null,this._state=State.STOPPED,this.playlistType=void 0,this.media=null,this.mediaBuffer=null,this.config=void 0,this.bitrateTest=!1,this.lastCurrentTime=0,this.nextLoadPosition=0,this.startPosition=0,this.startTimeOffset=null,this.loadedmetadata=!1,this.retryDate=0,this.levels=null,this.fragmentLoader=void 0,this.keyLoader=void 0,this.levelLastLoaded=null,this.startFragRequested=!1,this.decrypter=void 0,this.initPTS=[],this.onvseeking=null,this.onvended=null,this.logPrefix="",this.log=void 0,this.warn=void 0,this.playlistType=playlistType,this.logPrefix=logPrefix,this.log=logger.log.bind(logger,`${logPrefix}:`),this.warn=logger.warn.bind(logger,`${logPrefix}:`),this.hls=hls,this.fragmentLoader=new FragmentLoader(hls.config),this.keyLoader=keyLoader,this.fragmentTracker=fragmentTracker,this.config=hls.config,this.decrypter=new Decrypter(hls.config),hls.on(Events1.MANIFEST_LOADED,this.onManifestLoaded,this)}doTick(){this.onTickEnd()}onTickEnd(){}startLoad(startPosition){}stopLoad(){this.fragmentLoader.abort(),this.keyLoader.abort(this.playlistType);let frag=this.fragCurrent;null!=frag&&frag.loader&&(frag.abortRequests(),this.fragmentTracker.removeFragment(frag)),this.resetTransmuxer(),this.fragCurrent=null,this.fragPrevious=null,this.clearInterval(),this.clearNextTick(),this.state=State.STOPPED}_streamEnded(bufferInfo,levelDetails){if(levelDetails.live||bufferInfo.nextStart||!bufferInfo.end||!this.media)return!1;let partList=levelDetails.partList;if(null!=partList&&partList.length){let lastPart=partList[partList.length-1];return BufferHelper.isBuffered(this.media,lastPart.start+lastPart.duration/2)}let playlistType=levelDetails.fragments[levelDetails.fragments.length-1].type;return this.fragmentTracker.isEndListAppended(playlistType)}getLevelDetails(){if(this.levels&&null!==this.levelLastLoaded){var _this$levelLastLoaded;return null==(_this$levelLastLoaded=this.levelLastLoaded)?void 0:_this$levelLastLoaded.details}}onMediaAttached(event,data){let media=this.media=this.mediaBuffer=data.media;this.onvseeking=this.onMediaSeeking.bind(this),this.onvended=this.onMediaEnded.bind(this),media.addEventListener("seeking",this.onvseeking),media.addEventListener("ended",this.onvended);let config=this.config;this.levels&&config.autoStartLoad&&this.state===State.STOPPED&&this.startLoad(config.startPosition)}onMediaDetaching(){let media=this.media;null!=media&&media.ended&&(this.log("MSE detaching and video ended, reset startPosition"),this.startPosition=this.lastCurrentTime=0),media&&this.onvseeking&&this.onvended&&(media.removeEventListener("seeking",this.onvseeking),media.removeEventListener("ended",this.onvended),this.onvseeking=this.onvended=null),this.keyLoader&&this.keyLoader.detach(),this.media=this.mediaBuffer=null,this.loadedmetadata=!1,this.fragmentTracker.removeAllFragments(),this.stopLoad()}onMediaSeeking(){let{config,fragCurrent,media,mediaBuffer,state}=this,currentTime=media?media.currentTime:0,bufferInfo=BufferHelper.bufferInfo(mediaBuffer||media,currentTime,config.maxBufferHole);if(this.log(`media seeking to ${isFiniteNumber(currentTime)?currentTime.toFixed(3):currentTime}, state: ${state}`),this.state===State.ENDED)this.resetLoadingState();else if(fragCurrent){let tolerance=config.maxFragLookUpTolerance,fragStartOffset=fragCurrent.start-tolerance,fragEndOffset=fragCurrent.start+fragCurrent.duration+tolerance;if(!bufferInfo.len||fragEndOffset<bufferInfo.start||fragStartOffset>bufferInfo.end){let pastFragment=currentTime>fragEndOffset;(currentTime<fragStartOffset||pastFragment)&&(pastFragment&&fragCurrent.loader&&(this.log("seeking outside of buffer while fragment load in progress, cancel fragment load"),fragCurrent.abortRequests(),this.resetLoadingState()),this.fragPrevious=null)}}media&&(this.fragmentTracker.removeFragmentsInRange(currentTime,1/0,this.playlistType,!0),this.lastCurrentTime=currentTime),this.loadedmetadata||bufferInfo.len||(this.nextLoadPosition=this.startPosition=currentTime),this.tickImmediate()}onMediaEnded(){this.startPosition=this.lastCurrentTime=0}onManifestLoaded(event,data){this.startTimeOffset=data.startTimeOffset,this.initPTS=[]}onHandlerDestroying(){this.hls.off(Events1.MANIFEST_LOADED,this.onManifestLoaded,this),this.stopLoad(),super.onHandlerDestroying(),this.hls=null}onHandlerDestroyed(){this.state=State.STOPPED,this.fragmentLoader&&this.fragmentLoader.destroy(),this.keyLoader&&this.keyLoader.destroy(),this.decrypter&&this.decrypter.destroy(),this.hls=this.log=this.warn=this.decrypter=this.keyLoader=this.fragmentLoader=this.fragmentTracker=null,super.onHandlerDestroyed()}loadFragment(frag,level,targetBufferTime){this._loadFragForPlayback(frag,level,targetBufferTime)}_loadFragForPlayback(frag,level,targetBufferTime){this._doFragLoad(frag,level,targetBufferTime,data=>{if(this.fragContextChanged(frag)){this.warn(`Fragment ${frag.sn}${data.part?" p: "+data.part.index:""} of level ${frag.level} was dropped during download.`),this.fragmentTracker.removeFragment(frag);return}frag.stats.chunkCount++,this._handleFragmentLoadProgress(data)}).then(data=>{if(!data)return;let state=this.state;if(this.fragContextChanged(frag)){state!==State.FRAG_LOADING&&(this.fragCurrent||state!==State.PARSING)||(this.fragmentTracker.removeFragment(frag),this.state=State.IDLE);return}"payload"in data&&(this.log(`Loaded fragment ${frag.sn} of level ${frag.level}`),this.hls.trigger(Events1.FRAG_LOADED,data)),this._handleFragmentLoadComplete(data)}).catch(reason=>{this.state!==State.STOPPED&&this.state!==State.ERROR&&(this.warn(`Frag error: ${(null==reason?void 0:reason.message)||reason}`),this.resetFragmentLoading(frag))})}clearTrackerIfNeeded(frag){var _this$mediaBuffer;let{fragmentTracker}=this;if(fragmentTracker.getState(frag)===FragmentState.APPENDING){let playlistType=frag.type,bufferedInfo=this.getFwdBufferInfo(this.mediaBuffer,playlistType),minForwardBufferLength=Math.max(frag.duration,bufferedInfo?bufferedInfo.len:this.config.maxBufferLength),backtrackFragment=this.backtrackFragment;(1==(backtrackFragment?frag.sn-backtrackFragment.sn:0)||this.reduceMaxBufferLength(minForwardBufferLength,frag.duration))&&fragmentTracker.removeFragment(frag)}else(null==(_this$mediaBuffer=this.mediaBuffer)?void 0:_this$mediaBuffer.buffered.length)===0?fragmentTracker.removeAllFragments():fragmentTracker.hasParts(frag.type)&&(fragmentTracker.detectPartialFragments({frag,part:null,stats:frag.stats,id:frag.type}),fragmentTracker.getState(frag)===FragmentState.PARTIAL&&fragmentTracker.removeFragment(frag))}checkLiveUpdate(details){if(details.updated&&!details.live){let lastFragment=details.fragments[details.fragments.length-1];this.fragmentTracker.detectPartialFragments({frag:lastFragment,part:null,stats:lastFragment.stats,id:lastFragment.type})}details.fragments[0]||(details.deltaUpdateFailed=!0)}flushMainBuffer(startOffset,endOffset,type=null){startOffset-endOffset&&this.hls.trigger(Events1.BUFFER_FLUSHING,{startOffset,endOffset,type})}_loadInitSegment(frag,level){this._doFragLoad(frag,level).then(data=>{if(!data||this.fragContextChanged(frag)||!this.levels)throw Error("init load aborted");return data}).then(data=>{let{hls}=this,{payload}=data,decryptData=frag.decryptdata;if(payload&&payload.byteLength>0&&null!=decryptData&&decryptData.key&&decryptData.iv&&"AES-128"===decryptData.method){let startTime=self.performance.now();return this.decrypter.decrypt(new Uint8Array(payload),decryptData.key.buffer,decryptData.iv.buffer).catch(err=>{throw hls.trigger(Events1.ERROR,{type:ErrorTypes1.MEDIA_ERROR,details:ErrorDetails1.FRAG_DECRYPT_ERROR,fatal:!1,error:err,reason:err.message,frag}),err}).then(decryptedData=>{let endTime=self.performance.now();return hls.trigger(Events1.FRAG_DECRYPTED,{frag,payload:decryptedData,stats:{tstart:startTime,tdecrypt:endTime}}),data.payload=decryptedData,this.completeInitSegmentLoad(data)})}return this.completeInitSegmentLoad(data)}).catch(reason=>{this.state!==State.STOPPED&&this.state!==State.ERROR&&(this.warn(reason),this.resetFragmentLoading(frag))})}completeInitSegmentLoad(data){let{levels}=this;if(!levels)throw Error("init load aborted, missing levels");let stats=data.frag.stats;this.state=State.IDLE,data.frag.data=new Uint8Array(data.payload),stats.parsing.start=stats.buffering.start=self.performance.now(),stats.parsing.end=stats.buffering.end=self.performance.now(),this.tick()}fragContextChanged(frag){let{fragCurrent}=this;return!frag||!fragCurrent||frag.sn!==fragCurrent.sn||frag.level!==fragCurrent.level}fragBufferedComplete(frag,part){var _frag$startPTS,_frag$endPTS,_this$fragCurrent,_this$fragPrevious,_this$levels;let media=this.mediaBuffer?this.mediaBuffer:this.media;if(this.log(`Buffered ${frag.type} sn: ${frag.sn}${part?" part: "+part.index:""} of ${this.playlistType===PlaylistLevelType.MAIN?"level":"track"} ${frag.level} (frag:[${(null!=(_frag$startPTS=frag.startPTS)?_frag$startPTS:NaN).toFixed(3)}-${(null!=(_frag$endPTS=frag.endPTS)?_frag$endPTS:NaN).toFixed(3)}] > buffer:${media?TimeRanges.toString(BufferHelper.getBuffered(media)):"(detached)"})`),"initSegment"!==frag.sn){if(frag.type!==PlaylistLevelType.SUBTITLE){let el=frag.elementaryStreams;if(!Object.keys(el).some(type=>!!el[type])){this.state=State.IDLE;return}}let level=null==(_this$levels=this.levels)?void 0:_this$levels[frag.level];null!=level&&level.fragmentError&&(this.log(`Resetting level fragment error count of ${level.fragmentError} on frag buffered`),level.fragmentError=0)}this.state=State.IDLE,media&&(!this.loadedmetadata&&frag.type==PlaylistLevelType.MAIN&&media.buffered.length&&(null==(_this$fragCurrent=this.fragCurrent)?void 0:_this$fragCurrent.sn)===(null==(_this$fragPrevious=this.fragPrevious)?void 0:_this$fragPrevious.sn)&&(this.loadedmetadata=!0,this.seekToStartPos()),this.tick())}seekToStartPos(){}_handleFragmentLoadComplete(fragLoadedEndData){let{transmuxer}=this;if(!transmuxer)return;let{frag,part,partsLoaded}=fragLoadedEndData,complete=!partsLoaded||0===partsLoaded.length||partsLoaded.some(fragLoaded=>!fragLoaded),chunkMeta=new ChunkMetadata(frag.level,frag.sn,frag.stats.chunkCount+1,0,part?part.index:-1,!complete);transmuxer.flush(chunkMeta)}_handleFragmentLoadProgress(frag){}_doFragLoad(frag,level,targetBufferTime=null,progressCallback){var _frag$decryptdata;let result;let details=null==level?void 0:level.details;if(!this.levels||!details)throw Error(`frag load aborted, missing level${details?"":" detail"}s`);let keyLoadingPromise=null;if(frag.encrypted&&!(null!=(_frag$decryptdata=frag.decryptdata)&&_frag$decryptdata.key)?(this.log(`Loading key for ${frag.sn} of [${details.startSN}-${details.endSN}], ${"[stream-controller]"===this.logPrefix?"level":"track"} ${frag.level}`),this.state=State.KEY_LOADING,this.fragCurrent=frag,keyLoadingPromise=this.keyLoader.load(frag).then(keyLoadedData=>{if(!this.fragContextChanged(keyLoadedData.frag))return this.hls.trigger(Events1.KEY_LOADED,keyLoadedData),this.state===State.KEY_LOADING&&(this.state=State.IDLE),keyLoadedData}),this.hls.trigger(Events1.KEY_LOADING,{frag}),null===this.fragCurrent&&(keyLoadingPromise=Promise.reject(Error("frag load aborted, context changed in KEY_LOADING")))):!frag.encrypted&&details.encryptedFragments.length&&this.keyLoader.loadClear(frag,details.encryptedFragments),targetBufferTime=Math.max(frag.start,targetBufferTime||0),this.config.lowLatencyMode&&"initSegment"!==frag.sn){let partList=details.partList;if(partList&&progressCallback){targetBufferTime>frag.end&&details.fragmentHint&&(frag=details.fragmentHint);let partIndex=this.getNextPart(partList,frag,targetBufferTime);if(partIndex>-1){let _result;let part=partList[partIndex];return(this.log(`Loading part sn: ${frag.sn} p: ${part.index} cc: ${frag.cc} of playlist [${details.startSN}-${details.endSN}] parts [0-${partIndex}-${partList.length-1}] ${"[stream-controller]"===this.logPrefix?"level":"track"}: ${frag.level}, target: ${parseFloat(targetBufferTime.toFixed(3))}`),this.nextLoadPosition=part.start+part.duration,this.state=State.FRAG_LOADING,_result=keyLoadingPromise?keyLoadingPromise.then(keyLoadedData=>!keyLoadedData||this.fragContextChanged(keyLoadedData.frag)?null:this.doFragPartsLoad(frag,part,level,progressCallback)).catch(error=>this.handleFragLoadError(error)):this.doFragPartsLoad(frag,part,level,progressCallback).catch(error=>this.handleFragLoadError(error)),this.hls.trigger(Events1.FRAG_LOADING,{frag,part,targetBufferTime}),null===this.fragCurrent)?Promise.reject(Error("frag load aborted, context changed in FRAG_LOADING parts")):_result}if(!frag.url||this.loadedEndOfParts(partList,targetBufferTime))return Promise.resolve(null)}}this.log(`Loading fragment ${frag.sn} cc: ${frag.cc} ${details?"of ["+details.startSN+"-"+details.endSN+"] ":""}${"[stream-controller]"===this.logPrefix?"level":"track"}: ${frag.level}, target: ${parseFloat(targetBufferTime.toFixed(3))}`),isFiniteNumber(frag.sn)&&!this.bitrateTest&&(this.nextLoadPosition=frag.start+frag.duration),this.state=State.FRAG_LOADING;let dataOnProgress=this.config.progressive;return(result=dataOnProgress&&keyLoadingPromise?keyLoadingPromise.then(keyLoadedData=>!keyLoadedData||this.fragContextChanged(null==keyLoadedData?void 0:keyLoadedData.frag)?null:this.fragmentLoader.load(frag,progressCallback)).catch(error=>this.handleFragLoadError(error)):Promise.all([this.fragmentLoader.load(frag,dataOnProgress?progressCallback:void 0),keyLoadingPromise]).then(([fragLoadedData])=>(!dataOnProgress&&fragLoadedData&&progressCallback&&progressCallback(fragLoadedData),fragLoadedData)).catch(error=>this.handleFragLoadError(error)),this.hls.trigger(Events1.FRAG_LOADING,{frag,targetBufferTime}),null===this.fragCurrent)?Promise.reject(Error("frag load aborted, context changed in FRAG_LOADING")):result}doFragPartsLoad(frag,fromPart,level,progressCallback){return new Promise((resolve,reject)=>{var _level$details;let partsLoaded=[],initialPartList=null==(_level$details=level.details)?void 0:_level$details.partList,loadPart=part=>{this.fragmentLoader.loadPart(frag,part,progressCallback).then(partLoadedData=>{partsLoaded[part.index]=partLoadedData;let loadedPart=partLoadedData.part;this.hls.trigger(Events1.FRAG_LOADED,partLoadedData);let nextPart=getPartWith(level,frag.sn,part.index+1)||findPart(initialPartList,frag.sn,part.index+1);if(!nextPart)return resolve({frag,part:loadedPart,partsLoaded});loadPart(nextPart)}).catch(reject)};loadPart(fromPart)})}handleFragLoadError(error){if("data"in error){let data=error.data;error.data&&data.details===ErrorDetails1.INTERNAL_ABORTED?this.handleFragLoadAborted(data.frag,data.part):this.hls.trigger(Events1.ERROR,data)}else this.hls.trigger(Events1.ERROR,{type:ErrorTypes1.OTHER_ERROR,details:ErrorDetails1.INTERNAL_EXCEPTION,err:error,error,fatal:!0});return null}_handleTransmuxerFlush(chunkMeta){let context=this.getCurrentContext(chunkMeta);if(!context||this.state!==State.PARSING){this.fragCurrent||this.state===State.STOPPED||this.state===State.ERROR||(this.state=State.IDLE);return}let{frag,part,level}=context,now=self.performance.now();frag.stats.parsing.end=now,part&&(part.stats.parsing.end=now),this.updateLevelTiming(frag,part,level,chunkMeta.partial)}getCurrentContext(chunkMeta){let{levels,fragCurrent}=this,{level:levelIndex,sn,part:partIndex}=chunkMeta;if(!(null!=levels&&levels[levelIndex]))return this.warn(`Levels object was unset while buffering fragment ${sn} of level ${levelIndex}. The current chunk will not be buffered.`),null;let level=levels[levelIndex],part=partIndex>-1?getPartWith(level,sn,partIndex):null,frag=part?part.fragment:getFragmentWithSN(level,sn,fragCurrent);return frag?(fragCurrent&&fragCurrent!==frag&&(frag.stats=fragCurrent.stats),{frag,part,level}):null}bufferFragmentData(data,frag,part,chunkMeta,noBacktracking){var _buffer;if(!data||this.state!==State.PARSING)return;let{data1,data2}=data,buffer=data1;if(data1&&data2&&(buffer=appendUint8Array(data1,data2)),!(null!=(_buffer=buffer)&&_buffer.length))return;let segment={type:data.type,frag,part,chunkMeta,parent:frag.type,data:buffer};if(this.hls.trigger(Events1.BUFFER_APPENDING,segment),data.dropped&&data.independent&&!part){if(noBacktracking)return;this.flushBufferGap(frag)}}flushBufferGap(frag){let media=this.media;if(!media)return;if(!BufferHelper.isBuffered(media,media.currentTime)){this.flushMainBuffer(0,frag.start);return}let currentTime=media.currentTime,bufferInfo=BufferHelper.bufferInfo(media,currentTime,0),fragDuration=frag.duration,segmentFraction=Math.min(2*this.config.maxFragLookUpTolerance,.25*fragDuration),start=Math.max(Math.min(frag.start-segmentFraction,bufferInfo.end-segmentFraction),currentTime+segmentFraction);frag.start-start>segmentFraction&&this.flushMainBuffer(start,frag.start)}getFwdBufferInfo(bufferable,type){let pos=this.getLoadPosition();return isFiniteNumber(pos)?this.getFwdBufferInfoAtPos(bufferable,pos,type):null}getFwdBufferInfoAtPos(bufferable,pos,type){let{config:{maxBufferHole}}=this,bufferInfo=BufferHelper.bufferInfo(bufferable,pos,maxBufferHole);if(0===bufferInfo.len&&void 0!==bufferInfo.nextStart){let bufferedFragAtPos=this.fragmentTracker.getBufferedFrag(pos,type);if(bufferedFragAtPos&&bufferInfo.nextStart<bufferedFragAtPos.end)return BufferHelper.bufferInfo(bufferable,pos,Math.max(bufferInfo.nextStart,maxBufferHole))}return bufferInfo}getMaxBufferLength(levelBitrate){let{config}=this;return Math.min(levelBitrate?Math.max(8*config.maxBufferSize/levelBitrate,config.maxBufferLength):config.maxBufferLength,config.maxMaxBufferLength)}reduceMaxBufferLength(threshold,fragDuration){let config=this.config,minLength=Math.max(Math.min(threshold-fragDuration,config.maxBufferLength),fragDuration),reducedLength=Math.max(threshold-3*fragDuration,config.maxMaxBufferLength/2,minLength);return reducedLength>=minLength&&(config.maxMaxBufferLength=reducedLength,this.warn(`Reduce max buffer length to ${reducedLength}s`),!0)}getAppendedFrag(position,playlistType=PlaylistLevelType.MAIN){let fragOrPart=this.fragmentTracker.getAppendedFrag(position,PlaylistLevelType.MAIN);return fragOrPart&&"fragment"in fragOrPart?fragOrPart.fragment:fragOrPart}getNextFragment(pos,levelDetails){let frag;let fragments=levelDetails.fragments,fragLen=fragments.length;if(!fragLen)return null;let{config}=this,start=fragments[0].start;if(levelDetails.live){let initialLiveManifestSize=config.initialLiveManifestSize;if(fragLen<initialLiveManifestSize)return this.warn(`Not enough fragments to start playback (have: ${fragLen}, need: ${initialLiveManifestSize})`),null;(levelDetails.PTSKnown||this.startFragRequested||-1!==this.startPosition)&&!(pos<start)||(frag=this.getInitialLiveFragment(levelDetails,fragments),this.startPosition=this.nextLoadPosition=frag?this.hls.liveSyncPosition||frag.start:pos)}else pos<=start&&(frag=fragments[0]);if(!frag){let end=config.lowLatencyMode?levelDetails.partEnd:levelDetails.fragmentEnd;frag=this.getFragmentAtPosition(pos,end,levelDetails)}return this.mapToInitFragWhenRequired(frag)}isLoopLoading(frag,targetBufferTime){let trackerState=this.fragmentTracker.getState(frag);return(trackerState===FragmentState.OK||trackerState===FragmentState.PARTIAL&&!!frag.gap)&&this.nextLoadPosition>targetBufferTime}getNextFragmentLoopLoading(frag,levelDetails,bufferInfo,playlistType,maxBufLen){let gapStart=frag.gap,nextFragment=this.getNextFragment(this.nextLoadPosition,levelDetails);if(null===nextFragment)return nextFragment;if(frag=nextFragment,gapStart&&frag&&!frag.gap&&bufferInfo.nextStart){let nextbufferInfo=this.getFwdBufferInfoAtPos(this.mediaBuffer?this.mediaBuffer:this.media,bufferInfo.nextStart,playlistType);if(null!==nextbufferInfo&&bufferInfo.len+nextbufferInfo.len>=maxBufLen)return this.log(`buffer full after gaps in "${playlistType}" playlist starting at sn: ${frag.sn}`),null}return frag}mapToInitFragWhenRequired(frag){return null==frag||!frag.initSegment||null!=frag&&frag.initSegment.data||this.bitrateTest?frag:frag.initSegment}getNextPart(partList,frag,targetBufferTime){let nextPart=-1,contiguous=!1,independentAttrOmitted=!0;for(let i=0,len=partList.length;i<len;i++){let part=partList[i];if(independentAttrOmitted=independentAttrOmitted&&!part.independent,nextPart>-1&&targetBufferTime<part.start)break;let loaded=part.loaded;loaded?nextPart=-1:(contiguous||part.independent||independentAttrOmitted)&&part.fragment===frag&&(nextPart=i),contiguous=loaded}return nextPart}loadedEndOfParts(partList,targetBufferTime){let lastPart=partList[partList.length-1];return lastPart&&targetBufferTime>lastPart.start&&lastPart.loaded}getInitialLiveFragment(levelDetails,fragments){let fragPrevious=this.fragPrevious,frag=null;if(fragPrevious){if(levelDetails.hasProgramDateTime&&(this.log(`Live playlist, switching playlist, load frag with same PDT: ${fragPrevious.programDateTime}`),frag=findFragmentByPDT(fragments,fragPrevious.endProgramDateTime,this.config.maxFragLookUpTolerance)),!frag){let targetSN=fragPrevious.sn+1;if(targetSN>=levelDetails.startSN&&targetSN<=levelDetails.endSN){let fragNext=fragments[targetSN-levelDetails.startSN];fragPrevious.cc===fragNext.cc&&(frag=fragNext,this.log(`Live playlist, switching playlist, load frag with next SN: ${frag.sn}`))}!frag&&(frag=findFragWithCC(fragments,fragPrevious.cc))&&this.log(`Live playlist, switching playlist, load frag with same CC: ${frag.sn}`)}}else{let liveStart=this.hls.liveSyncPosition;null!==liveStart&&(frag=this.getFragmentAtPosition(liveStart,this.bitrateTest?levelDetails.fragmentEnd:levelDetails.edge,levelDetails))}return frag}getFragmentAtPosition(bufferEnd,end,levelDetails){let frag;let{config}=this,{fragPrevious}=this,{fragments,endSN}=levelDetails,{fragmentHint}=levelDetails,{maxFragLookUpTolerance}=config,partList=levelDetails.partList,loadingParts=!!(config.lowLatencyMode&&null!=partList&&partList.length&&fragmentHint);if(loadingParts&&fragmentHint&&!this.bitrateTest&&(fragments=fragments.concat(fragmentHint),endSN=fragmentHint.sn),frag=bufferEnd<end?findFragmentByPTS(fragPrevious,fragments,bufferEnd,bufferEnd>end-maxFragLookUpTolerance?0:maxFragLookUpTolerance):fragments[fragments.length-1]){let curSNIdx=frag.sn-levelDetails.startSN,fragState=this.fragmentTracker.getState(frag);if((fragState===FragmentState.OK||fragState===FragmentState.PARTIAL&&frag.gap)&&(fragPrevious=frag),fragPrevious&&frag.sn===fragPrevious.sn&&(!loadingParts||partList[0].fragment.sn>frag.sn)&&fragPrevious&&frag.level===fragPrevious.level){let nextFrag=fragments[curSNIdx+1];frag=frag.sn<endSN&&this.fragmentTracker.getState(nextFrag)!==FragmentState.OK?nextFrag:null}}return frag}synchronizeToLiveEdge(levelDetails){let{config,media}=this;if(!media)return;let liveSyncPosition=this.hls.liveSyncPosition,currentTime=media.currentTime,start=levelDetails.fragments[0].start,end=levelDetails.edge,withinSlidingWindow=currentTime>=start-config.maxFragLookUpTolerance&&currentTime<=end;if(null!==liveSyncPosition&&media.duration>liveSyncPosition&&(currentTime<liveSyncPosition||!withinSlidingWindow)){let maxLatency=void 0!==config.liveMaxLatencyDuration?config.liveMaxLatencyDuration:config.liveMaxLatencyDurationCount*levelDetails.targetduration;(!withinSlidingWindow&&media.readyState<4||currentTime<end-maxLatency)&&(this.loadedmetadata||(this.nextLoadPosition=liveSyncPosition),media.readyState&&(this.warn(`Playback: ${currentTime.toFixed(3)} is located too far from the end of live sliding playlist: ${end}, reset currentTime to : ${liveSyncPosition.toFixed(3)}`),media.currentTime=liveSyncPosition))}}alignPlaylists(details,previousDetails,switchDetails){let length=details.fragments.length;if(!length)return this.warn("No fragments in live playlist"),0;let slidingStart=details.fragments[0].start,aligned=details.alignedSliding&&isFiniteNumber(slidingStart);if(!previousDetails||!aligned&&!slidingStart){let{fragPrevious}=this;alignStream(fragPrevious,switchDetails,details);let alignedSlidingStart=details.fragments[0].start;return this.log(`Live playlist sliding: ${alignedSlidingStart.toFixed(2)} start-sn: ${previousDetails?previousDetails.startSN:"na"}->${details.startSN} prev-sn: ${fragPrevious?fragPrevious.sn:"na"} fragments: ${length}`),alignedSlidingStart}return slidingStart}waitForCdnTuneIn(details){return details.live&&details.canBlockReload&&details.partTarget&&details.tuneInGoal>Math.max(details.partHoldBack,3*details.partTarget)}setStartPosition(details,sliding){let startPosition=this.startPosition;if(startPosition<sliding&&(startPosition=-1),-1===startPosition||-1===this.lastCurrentTime){let offsetInMultivariantPlaylist=null!==this.startTimeOffset,startTimeOffset=offsetInMultivariantPlaylist?this.startTimeOffset:details.startTimeOffset;null!==startTimeOffset&&isFiniteNumber(startTimeOffset)?(startPosition=sliding+startTimeOffset,startTimeOffset<0&&(startPosition+=details.totalduration),startPosition=Math.min(Math.max(sliding,startPosition),sliding+details.totalduration),this.log(`Start time offset ${startTimeOffset} found in ${offsetInMultivariantPlaylist?"multivariant":"media"} playlist, adjust startPosition to ${startPosition}`),this.startPosition=startPosition):details.live?startPosition=this.hls.liveSyncPosition||sliding:this.startPosition=startPosition=0,this.lastCurrentTime=startPosition}this.nextLoadPosition=startPosition}getLoadPosition(){let{media}=this,pos=0;return this.loadedmetadata&&media?pos=media.currentTime:this.nextLoadPosition&&(pos=this.nextLoadPosition),pos}handleFragLoadAborted(frag,part){this.transmuxer&&"initSegment"!==frag.sn&&frag.stats.aborted&&(this.warn(`Fragment ${frag.sn}${part?" part "+part.index:""} of level ${frag.level} was aborted`),this.resetFragmentLoading(frag))}resetFragmentLoading(frag){this.fragCurrent&&(this.fragContextChanged(frag)||this.state===State.FRAG_LOADING_WAITING_RETRY)||(this.state=State.IDLE)}onFragmentOrKeyLoadError(filterType,data){if(data.chunkMeta&&!data.frag){let context=this.getCurrentContext(data.chunkMeta);context&&(data.frag=context.frag)}let frag=data.frag;if(!frag||frag.type!==filterType||!this.levels)return;if(this.fragContextChanged(frag)){var _this$fragCurrent2;this.warn(`Frag load error must match current frag to retry ${frag.url} > ${null==(_this$fragCurrent2=this.fragCurrent)?void 0:_this$fragCurrent2.url}`);return}let gapTagEncountered=data.details===ErrorDetails1.FRAG_GAP;gapTagEncountered&&this.fragmentTracker.fragBuffered(frag,!0);let errorAction=data.errorAction,{action,retryCount=0,retryConfig}=errorAction||{};if(errorAction&&action===NetworkErrorAction.RetryRequest&&retryConfig){this.resetStartWhenNotLoaded(this.levelLastLoaded);let delay=getRetryDelay(retryConfig,retryCount);this.warn(`Fragment ${frag.sn} of ${filterType} ${frag.level} errored with ${data.details}, retrying loading ${retryCount+1}/${retryConfig.maxNumRetry} in ${delay}ms`),errorAction.resolved=!0,this.retryDate=self.performance.now()+delay,this.state=State.FRAG_LOADING_WAITING_RETRY}else if(retryConfig&&errorAction){if(this.resetFragmentErrors(filterType),retryCount<retryConfig.maxNumRetry)gapTagEncountered||action===NetworkErrorAction.RemoveAlternatePermanently||(errorAction.resolved=!0);else{logger.warn(`${data.details} reached or exceeded max retry (${retryCount})`);return}}else(null==errorAction?void 0:errorAction.action)===NetworkErrorAction.SendAlternateToPenaltyBox?this.state=State.WAITING_LEVEL:this.state=State.ERROR;this.tickImmediate()}reduceLengthAndFlushBuffer(data){if(this.state===State.PARSING||this.state===State.PARSED){let frag=data.frag,playlistType=data.parent,bufferedInfo=this.getFwdBufferInfo(this.mediaBuffer,playlistType),buffered=bufferedInfo&&bufferedInfo.len>.5;buffered&&this.reduceMaxBufferLength(bufferedInfo.len,(null==frag?void 0:frag.duration)||10);let flushBuffer=!buffered;return flushBuffer&&this.warn(`Buffer full error while media.currentTime is not buffered, flush ${playlistType} buffer`),frag&&(this.fragmentTracker.removeFragment(frag),this.nextLoadPosition=frag.start),this.resetLoadingState(),flushBuffer}return!1}resetFragmentErrors(filterType){filterType===PlaylistLevelType.AUDIO&&(this.fragCurrent=null),this.loadedmetadata||(this.startFragRequested=!1),this.state!==State.STOPPED&&(this.state=State.IDLE)}afterBufferFlushed(media,bufferType,playlistType){if(!media)return;let bufferedTimeRanges=BufferHelper.getBuffered(media);this.fragmentTracker.detectEvictedFragments(bufferType,bufferedTimeRanges,playlistType),this.state===State.ENDED&&this.resetLoadingState()}resetLoadingState(){this.log("Reset loading state"),this.fragCurrent=null,this.fragPrevious=null,this.state=State.IDLE}resetStartWhenNotLoaded(level){if(!this.loadedmetadata){this.startFragRequested=!1;let details=level?level.details:null;null!=details&&details.live?(this.startPosition=-1,this.setStartPosition(details,0),this.resetLoadingState()):this.nextLoadPosition=this.startPosition}}resetWhenMissingContext(chunkMeta){this.warn(`The loading context changed while buffering fragment ${chunkMeta.sn} of level ${chunkMeta.level}. This chunk will not be buffered.`),this.removeUnbufferedFrags(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState()}removeUnbufferedFrags(start=0){this.fragmentTracker.removeFragmentsInRange(start,1/0,this.playlistType,!1,!0)}updateLevelTiming(frag,part,level,partial){var _this$transmuxer;let details=level.details;if(!details){this.warn("level.details undefined");return}if(!Object.keys(frag.elementaryStreams).reduce((result,type)=>{let info=frag.elementaryStreams[type];if(info){let parsedDuration=info.endPTS-info.startPTS;if(parsedDuration<=0)return this.warn(`Could not parse fragment ${frag.sn} ${type} duration reliably (${parsedDuration})`),result||!1;let drift=partial?0:updateFragPTSDTS(details,frag,info.startPTS,info.endPTS,info.startDTS,info.endDTS);return this.hls.trigger(Events1.LEVEL_PTS_UPDATED,{details,level,drift,type,frag,start:info.startPTS,end:info.endPTS}),!0}return result},!1)&&(null==(_this$transmuxer=this.transmuxer)?void 0:_this$transmuxer.error)===null){let error=Error(`Found no media in fragment ${frag.sn} of level ${frag.level} resetting transmuxer to fallback to playlist timing`);if(0===level.fragmentError&&(level.fragmentError++,frag.gap=!0,this.fragmentTracker.removeFragment(frag),this.fragmentTracker.fragBuffered(frag,!0)),this.warn(error.message),this.hls.trigger(Events1.ERROR,{type:ErrorTypes1.MEDIA_ERROR,details:ErrorDetails1.FRAG_PARSING_ERROR,fatal:!1,error,frag,reason:`Found no media in msn ${frag.sn} of level "${level.url}"`}),!this.hls)return;this.resetTransmuxer()}this.state=State.PARSED,this.hls.trigger(Events1.FRAG_PARSED,{frag,part})}resetTransmuxer(){this.transmuxer&&(this.transmuxer.destroy(),this.transmuxer=null)}recoverWorkerError(data){"demuxerWorker"===data.event&&(this.fragmentTracker.removeAllFragments(),this.resetTransmuxer(),this.resetStartWhenNotLoaded(this.levelLastLoaded),this.resetLoadingState())}set state(nextState){let previousState=this._state;previousState!==nextState&&(this._state=nextState,this.log(`${previousState}->${nextState}`))}get state(){return this._state}}function getSourceBuffer(){return self.SourceBuffer||self.WebKitSourceBuffer}function isMSESupported(){if(!getMediaSource())return!1;let sourceBuffer=getSourceBuffer();return!sourceBuffer||sourceBuffer.prototype&&"function"==typeof sourceBuffer.prototype.appendBuffer&&"function"==typeof sourceBuffer.prototype.remove}function isSupported(){if(!isMSESupported())return!1;let mediaSource=getMediaSource();return"function"==typeof(null==mediaSource?void 0:mediaSource.isTypeSupported)&&(["avc1.42E01E,mp4a.40.2","av01.0.01M.08","vp09.00.50.08"].some(codecsForVideoContainer=>mediaSource.isTypeSupported(mimeTypeForCodec(codecsForVideoContainer,"video")))||["mp4a.40.2","fLaC"].some(codecForAudioContainer=>mediaSource.isTypeSupported(mimeTypeForCodec(codecForAudioContainer,"audio"))))}function changeTypeSupported(){var _sourceBuffer$prototy;let sourceBuffer=getSourceBuffer();return"function"==typeof(null==sourceBuffer?void 0:null==(_sourceBuffer$prototy=sourceBuffer.prototype)?void 0:_sourceBuffer$prototy.changeType)}function hasUMDWorker(){return"function"==typeof __HLS_WORKER_BUNDLE__}function injectWorker(){let blob=new self.Blob([`var exports={};var module={exports:exports};function define(f){f()};define.amd=true;(${__HLS_WORKER_BUNDLE__.toString()})(true);`],{type:"text/javascript"}),objectURL=self.URL.createObjectURL(blob);return{worker:new self.Worker(objectURL),objectURL}}function loadWorker(path){let scriptURL=new self.URL(path,self.location.href).href;return{worker:new self.Worker(scriptURL),scriptURL}}function dummyTrack(type="",inputTimeScale=9e4){return{type,id:-1,pid:-1,inputTimeScale,sequenceNumber:-1,samples:[],dropped:0}}class BaseAudioDemuxer{constructor(){this._audioTrack=void 0,this._id3Track=void 0,this.frameIndex=0,this.cachedData=null,this.basePTS=null,this.initPTS=null,this.lastPTS=null}resetInitSegment(initSegment,audioCodec,videoCodec,trackDuration){this._id3Track={type:"id3",id:3,pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0}}resetTimeStamp(deaultTimestamp){this.initPTS=deaultTimestamp,this.resetContiguity()}resetContiguity(){this.basePTS=null,this.lastPTS=null,this.frameIndex=0}canParse(data,offset){return!1}appendFrame(track,data,offset){}demux(data,timeOffset){let lastDataIndex;this.cachedData&&(data=appendUint8Array(this.cachedData,data),this.cachedData=null);let id3Data=getID3Data(data,0),offset=id3Data?id3Data.length:0,track=this._audioTrack,id3Track=this._id3Track,timestamp=id3Data?getTimeStamp(id3Data):void 0,length=data.length;for((null===this.basePTS||0===this.frameIndex&&isFiniteNumber(timestamp))&&(this.basePTS=initPTSFn(timestamp,timeOffset,this.initPTS),this.lastPTS=this.basePTS),null===this.lastPTS&&(this.lastPTS=this.basePTS),id3Data&&id3Data.length>0&&id3Track.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:id3Data,type:MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY});offset<length;){if(this.canParse(data,offset)){let frame=this.appendFrame(track,data,offset);frame?(this.frameIndex++,this.lastPTS=frame.sample.pts,offset+=frame.length,lastDataIndex=offset):offset=length}else canParse$2(data,offset)?(id3Data=getID3Data(data,offset),id3Track.samples.push({pts:this.lastPTS,dts:this.lastPTS,data:id3Data,type:MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY}),offset+=id3Data.length,lastDataIndex=offset):offset++;if(offset===length&&lastDataIndex!==length){let partialData=sliceUint8(data,lastDataIndex);this.cachedData?this.cachedData=appendUint8Array(this.cachedData,partialData):this.cachedData=partialData}}return{audioTrack:track,videoTrack:dummyTrack(),id3Track,textTrack:dummyTrack()}}demuxSampleAes(data,keyData,timeOffset){return Promise.reject(Error(`[${this}] This demuxer does not support Sample-AES decryption`))}flush(timeOffset){let cachedData=this.cachedData;return cachedData&&(this.cachedData=null,this.demux(cachedData,0)),{audioTrack:this._audioTrack,videoTrack:dummyTrack(),id3Track:this._id3Track,textTrack:dummyTrack()}}destroy(){}}let initPTSFn=(timestamp,timeOffset,initPTS)=>isFiniteNumber(timestamp)?90*timestamp:9e4*timeOffset+(initPTS?9e4*initPTS.baseTime/initPTS.timescale:0);function getAudioConfig(observer,data,offset,audioCodec){let adtsObjectType,adtsExtensionSamplingIndex,adtsChannelConfig,config;let userAgent=navigator.userAgent.toLowerCase(),adtsSamplingRates=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350];adtsObjectType=((192&data[offset+2])>>>6)+1;let adtsSamplingIndex=(60&data[offset+2])>>>2;if(adtsSamplingIndex>adtsSamplingRates.length-1){let error=Error(`invalid ADTS sampling index:${adtsSamplingIndex}`);observer.emit(Events1.ERROR,Events1.ERROR,{type:ErrorTypes1.MEDIA_ERROR,details:ErrorDetails1.FRAG_PARSING_ERROR,fatal:!0,error,reason:error.message});return}return adtsChannelConfig=(1&data[offset+2])<<2|(192&data[offset+3])>>>6,logger.log(`manifest codec:${audioCodec}, ADTS type:${adtsObjectType}, samplingIndex:${adtsSamplingIndex}`),/firefox/i.test(userAgent)?adtsSamplingIndex>=6?(adtsObjectType=5,config=[,,,,],adtsExtensionSamplingIndex=adtsSamplingIndex-3):(adtsObjectType=2,config=[,,],adtsExtensionSamplingIndex=adtsSamplingIndex):-1!==userAgent.indexOf("android")?(adtsObjectType=2,config=[,,],adtsExtensionSamplingIndex=adtsSamplingIndex):(adtsObjectType=5,config=[,,,,],audioCodec&&(-1!==audioCodec.indexOf("mp4a.40.29")||-1!==audioCodec.indexOf("mp4a.40.5"))||!audioCodec&&adtsSamplingIndex>=6?adtsExtensionSamplingIndex=adtsSamplingIndex-3:((audioCodec&&-1!==audioCodec.indexOf("mp4a.40.2")&&(adtsSamplingIndex>=6&&1===adtsChannelConfig||/vivaldi/i.test(userAgent))||!audioCodec&&1===adtsChannelConfig)&&(adtsObjectType=2,config=[,,]),adtsExtensionSamplingIndex=adtsSamplingIndex)),config[0]=adtsObjectType<<3,config[0]|=(14&adtsSamplingIndex)>>1,config[1]|=(1&adtsSamplingIndex)<<7,config[1]|=adtsChannelConfig<<3,5===adtsObjectType&&(config[1]|=(14&adtsExtensionSamplingIndex)>>1,config[2]=(1&adtsExtensionSamplingIndex)<<7,config[2]|=8,config[3]=0),{config,samplerate:adtsSamplingRates[adtsSamplingIndex],channelCount:adtsChannelConfig,codec:"mp4a.40."+adtsObjectType,manifestCodec:audioCodec}}function isHeaderPattern$1(data,offset){return 255===data[offset]&&(246&data[offset+1])==240}function getHeaderLength(data,offset){return 1&data[offset+1]?7:9}function getFullFrameLength(data,offset){return(3&data[offset+3])<<11|data[offset+4]<<3|(224&data[offset+5])>>>5}function canGetFrameLength(data,offset){return offset+5<data.length}function isHeader$1(data,offset){return offset+1<data.length&&isHeaderPattern$1(data,offset)}function canParse$1(data,offset){return canGetFrameLength(data,offset)&&isHeaderPattern$1(data,offset)&&getFullFrameLength(data,offset)<=data.length-offset}function probe$1(data,offset){if(isHeader$1(data,offset)){let headerLength=getHeaderLength(data,offset);if(offset+headerLength>=data.length)return!1;let frameLength=getFullFrameLength(data,offset);if(frameLength<=headerLength)return!1;let newOffset=offset+frameLength;return newOffset===data.length||isHeader$1(data,newOffset)}return!1}function initTrackConfig(track,observer,data,offset,audioCodec){if(!track.samplerate){let config=getAudioConfig(observer,data,offset,audioCodec);config&&(track.config=config.config,track.samplerate=config.samplerate,track.channelCount=config.channelCount,track.codec=config.codec,track.manifestCodec=config.manifestCodec,logger.log(`parsed codec:${track.codec}, rate:${config.samplerate}, channels:${config.channelCount}`))}}function parseFrameHeader(data,offset){let headerLength=getHeaderLength(data,offset);if(offset+headerLength<=data.length){let frameLength=getFullFrameLength(data,offset)-headerLength;if(frameLength>0)return{headerLength,frameLength}}}function appendFrame$1(track,data,offset,pts,frameIndex){let unit;let stamp=pts+9216e4/track.samplerate*frameIndex,header=parseFrameHeader(data,offset);if(header){let{frameLength,headerLength}=header,_length=headerLength+frameLength,missing=Math.max(0,offset+_length-data.length);missing?(unit=new Uint8Array(_length-headerLength)).set(data.subarray(offset+headerLength,data.length),0):unit=data.subarray(offset+headerLength,offset+_length);let _sample={unit,pts:stamp};return missing||track.samples.push(_sample),{sample:_sample,length:_length,missing}}let length=data.length-offset;return(unit=new Uint8Array(length)).set(data.subarray(offset,data.length),0),{sample:{unit,pts:stamp},length,missing:-1}}let chromeVersion$1=null,BitratesMap=[32,64,96,128,160,192,224,256,288,320,352,384,416,448,32,48,56,64,80,96,112,128,160,192,224,256,320,384,32,40,48,56,64,80,96,112,128,160,192,224,256,320,32,48,56,64,80,96,112,128,144,160,176,192,224,256,8,16,24,32,40,48,56,64,80,96,112,128,144,160],SamplingRateMap=[44100,48e3,32e3,22050,24e3,16e3,11025,12e3,8e3],SamplesCoefficients=[[0,72,144,12],[0,0,0,0],[0,72,144,12],[0,144,144,12]],BytesInSlot=[0,1,1,4];function appendFrame(track,data,offset,pts,frameIndex){if(offset+24>data.length)return;let header=parseHeader(data,offset);if(header&&offset+header.frameLength<=data.length){let stamp=pts+9e4*header.samplesPerFrame/header.sampleRate*frameIndex,sample={unit:data.subarray(offset,offset+header.frameLength),pts:stamp,dts:stamp};return track.config=[],track.channelCount=header.channelCount,track.samplerate=header.sampleRate,track.samples.push(sample),{sample,length:header.frameLength,missing:0}}}function parseHeader(data,offset){let mpegVersion=data[offset+1]>>3&3,mpegLayer=data[offset+1]>>1&3,bitRateIndex=data[offset+2]>>4&15,sampleRateIndex=data[offset+2]>>2&3;if(1!==mpegVersion&&0!==bitRateIndex&&15!==bitRateIndex&&3!==sampleRateIndex){let paddingBit=data[offset+2]>>1&1,channelMode=data[offset+3]>>6,bitRate=1e3*BitratesMap[14*(3===mpegVersion?3-mpegLayer:3===mpegLayer?3:4)+bitRateIndex-1],sampleRate=SamplingRateMap[3*(3===mpegVersion?0:2===mpegVersion?1:2)+sampleRateIndex],sampleCoefficient=SamplesCoefficients[mpegVersion][mpegLayer],bytesInSlot=BytesInSlot[mpegLayer];if(null===chromeVersion$1){let result=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);chromeVersion$1=result?parseInt(result[1]):0}return chromeVersion$1&&chromeVersion$1<=87&&2===mpegLayer&&bitRate>=224e3&&0===channelMode&&(data[offset+3]=128|data[offset+3]),{sampleRate,channelCount:3===channelMode?1:2,frameLength:Math.floor(sampleCoefficient*bitRate/sampleRate+paddingBit)*bytesInSlot,samplesPerFrame:8*sampleCoefficient*bytesInSlot}}}function isHeaderPattern(data,offset){return 255===data[offset]&&(224&data[offset+1])==224&&(6&data[offset+1])!=0}function isHeader(data,offset){return offset+1<data.length&&isHeaderPattern(data,offset)}function canParse(data,offset){return isHeaderPattern(data,offset)&&4<=data.length-offset}function probe(data,offset){if(offset+1<data.length&&isHeaderPattern(data,offset)){let header=parseHeader(data,offset),frameLength=4;null!=header&&header.frameLength&&(frameLength=header.frameLength);let newOffset=offset+frameLength;return newOffset===data.length||isHeader(data,newOffset)}return!1}let emsgSchemePattern=/\/emsg[-/]ID3/i,getAudioBSID=(data,offset)=>{let bsid=0,numBits=5;offset+=5;let temp=new Uint32Array(1),mask=new Uint32Array(1),byte=new Uint8Array(1);for(;numBits>0;){byte[0]=data[offset];let bits=Math.min(numBits,8),shift=8-bits;mask[0]=4278190080>>>24+shift<<shift,temp[0]=(byte[0]&mask[0])>>shift,bsid=bsid?bsid<<bits|temp[0]:temp[0],offset+=1,numBits-=bits}return bsid};class BaseVideoParser{constructor(){this.VideoSample=null}createVideoSample(key,pts,dts,debug){return{key,frame:!1,pts,dts,units:[],debug,length:0}}getLastNalUnit(samples){var _VideoSample;let lastUnit;let VideoSample=this.VideoSample;if(VideoSample&&0!==VideoSample.units.length||(VideoSample=samples[samples.length-1]),null!=(_VideoSample=VideoSample)&&_VideoSample.units){let units=VideoSample.units;lastUnit=units[units.length-1]}return lastUnit}pushAccessUnit(VideoSample,videoTrack){if(VideoSample.units.length&&VideoSample.frame){if(void 0===VideoSample.pts){let samples=videoTrack.samples,nbSamples=samples.length;if(nbSamples){let lastSample=samples[nbSamples-1];VideoSample.pts=lastSample.pts,VideoSample.dts=lastSample.dts}else{videoTrack.dropped++;return}}videoTrack.samples.push(VideoSample)}VideoSample.debug.length&&logger.log(VideoSample.pts+"/"+VideoSample.dts+":"+VideoSample.debug)}}class ExpGolomb{constructor(data){this.data=void 0,this.bytesAvailable=void 0,this.word=void 0,this.bitsAvailable=void 0,this.data=data,this.bytesAvailable=data.byteLength,this.word=0,this.bitsAvailable=0}loadWord(){let data=this.data,bytesAvailable=this.bytesAvailable,position=data.byteLength-bytesAvailable,workingBytes=new Uint8Array(4),availableBytes=Math.min(4,bytesAvailable);if(0===availableBytes)throw Error("no bytes available");workingBytes.set(data.subarray(position,position+availableBytes)),this.word=new DataView(workingBytes.buffer).getUint32(0),this.bitsAvailable=8*availableBytes,this.bytesAvailable-=availableBytes}skipBits(count){let skipBytes;count=Math.min(count,8*this.bytesAvailable+this.bitsAvailable),this.bitsAvailable>count||(count-=this.bitsAvailable,skipBytes=count>>3,count-=skipBytes<<3,this.bytesAvailable-=skipBytes,this.loadWord()),this.word<<=count,this.bitsAvailable-=count}readBits(size){let bits=Math.min(this.bitsAvailable,size),valu=this.word>>>32-bits;if(size>32&&logger.error("Cannot read more than 32 bits at a time"),this.bitsAvailable-=bits,this.bitsAvailable>0)this.word<<=bits;else if(this.bytesAvailable>0)this.loadWord();else throw Error("no bits available");return(bits=size-bits)>0&&this.bitsAvailable?valu<<bits|this.readBits(bits):valu}skipLZ(){let leadingZeroCount;for(leadingZeroCount=0;leadingZeroCount<this.bitsAvailable;++leadingZeroCount)if((this.word&2147483648>>>leadingZeroCount)!=0)return this.word<<=leadingZeroCount,this.bitsAvailable-=leadingZeroCount,leadingZeroCount;return this.loadWord(),leadingZeroCount+this.skipLZ()}skipUEG(){this.skipBits(1+this.skipLZ())}skipEG(){this.skipBits(1+this.skipLZ())}readUEG(){let clz=this.skipLZ();return this.readBits(clz+1)-1}readEG(){let valu=this.readUEG();return 1&valu?1+valu>>>1:-1*(valu>>>1)}readBoolean(){return 1===this.readBits(1)}readUByte(){return this.readBits(8)}readUShort(){return this.readBits(16)}readUInt(){return this.readBits(32)}skipScalingList(count){let lastScale=8,nextScale=8;for(let j=0;j<count;j++)0!==nextScale&&(nextScale=(lastScale+this.readEG()+256)%256),lastScale=0===nextScale?lastScale:nextScale}readSPS(){let numRefFramesInPicOrderCntCycle,scalingListCount,i,frameCropLeftOffset=0,frameCropRightOffset=0,frameCropTopOffset=0,frameCropBottomOffset=0,readUByte=this.readUByte.bind(this),readBits=this.readBits.bind(this),readUEG=this.readUEG.bind(this),readBoolean=this.readBoolean.bind(this),skipBits=this.skipBits.bind(this),skipEG=this.skipEG.bind(this),skipUEG=this.skipUEG.bind(this),skipScalingList=this.skipScalingList.bind(this);readUByte();let profileIdc=readUByte();if(readBits(5),skipBits(3),readUByte(),skipUEG(),100===profileIdc||110===profileIdc||122===profileIdc||244===profileIdc||44===profileIdc||83===profileIdc||86===profileIdc||118===profileIdc||128===profileIdc){let chromaFormatIdc=readUEG();if(3===chromaFormatIdc&&skipBits(1),skipUEG(),skipUEG(),skipBits(1),readBoolean())for(i=0,scalingListCount=3!==chromaFormatIdc?8:12;i<scalingListCount;i++)readBoolean()&&skipScalingList(i<6?16:64)}skipUEG();let picOrderCntType=readUEG();if(0===picOrderCntType)readUEG();else if(1===picOrderCntType)for(skipBits(1),skipEG(),skipEG(),numRefFramesInPicOrderCntCycle=readUEG(),i=0;i<numRefFramesInPicOrderCntCycle;i++)skipEG();skipUEG(),skipBits(1);let picWidthInMbsMinus1=readUEG(),picHeightInMapUnitsMinus1=readUEG(),frameMbsOnlyFlag=readBits(1);0===frameMbsOnlyFlag&&skipBits(1),skipBits(1),readBoolean()&&(frameCropLeftOffset=readUEG(),frameCropRightOffset=readUEG(),frameCropTopOffset=readUEG(),frameCropBottomOffset=readUEG());let pixelRatio=[1,1];if(readBoolean()&&readBoolean())switch(readUByte()){case 1:pixelRatio=[1,1];break;case 2:pixelRatio=[12,11];break;case 3:pixelRatio=[10,11];break;case 4:pixelRatio=[16,11];break;case 5:pixelRatio=[40,33];break;case 6:pixelRatio=[24,11];break;case 7:pixelRatio=[20,11];break;case 8:pixelRatio=[32,11];break;case 9:pixelRatio=[80,33];break;case 10:pixelRatio=[18,11];break;case 11:pixelRatio=[15,11];break;case 12:pixelRatio=[64,33];break;case 13:pixelRatio=[160,99];break;case 14:pixelRatio=[4,3];break;case 15:pixelRatio=[3,2];break;case 16:pixelRatio=[2,1];break;case 255:pixelRatio=[readUByte()<<8|readUByte(),readUByte()<<8|readUByte()]}return{width:Math.ceil((picWidthInMbsMinus1+1)*16-2*frameCropLeftOffset-2*frameCropRightOffset),height:(2-frameMbsOnlyFlag)*(picHeightInMapUnitsMinus1+1)*16-(frameMbsOnlyFlag?2:4)*(frameCropTopOffset+frameCropBottomOffset),pixelRatio:pixelRatio}}readSliceType(){return this.readUByte(),this.readUEG(),this.readUEG()}}class AvcVideoParser extends BaseVideoParser{parseAVCPES(track,textTrack,pes,last,duration){let push;let units=this.parseAVCNALu(track,pes.data),VideoSample=this.VideoSample,spsfound=!1;pes.data=null,VideoSample&&units.length&&!track.audFound&&(this.pushAccessUnit(VideoSample,track),VideoSample=this.VideoSample=this.createVideoSample(!1,pes.pts,pes.dts,"")),units.forEach(unit=>{var _VideoSample2,_VideoSample,_track$pixelRatio,_track$pixelRatio2;switch(unit.type){case 1:{let iskey=!1;push=!0;let data=unit.data;if(spsfound&&data.length>4){let sliceType=new ExpGolomb(data).readSliceType();(2===sliceType||4===sliceType||7===sliceType||9===sliceType)&&(iskey=!0)}iskey&&null!=(_VideoSample=VideoSample)&&_VideoSample.frame&&!VideoSample.key&&(this.pushAccessUnit(VideoSample,track),VideoSample=this.VideoSample=null),VideoSample||(VideoSample=this.VideoSample=this.createVideoSample(!0,pes.pts,pes.dts,"")),VideoSample.frame=!0,VideoSample.key=iskey;break}case 5:push=!0,null!=(_VideoSample2=VideoSample)&&_VideoSample2.frame&&!VideoSample.key&&(this.pushAccessUnit(VideoSample,track),VideoSample=this.VideoSample=null),VideoSample||(VideoSample=this.VideoSample=this.createVideoSample(!0,pes.pts,pes.dts,"")),VideoSample.key=!0,VideoSample.frame=!0;break;case 6:push=!0,parseSEIMessageFromNALu(unit.data,1,pes.pts,textTrack.samples);break;case 7:{push=!0,spsfound=!0;let sps=unit.data,config=new ExpGolomb(sps).readSPS();if(!track.sps||track.width!==config.width||track.height!==config.height||(null==(_track$pixelRatio=track.pixelRatio)?void 0:_track$pixelRatio[0])!==config.pixelRatio[0]||(null==(_track$pixelRatio2=track.pixelRatio)?void 0:_track$pixelRatio2[1])!==config.pixelRatio[1]){track.width=config.width,track.height=config.height,track.pixelRatio=config.pixelRatio,track.sps=[sps],track.duration=duration;let codecarray=sps.subarray(1,4),codecstring="avc1.";for(let i=0;i<3;i++){let h=codecarray[i].toString(16);h.length<2&&(h="0"+h),codecstring+=h}track.codec=codecstring}break}case 8:push=!0,track.pps=[unit.data];break;case 9:push=!0,track.audFound=!0,VideoSample&&this.pushAccessUnit(VideoSample,track),VideoSample=this.VideoSample=this.createVideoSample(!1,pes.pts,pes.dts,"");break;case 12:push=!0;break;default:push=!1,VideoSample&&(VideoSample.debug+="unknown NAL "+unit.type+" ")}VideoSample&&push&&VideoSample.units.push(unit)}),last&&VideoSample&&(this.pushAccessUnit(VideoSample,track),this.VideoSample=null)}parseAVCNALu(track,array){let value,overflow,unitType;let len=array.byteLength,state=track.naluState||0,lastState=state,units=[],i=0,lastUnitStart=-1,lastUnitType=0;for(-1===state&&(lastUnitStart=0,lastUnitType=31&array[0],state=0,i=1);i<len;){if(value=array[i++],!state){state=value?0:1;continue}if(1===state){state=value?0:2;continue}if(value){if(1===value){if(overflow=i-state-1,lastUnitStart>=0){let unit={data:array.subarray(lastUnitStart,overflow),type:lastUnitType};units.push(unit)}else{let lastUnit=this.getLastNalUnit(track.samples);lastUnit&&(lastState&&i<=4-lastState&&lastUnit.state&&(lastUnit.data=lastUnit.data.subarray(0,lastUnit.data.byteLength-lastState)),overflow>0&&(lastUnit.data=appendUint8Array(lastUnit.data,array.subarray(0,overflow)),lastUnit.state=0))}i<len?(unitType=31&array[i],lastUnitStart=i,lastUnitType=unitType,state=0):state=-1}else state=0}else state=3}if(lastUnitStart>=0&&state>=0){let unit={data:array.subarray(lastUnitStart,len),type:lastUnitType,state:state};units.push(unit)}if(0===units.length){let lastUnit=this.getLastNalUnit(track.samples);lastUnit&&(lastUnit.data=appendUint8Array(lastUnit.data,array))}return track.naluState=state,units}}class SampleAesDecrypter{constructor(observer,config,keyData){this.keyData=void 0,this.decrypter=void 0,this.keyData=keyData,this.decrypter=new Decrypter(config,{removePKCS7Padding:!1})}decryptBuffer(encryptedData){return this.decrypter.decrypt(encryptedData,this.keyData.key.buffer,this.keyData.iv.buffer)}decryptAacSample(samples,sampleIndex,callback){let curUnit=samples[sampleIndex].unit;if(curUnit.length<=16)return;let encryptedData=curUnit.subarray(16,curUnit.length-curUnit.length%16),encryptedBuffer=encryptedData.buffer.slice(encryptedData.byteOffset,encryptedData.byteOffset+encryptedData.length);this.decryptBuffer(encryptedBuffer).then(decryptedBuffer=>{let decryptedData=new Uint8Array(decryptedBuffer);curUnit.set(decryptedData,16),this.decrypter.isSync()||this.decryptAacSamples(samples,sampleIndex+1,callback)})}decryptAacSamples(samples,sampleIndex,callback){for(;;sampleIndex++){if(sampleIndex>=samples.length){callback();return}if(!(samples[sampleIndex].unit.length<32)&&(this.decryptAacSample(samples,sampleIndex,callback),!this.decrypter.isSync()))return}}getAvcEncryptedData(decodedData){let encryptedDataLen=16*Math.floor((decodedData.length-48)/160)+16,encryptedData=new Int8Array(encryptedDataLen),outputPos=0;for(let inputPos=32;inputPos<decodedData.length-16;inputPos+=160,outputPos+=16)encryptedData.set(decodedData.subarray(inputPos,inputPos+16),outputPos);return encryptedData}getAvcDecryptedUnit(decodedData,decryptedData){let uint8DecryptedData=new Uint8Array(decryptedData),inputPos=0;for(let outputPos=32;outputPos<decodedData.length-16;outputPos+=160,inputPos+=16)decodedData.set(uint8DecryptedData.subarray(inputPos,inputPos+16),outputPos);return decodedData}decryptAvcSample(samples,sampleIndex,unitIndex,callback,curUnit){let decodedData=discardEPB(curUnit.data),encryptedData=this.getAvcEncryptedData(decodedData);this.decryptBuffer(encryptedData.buffer).then(decryptedBuffer=>{curUnit.data=this.getAvcDecryptedUnit(decodedData,decryptedBuffer),this.decrypter.isSync()||this.decryptAvcSamples(samples,sampleIndex,unitIndex+1,callback)})}decryptAvcSamples(samples,sampleIndex,unitIndex,callback){if(samples instanceof Uint8Array)throw Error("Cannot decrypt samples of type Uint8Array");for(;;sampleIndex++,unitIndex=0){if(sampleIndex>=samples.length){callback();return}let curUnits=samples[sampleIndex].units;for(;!(unitIndex>=curUnits.length);unitIndex++){let curUnit=curUnits[unitIndex];if(!(curUnit.data.length<=48)&&(1===curUnit.type||5===curUnit.type)&&(this.decryptAvcSample(samples,sampleIndex,unitIndex,callback,curUnit),!this.decrypter.isSync()))return}}}}class TSDemuxer{constructor(observer,config,typeSupported){this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.sampleAes=null,this.pmtParsed=!1,this.audioCodec=void 0,this.videoCodec=void 0,this._duration=0,this._pmtId=-1,this._videoTrack=void 0,this._audioTrack=void 0,this._id3Track=void 0,this._txtTrack=void 0,this.aacOverFlow=null,this.remainderData=null,this.videoParser=void 0,this.observer=observer,this.config=config,this.typeSupported=typeSupported,this.videoParser=new AvcVideoParser}static probe(data){let syncOffset=TSDemuxer.syncOffset(data);return syncOffset>0&&logger.warn(`MPEG2-TS detected but first sync word found @ offset ${syncOffset}`),-1!==syncOffset}static syncOffset(data){let length=data.length,scanwindow=Math.min(940,length-188)+1,i=0;for(;i<scanwindow;){let foundPat=!1,packetStart=-1,tsPackets=0;for(let j=i;j<length;j+=188)if(71===data[j]&&(length-j==188||71===data[j+188])){if(tsPackets++,-1===packetStart&&0!==(packetStart=j)&&(scanwindow=Math.min(packetStart+18612,data.length-188)+1),foundPat||(foundPat=0===parsePID(data,j)),foundPat&&tsPackets>1&&(0===packetStart&&tsPackets>2||j+188>scanwindow))return packetStart}else if(tsPackets)return -1;else break;i++}return -1}static createTrack(type,duration){return{container:"video"===type||"audio"===type?"video/mp2t":void 0,type,id:RemuxerTrackIdConfig[type],pid:-1,inputTimeScale:9e4,sequenceNumber:0,samples:[],dropped:0,duration:"audio"===type?duration:void 0}}resetInitSegment(initSegment,audioCodec,videoCodec,trackDuration){this.pmtParsed=!1,this._pmtId=-1,this._videoTrack=TSDemuxer.createTrack("video"),this._audioTrack=TSDemuxer.createTrack("audio",trackDuration),this._id3Track=TSDemuxer.createTrack("id3"),this._txtTrack=TSDemuxer.createTrack("text"),this._audioTrack.segmentCodec="aac",this.aacOverFlow=null,this.remainderData=null,this.audioCodec=audioCodec,this.videoCodec=videoCodec,this._duration=trackDuration}resetTimeStamp(){}resetContiguity(){let{_audioTrack,_videoTrack,_id3Track}=this;_audioTrack&&(_audioTrack.pesData=null),_videoTrack&&(_videoTrack.pesData=null),_id3Track&&(_id3Track.pesData=null),this.aacOverFlow=null,this.remainderData=null}demux(data,timeOffset,isSampleAes=!1,flush=!1){let pes;isSampleAes||(this.sampleAes=null);let videoTrack=this._videoTrack,audioTrack=this._audioTrack,id3Track=this._id3Track,textTrack=this._txtTrack,videoPid=videoTrack.pid,videoData=videoTrack.pesData,audioPid=audioTrack.pid,id3Pid=id3Track.pid,audioData=audioTrack.pesData,id3Data=id3Track.pesData,unknownPID=null,pmtParsed=this.pmtParsed,pmtId=this._pmtId,len=data.length;if(this.remainderData&&(len=(data=appendUint8Array(this.remainderData,data)).length,this.remainderData=null),len<188&&!flush)return this.remainderData=data,{audioTrack,videoTrack,id3Track,textTrack};let syncOffset=Math.max(0,TSDemuxer.syncOffset(data));(len-=(len-syncOffset)%188)<data.byteLength&&!flush&&(this.remainderData=new Uint8Array(data.buffer,len,data.buffer.byteLength-len));let tsPacketErrors=0;for(let start=syncOffset;start<len;start+=188)if(71===data[start]){let offset;let stt=!!(64&data[start+1]),pid=parsePID(data,start);if((48&data[start+3])>>4>1){if((offset=start+5+data[start+4])===start+188)continue}else offset=start+4;switch(pid){case videoPid:stt&&(videoData&&(pes=parsePES(videoData))&&this.videoParser.parseAVCPES(videoTrack,textTrack,pes,!1,this._duration),videoData={data:[],size:0}),videoData&&(videoData.data.push(data.subarray(offset,start+188)),videoData.size+=start+188-offset);break;case audioPid:if(stt){if(audioData&&(pes=parsePES(audioData)))switch(audioTrack.segmentCodec){case"aac":this.parseAACPES(audioTrack,pes);break;case"mp3":this.parseMPEGPES(audioTrack,pes)}audioData={data:[],size:0}}audioData&&(audioData.data.push(data.subarray(offset,start+188)),audioData.size+=start+188-offset);break;case id3Pid:stt&&(id3Data&&(pes=parsePES(id3Data))&&this.parseID3PES(id3Track,pes),id3Data={data:[],size:0}),id3Data&&(id3Data.data.push(data.subarray(offset,start+188)),id3Data.size+=start+188-offset);break;case 0:stt&&(offset+=data[offset]+1),pmtId=this._pmtId=parsePAT(data,offset);break;case pmtId:{stt&&(offset+=data[offset]+1);let parsedPIDs=parsePMT(data,offset,this.typeSupported,isSampleAes,this.observer);(videoPid=parsedPIDs.videoPid)>0&&(videoTrack.pid=videoPid,videoTrack.segmentCodec=parsedPIDs.segmentVideoCodec),(audioPid=parsedPIDs.audioPid)>0&&(audioTrack.pid=audioPid,audioTrack.segmentCodec=parsedPIDs.segmentAudioCodec),(id3Pid=parsedPIDs.id3Pid)>0&&(id3Track.pid=id3Pid),null===unknownPID||pmtParsed||(logger.warn(`MPEG-TS PMT found at ${start} after unknown PID '${unknownPID}'. Backtracking to sync byte @${syncOffset} to parse all TS packets.`),unknownPID=null,start=syncOffset-188),pmtParsed=this.pmtParsed=!0;break}case 17:case 8191:break;default:unknownPID=pid}}else tsPacketErrors++;tsPacketErrors>0&&emitParsingError(this.observer,Error(`Found ${tsPacketErrors} TS packet/s that do not start with 0x47`)),videoTrack.pesData=videoData,audioTrack.pesData=audioData,id3Track.pesData=id3Data;let demuxResult={audioTrack,videoTrack,id3Track,textTrack};return flush&&this.extractRemainingSamples(demuxResult),demuxResult}flush(){let result;let{remainderData}=this;return(this.remainderData=null,result=remainderData?this.demux(remainderData,-1,!1,!0):{videoTrack:this._videoTrack,audioTrack:this._audioTrack,id3Track:this._id3Track,textTrack:this._txtTrack},this.extractRemainingSamples(result),this.sampleAes)?this.decrypt(result,this.sampleAes):result}extractRemainingSamples(demuxResult){let pes;let{audioTrack,videoTrack,id3Track,textTrack}=demuxResult,videoData=videoTrack.pesData,audioData=audioTrack.pesData,id3Data=id3Track.pesData;if(videoData&&(pes=parsePES(videoData))?(this.videoParser.parseAVCPES(videoTrack,textTrack,pes,!0,this._duration),videoTrack.pesData=null):videoTrack.pesData=videoData,audioData&&(pes=parsePES(audioData))){switch(audioTrack.segmentCodec){case"aac":this.parseAACPES(audioTrack,pes);break;case"mp3":this.parseMPEGPES(audioTrack,pes)}audioTrack.pesData=null}else null!=audioData&&audioData.size&&logger.log("last AAC PES packet truncated,might overlap between fragments"),audioTrack.pesData=audioData;id3Data&&(pes=parsePES(id3Data))?(this.parseID3PES(id3Track,pes),id3Track.pesData=null):id3Track.pesData=id3Data}demuxSampleAes(data,keyData,timeOffset){let demuxResult=this.demux(data,timeOffset,!0,!this.config.progressive),sampleAes=this.sampleAes=new SampleAesDecrypter(this.observer,this.config,keyData);return this.decrypt(demuxResult,sampleAes)}decrypt(demuxResult,sampleAes){return new Promise(resolve=>{let{audioTrack,videoTrack}=demuxResult;audioTrack.samples&&"aac"===audioTrack.segmentCodec?sampleAes.decryptAacSamples(audioTrack.samples,0,()=>{videoTrack.samples?sampleAes.decryptAvcSamples(videoTrack.samples,0,0,()=>{resolve(demuxResult)}):resolve(demuxResult)}):videoTrack.samples&&sampleAes.decryptAvcSamples(videoTrack.samples,0,0,()=>{resolve(demuxResult)})})}destroy(){this._duration=0}parseAACPES(track,pes){let offset,len,pts,frame,startOffset=0,aacOverFlow=this.aacOverFlow,data=pes.data;if(aacOverFlow){this.aacOverFlow=null;let frameMissingBytes=aacOverFlow.missing,sampleLength=aacOverFlow.sample.unit.byteLength;-1===frameMissingBytes?data=appendUint8Array(aacOverFlow.sample.unit,data):(aacOverFlow.sample.unit.set(data.subarray(0,frameMissingBytes),sampleLength-frameMissingBytes),track.samples.push(aacOverFlow.sample),startOffset=aacOverFlow.missing)}for(offset=startOffset,len=data.length;offset<len-1&&!isHeader$1(data,offset);offset++);if(offset!==startOffset){let reason;let recoverable=offset<len-1;if(reason=recoverable?`AAC PES did not start with ADTS header,offset:${offset}`:"No ADTS header found in AAC PES",emitParsingError(this.observer,Error(reason),recoverable),!recoverable)return}if(initTrackConfig(track,this.observer,data,offset,this.audioCodec),void 0!==pes.pts)pts=pes.pts;else if(aacOverFlow){let frameDuration=9216e4/track.samplerate;pts=aacOverFlow.sample.pts+frameDuration}else{logger.warn("[tsdemuxer]: AAC PES unknown PTS");return}let frameIndex=0;for(;offset<len;){if(frame=appendFrame$1(track,data,offset,pts,frameIndex),offset+=frame.length,frame.missing){this.aacOverFlow=frame;break}for(frameIndex++;offset<len-1&&!isHeader$1(data,offset);offset++);}}parseMPEGPES(track,pes){let data=pes.data,length=data.length,frameIndex=0,offset=0,pts=pes.pts;if(void 0===pts){logger.warn("[tsdemuxer]: MPEG PES unknown PTS");return}for(;offset<length;)if(isHeader(data,offset)){let frame=appendFrame(track,data,offset,pts,frameIndex);if(frame)offset+=frame.length,frameIndex++;else break}else offset++}parseAC3PES(track,pes){}parseID3PES(id3Track,pes){if(void 0===pes.pts){logger.warn("[tsdemuxer]: ID3 PES unknown PTS");return}let id3Sample=_extends({},pes,{type:this._videoTrack?MetadataSchema.emsg:MetadataSchema.audioId3,duration:Number.POSITIVE_INFINITY});id3Track.samples.push(id3Sample)}}function parsePID(data,offset){return((31&data[offset+1])<<8)+data[offset+2]}function parsePAT(data,offset){return(31&data[offset+10])<<8|data[offset+11]}function parsePMT(data,offset,typeSupported,isSampleAes,observer){let result={audioPid:-1,videoPid:-1,id3Pid:-1,segmentVideoCodec:"avc",segmentAudioCodec:"aac"},sectionLength=(15&data[offset+1])<<8|data[offset+2],tableEnd=offset+3+sectionLength-4,programInfoLength=(15&data[offset+10])<<8|data[offset+11];for(offset+=12+programInfoLength;offset<tableEnd;){let pid=parsePID(data,offset),esInfoLength=(15&data[offset+3])<<8|data[offset+4];switch(data[offset]){case 207:if(!isSampleAes){logEncryptedSamplesFoundInUnencryptedStream("ADTS AAC");break}case 15:-1===result.audioPid&&(result.audioPid=pid);break;case 21:-1===result.id3Pid&&(result.id3Pid=pid);break;case 219:if(!isSampleAes){logEncryptedSamplesFoundInUnencryptedStream("H.264");break}case 27:-1===result.videoPid&&(result.videoPid=pid,result.segmentVideoCodec="avc");break;case 3:case 4:typeSupported.mpeg||typeSupported.mp3?-1===result.audioPid&&(result.audioPid=pid,result.segmentAudioCodec="mp3"):logger.log("MPEG audio found, not supported in this browser");break;case 193:if(!isSampleAes){logEncryptedSamplesFoundInUnencryptedStream("AC-3");break}case 129:logger.warn("AC-3 in M2TS support not included in build");break;case 6:if(-1===result.audioPid&&esInfoLength>0){let parsePos=offset+5,remaining=esInfoLength;for(;remaining>2;){106===data[parsePos]&&logger.warn("AC-3 in M2TS support not included in build");let descriptorLen=data[parsePos+1]+2;parsePos+=descriptorLen,remaining-=descriptorLen}}break;case 194:case 135:return emitParsingError(observer,Error("Unsupported EC-3 in M2TS found")),result;case 36:return emitParsingError(observer,Error("Unsupported HEVC in M2TS found")),result}offset+=esInfoLength+5}return result}function emitParsingError(observer,error,levelRetry){logger.warn(`parsing error: ${error.message}`),observer.emit(Events1.ERROR,Events1.ERROR,{type:ErrorTypes1.MEDIA_ERROR,details:ErrorDetails1.FRAG_PARSING_ERROR,fatal:!1,levelRetry,error,reason:error.message})}function logEncryptedSamplesFoundInUnencryptedStream(type){logger.log(`${type} with AES-128-CBC encryption found in unencrypted stream`)}function parsePES(stream){let frag,pesLen,pesHdrLen,pesPts,pesDts,i=0,data=stream.data;if(!stream||0===stream.size)return null;for(;data[0].length<19&&data.length>1;)data[0]=appendUint8Array(data[0],data[1]),data.splice(1,1);if(1===((frag=data[0])[0]<<16)+(frag[1]<<8)+frag[2]){if((pesLen=(frag[4]<<8)+frag[5])&&pesLen>stream.size-6)return null;let pesFlags=frag[7];192&pesFlags&&(pesPts=(14&frag[9])*536870912+(255&frag[10])*4194304+(254&frag[11])*16384+(255&frag[12])*128+(254&frag[13])/2,64&pesFlags?pesPts-(pesDts=(14&frag[14])*536870912+(255&frag[15])*4194304+(254&frag[16])*16384+(255&frag[17])*128+(254&frag[18])/2)>54e5&&(logger.warn(`${Math.round((pesPts-pesDts)/9e4)}s delta between PTS and DTS, align them`),pesPts=pesDts):pesDts=pesPts);let payloadStartOffset=(pesHdrLen=frag[8])+9;if(stream.size<=payloadStartOffset)return null;stream.size-=payloadStartOffset;let pesData=new Uint8Array(stream.size);for(let j=0,dataLen=data.length;j<dataLen;j++){let len=(frag=data[j]).byteLength;if(payloadStartOffset){if(payloadStartOffset>len){payloadStartOffset-=len;continue}frag=frag.subarray(payloadStartOffset),len-=payloadStartOffset,payloadStartOffset=0}pesData.set(frag,i),i+=len}return pesLen&&(pesLen-=pesHdrLen+3),{data:pesData,pts:pesPts,dts:pesDts,len:pesLen}}return null}class AAC{static getSilentFrame(codec,channelCount){if("mp4a.40.2"===codec){if(1===channelCount)return new Uint8Array([0,200,0,128,35,128]);if(2===channelCount)return new Uint8Array([33,0,73,144,2,25,0,35,128]);if(3===channelCount)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,142]);if(4===channelCount)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,128,44,128,8,2,56]);else if(5===channelCount)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,56]);else if(6===channelCount)return new Uint8Array([0,200,0,128,32,132,1,38,64,8,100,0,130,48,4,153,0,33,144,2,0,178,0,32,8,224])}else{if(1===channelCount)return new Uint8Array([1,64,34,128,163,78,230,128,186,8,0,0,0,28,6,241,193,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94]);if(2===channelCount||3===channelCount)return new Uint8Array([1,64,34,128,163,94,230,128,186,8,0,0,0,0,149,0,6,241,161,10,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,90,94])}}}class MP4{static init(){let i;for(i in MP4.types={avc1:[],avcC:[],btrt:[],dinf:[],dref:[],esds:[],ftyp:[],hdlr:[],mdat:[],mdhd:[],mdia:[],mfhd:[],minf:[],moof:[],moov:[],mp4a:[],".mp3":[],dac3:[],"ac-3":[],mvex:[],mvhd:[],pasp:[],sdtp:[],stbl:[],stco:[],stsc:[],stsd:[],stsz:[],stts:[],tfdt:[],tfhd:[],traf:[],trak:[],trun:[],trex:[],tkhd:[],vmhd:[],smhd:[]},MP4.types)MP4.types.hasOwnProperty(i)&&(MP4.types[i]=[i.charCodeAt(0),i.charCodeAt(1),i.charCodeAt(2),i.charCodeAt(3)]);let videoHdlr=new Uint8Array([0,0,0,0,0,0,0,0,118,105,100,101,0,0,0,0,0,0,0,0,0,0,0,0,86,105,100,101,111,72,97,110,100,108,101,114,0]),audioHdlr=new Uint8Array([0,0,0,0,0,0,0,0,115,111,117,110,0,0,0,0,0,0,0,0,0,0,0,0,83,111,117,110,100,72,97,110,100,108,101,114,0]);MP4.HDLR_TYPES={video:videoHdlr,audio:audioHdlr};let dref=new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,12,117,114,108,32,0,0,0,1]),stco=new Uint8Array([0,0,0,0,0,0,0,0]);MP4.STTS=MP4.STSC=MP4.STCO=stco,MP4.STSZ=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0]),MP4.VMHD=new Uint8Array([0,0,0,1,0,0,0,0,0,0,0,0]),MP4.SMHD=new Uint8Array([0,0,0,0,0,0,0,0]),MP4.STSD=new Uint8Array([0,0,0,0,0,0,0,1]);let majorBrand=new Uint8Array([105,115,111,109]),avc1Brand=new Uint8Array([97,118,99,49]),minorVersion=new Uint8Array([0,0,0,1]);MP4.FTYP=MP4.box(MP4.types.ftyp,majorBrand,minorVersion,majorBrand,avc1Brand),MP4.DINF=MP4.box(MP4.types.dinf,MP4.box(MP4.types.dref,dref))}static box(type,...payload){let size=8,i=payload.length,len=i;for(;i--;)size+=payload[i].byteLength;let result=new Uint8Array(size);for(result[0]=size>>24&255,result[1]=size>>16&255,result[2]=size>>8&255,result[3]=255&size,result.set(type,4),i=0,size=8;i<len;i++)result.set(payload[i],size),size+=payload[i].byteLength;return result}static hdlr(type){return MP4.box(MP4.types.hdlr,MP4.HDLR_TYPES[type])}static mdat(data){return MP4.box(MP4.types.mdat,data)}static mdhd(timescale,duration){let upperWordDuration=Math.floor((duration*=timescale)/4294967296),lowerWordDuration=Math.floor(duration%4294967296);return MP4.box(MP4.types.mdhd,new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,timescale>>24&255,timescale>>16&255,timescale>>8&255,255&timescale,upperWordDuration>>24,upperWordDuration>>16&255,upperWordDuration>>8&255,255&upperWordDuration,lowerWordDuration>>24,lowerWordDuration>>16&255,lowerWordDuration>>8&255,255&lowerWordDuration,85,196,0,0]))}static mdia(track){return MP4.box(MP4.types.mdia,MP4.mdhd(track.timescale,track.duration),MP4.hdlr(track.type),MP4.minf(track))}static mfhd(sequenceNumber){return MP4.box(MP4.types.mfhd,new Uint8Array([0,0,0,0,sequenceNumber>>24,sequenceNumber>>16&255,sequenceNumber>>8&255,255&sequenceNumber]))}static minf(track){return"audio"===track.type?MP4.box(MP4.types.minf,MP4.box(MP4.types.smhd,MP4.SMHD),MP4.DINF,MP4.stbl(track)):MP4.box(MP4.types.minf,MP4.box(MP4.types.vmhd,MP4.VMHD),MP4.DINF,MP4.stbl(track))}static moof(sn,baseMediaDecodeTime,track){return MP4.box(MP4.types.moof,MP4.mfhd(sn),MP4.traf(track,baseMediaDecodeTime))}static moov(tracks){let i=tracks.length,boxes=[];for(;i--;)boxes[i]=MP4.trak(tracks[i]);return MP4.box.apply(null,[MP4.types.moov,MP4.mvhd(tracks[0].timescale,tracks[0].duration)].concat(boxes).concat(MP4.mvex(tracks)))}static mvex(tracks){let i=tracks.length,boxes=[];for(;i--;)boxes[i]=MP4.trex(tracks[i]);return MP4.box.apply(null,[MP4.types.mvex,...boxes])}static mvhd(timescale,duration){let upperWordDuration=Math.floor((duration*=timescale)/4294967296),lowerWordDuration=Math.floor(duration%4294967296),bytes=new Uint8Array([1,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,timescale>>24&255,timescale>>16&255,timescale>>8&255,255&timescale,upperWordDuration>>24,upperWordDuration>>16&255,upperWordDuration>>8&255,255&upperWordDuration,lowerWordDuration>>24,lowerWordDuration>>16&255,lowerWordDuration>>8&255,255&lowerWordDuration,0,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,255,255,255,255]);return MP4.box(MP4.types.mvhd,bytes)}static sdtp(track){let i,flags;let samples=track.samples||[],bytes=new Uint8Array(4+samples.length);for(i=0;i<samples.length;i++)flags=samples[i].flags,bytes[i+4]=flags.dependsOn<<4|flags.isDependedOn<<2|flags.hasRedundancy;return MP4.box(MP4.types.sdtp,bytes)}static stbl(track){return MP4.box(MP4.types.stbl,MP4.stsd(track),MP4.box(MP4.types.stts,MP4.STTS),MP4.box(MP4.types.stsc,MP4.STSC),MP4.box(MP4.types.stsz,MP4.STSZ),MP4.box(MP4.types.stco,MP4.STCO))}static avc1(track){let i,data,len,sps=[],pps=[];for(i=0;i<track.sps.length;i++)len=(data=track.sps[i]).byteLength,sps.push(len>>>8&255),sps.push(255&len),sps=sps.concat(Array.prototype.slice.call(data));for(i=0;i<track.pps.length;i++)len=(data=track.pps[i]).byteLength,pps.push(len>>>8&255),pps.push(255&len),pps=pps.concat(Array.prototype.slice.call(data));let avcc=MP4.box(MP4.types.avcC,new Uint8Array([1,sps[3],sps[4],sps[5],255,224|track.sps.length].concat(sps).concat([track.pps.length]).concat(pps))),width=track.width,height=track.height,hSpacing=track.pixelRatio[0],vSpacing=track.pixelRatio[1];return MP4.box(MP4.types.avc1,new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,width>>8&255,255&width,height>>8&255,255&height,0,72,0,0,0,72,0,0,0,0,0,0,0,1,18,100,97,105,108,121,109,111,116,105,111,110,47,104,108,115,46,106,115,0,0,0,0,0,0,0,0,0,0,0,0,0,0,24,17,17]),avcc,MP4.box(MP4.types.btrt,new Uint8Array([0,28,156,128,0,45,198,192,0,45,198,192])),MP4.box(MP4.types.pasp,new Uint8Array([hSpacing>>24,hSpacing>>16&255,hSpacing>>8&255,255&hSpacing,vSpacing>>24,vSpacing>>16&255,vSpacing>>8&255,255&vSpacing])))}static esds(track){let configlen=track.config.length;return new Uint8Array([0,0,0,0,3,23+configlen,0,1,0,4,15+configlen,64,21,0,0,0,0,0,0,0,0,0,0,0,5].concat([configlen]).concat(track.config).concat([6,1,2]))}static audioStsd(track){let samplerate=track.samplerate;return new Uint8Array([0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,track.channelCount,0,16,0,0,0,0,samplerate>>8&255,255&samplerate,0,0])}static mp4a(track){return MP4.box(MP4.types.mp4a,MP4.audioStsd(track),MP4.box(MP4.types.esds,MP4.esds(track)))}static mp3(track){return MP4.box(MP4.types[".mp3"],MP4.audioStsd(track))}static ac3(track){return MP4.box(MP4.types["ac-3"],MP4.audioStsd(track),MP4.box(MP4.types.dac3,track.config))}static stsd(track){return"audio"!==track.type?MP4.box(MP4.types.stsd,MP4.STSD,MP4.avc1(track)):"mp3"===track.segmentCodec&&"mp3"===track.codec?MP4.box(MP4.types.stsd,MP4.STSD,MP4.mp3(track)):"ac3"===track.segmentCodec?MP4.box(MP4.types.stsd,MP4.STSD,MP4.ac3(track)):MP4.box(MP4.types.stsd,MP4.STSD,MP4.mp4a(track))}static tkhd(track){let id=track.id,duration=track.duration*track.timescale,width=track.width,height=track.height,upperWordDuration=Math.floor(duration/4294967296),lowerWordDuration=Math.floor(duration%4294967296);return MP4.box(MP4.types.tkhd,new Uint8Array([1,0,0,7,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,3,id>>24&255,id>>16&255,id>>8&255,255&id,0,0,0,0,upperWordDuration>>24,upperWordDuration>>16&255,upperWordDuration>>8&255,255&upperWordDuration,lowerWordDuration>>24,lowerWordDuration>>16&255,lowerWordDuration>>8&255,255&lowerWordDuration,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,64,0,0,0,width>>8&255,255&width,0,0,height>>8&255,255&height,0,0]))}static traf(track,baseMediaDecodeTime){let sampleDependencyTable=MP4.sdtp(track),id=track.id,upperWordBaseMediaDecodeTime=Math.floor(baseMediaDecodeTime/4294967296),lowerWordBaseMediaDecodeTime=Math.floor(baseMediaDecodeTime%4294967296);return MP4.box(MP4.types.traf,MP4.box(MP4.types.tfhd,new Uint8Array([0,0,0,0,id>>24,id>>16&255,id>>8&255,255&id])),MP4.box(MP4.types.tfdt,new Uint8Array([1,0,0,0,upperWordBaseMediaDecodeTime>>24,upperWordBaseMediaDecodeTime>>16&255,upperWordBaseMediaDecodeTime>>8&255,255&upperWordBaseMediaDecodeTime,lowerWordBaseMediaDecodeTime>>24,lowerWordBaseMediaDecodeTime>>16&255,lowerWordBaseMediaDecodeTime>>8&255,255&lowerWordBaseMediaDecodeTime])),MP4.trun(track,sampleDependencyTable.length+16+20+8+16+8+8),sampleDependencyTable)}static trak(track){return track.duration=track.duration||4294967295,MP4.box(MP4.types.trak,MP4.tkhd(track),MP4.mdia(track))}static trex(track){let id=track.id;return MP4.box(MP4.types.trex,new Uint8Array([0,0,0,0,id>>24,id>>16&255,id>>8&255,255&id,0,0,0,1,0,0,0,0,0,0,0,0,0,1,0,1]))}static trun(track,offset){let i,sample,duration,size,flags,cts;let samples=track.samples||[],len=samples.length,arraylen=12+16*len,array=new Uint8Array(arraylen);for(offset+=8+arraylen,array.set(["video"===track.type?1:0,0,15,1,len>>>24&255,len>>>16&255,len>>>8&255,255&len,offset>>>24&255,offset>>>16&255,offset>>>8&255,255&offset],0),i=0;i<len;i++)duration=(sample=samples[i]).duration,size=sample.size,flags=sample.flags,cts=sample.cts,array.set([duration>>>24&255,duration>>>16&255,duration>>>8&255,255&duration,size>>>24&255,size>>>16&255,size>>>8&255,255&size,flags.isLeading<<2|flags.dependsOn,flags.isDependedOn<<6|flags.hasRedundancy<<4|flags.paddingValue<<1|flags.isNonSync,61440&flags.degradPrio,15&flags.degradPrio,cts>>>24&255,cts>>>16&255,cts>>>8&255,255&cts],12+16*i);return MP4.box(MP4.types.trun,array)}static initSegment(tracks){MP4.types||MP4.init();let movie=MP4.moov(tracks);return appendUint8Array(MP4.FTYP,movie)}}function toTimescaleFromBase(baseTime,destScale,srcBase=1,round=!1){let result=baseTime*destScale*srcBase;return round?Math.round(result):result}function toMsFromMpegTsClock(baseTime,round=!1){return toTimescaleFromBase(baseTime,1e3,11111111111111112e-21,round)}MP4.types=void 0,MP4.HDLR_TYPES=void 0,MP4.STTS=void 0,MP4.STSC=void 0,MP4.STCO=void 0,MP4.STSZ=void 0,MP4.VMHD=void 0,MP4.SMHD=void 0,MP4.STSD=void 0,MP4.FTYP=void 0,MP4.DINF=void 0;let chromeVersion=null,safariWebkitVersion=null;class MP4Remuxer{constructor(observer,config,typeSupported,vendor=""){if(this.observer=void 0,this.config=void 0,this.typeSupported=void 0,this.ISGenerated=!1,this._initPTS=null,this._initDTS=null,this.nextAvcDts=null,this.nextAudioPts=null,this.videoSampleDuration=null,this.isAudioContiguous=!1,this.isVideoContiguous=!1,this.videoTrackConfig=void 0,this.observer=observer,this.config=config,this.typeSupported=typeSupported,this.ISGenerated=!1,null===chromeVersion){let result=(navigator.userAgent||"").match(/Chrome\/(\d+)/i);chromeVersion=result?parseInt(result[1]):0}if(null===safariWebkitVersion){let result=navigator.userAgent.match(/Safari\/(\d+)/i);safariWebkitVersion=result?parseInt(result[1]):0}}destroy(){this.config=this.videoTrackConfig=this._initPTS=this._initDTS=null}resetTimeStamp(defaultTimeStamp){logger.log("[mp4-remuxer]: initPTS & initDTS reset"),this._initPTS=this._initDTS=defaultTimeStamp}resetNextTimestamp(){logger.log("[mp4-remuxer]: reset next timestamp"),this.isVideoContiguous=!1,this.isAudioContiguous=!1}resetInitSegment(){logger.log("[mp4-remuxer]: ISGenerated flag reset"),this.ISGenerated=!1,this.videoTrackConfig=void 0}getVideoStartPts(videoSamples){let rolloverDetected=!1,startPTS=videoSamples.reduce((minPTS,sample)=>{let delta=sample.pts-minPTS;return delta<-4294967296?(rolloverDetected=!0,normalizePts(minPTS,sample.pts)):delta>0?minPTS:sample.pts},videoSamples[0].pts);return rolloverDetected&&logger.debug("PTS rollover detected"),startPTS}remux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,accurateTimeOffset,flush,playlistType){let video,audio,initSegment,text,id3,independent;let audioTimeOffset=timeOffset,videoTimeOffset=timeOffset,hasAudio=audioTrack.pid>-1,hasVideo=videoTrack.pid>-1,length=videoTrack.samples.length,enoughAudioSamples=audioTrack.samples.length>0,enoughVideoSamples=flush&&length>0||length>1;if((!hasAudio||enoughAudioSamples)&&(!hasVideo||enoughVideoSamples)||this.ISGenerated||flush){let firstKeyFramePTS;if(this.ISGenerated){var _videoTrack$pixelRati,_config$pixelRatio,_videoTrack$pixelRati2,_config$pixelRatio2;let config=this.videoTrackConfig;config&&(videoTrack.width!==config.width||videoTrack.height!==config.height||(null==(_videoTrack$pixelRati=videoTrack.pixelRatio)?void 0:_videoTrack$pixelRati[0])!==(null==(_config$pixelRatio=config.pixelRatio)?void 0:_config$pixelRatio[0])||(null==(_videoTrack$pixelRati2=videoTrack.pixelRatio)?void 0:_videoTrack$pixelRati2[1])!==(null==(_config$pixelRatio2=config.pixelRatio)?void 0:_config$pixelRatio2[1]))&&this.resetInitSegment()}else initSegment=this.generateIS(audioTrack,videoTrack,timeOffset,accurateTimeOffset);let isVideoContiguous=this.isVideoContiguous,firstKeyFrameIndex=-1;if(enoughVideoSamples&&(firstKeyFrameIndex=findKeyframeIndex(videoTrack.samples),!isVideoContiguous&&this.config.forceKeyFrameOnDiscontinuity)){if(independent=!0,firstKeyFrameIndex>0){logger.warn(`[mp4-remuxer]: Dropped ${firstKeyFrameIndex} out of ${length} video samples due to a missing keyframe`);let startPTS=this.getVideoStartPts(videoTrack.samples);videoTrack.samples=videoTrack.samples.slice(firstKeyFrameIndex),videoTrack.dropped+=firstKeyFrameIndex,videoTimeOffset+=(videoTrack.samples[0].pts-startPTS)/videoTrack.inputTimeScale,firstKeyFramePTS=videoTimeOffset}else -1===firstKeyFrameIndex&&(logger.warn(`[mp4-remuxer]: No keyframe found out of ${length} video samples`),independent=!1)}if(this.ISGenerated){if(enoughAudioSamples&&enoughVideoSamples){let startPTS=this.getVideoStartPts(videoTrack.samples),audiovideoTimestampDelta=(normalizePts(audioTrack.samples[0].pts,startPTS)-startPTS)/videoTrack.inputTimeScale;audioTimeOffset+=Math.max(0,audiovideoTimestampDelta),videoTimeOffset+=Math.max(0,-audiovideoTimestampDelta)}if(enoughAudioSamples){if(audioTrack.samplerate||(logger.warn("[mp4-remuxer]: regenerate InitSegment as audio detected"),initSegment=this.generateIS(audioTrack,videoTrack,timeOffset,accurateTimeOffset)),audio=this.remuxAudio(audioTrack,audioTimeOffset,this.isAudioContiguous,accurateTimeOffset,hasVideo||enoughVideoSamples||playlistType===PlaylistLevelType.AUDIO?videoTimeOffset:void 0),enoughVideoSamples){let audioTrackLength=audio?audio.endPTS-audio.startPTS:0;videoTrack.inputTimeScale||(logger.warn("[mp4-remuxer]: regenerate InitSegment as video detected"),initSegment=this.generateIS(audioTrack,videoTrack,timeOffset,accurateTimeOffset)),video=this.remuxVideo(videoTrack,videoTimeOffset,isVideoContiguous,audioTrackLength)}}else enoughVideoSamples&&(video=this.remuxVideo(videoTrack,videoTimeOffset,isVideoContiguous,0));video&&(video.firstKeyFrame=firstKeyFrameIndex,video.independent=-1!==firstKeyFrameIndex,video.firstKeyFramePTS=firstKeyFramePTS)}}return this.ISGenerated&&this._initPTS&&this._initDTS&&(id3Track.samples.length&&(id3=flushTextTrackMetadataCueSamples(id3Track,timeOffset,this._initPTS,this._initDTS)),textTrack.samples.length&&(text=flushTextTrackUserdataCueSamples(textTrack,timeOffset,this._initPTS))),{audio,video,initSegment,independent,text,id3}}generateIS(audioTrack,videoTrack,timeOffset,accurateTimeOffset){let initPTS,initDTS,timescale;let audioSamples=audioTrack.samples,videoSamples=videoTrack.samples,typeSupported=this.typeSupported,tracks={},_initPTS=this._initPTS,computePTSDTS=!_initPTS||accurateTimeOffset,container="audio/mp4";if(computePTSDTS&&(initPTS=initDTS=1/0),audioTrack.config&&audioSamples.length){switch(audioTrack.timescale=audioTrack.samplerate,audioTrack.segmentCodec){case"mp3":typeSupported.mpeg?(container="audio/mpeg",audioTrack.codec=""):typeSupported.mp3&&(audioTrack.codec="mp3");break;case"ac3":audioTrack.codec="ac-3"}tracks.audio={id:"audio",container:container,codec:audioTrack.codec,initSegment:"mp3"===audioTrack.segmentCodec&&typeSupported.mpeg?new Uint8Array(0):MP4.initSegment([audioTrack]),metadata:{channelCount:audioTrack.channelCount}},computePTSDTS&&(timescale=audioTrack.inputTimeScale,_initPTS&&timescale===_initPTS.timescale?computePTSDTS=!1:initPTS=initDTS=audioSamples[0].pts-Math.round(timescale*timeOffset))}if(videoTrack.sps&&videoTrack.pps&&videoSamples.length){if(videoTrack.timescale=videoTrack.inputTimeScale,tracks.video={id:"main",container:"video/mp4",codec:videoTrack.codec,initSegment:MP4.initSegment([videoTrack]),metadata:{width:videoTrack.width,height:videoTrack.height}},computePTSDTS){if(timescale=videoTrack.inputTimeScale,_initPTS&&timescale===_initPTS.timescale)computePTSDTS=!1;else{let startPTS=this.getVideoStartPts(videoSamples),startOffset=Math.round(timescale*timeOffset);initDTS=Math.min(initDTS,normalizePts(videoSamples[0].dts,startPTS)-startOffset),initPTS=Math.min(initPTS,startPTS-startOffset)}}this.videoTrackConfig={width:videoTrack.width,height:videoTrack.height,pixelRatio:videoTrack.pixelRatio}}if(Object.keys(tracks).length)return this.ISGenerated=!0,computePTSDTS?(this._initPTS={baseTime:initPTS,timescale:timescale},this._initDTS={baseTime:initDTS,timescale:timescale}):initPTS=timescale=void 0,{tracks,initPTS,timescale}}remuxVideo(track,timeOffset,contiguous,audioTrackLength){let firstDTS,lastDTS,mdat;let timeScale=track.inputTimeScale,inputSamples=track.samples,outputSamples=[],nbSamples=inputSamples.length,initPTS=this._initPTS,nextAvcDts=this.nextAvcDts,offset=8,mp4SampleDuration=this.videoSampleDuration,minPTS=Number.POSITIVE_INFINITY,maxPTS=Number.NEGATIVE_INFINITY,sortSamples=!1;if(!contiguous||null===nextAvcDts){let pts=timeOffset*timeScale,cts=inputSamples[0].pts-normalizePts(inputSamples[0].dts,inputSamples[0].pts);chromeVersion&&null!==nextAvcDts&&15e3>Math.abs(pts-cts-nextAvcDts)?contiguous=!0:nextAvcDts=pts-cts}let initTime=initPTS.baseTime*timeScale/initPTS.timescale;for(let i=0;i<nbSamples;i++){let sample=inputSamples[i];sample.pts=normalizePts(sample.pts-initTime,nextAvcDts),sample.dts=normalizePts(sample.dts-initTime,nextAvcDts),sample.dts<inputSamples[i>0?i-1:i].dts&&(sortSamples=!0)}sortSamples&&inputSamples.sort(function(a,b){let deltadts=a.dts-b.dts,deltapts=a.pts-b.pts;return deltadts||deltapts}),firstDTS=inputSamples[0].dts;let inputDuration=(lastDTS=inputSamples[inputSamples.length-1].dts)-firstDTS,averageSampleDuration=inputDuration?Math.round(inputDuration/(nbSamples-1)):mp4SampleDuration||track.inputTimeScale/30;if(contiguous){let delta=firstDTS-nextAvcDts,foundHole=delta>averageSampleDuration,foundOverlap=delta<-1;if((foundHole||foundOverlap)&&(foundHole?logger.warn(`AVC: ${toMsFromMpegTsClock(delta,!0)} ms (${delta}dts) hole between fragments detected at ${timeOffset.toFixed(3)}`):logger.warn(`AVC: ${toMsFromMpegTsClock(-delta,!0)} ms (${delta}dts) overlapping between fragments detected at ${timeOffset.toFixed(3)}`),!foundOverlap||nextAvcDts>=inputSamples[0].pts||chromeVersion)){firstDTS=nextAvcDts;let firstPTS=inputSamples[0].pts-delta;if(foundHole)inputSamples[0].dts=firstDTS,inputSamples[0].pts=firstPTS;else for(let i=0;i<inputSamples.length&&!(inputSamples[i].dts>firstPTS);i++)inputSamples[i].dts-=delta,inputSamples[i].pts-=delta;logger.log(`Video: Initial PTS/DTS adjusted: ${toMsFromMpegTsClock(firstPTS,!0)}/${toMsFromMpegTsClock(firstDTS,!0)}, delta: ${toMsFromMpegTsClock(delta,!0)} ms`)}}let nbNalu=0,naluLen=0,dtsStep=firstDTS=Math.max(0,firstDTS);for(let i=0;i<nbSamples;i++){let sample=inputSamples[i],units=sample.units,nbUnits=units.length,sampleLen=0;for(let j=0;j<nbUnits;j++)sampleLen+=units[j].data.length;naluLen+=sampleLen,nbNalu+=nbUnits,sample.length=sampleLen,sample.dts<dtsStep?(sample.dts=dtsStep,dtsStep+=averageSampleDuration/4|0||1):dtsStep=sample.dts,minPTS=Math.min(sample.pts,minPTS),maxPTS=Math.max(sample.pts,maxPTS)}lastDTS=inputSamples[nbSamples-1].dts;let mdatSize=naluLen+4*nbNalu+8;try{mdat=new Uint8Array(mdatSize)}catch(err){this.observer.emit(Events1.ERROR,Events1.ERROR,{type:ErrorTypes1.MUX_ERROR,details:ErrorDetails1.REMUX_ALLOC_ERROR,fatal:!1,error:err,bytes:mdatSize,reason:`fail allocating video mdat ${mdatSize}`});return}let view=new DataView(mdat.buffer);view.setUint32(0,mdatSize),mdat.set(MP4.types.mdat,4);let stretchedLastFrame=!1,minDtsDelta=Number.POSITIVE_INFINITY,minPtsDelta=Number.POSITIVE_INFINITY,maxDtsDelta=Number.NEGATIVE_INFINITY,maxPtsDelta=Number.NEGATIVE_INFINITY;for(let i=0;i<nbSamples;i++){let ptsDelta;let VideoSample=inputSamples[i],VideoSampleUnits=VideoSample.units,mp4SampleLength=0;for(let j=0,nbUnits=VideoSampleUnits.length;j<nbUnits;j++){let unit=VideoSampleUnits[j],unitData=unit.data,unitDataLen=unit.data.byteLength;view.setUint32(offset,unitDataLen),offset+=4,mdat.set(unitData,offset),offset+=unitDataLen,mp4SampleLength+=4+unitDataLen}if(i<nbSamples-1)mp4SampleDuration=inputSamples[i+1].dts-VideoSample.dts,ptsDelta=inputSamples[i+1].pts-VideoSample.pts;else{let config=this.config,lastFrameDuration=i>0?VideoSample.dts-inputSamples[i-1].dts:averageSampleDuration;if(ptsDelta=i>0?VideoSample.pts-inputSamples[i-1].pts:averageSampleDuration,config.stretchShortVideoTrack&&null!==this.nextAudioPts){let gapTolerance=Math.floor(config.maxBufferHole*timeScale),deltaToFrameEnd=(audioTrackLength?minPTS+audioTrackLength*timeScale:this.nextAudioPts)-VideoSample.pts;deltaToFrameEnd>gapTolerance?((mp4SampleDuration=deltaToFrameEnd-lastFrameDuration)<0?mp4SampleDuration=lastFrameDuration:stretchedLastFrame=!0,logger.log(`[mp4-remuxer]: It is approximately ${deltaToFrameEnd/90} ms to the next segment; using duration ${mp4SampleDuration/90} ms for the last video frame.`)):mp4SampleDuration=lastFrameDuration}else mp4SampleDuration=lastFrameDuration}let compositionTimeOffset=Math.round(VideoSample.pts-VideoSample.dts);minDtsDelta=Math.min(minDtsDelta,mp4SampleDuration),maxDtsDelta=Math.max(maxDtsDelta,mp4SampleDuration),minPtsDelta=Math.min(minPtsDelta,ptsDelta),maxPtsDelta=Math.max(maxPtsDelta,ptsDelta),outputSamples.push(new Mp4Sample(VideoSample.key,mp4SampleDuration,mp4SampleLength,compositionTimeOffset))}if(outputSamples.length){if(chromeVersion){if(chromeVersion<70){let flags=outputSamples[0].flags;flags.dependsOn=2,flags.isNonSync=0}}else if(safariWebkitVersion&&maxPtsDelta-minPtsDelta<maxDtsDelta-minDtsDelta&&averageSampleDuration/maxDtsDelta<.025&&0===outputSamples[0].cts){logger.warn("Found irregular gaps in sample duration. Using PTS instead of DTS to determine MP4 sample duration.");let dts=firstDTS;for(let i=0,len=outputSamples.length;i<len;i++){let nextDts=dts+outputSamples[i].duration,pts=dts+outputSamples[i].cts;if(i<len-1){let nextPts=nextDts+outputSamples[i+1].cts;outputSamples[i].duration=nextPts-pts}else outputSamples[i].duration=i?outputSamples[i-1].duration:averageSampleDuration;outputSamples[i].cts=0,dts=nextDts}}}mp4SampleDuration=stretchedLastFrame||!mp4SampleDuration?averageSampleDuration:mp4SampleDuration,this.nextAvcDts=nextAvcDts=lastDTS+mp4SampleDuration,this.videoSampleDuration=mp4SampleDuration,this.isVideoContiguous=!0;let data={data1:MP4.moof(track.sequenceNumber++,firstDTS,_extends({},track,{samples:outputSamples})),data2:mdat,startPTS:minPTS/timeScale,endPTS:(maxPTS+mp4SampleDuration)/timeScale,startDTS:firstDTS/timeScale,endDTS:nextAvcDts/timeScale,type:"video",hasAudio:!1,hasVideo:!0,nb:outputSamples.length,dropped:track.dropped};return track.samples=[],track.dropped=0,data}getSamplesPerFrame(track){switch(track.segmentCodec){case"mp3":return 1152;case"ac3":return 1536;default:return 1024}}remuxAudio(track,timeOffset,contiguous,accurateTimeOffset,videoTimeOffset){let mdat;let inputTimeScale=track.inputTimeScale,mp4timeScale=track.samplerate?track.samplerate:inputTimeScale,scaleFactor=inputTimeScale/mp4timeScale,mp4SampleDuration=this.getSamplesPerFrame(track),inputSampleDuration=mp4SampleDuration*scaleFactor,initPTS=this._initPTS,rawMPEG="mp3"===track.segmentCodec&&this.typeSupported.mpeg,outputSamples=[],alignedWithVideo=void 0!==videoTimeOffset,inputSamples=track.samples,offset=rawMPEG?0:8,nextAudioPts=this.nextAudioPts||-1,timeOffsetMpegTS=timeOffset*inputTimeScale,initTime=initPTS.baseTime*inputTimeScale/initPTS.timescale;if(this.isAudioContiguous=contiguous=contiguous||inputSamples.length&&nextAudioPts>0&&(accurateTimeOffset&&9e3>Math.abs(timeOffsetMpegTS-nextAudioPts)||Math.abs(normalizePts(inputSamples[0].pts-initTime,timeOffsetMpegTS)-nextAudioPts)<20*inputSampleDuration),inputSamples.forEach(function(sample){sample.pts=normalizePts(sample.pts-initTime,timeOffsetMpegTS)}),!contiguous||nextAudioPts<0){if(!(inputSamples=inputSamples.filter(sample=>sample.pts>=0)).length)return;nextAudioPts=0===videoTimeOffset?0:accurateTimeOffset&&!alignedWithVideo?Math.max(0,timeOffsetMpegTS):inputSamples[0].pts}if("aac"===track.segmentCodec){let maxAudioFramesDrift=this.config.maxAudioFramesDrift;for(let i=0,nextPts=nextAudioPts;i<inputSamples.length;i++){let sample=inputSamples[i],pts=sample.pts,delta=pts-nextPts,duration=Math.abs(1e3*delta/inputTimeScale);if(delta<=-maxAudioFramesDrift*inputSampleDuration&&alignedWithVideo)0===i&&(logger.warn(`Audio frame @ ${(pts/inputTimeScale).toFixed(3)}s overlaps nextAudioPts by ${Math.round(1e3*delta/inputTimeScale)} ms.`),this.nextAudioPts=nextAudioPts=nextPts=pts);else if(delta>=maxAudioFramesDrift*inputSampleDuration&&duration<1e4&&alignedWithVideo){let missing=Math.round(delta/inputSampleDuration);(nextPts=pts-missing*inputSampleDuration)<0&&(missing--,nextPts+=inputSampleDuration),0===i&&(this.nextAudioPts=nextAudioPts=nextPts),logger.warn(`[mp4-remuxer]: Injecting ${missing} audio frame @ ${(nextPts/inputTimeScale).toFixed(3)}s due to ${Math.round(1e3*delta/inputTimeScale)} ms gap.`);for(let j=0;j<missing;j++){let newStamp=Math.max(nextPts,0),fillFrame=AAC.getSilentFrame(track.manifestCodec||track.codec,track.channelCount);fillFrame||(logger.log("[mp4-remuxer]: Unable to get silent frame for given audio codec; duplicating last frame instead."),fillFrame=sample.unit.subarray()),inputSamples.splice(i,0,{unit:fillFrame,pts:newStamp}),nextPts+=inputSampleDuration,i++}}sample.pts=nextPts,nextPts+=inputSampleDuration}}let firstPTS=null,lastPTS=null,mdatSize=0,sampleLength=inputSamples.length;for(;sampleLength--;)mdatSize+=inputSamples[sampleLength].unit.byteLength;for(let j=0,_nbSamples=inputSamples.length;j<_nbSamples;j++){let audioSample=inputSamples[j],unit=audioSample.unit,pts=audioSample.pts;if(null!==lastPTS)outputSamples[j-1].duration=Math.round((pts-lastPTS)/scaleFactor);else{if(contiguous&&"aac"===track.segmentCodec&&(pts=nextAudioPts),firstPTS=pts,!(mdatSize>0))return;mdatSize+=offset;try{mdat=new Uint8Array(mdatSize)}catch(err){this.observer.emit(Events1.ERROR,Events1.ERROR,{type:ErrorTypes1.MUX_ERROR,details:ErrorDetails1.REMUX_ALLOC_ERROR,fatal:!1,error:err,bytes:mdatSize,reason:`fail allocating audio mdat ${mdatSize}`});return}rawMPEG||(new DataView(mdat.buffer).setUint32(0,mdatSize),mdat.set(MP4.types.mdat,4))}mdat.set(unit,offset);let unitLen=unit.byteLength;offset+=unitLen,outputSamples.push(new Mp4Sample(!0,mp4SampleDuration,unitLen,0)),lastPTS=pts}let nbSamples=outputSamples.length;if(!nbSamples)return;let lastSample=outputSamples[outputSamples.length-1];this.nextAudioPts=nextAudioPts=lastPTS+scaleFactor*lastSample.duration;let moof=rawMPEG?new Uint8Array(0):MP4.moof(track.sequenceNumber++,firstPTS/scaleFactor,_extends({},track,{samples:outputSamples}));track.samples=[];let start=firstPTS/inputTimeScale,end=nextAudioPts/inputTimeScale,audioData={data1:moof,data2:mdat,startPTS:start,endPTS:end,startDTS:start,endDTS:end,type:"audio",hasAudio:!0,hasVideo:!1,nb:nbSamples};return this.isAudioContiguous=!0,audioData}remuxEmptyAudio(track,timeOffset,contiguous,videoData){let inputTimeScale=track.inputTimeScale,mp4timeScale=track.samplerate?track.samplerate:inputTimeScale,nextAudioPts=this.nextAudioPts,initDTS=this._initDTS,init90kHz=9e4*initDTS.baseTime/initDTS.timescale,startDTS=(null!==nextAudioPts?nextAudioPts:videoData.startDTS*inputTimeScale)+init90kHz,endDTS=videoData.endDTS*inputTimeScale+init90kHz,frameDuration=inputTimeScale/mp4timeScale*1024,nbSamples=Math.ceil((endDTS-startDTS)/frameDuration),silentFrame=AAC.getSilentFrame(track.manifestCodec||track.codec,track.channelCount);if(logger.warn("[mp4-remuxer]: remux empty Audio"),!silentFrame){logger.trace("[mp4-remuxer]: Unable to remuxEmptyAudio since we were unable to get a silent frame for given audio codec");return}let samples=[];for(let i=0;i<nbSamples;i++){let stamp=startDTS+i*frameDuration;samples.push({unit:silentFrame,pts:stamp,dts:stamp})}return track.samples=samples,this.remuxAudio(track,timeOffset,contiguous,!1)}}function normalizePts(value,reference){let offset;if(null===reference)return value;for(offset=reference<value?-8589934592:8589934592;Math.abs(value-reference)>4294967296;)value+=offset;return value}function findKeyframeIndex(samples){for(let i=0;i<samples.length;i++)if(samples[i].key)return i;return -1}function flushTextTrackMetadataCueSamples(track,timeOffset,initPTS,initDTS){let length=track.samples.length;if(!length)return;let inputTimeScale=track.inputTimeScale;for(let index=0;index<length;index++){let sample=track.samples[index];sample.pts=normalizePts(sample.pts-initPTS.baseTime*inputTimeScale/initPTS.timescale,timeOffset*inputTimeScale)/inputTimeScale,sample.dts=normalizePts(sample.dts-initDTS.baseTime*inputTimeScale/initDTS.timescale,timeOffset*inputTimeScale)/inputTimeScale}let samples=track.samples;return track.samples=[],{samples}}function flushTextTrackUserdataCueSamples(track,timeOffset,initPTS){let length=track.samples.length;if(!length)return;let inputTimeScale=track.inputTimeScale;for(let index=0;index<length;index++){let sample=track.samples[index];sample.pts=normalizePts(sample.pts-initPTS.baseTime*inputTimeScale/initPTS.timescale,timeOffset*inputTimeScale)/inputTimeScale}track.samples.sort((a,b)=>a.pts-b.pts);let samples=track.samples;return track.samples=[],{samples}}class Mp4Sample{constructor(isKeyframe,duration,size,cts){this.size=void 0,this.duration=void 0,this.cts=void 0,this.flags=void 0,this.duration=duration,this.size=size,this.cts=cts,this.flags={isLeading:0,isDependedOn:0,hasRedundancy:0,degradPrio:0,dependsOn:isKeyframe?2:1,isNonSync:isKeyframe?0:1}}}function isInvalidInitPts(initPTS,startDTS,timeOffset,duration){return null===initPTS||Math.abs(startDTS-initPTS.baseTime/initPTS.timescale-timeOffset)>Math.max(duration,1)}function getParsedTrackCodec(track,type){let parsedCodec=null==track?void 0:track.codec;if(parsedCodec&&parsedCodec.length>4)return parsedCodec;if(type===ElementaryStreamTypes.AUDIO){if("ec-3"===parsedCodec||"ac-3"===parsedCodec||"alac"===parsedCodec)return parsedCodec;if("fLaC"===parsedCodec||"Opus"===parsedCodec)return getCodecCompatibleName(parsedCodec,!1);let result="mp4a.40.5";return logger.info(`Parsed audio codec "${parsedCodec}" or audio object type not handled. Using "${result}"`),result}return(logger.warn(`Unhandled video codec "${parsedCodec}"`),"hvc1"===parsedCodec||"hev1"===parsedCodec)?"hvc1.1.6.L120.90":"av01"===parsedCodec?"av01.0.04M.08":"avc1.42e01e"}let optionalSelf="undefined"!=typeof self?self:void 0;try{now=self.performance.now.bind(self.performance)}catch(err){logger.debug("Unable to use Performance API on this environment"),now=null==optionalSelf?void 0:optionalSelf.Date.now}let muxConfig=[{demux:class{constructor(observer,config){this.remainderData=null,this.timeOffset=0,this.config=void 0,this.videoTrack=void 0,this.audioTrack=void 0,this.id3Track=void 0,this.txtTrack=void 0,this.config=config}resetTimeStamp(){}resetInitSegment(initSegment,audioCodec,videoCodec,trackDuration){let videoTrack=this.videoTrack=dummyTrack("video",1),audioTrack=this.audioTrack=dummyTrack("audio",1),captionTrack=this.txtTrack=dummyTrack("text",1);if(this.id3Track=dummyTrack("id3",1),this.timeOffset=0,!(null!=initSegment&&initSegment.byteLength))return;let initData=parseInitSegment(initSegment);if(initData.video){let{id,timescale,codec}=initData.video;videoTrack.id=id,videoTrack.timescale=captionTrack.timescale=timescale,videoTrack.codec=codec}if(initData.audio){let{id,timescale,codec}=initData.audio;audioTrack.id=id,audioTrack.timescale=timescale,audioTrack.codec=codec}captionTrack.id=4,videoTrack.sampleDuration=0,videoTrack.duration=audioTrack.duration=trackDuration}resetContiguity(){this.remainderData=null}static probe(data){return hasMoofData(data)}demux(data,timeOffset){this.timeOffset=timeOffset;let videoSamples=data,videoTrack=this.videoTrack,textTrack=this.txtTrack;if(this.config.progressive){this.remainderData&&(videoSamples=appendUint8Array(this.remainderData,data));let segmentedData=segmentValidRange(videoSamples);this.remainderData=segmentedData.remainder,videoTrack.samples=segmentedData.valid||new Uint8Array}else videoTrack.samples=videoSamples;let id3Track=this.extractID3Track(videoTrack,timeOffset);return textTrack.samples=parseSamples(timeOffset,videoTrack),{videoTrack,audioTrack:this.audioTrack,id3Track,textTrack:this.txtTrack}}flush(){let timeOffset=this.timeOffset,videoTrack=this.videoTrack,textTrack=this.txtTrack;videoTrack.samples=this.remainderData||new Uint8Array,this.remainderData=null;let id3Track=this.extractID3Track(videoTrack,this.timeOffset);return textTrack.samples=parseSamples(timeOffset,videoTrack),{videoTrack,audioTrack:dummyTrack(),id3Track,textTrack:dummyTrack()}}extractID3Track(videoTrack,timeOffset){let id3Track=this.id3Track;if(videoTrack.samples.length){let emsgs=findBox(videoTrack.samples,["emsg"]);emsgs&&emsgs.forEach(data=>{let emsgInfo=parseEmsg(data);if(emsgSchemePattern.test(emsgInfo.schemeIdUri)){let pts=isFiniteNumber(emsgInfo.presentationTime)?emsgInfo.presentationTime/emsgInfo.timeScale:timeOffset+emsgInfo.presentationTimeDelta/emsgInfo.timeScale,duration=4294967295===emsgInfo.eventDuration?Number.POSITIVE_INFINITY:emsgInfo.eventDuration/emsgInfo.timeScale;duration<=.001&&(duration=Number.POSITIVE_INFINITY);let payload=emsgInfo.payload;id3Track.samples.push({data:payload,len:payload.byteLength,dts:pts,pts:pts,type:MetadataSchema.emsg,duration:duration})}})}return id3Track}demuxSampleAes(data,keyData,timeOffset){return Promise.reject(Error("The MP4 demuxer does not support SAMPLE-AES decryption"))}destroy(){}},remux:class{constructor(){this.emitInitSegment=!1,this.audioCodec=void 0,this.videoCodec=void 0,this.initData=void 0,this.initPTS=null,this.initTracks=void 0,this.lastEndTime=null}destroy(){}resetTimeStamp(defaultInitPTS){this.initPTS=defaultInitPTS,this.lastEndTime=null}resetNextTimestamp(){this.lastEndTime=null}resetInitSegment(initSegment,audioCodec,videoCodec,decryptdata){this.audioCodec=audioCodec,this.videoCodec=videoCodec,this.generateInitSegment(patchEncyptionData(initSegment,decryptdata)),this.emitInitSegment=!0}generateInitSegment(initSegment){let{audioCodec,videoCodec}=this;if(!(null!=initSegment&&initSegment.byteLength)){this.initTracks=void 0,this.initData=void 0;return}let initData=this.initData=parseInitSegment(initSegment);initData.audio&&(audioCodec=getParsedTrackCodec(initData.audio,ElementaryStreamTypes.AUDIO)),initData.video&&(videoCodec=getParsedTrackCodec(initData.video,ElementaryStreamTypes.VIDEO));let tracks={};initData.audio&&initData.video?tracks.audiovideo={container:"video/mp4",codec:audioCodec+","+videoCodec,initSegment,id:"main"}:initData.audio?tracks.audio={container:"audio/mp4",codec:audioCodec,initSegment,id:"audio"}:initData.video?tracks.video={container:"video/mp4",codec:videoCodec,initSegment,id:"main"}:logger.warn("[passthrough-remuxer.ts]: initSegment does not contain moov or trak boxes."),this.initTracks=tracks}remux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,accurateTimeOffset){var _initData,_initData2;let{initPTS,lastEndTime}=this,result={audio:void 0,video:void 0,text:textTrack,id3:id3Track,initSegment:void 0};isFiniteNumber(lastEndTime)||(lastEndTime=this.lastEndTime=timeOffset||0);let data=videoTrack.samples;if(!(null!=data&&data.length))return result;let initSegment={initPTS:void 0,timescale:1},initData=this.initData;if(null!=(_initData=initData)&&_initData.length||(this.generateInitSegment(data),initData=this.initData),!(null!=(_initData2=initData)&&_initData2.length))return logger.warn("[passthrough-remuxer.ts]: Failed to generate initSegment."),result;this.emitInitSegment&&(initSegment.tracks=this.initTracks,this.emitInitSegment=!1);let duration=getDuration(data,initData),startDTS=getStartDTS(initData,data),decodeTime=null===startDTS?timeOffset:startDTS;(isInvalidInitPts(initPTS,decodeTime,timeOffset,duration)||initSegment.timescale!==initPTS.timescale&&accurateTimeOffset)&&(initSegment.initPTS=decodeTime-timeOffset,initPTS&&1===initPTS.timescale&&logger.warn(`Adjusting initPTS by ${initSegment.initPTS-initPTS.baseTime}`),this.initPTS=initPTS={baseTime:initSegment.initPTS,timescale:1});let startTime=audioTrack?decodeTime-initPTS.baseTime/initPTS.timescale:lastEndTime,endTime=startTime+duration;offsetStartDTS(initData,data,initPTS.baseTime/initPTS.timescale),duration>0?this.lastEndTime=endTime:(logger.warn("Duration parsed from mp4 should be greater than zero"),this.resetNextTimestamp());let hasAudio=!!initData.audio,hasVideo=!!initData.video,type="";hasAudio&&(type+="audio"),hasVideo&&(type+="video");let track={data1:data,startPTS:startTime,startDTS:startTime,endPTS:endTime,endDTS:endTime,type,hasAudio,hasVideo,nb:1,dropped:0};return result.audio="audio"===track.type?track:void 0,result.video="audio"!==track.type?track:void 0,result.initSegment=initSegment,result.id3=flushTextTrackMetadataCueSamples(id3Track,timeOffset,initPTS,initPTS),textTrack.samples.length&&(result.text=flushTextTrackUserdataCueSamples(textTrack,timeOffset,initPTS)),result}}},{demux:TSDemuxer,remux:MP4Remuxer},{demux:class extends BaseAudioDemuxer{constructor(observer,config){super(),this.observer=void 0,this.config=void 0,this.observer=observer,this.config=config}resetInitSegment(initSegment,audioCodec,videoCodec,trackDuration){super.resetInitSegment(initSegment,audioCodec,videoCodec,trackDuration),this._audioTrack={container:"audio/adts",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"aac",samples:[],manifestCodec:audioCodec,duration:trackDuration,inputTimeScale:9e4,dropped:0}}static probe(data){if(!data)return!1;let id3Data=getID3Data(data,0),offset=(null==id3Data?void 0:id3Data.length)||0;if(probe(data,offset))return!1;for(let length=data.length;offset<length;offset++)if(probe$1(data,offset))return logger.log("ADTS sync word found !"),!0;return!1}canParse(data,offset){return canParse$1(data,offset)}appendFrame(track,data,offset){initTrackConfig(track,this.observer,data,offset,track.manifestCodec);let frame=appendFrame$1(track,data,offset,this.basePTS,this.frameIndex);if(frame&&0===frame.missing)return frame}},remux:MP4Remuxer},{demux:class extends BaseAudioDemuxer{resetInitSegment(initSegment,audioCodec,videoCodec,trackDuration){super.resetInitSegment(initSegment,audioCodec,videoCodec,trackDuration),this._audioTrack={container:"audio/mpeg",type:"audio",id:2,pid:-1,sequenceNumber:0,segmentCodec:"mp3",samples:[],manifestCodec:audioCodec,duration:trackDuration,inputTimeScale:9e4,dropped:0}}static probe(data){if(!data)return!1;let id3Data=getID3Data(data,0),offset=(null==id3Data?void 0:id3Data.length)||0;if(id3Data&&11===data[offset]&&119===data[offset+1]&&void 0!==getTimeStamp(id3Data)&&16>=getAudioBSID(data,offset))return!1;for(let length=data.length;offset<length;offset++)if(probe(data,offset))return logger.log("MPEG Audio sync word found !"),!0;return!1}canParse(data,offset){return canParse(data,offset)}appendFrame(track,data,offset){if(null!==this.basePTS)return appendFrame(track,data,offset,this.basePTS,this.frameIndex)}},remux:MP4Remuxer}];class Transmuxer{constructor(observer,typeSupported,config,vendor,id){this.async=!1,this.observer=void 0,this.typeSupported=void 0,this.config=void 0,this.vendor=void 0,this.id=void 0,this.demuxer=void 0,this.remuxer=void 0,this.decrypter=void 0,this.probe=void 0,this.decryptionPromise=null,this.transmuxConfig=void 0,this.currentTransmuxState=void 0,this.observer=observer,this.typeSupported=typeSupported,this.config=config,this.vendor=vendor,this.id=id}configure(transmuxConfig){this.transmuxConfig=transmuxConfig,this.decrypter&&this.decrypter.reset()}push(data,decryptdata,chunkMeta,state){let stats=chunkMeta.transmuxing;stats.executeStart=now();let uintData=new Uint8Array(data),{currentTransmuxState,transmuxConfig}=this;state&&(this.currentTransmuxState=state);let{contiguous,discontinuity,trackSwitch,accurateTimeOffset,timeOffset,initSegmentChange}=state||currentTransmuxState,{audioCodec,videoCodec,defaultInitPts,duration,initSegmentData}=transmuxConfig,keyData=getEncryptionType(uintData,decryptdata);if(keyData&&"AES-128"===keyData.method){let decrypter=this.getDecrypter();if(!decrypter.isSync())return this.decryptionPromise=decrypter.webCryptoDecrypt(uintData,keyData.key.buffer,keyData.iv.buffer).then(decryptedData=>{let result=this.push(decryptedData,null,chunkMeta);return this.decryptionPromise=null,result}),this.decryptionPromise;{let decryptedData=decrypter.softwareDecrypt(uintData,keyData.key.buffer,keyData.iv.buffer);if(chunkMeta.part>-1&&(decryptedData=decrypter.flush()),!decryptedData)return stats.executeEnd=now(),emptyResult(chunkMeta);uintData=new Uint8Array(decryptedData)}}let resetMuxers=this.needsProbing(discontinuity,trackSwitch);if(resetMuxers){let error=this.configureTransmuxer(uintData);if(error)return logger.warn(`[transmuxer] ${error.message}`),this.observer.emit(Events1.ERROR,Events1.ERROR,{type:ErrorTypes1.MEDIA_ERROR,details:ErrorDetails1.FRAG_PARSING_ERROR,fatal:!1,error,reason:error.message}),stats.executeEnd=now(),emptyResult(chunkMeta)}(discontinuity||trackSwitch||initSegmentChange||resetMuxers)&&this.resetInitSegment(initSegmentData,audioCodec,videoCodec,duration,decryptdata),(discontinuity||initSegmentChange||resetMuxers)&&this.resetInitialTimestamp(defaultInitPts),contiguous||this.resetContiguity();let result=this.transmux(uintData,keyData,timeOffset,accurateTimeOffset,chunkMeta),currentState=this.currentTransmuxState;return currentState.contiguous=!0,currentState.discontinuity=!1,currentState.trackSwitch=!1,stats.executeEnd=now(),result}flush(chunkMeta){let stats=chunkMeta.transmuxing;stats.executeStart=now();let{decrypter,currentTransmuxState,decryptionPromise}=this;if(decryptionPromise)return decryptionPromise.then(()=>this.flush(chunkMeta));let transmuxResults=[],{timeOffset}=currentTransmuxState;if(decrypter){let decryptedData=decrypter.flush();decryptedData&&transmuxResults.push(this.push(decryptedData,null,chunkMeta))}let{demuxer,remuxer}=this;if(!demuxer||!remuxer)return stats.executeEnd=now(),[emptyResult(chunkMeta)];let demuxResultOrPromise=demuxer.flush(timeOffset);return isPromise(demuxResultOrPromise)?demuxResultOrPromise.then(demuxResult=>(this.flushRemux(transmuxResults,demuxResult,chunkMeta),transmuxResults)):(this.flushRemux(transmuxResults,demuxResultOrPromise,chunkMeta),transmuxResults)}flushRemux(transmuxResults,demuxResult,chunkMeta){let{audioTrack,videoTrack,id3Track,textTrack}=demuxResult,{accurateTimeOffset,timeOffset}=this.currentTransmuxState;logger.log(`[transmuxer.ts]: Flushed fragment ${chunkMeta.sn}${chunkMeta.part>-1?" p: "+chunkMeta.part:""} of level ${chunkMeta.level}`);let remuxResult=this.remuxer.remux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,accurateTimeOffset,!0,this.id);transmuxResults.push({remuxResult,chunkMeta}),chunkMeta.transmuxing.executeEnd=now()}resetInitialTimestamp(defaultInitPts){let{demuxer,remuxer}=this;demuxer&&remuxer&&(demuxer.resetTimeStamp(defaultInitPts),remuxer.resetTimeStamp(defaultInitPts))}resetContiguity(){let{demuxer,remuxer}=this;demuxer&&remuxer&&(demuxer.resetContiguity(),remuxer.resetNextTimestamp())}resetInitSegment(initSegmentData,audioCodec,videoCodec,trackDuration,decryptdata){let{demuxer,remuxer}=this;demuxer&&remuxer&&(demuxer.resetInitSegment(initSegmentData,audioCodec,videoCodec,trackDuration),remuxer.resetInitSegment(initSegmentData,audioCodec,videoCodec,decryptdata))}destroy(){this.demuxer&&(this.demuxer.destroy(),this.demuxer=void 0),this.remuxer&&(this.remuxer.destroy(),this.remuxer=void 0)}transmux(data,keyData,timeOffset,accurateTimeOffset,chunkMeta){return keyData&&"SAMPLE-AES"===keyData.method?this.transmuxSampleAes(data,keyData,timeOffset,accurateTimeOffset,chunkMeta):this.transmuxUnencrypted(data,timeOffset,accurateTimeOffset,chunkMeta)}transmuxUnencrypted(data,timeOffset,accurateTimeOffset,chunkMeta){let{audioTrack,videoTrack,id3Track,textTrack}=this.demuxer.demux(data,timeOffset,!1,!this.config.progressive);return{remuxResult:this.remuxer.remux(audioTrack,videoTrack,id3Track,textTrack,timeOffset,accurateTimeOffset,!1,this.id),chunkMeta}}transmuxSampleAes(data,decryptData,timeOffset,accurateTimeOffset,chunkMeta){return this.demuxer.demuxSampleAes(data,decryptData,timeOffset).then(demuxResult=>({remuxResult:this.remuxer.remux(demuxResult.audioTrack,demuxResult.videoTrack,demuxResult.id3Track,demuxResult.textTrack,timeOffset,accurateTimeOffset,!1,this.id),chunkMeta}))}configureTransmuxer(data){let mux;let{config,observer,typeSupported,vendor}=this;for(let i=0,len=muxConfig.length;i<len;i++){var _muxConfig$i$demux;if(null!=(_muxConfig$i$demux=muxConfig[i].demux)&&_muxConfig$i$demux.probe(data)){mux=muxConfig[i];break}}if(!mux)return Error("Failed to find demuxer by probing fragment data");let demuxer=this.demuxer,remuxer=this.remuxer,Remuxer=mux.remux,Demuxer=mux.demux;remuxer&&remuxer instanceof Remuxer||(this.remuxer=new Remuxer(observer,config,typeSupported,vendor)),demuxer&&demuxer instanceof Demuxer||(this.demuxer=new Demuxer(observer,config,typeSupported),this.probe=Demuxer.probe)}needsProbing(discontinuity,trackSwitch){return!this.demuxer||!this.remuxer||discontinuity||trackSwitch}getDecrypter(){let decrypter=this.decrypter;return decrypter||(decrypter=this.decrypter=new Decrypter(this.config)),decrypter}}function getEncryptionType(data,decryptData){let encryptionType=null;return data.byteLength>0&&(null==decryptData?void 0:decryptData.key)!=null&&null!==decryptData.iv&&null!=decryptData.method&&(encryptionType=decryptData),encryptionType}let emptyResult=chunkMeta=>({remuxResult:{},chunkMeta});function isPromise(p){return"then"in p&&p.then instanceof Function}class TransmuxConfig{constructor(audioCodec,videoCodec,initSegmentData,duration,defaultInitPts){this.audioCodec=void 0,this.videoCodec=void 0,this.initSegmentData=void 0,this.duration=void 0,this.defaultInitPts=void 0,this.audioCodec=audioCodec,this.videoCodec=videoCodec,this.initSegmentData=initSegmentData,this.duration=duration,this.defaultInitPts=defaultInitPts||null}}class TransmuxState{constructor(discontinuity,contiguous,accurateTimeOffset,trackSwitch,timeOffset,initSegmentChange){this.discontinuity=void 0,this.contiguous=void 0,this.accurateTimeOffset=void 0,this.trackSwitch=void 0,this.timeOffset=void 0,this.initSegmentChange=void 0,this.discontinuity=discontinuity,this.contiguous=contiguous,this.accurateTimeOffset=accurateTimeOffset,this.trackSwitch=trackSwitch,this.timeOffset=timeOffset,this.initSegmentChange=initSegmentChange}}var eventemitter3={exports:{}};!function(module){var has=Object.prototype.hasOwnProperty,prefix="~";function Events(){}function EE(fn,context,once){this.fn=fn,this.context=context,this.once=once||!1}function addListener(emitter,event,fn,context,once){if("function"!=typeof fn)throw TypeError("The listener must be a function");var listener=new EE(fn,context||emitter,once),evt=prefix?prefix+event:event;return emitter._events[evt]?emitter._events[evt].fn?emitter._events[evt]=[emitter._events[evt],listener]:emitter._events[evt].push(listener):(emitter._events[evt]=listener,emitter._eventsCount++),emitter}function clearEvent(emitter,evt){0==--emitter._eventsCount?emitter._events=new Events:delete emitter._events[evt]}function EventEmitter(){this._events=new Events,this._eventsCount=0}Object.create&&(Events.prototype=Object.create(null),new Events().__proto__||(prefix=!1)),EventEmitter.prototype.eventNames=function eventNames(){var events,name,names=[];if(0===this._eventsCount)return names;for(name in events=this._events)has.call(events,name)&&names.push(prefix?name.slice(1):name);return Object.getOwnPropertySymbols?names.concat(Object.getOwnPropertySymbols(events)):names},EventEmitter.prototype.listeners=function listeners(event){var evt=prefix?prefix+event:event,handlers=this._events[evt];if(!handlers)return[];if(handlers.fn)return[handlers.fn];for(var i=0,l=handlers.length,ee=Array(l);i<l;i++)ee[i]=handlers[i].fn;return ee},EventEmitter.prototype.listenerCount=function listenerCount(event){var evt=prefix?prefix+event:event,listeners=this._events[evt];return listeners?listeners.fn?1:listeners.length:0},EventEmitter.prototype.emit=function emit(event,a1,a2,a3,a4,a5){var evt=prefix?prefix+event:event;if(!this._events[evt])return!1;var args,i,listeners=this._events[evt],len=arguments.length;if(listeners.fn){switch(listeners.once&&this.removeListener(event,listeners.fn,void 0,!0),len){case 1:return listeners.fn.call(listeners.context),!0;case 2:return listeners.fn.call(listeners.context,a1),!0;case 3:return listeners.fn.call(listeners.context,a1,a2),!0;case 4:return listeners.fn.call(listeners.context,a1,a2,a3),!0;case 5:return listeners.fn.call(listeners.context,a1,a2,a3,a4),!0;case 6:return listeners.fn.call(listeners.context,a1,a2,a3,a4,a5),!0}for(i=1,args=Array(len-1);i<len;i++)args[i-1]=arguments[i];listeners.fn.apply(listeners.context,args)}else{var j,length=listeners.length;for(i=0;i<length;i++)switch(listeners[i].once&&this.removeListener(event,listeners[i].fn,void 0,!0),len){case 1:listeners[i].fn.call(listeners[i].context);break;case 2:listeners[i].fn.call(listeners[i].context,a1);break;case 3:listeners[i].fn.call(listeners[i].context,a1,a2);break;case 4:listeners[i].fn.call(listeners[i].context,a1,a2,a3);break;default:if(!args)for(j=1,args=Array(len-1);j<len;j++)args[j-1]=arguments[j];listeners[i].fn.apply(listeners[i].context,args)}}return!0},EventEmitter.prototype.on=function on(event,fn,context){return addListener(this,event,fn,context,!1)},EventEmitter.prototype.once=function once(event,fn,context){return addListener(this,event,fn,context,!0)},EventEmitter.prototype.removeListener=function removeListener(event,fn,context,once){var evt=prefix?prefix+event:event;if(!this._events[evt])return this;if(!fn)return clearEvent(this,evt),this;var listeners=this._events[evt];if(listeners.fn)listeners.fn!==fn||once&&!listeners.once||context&&listeners.context!==context||clearEvent(this,evt);else{for(var i=0,events=[],length=listeners.length;i<length;i++)(listeners[i].fn!==fn||once&&!listeners[i].once||context&&listeners[i].context!==context)&&events.push(listeners[i]);events.length?this._events[evt]=1===events.length?events[0]:events:clearEvent(this,evt)}return this},EventEmitter.prototype.removeAllListeners=function removeAllListeners(event){var evt;return event?(evt=prefix?prefix+event:event,this._events[evt]&&clearEvent(this,evt)):(this._events=new Events,this._eventsCount=0),this},EventEmitter.prototype.off=EventEmitter.prototype.removeListener,EventEmitter.prototype.addListener=EventEmitter.prototype.on,EventEmitter.prefixed=prefix,EventEmitter.EventEmitter=EventEmitter,module.exports=EventEmitter}(eventemitter3);var EventEmitter=getDefaultExportFromCjs(eventemitter3.exports);class TransmuxerInterface{constructor(hls,id,onTransmuxComplete,onFlush){this.error=null,this.hls=void 0,this.id=void 0,this.observer=void 0,this.frag=null,this.part=null,this.useWorker=void 0,this.workerContext=null,this.onwmsg=void 0,this.transmuxer=null,this.onTransmuxComplete=void 0,this.onFlush=void 0;let config=hls.config;this.hls=hls,this.id=id,this.useWorker=!!config.enableWorker,this.onTransmuxComplete=onTransmuxComplete,this.onFlush=onFlush;let forwardMessage=(ev,data)=>{(data=data||{}).frag=this.frag,data.id=this.id,ev===Events1.ERROR&&(this.error=data.error),this.hls.trigger(ev,data)};this.observer=new EventEmitter,this.observer.on(Events1.FRAG_DECRYPTED,forwardMessage),this.observer.on(Events1.ERROR,forwardMessage);let MediaSource=getMediaSource(config.preferManagedMediaSource)||{isTypeSupported:()=>!1},m2tsTypeSupported={mpeg:MediaSource.isTypeSupported("audio/mpeg"),mp3:MediaSource.isTypeSupported('audio/mp4; codecs="mp3"'),ac3:!1};if(this.useWorker&&"undefined"!=typeof Worker&&(config.workerPath||hasUMDWorker())){try{config.workerPath?(logger.log(`loading Web Worker ${config.workerPath} for "${id}"`),this.workerContext=loadWorker(config.workerPath)):(logger.log(`injecting Web Worker for "${id}"`),this.workerContext=injectWorker()),this.onwmsg=event=>this.onWorkerMessage(event);let{worker}=this.workerContext;worker.addEventListener("message",this.onwmsg),worker.onerror=event=>{let error=Error(`${event.message}  (${event.filename}:${event.lineno})`);config.enableWorker=!1,logger.warn(`Error in "${id}" Web Worker, fallback to inline`),this.hls.trigger(Events1.ERROR,{type:ErrorTypes1.OTHER_ERROR,details:ErrorDetails1.INTERNAL_EXCEPTION,fatal:!1,event:"demuxerWorker",error})},worker.postMessage({cmd:"init",typeSupported:m2tsTypeSupported,vendor:"",id:id,config:JSON.stringify(config)})}catch(err){logger.warn(`Error setting up "${id}" Web Worker, fallback to inline`,err),this.resetWorker(),this.error=null,this.transmuxer=new Transmuxer(this.observer,m2tsTypeSupported,config,"",id)}return}this.transmuxer=new Transmuxer(this.observer,m2tsTypeSupported,config,"",id)}resetWorker(){if(this.workerContext){let{worker,objectURL}=this.workerContext;objectURL&&self.URL.revokeObjectURL(objectURL),worker.removeEventListener("message",this.onwmsg),worker.onerror=null,worker.terminate(),this.workerContext=null}}destroy(){if(this.workerContext)this.resetWorker(),this.onwmsg=void 0;else{let transmuxer=this.transmuxer;transmuxer&&(transmuxer.destroy(),this.transmuxer=null)}let observer=this.observer;observer&&observer.removeAllListeners(),this.frag=null,this.observer=null,this.hls=null}push(data,initSegmentData,audioCodec,videoCodec,frag,part,duration,accurateTimeOffset,chunkMeta,defaultInitPTS){var _frag$initSegment,_lastFrag$initSegment;chunkMeta.transmuxing.start=self.performance.now();let{transmuxer}=this,timeOffset=part?part.start:frag.start,decryptdata=frag.decryptdata,lastFrag=this.frag,discontinuity=!(lastFrag&&frag.cc===lastFrag.cc),trackSwitch=!(lastFrag&&chunkMeta.level===lastFrag.level),snDiff=lastFrag?chunkMeta.sn-lastFrag.sn:-1,partDiff=this.part?chunkMeta.part-this.part.index:-1,progressive=0===snDiff&&chunkMeta.id>1&&chunkMeta.id===(null==lastFrag?void 0:lastFrag.stats.chunkCount),contiguous=!trackSwitch&&(1===snDiff||0===snDiff&&(1===partDiff||progressive&&partDiff<=0)),now=self.performance.now();(trackSwitch||snDiff||0===frag.stats.parsing.start)&&(frag.stats.parsing.start=now),part&&(partDiff||!contiguous)&&(part.stats.parsing.start=now);let initSegmentChange=!(lastFrag&&(null==(_frag$initSegment=frag.initSegment)?void 0:_frag$initSegment.url)===(null==(_lastFrag$initSegment=lastFrag.initSegment)?void 0:_lastFrag$initSegment.url)),state=new TransmuxState(discontinuity,contiguous,accurateTimeOffset,trackSwitch,timeOffset,initSegmentChange);if(!contiguous||discontinuity||initSegmentChange){logger.log(`[transmuxer-interface, ${frag.type}]: Starting new transmux session for sn: ${chunkMeta.sn} p: ${chunkMeta.part} level: ${chunkMeta.level} id: ${chunkMeta.id}
        discontinuity: ${discontinuity}
        trackSwitch: ${trackSwitch}
        contiguous: ${contiguous}
        accurateTimeOffset: ${accurateTimeOffset}
        timeOffset: ${timeOffset}
        initSegmentChange: ${initSegmentChange}`);let config=new TransmuxConfig(audioCodec,videoCodec,initSegmentData,duration,defaultInitPTS);this.configureTransmuxer(config)}if(this.frag=frag,this.part=part,this.workerContext)this.workerContext.worker.postMessage({cmd:"demux",data,decryptdata,chunkMeta,state},data instanceof ArrayBuffer?[data]:[]);else if(transmuxer){let transmuxResult=transmuxer.push(data,decryptdata,chunkMeta,state);isPromise(transmuxResult)?(transmuxer.async=!0,transmuxResult.then(data=>{this.handleTransmuxComplete(data)}).catch(error=>{this.transmuxerError(error,chunkMeta,"transmuxer-interface push error")})):(transmuxer.async=!1,this.handleTransmuxComplete(transmuxResult))}}flush(chunkMeta){chunkMeta.transmuxing.start=self.performance.now();let{transmuxer}=this;if(this.workerContext)this.workerContext.worker.postMessage({cmd:"flush",chunkMeta});else if(transmuxer){let transmuxResult=transmuxer.flush(chunkMeta);isPromise(transmuxResult)||transmuxer.async?(isPromise(transmuxResult)||(transmuxResult=Promise.resolve(transmuxResult)),transmuxResult.then(data=>{this.handleFlushResult(data,chunkMeta)}).catch(error=>{this.transmuxerError(error,chunkMeta,"transmuxer-interface flush error")})):this.handleFlushResult(transmuxResult,chunkMeta)}}transmuxerError(error,chunkMeta,reason){this.hls&&(this.error=error,this.hls.trigger(Events1.ERROR,{type:ErrorTypes1.MEDIA_ERROR,details:ErrorDetails1.FRAG_PARSING_ERROR,chunkMeta,frag:this.frag||void 0,fatal:!1,error,err:error,reason}))}handleFlushResult(results,chunkMeta){results.forEach(result=>{this.handleTransmuxComplete(result)}),this.onFlush(chunkMeta)}onWorkerMessage(event){let data=event.data;if(!(null!=data&&data.event)){logger.warn(`worker message received with no ${data?"event name":"data"}`);return}let hls=this.hls;if(this.hls)switch(data.event){case"init":{var _this$workerContext;let objectURL=null==(_this$workerContext=this.workerContext)?void 0:_this$workerContext.objectURL;objectURL&&self.URL.revokeObjectURL(objectURL);break}case"transmuxComplete":this.handleTransmuxComplete(data.data);break;case"flush":this.onFlush(data.data);break;case"workerLog":logger[data.data.logType]&&logger[data.data.logType](data.data.message);break;default:data.data=data.data||{},data.data.frag=this.frag,data.data.id=this.id,hls.trigger(data.event,data.data)}}configureTransmuxer(config){let{transmuxer}=this;this.workerContext?this.workerContext.worker.postMessage({cmd:"configure",config}):transmuxer&&transmuxer.configure(config)}handleTransmuxComplete(result){result.chunkMeta.transmuxing.end=self.performance.now(),this.onTransmuxComplete(result)}}class GapController{constructor(config,media,fragmentTracker,hls){this.config=void 0,this.media=null,this.fragmentTracker=void 0,this.hls=void 0,this.nudgeRetry=0,this.stallReported=!1,this.stalled=null,this.moved=!1,this.seeking=!1,this.config=config,this.media=media,this.fragmentTracker=fragmentTracker,this.hls=hls}destroy(){this.media=null,this.hls=this.fragmentTracker=null}poll(lastCurrentTime,activeFrag){let{config,media,stalled}=this;if(null===media)return;let{currentTime,seeking}=media,seeked=this.seeking&&!seeking,beginSeek=!this.seeking&&seeking;if(this.seeking=seeking,currentTime!==lastCurrentTime){if(this.moved=!0,seeking||(this.nudgeRetry=0),null!==stalled){if(this.stallReported){let _stalledDuration=self.performance.now()-stalled;logger.warn(`playback not stuck anymore @${currentTime}, after ${Math.round(_stalledDuration)}ms`),this.stallReported=!1}this.stalled=null}return}if(beginSeek||seeked){this.stalled=null;return}if(media.paused&&!seeking||media.ended||0===media.playbackRate||!BufferHelper.getBuffered(media).length){this.nudgeRetry=0;return}let bufferInfo=BufferHelper.bufferInfo(media,currentTime,0),nextStart=bufferInfo.nextStart||0;if(seeking){let hasEnoughBuffer=bufferInfo.len>2,noBufferGap=!nextStart||activeFrag&&activeFrag.start<=currentTime||nextStart-currentTime>2&&!this.fragmentTracker.getPartialFragment(currentTime);if(hasEnoughBuffer||noBufferGap)return;this.moved=!1}if(!this.moved&&null!==this.stalled){var _level$details;if(!(bufferInfo.len>0)&&!nextStart)return;let startJump=Math.max(nextStart,bufferInfo.start||0)-currentTime,level=this.hls.levels?this.hls.levels[this.hls.currentLevel]:null,maxStartGapJump=(null==level?void 0:null==(_level$details=level.details)?void 0:_level$details.live)?2*level.details.targetduration:2,partialOrGap=this.fragmentTracker.getPartialFragment(currentTime);if(startJump>0&&(startJump<=maxStartGapJump||partialOrGap)){media.paused||this._trySkipBufferHole(partialOrGap);return}}let tnow=self.performance.now();if(null===stalled){this.stalled=tnow;return}let stalledDuration=tnow-stalled;if(!seeking&&stalledDuration>=250&&(this._reportStall(bufferInfo),!this.media))return;let bufferedWithHoles=BufferHelper.bufferInfo(media,currentTime,config.maxBufferHole);this._tryFixBufferStall(bufferedWithHoles,stalledDuration)}_tryFixBufferStall(bufferInfo,stalledDurationMs){let{config,fragmentTracker,media}=this;if(null===media)return;let currentTime=media.currentTime,partial=fragmentTracker.getPartialFragment(currentTime);!(partial&&(this._trySkipBufferHole(partial)||!this.media))&&(bufferInfo.len>config.maxBufferHole||bufferInfo.nextStart&&bufferInfo.nextStart-currentTime<config.maxBufferHole)&&stalledDurationMs>1e3*config.highBufferWatchdogPeriod&&(logger.warn("Trying to nudge playhead over buffer-hole"),this.stalled=null,this._tryNudgeBuffer())}_reportStall(bufferInfo){let{hls,media,stallReported}=this;if(!stallReported&&media){this.stallReported=!0;let error=Error(`Playback stalling at @${media.currentTime} due to low buffer (${JSON.stringify(bufferInfo)})`);logger.warn(error.message),hls.trigger(Events1.ERROR,{type:ErrorTypes1.MEDIA_ERROR,details:ErrorDetails1.BUFFER_STALLED_ERROR,fatal:!1,error,buffer:bufferInfo.len})}}_trySkipBufferHole(partial){let{config,hls,media}=this;if(null===media)return 0;let currentTime=media.currentTime,bufferInfo=BufferHelper.bufferInfo(media,currentTime,0),startTime=currentTime<bufferInfo.start?bufferInfo.start:bufferInfo.nextStart;if(startTime){let bufferStarved=bufferInfo.len<=config.maxBufferHole,waiting=bufferInfo.len>0&&bufferInfo.len<1&&media.readyState<3,gapLength=startTime-currentTime;if(gapLength>0&&(bufferStarved||waiting)){if(gapLength>config.maxBufferHole){let{fragmentTracker}=this,startGap=!1;if(0===currentTime){let startFrag=fragmentTracker.getAppendedFrag(0,PlaylistLevelType.MAIN);startFrag&&startTime<startFrag.end&&(startGap=!0)}if(!startGap){let startProvisioned=partial||fragmentTracker.getAppendedFrag(currentTime,PlaylistLevelType.MAIN);if(startProvisioned){let moreToLoad=!1,pos=startProvisioned.end;for(;pos<startTime;){let provisioned=fragmentTracker.getPartialFragment(pos);if(provisioned)pos+=provisioned.duration;else{moreToLoad=!0;break}}if(moreToLoad)return 0}}}let targetTime=Math.max(startTime+.05,currentTime+.1);if(logger.warn(`skipping hole, adjusting currentTime from ${currentTime} to ${targetTime}`),this.moved=!0,this.stalled=null,media.currentTime=targetTime,partial&&!partial.gap){let error=Error(`fragment loaded with buffer holes, seeking from ${currentTime} to ${targetTime}`);hls.trigger(Events1.ERROR,{type:ErrorTypes1.MEDIA_ERROR,details:ErrorDetails1.BUFFER_SEEK_OVER_HOLE,fatal:!1,error,reason:error.message,frag:partial})}return targetTime}}return 0}_tryNudgeBuffer(){let{config,hls,media,nudgeRetry}=this;if(null===media)return;let currentTime=media.currentTime;if(this.nudgeRetry++,nudgeRetry<config.nudgeMaxRetry){let targetTime=currentTime+(nudgeRetry+1)*config.nudgeOffset,error=Error(`Nudging 'currentTime' from ${currentTime} to ${targetTime}`);logger.warn(error.message),media.currentTime=targetTime,hls.trigger(Events1.ERROR,{type:ErrorTypes1.MEDIA_ERROR,details:ErrorDetails1.BUFFER_NUDGE_ON_STALL,error,fatal:!1})}else{let error=Error(`Playhead still not moving while enough data buffered @${currentTime} after ${config.nudgeMaxRetry} nudges`);logger.error(error.message),hls.trigger(Events1.ERROR,{type:ErrorTypes1.MEDIA_ERROR,details:ErrorDetails1.BUFFER_STALLED_ERROR,error,fatal:!0})}}}class StreamController extends BaseStreamController{constructor(hls,fragmentTracker,keyLoader){super(hls,fragmentTracker,keyLoader,"[stream-controller]",PlaylistLevelType.MAIN),this.audioCodecSwap=!1,this.gapController=null,this.level=-1,this._forceStartLoad=!1,this.altAudio=!1,this.audioOnly=!1,this.fragPlaying=null,this.onvplaying=null,this.onvseeked=null,this.fragLastKbps=0,this.couldBacktrack=!1,this.backtrackFragment=null,this.audioCodecSwitch=!1,this.videoBuffer=null,this._registerListeners()}_registerListeners(){let{hls}=this;hls.on(Events1.MEDIA_ATTACHED,this.onMediaAttached,this),hls.on(Events1.MEDIA_DETACHING,this.onMediaDetaching,this),hls.on(Events1.MANIFEST_LOADING,this.onManifestLoading,this),hls.on(Events1.MANIFEST_PARSED,this.onManifestParsed,this),hls.on(Events1.LEVEL_LOADING,this.onLevelLoading,this),hls.on(Events1.LEVEL_LOADED,this.onLevelLoaded,this),hls.on(Events1.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),hls.on(Events1.ERROR,this.onError,this),hls.on(Events1.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),hls.on(Events1.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),hls.on(Events1.BUFFER_CREATED,this.onBufferCreated,this),hls.on(Events1.BUFFER_FLUSHED,this.onBufferFlushed,this),hls.on(Events1.LEVELS_UPDATED,this.onLevelsUpdated,this),hls.on(Events1.FRAG_BUFFERED,this.onFragBuffered,this)}_unregisterListeners(){let{hls}=this;hls.off(Events1.MEDIA_ATTACHED,this.onMediaAttached,this),hls.off(Events1.MEDIA_DETACHING,this.onMediaDetaching,this),hls.off(Events1.MANIFEST_LOADING,this.onManifestLoading,this),hls.off(Events1.MANIFEST_PARSED,this.onManifestParsed,this),hls.off(Events1.LEVEL_LOADED,this.onLevelLoaded,this),hls.off(Events1.FRAG_LOAD_EMERGENCY_ABORTED,this.onFragLoadEmergencyAborted,this),hls.off(Events1.ERROR,this.onError,this),hls.off(Events1.AUDIO_TRACK_SWITCHING,this.onAudioTrackSwitching,this),hls.off(Events1.AUDIO_TRACK_SWITCHED,this.onAudioTrackSwitched,this),hls.off(Events1.BUFFER_CREATED,this.onBufferCreated,this),hls.off(Events1.BUFFER_FLUSHED,this.onBufferFlushed,this),hls.off(Events1.LEVELS_UPDATED,this.onLevelsUpdated,this),hls.off(Events1.FRAG_BUFFERED,this.onFragBuffered,this)}onHandlerDestroying(){this._unregisterListeners(),super.onHandlerDestroying()}startLoad(startPosition){if(this.levels){let{lastCurrentTime,hls}=this;if(this.stopLoad(),this.setInterval(100),this.level=-1,!this.startFragRequested){let startLevel=hls.startLevel;-1===startLevel&&(hls.config.testBandwidth&&this.levels.length>1?(startLevel=0,this.bitrateTest=!0):startLevel=hls.firstAutoLevel),hls.nextLoadLevel=startLevel,this.level=hls.loadLevel,this.loadedmetadata=!1}lastCurrentTime>0&&-1===startPosition&&(this.log(`Override startPosition with lastCurrentTime @${lastCurrentTime.toFixed(3)}`),startPosition=lastCurrentTime),this.state=State.IDLE,this.nextLoadPosition=this.startPosition=this.lastCurrentTime=startPosition,this.tick()}else this._forceStartLoad=!0,this.state=State.STOPPED}stopLoad(){this._forceStartLoad=!1,super.stopLoad()}doTick(){switch(this.state){case State.WAITING_LEVEL:{let{levels,level}=this,currentLevel=null==levels?void 0:levels[level],details=null==currentLevel?void 0:currentLevel.details;if(details&&(!details.live||this.levelLastLoaded===currentLevel)){if(this.waitForCdnTuneIn(details))break;this.state=State.IDLE}else this.hls.nextLoadLevel!==this.level&&(this.state=State.IDLE);break}case State.FRAG_LOADING_WAITING_RETRY:{var _this$media;let now=self.performance.now(),retryDate=this.retryDate;if(!retryDate||now>=retryDate||null!=(_this$media=this.media)&&_this$media.seeking){let{levels,level}=this,currentLevel=null==levels?void 0:levels[level];this.resetStartWhenNotLoaded(currentLevel||null),this.state=State.IDLE}}}this.state===State.IDLE&&this.doTickIdle(),this.onTickEnd()}onTickEnd(){super.onTickEnd(),this.checkBuffer(),this.checkFragmentChanged()}doTickIdle(){let{hls,levelLastLoaded,levels,media}=this;if(null===levelLastLoaded||!media&&(this.startFragRequested||!hls.config.startFragPrefetch)||this.altAudio&&this.audioOnly)return;let level=hls.nextLoadLevel;if(!(null!=levels&&levels[level]))return;let levelInfo=levels[level],bufferInfo=this.getMainFwdBufferInfo();if(null===bufferInfo)return;let lastDetails=this.getLevelDetails();if(lastDetails&&this._streamEnded(bufferInfo,lastDetails)){let data={};this.altAudio&&(data.type="video"),this.hls.trigger(Events1.BUFFER_EOS,data),this.state=State.ENDED;return}hls.loadLevel!==level&&-1===hls.manualLevel&&this.log(`Adapting to level ${level} from level ${this.level}`),this.level=hls.nextLoadLevel=level;let levelDetails=levelInfo.details;if(!levelDetails||this.state===State.WAITING_LEVEL||levelDetails.live&&this.levelLastLoaded!==levelInfo){this.level=level,this.state=State.WAITING_LEVEL;return}let bufferLen=bufferInfo.len,maxBufLen=this.getMaxBufferLength(levelInfo.maxBitrate);if(bufferLen>=maxBufLen)return;this.backtrackFragment&&this.backtrackFragment.start>bufferInfo.end&&(this.backtrackFragment=null);let targetBufferTime=this.backtrackFragment?this.backtrackFragment.start:bufferInfo.end,frag=this.getNextFragment(targetBufferTime,levelDetails);if(this.couldBacktrack&&!this.fragPrevious&&frag&&"initSegment"!==frag.sn&&this.fragmentTracker.getState(frag)!==FragmentState.OK){var _this$backtrackFragme;let fragIdx=(null!=(_this$backtrackFragme=this.backtrackFragment)?_this$backtrackFragme:frag).sn-levelDetails.startSN,backtrackFrag=levelDetails.fragments[fragIdx-1];backtrackFrag&&frag.cc===backtrackFrag.cc&&(frag=backtrackFrag,this.fragmentTracker.removeFragment(backtrackFrag))}else this.backtrackFragment&&bufferInfo.len&&(this.backtrackFragment=null);if(frag&&this.isLoopLoading(frag,targetBufferTime)){if(!frag.gap){let type=this.audioOnly&&!this.altAudio?ElementaryStreamTypes.AUDIO:ElementaryStreamTypes.VIDEO,mediaBuffer=(type===ElementaryStreamTypes.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;mediaBuffer&&this.afterBufferFlushed(mediaBuffer,type,PlaylistLevelType.MAIN)}frag=this.getNextFragmentLoopLoading(frag,levelDetails,bufferInfo,PlaylistLevelType.MAIN,maxBufLen)}frag&&(!frag.initSegment||frag.initSegment.data||this.bitrateTest||(frag=frag.initSegment),this.loadFragment(frag,levelInfo,targetBufferTime))}loadFragment(frag,level,targetBufferTime){let fragState=this.fragmentTracker.getState(frag);this.fragCurrent=frag,fragState===FragmentState.NOT_LOADED||fragState===FragmentState.PARTIAL?"initSegment"===frag.sn?this._loadInitSegment(frag,level):this.bitrateTest?(this.log(`Fragment ${frag.sn} of level ${frag.level} is being downloaded to test bitrate and will not be buffered`),this._loadBitrateTestFrag(frag,level)):(this.startFragRequested=!0,super.loadFragment(frag,level,targetBufferTime)):this.clearTrackerIfNeeded(frag)}getBufferedFrag(position){return this.fragmentTracker.getBufferedFrag(position,PlaylistLevelType.MAIN)}followingBufferedFrag(frag){return frag?this.getBufferedFrag(frag.end+.5):null}immediateLevelSwitch(){this.abortCurrentFrag(),this.flushMainBuffer(0,Number.POSITIVE_INFINITY)}nextLevelSwitch(){let{levels,media}=this;if(null!=media&&media.readyState){let fetchdelay;let fragPlayingCurrent=this.getAppendedFrag(media.currentTime);fragPlayingCurrent&&fragPlayingCurrent.start>1&&this.flushMainBuffer(0,fragPlayingCurrent.start-1);let levelDetails=this.getLevelDetails();if(null!=levelDetails&&levelDetails.live){let bufferInfo=this.getMainFwdBufferInfo();if(!bufferInfo||bufferInfo.len<2*levelDetails.targetduration)return}if(!media.paused&&levels){let nextLevel=levels[this.hls.nextLoadLevel],fragLastKbps=this.fragLastKbps;fetchdelay=fragLastKbps&&this.fragCurrent?this.fragCurrent.duration*nextLevel.maxBitrate/(1e3*fragLastKbps)+1:0}else fetchdelay=0;let bufferedFrag=this.getBufferedFrag(media.currentTime+fetchdelay);if(bufferedFrag){let nextBufferedFrag=this.followingBufferedFrag(bufferedFrag);if(nextBufferedFrag){this.abortCurrentFrag();let maxStart=nextBufferedFrag.maxStartPTS?nextBufferedFrag.maxStartPTS:nextBufferedFrag.start,fragDuration=nextBufferedFrag.duration,startPts=Math.max(bufferedFrag.end,maxStart+Math.min(Math.max(fragDuration-this.config.maxFragLookUpTolerance,fragDuration*(this.couldBacktrack?.5:.125)),fragDuration*(this.couldBacktrack?.75:.25)));this.flushMainBuffer(startPts,Number.POSITIVE_INFINITY)}}}}abortCurrentFrag(){let fragCurrent=this.fragCurrent;switch(this.fragCurrent=null,this.backtrackFragment=null,fragCurrent&&(fragCurrent.abortRequests(),this.fragmentTracker.removeFragment(fragCurrent)),this.state){case State.KEY_LOADING:case State.FRAG_LOADING:case State.FRAG_LOADING_WAITING_RETRY:case State.PARSING:case State.PARSED:this.state=State.IDLE}this.nextLoadPosition=this.getLoadPosition()}flushMainBuffer(startOffset,endOffset){super.flushMainBuffer(startOffset,endOffset,this.altAudio?"video":null)}onMediaAttached(event,data){super.onMediaAttached(event,data);let media=data.media;this.onvplaying=this.onMediaPlaying.bind(this),this.onvseeked=this.onMediaSeeked.bind(this),media.addEventListener("playing",this.onvplaying),media.addEventListener("seeked",this.onvseeked),this.gapController=new GapController(this.config,media,this.fragmentTracker,this.hls)}onMediaDetaching(){let{media}=this;media&&this.onvplaying&&this.onvseeked&&(media.removeEventListener("playing",this.onvplaying),media.removeEventListener("seeked",this.onvseeked),this.onvplaying=this.onvseeked=null,this.videoBuffer=null),this.fragPlaying=null,this.gapController&&(this.gapController.destroy(),this.gapController=null),super.onMediaDetaching()}onMediaPlaying(){this.tick()}onMediaSeeked(){let media=this.media,currentTime=media?media.currentTime:null;isFiniteNumber(currentTime)&&this.log(`Media seeked to ${currentTime.toFixed(3)}`);let bufferInfo=this.getMainFwdBufferInfo();if(null===bufferInfo||0===bufferInfo.len){this.warn(`Main forward buffer length on "seeked" event ${bufferInfo?bufferInfo.len:"empty"})`);return}this.tick()}onManifestLoading(){this.log("Trigger BUFFER_RESET"),this.hls.trigger(Events1.BUFFER_RESET,void 0),this.fragmentTracker.removeAllFragments(),this.couldBacktrack=!1,this.startPosition=this.lastCurrentTime=this.fragLastKbps=0,this.levels=this.fragPlaying=this.backtrackFragment=this.levelLastLoaded=null,this.altAudio=this.audioOnly=this.startFragRequested=!1}onManifestParsed(event,data){let aac=!1,heaac=!1;data.levels.forEach(level=>{let codec=level.audioCodec;codec&&(aac=aac||-1!==codec.indexOf("mp4a.40.2"),heaac=heaac||-1!==codec.indexOf("mp4a.40.5"))}),this.audioCodecSwitch=aac&&heaac&&!changeTypeSupported(),this.audioCodecSwitch&&this.log("Both AAC/HE-AAC audio found in levels; declaring level codec as HE-AAC"),this.levels=data.levels,this.startFragRequested=!1}onLevelLoading(event,data){let{levels}=this;if(!levels||this.state!==State.IDLE)return;let level=levels[data.level];(!level.details||level.details.live&&this.levelLastLoaded!==level||this.waitForCdnTuneIn(level.details))&&(this.state=State.WAITING_LEVEL)}onLevelLoaded(event,data){var _curLevel$details,_this$levelLastLoaded;let{levels}=this,newLevelId=data.level,newDetails=data.details,duration=newDetails.totalduration;if(!levels){this.warn(`Levels were reset while loading level ${newLevelId}`);return}this.log(`Level ${newLevelId} loaded [${newDetails.startSN},${newDetails.endSN}]${newDetails.lastPartSn?`[part-${newDetails.lastPartSn}-${newDetails.lastPartIndex}]`:""}, cc [${newDetails.startCC}, ${newDetails.endCC}] duration:${duration}`);let curLevel=levels[newLevelId],fragCurrent=this.fragCurrent;fragCurrent&&(this.state===State.FRAG_LOADING||this.state===State.FRAG_LOADING_WAITING_RETRY)&&fragCurrent.level!==data.level&&fragCurrent.loader&&this.abortCurrentFrag();let sliding=0;if(newDetails.live||null!=(_curLevel$details=curLevel.details)&&_curLevel$details.live){if(this.checkLiveUpdate(newDetails),newDetails.deltaUpdateFailed)return;sliding=this.alignPlaylists(newDetails,curLevel.details,null==(_this$levelLastLoaded=this.levelLastLoaded)?void 0:_this$levelLastLoaded.details)}if(curLevel.details=newDetails,this.levelLastLoaded=curLevel,this.hls.trigger(Events1.LEVEL_UPDATED,{details:newDetails,level:newLevelId}),this.state===State.WAITING_LEVEL){if(this.waitForCdnTuneIn(newDetails))return;this.state=State.IDLE}this.startFragRequested?newDetails.live&&this.synchronizeToLiveEdge(newDetails):this.setStartPosition(newDetails,sliding),this.tick()}_handleFragmentLoadProgress(data){var _frag$initSegment;let{frag,part,payload}=data,{levels}=this;if(!levels){this.warn(`Levels were reset while fragment load was in progress. Fragment ${frag.sn} of level ${frag.level} will not be buffered`);return}let currentLevel=levels[frag.level],details=currentLevel.details;if(!details){this.warn(`Dropping fragment ${frag.sn} of level ${frag.level} after level details were reset`),this.fragmentTracker.removeFragment(frag);return}let videoCodec=currentLevel.videoCodec,accurateTimeOffset=details.PTSKnown||!details.live,initSegmentData=null==(_frag$initSegment=frag.initSegment)?void 0:_frag$initSegment.data,audioCodec=this._getAudioCodec(currentLevel),transmuxer=this.transmuxer=this.transmuxer||new TransmuxerInterface(this.hls,PlaylistLevelType.MAIN,this._handleTransmuxComplete.bind(this),this._handleTransmuxerFlush.bind(this)),partIndex=part?part.index:-1,chunkMeta=new ChunkMetadata(frag.level,frag.sn,frag.stats.chunkCount,payload.byteLength,partIndex,-1!==partIndex),initPTS=this.initPTS[frag.cc];transmuxer.push(payload,initSegmentData,audioCodec,videoCodec,frag,part,details.totalduration,accurateTimeOffset,chunkMeta,initPTS)}onAudioTrackSwitching(event,data){let fromAltAudio=this.altAudio;if(!data.url){if(this.mediaBuffer!==this.media){this.log("Switching on main audio, use media.buffered to schedule main fragment loading"),this.mediaBuffer=this.media;let fragCurrent=this.fragCurrent;fragCurrent&&(this.log("Switching to main audio track, cancel main fragment load"),fragCurrent.abortRequests(),this.fragmentTracker.removeFragment(fragCurrent)),this.resetTransmuxer(),this.resetLoadingState()}else this.audioOnly&&this.resetTransmuxer();let hls=this.hls;fromAltAudio&&(hls.trigger(Events1.BUFFER_FLUSHING,{startOffset:0,endOffset:Number.POSITIVE_INFINITY,type:null}),this.fragmentTracker.removeAllFragments()),hls.trigger(Events1.AUDIO_TRACK_SWITCHED,data)}}onAudioTrackSwitched(event,data){let trackId=data.id,altAudio=!!this.hls.audioTracks[trackId].url;if(altAudio){let videoBuffer=this.videoBuffer;videoBuffer&&this.mediaBuffer!==videoBuffer&&(this.log("Switching on alternate audio, use video.buffered to schedule main fragment loading"),this.mediaBuffer=videoBuffer)}this.altAudio=altAudio,this.tick()}onBufferCreated(event,data){let mediaTrack,name;let tracks=data.tracks,alternate=!1;for(let type in tracks){let track=tracks[type];if("main"===track.id){if(name=type,mediaTrack=track,"video"===type){let videoTrack=tracks[type];videoTrack&&(this.videoBuffer=videoTrack.buffer)}}else alternate=!0}alternate&&mediaTrack?(this.log(`Alternate track found, use ${name}.buffered to schedule main fragment loading`),this.mediaBuffer=mediaTrack.buffer):this.mediaBuffer=this.media}onFragBuffered(event,data){let{frag,part}=data;if(frag&&frag.type!==PlaylistLevelType.MAIN)return;if(this.fragContextChanged(frag)){this.warn(`Fragment ${frag.sn}${part?" p: "+part.index:""} of level ${frag.level} finished buffering, but was aborted. state: ${this.state}`),this.state===State.PARSED&&(this.state=State.IDLE);return}let stats=part?part.stats:frag.stats;this.fragLastKbps=Math.round(8*stats.total/(stats.buffering.end-stats.loading.first)),"initSegment"!==frag.sn&&(this.fragPrevious=frag),this.fragBufferedComplete(frag,part)}onError(event,data){var _data$context;if(data.fatal){this.state=State.ERROR;return}switch(data.details){case ErrorDetails1.FRAG_GAP:case ErrorDetails1.FRAG_PARSING_ERROR:case ErrorDetails1.FRAG_DECRYPT_ERROR:case ErrorDetails1.FRAG_LOAD_ERROR:case ErrorDetails1.FRAG_LOAD_TIMEOUT:case ErrorDetails1.KEY_LOAD_ERROR:case ErrorDetails1.KEY_LOAD_TIMEOUT:this.onFragmentOrKeyLoadError(PlaylistLevelType.MAIN,data);break;case ErrorDetails1.LEVEL_LOAD_ERROR:case ErrorDetails1.LEVEL_LOAD_TIMEOUT:case ErrorDetails1.LEVEL_PARSING_ERROR:data.levelRetry||this.state!==State.WAITING_LEVEL||(null==(_data$context=data.context)?void 0:_data$context.type)!==PlaylistContextType.LEVEL||(this.state=State.IDLE);break;case ErrorDetails1.BUFFER_APPEND_ERROR:case ErrorDetails1.BUFFER_FULL_ERROR:if(!data.parent||"main"!==data.parent)return;if(data.details===ErrorDetails1.BUFFER_APPEND_ERROR){this.resetLoadingState();return}this.reduceLengthAndFlushBuffer(data)&&this.flushMainBuffer(0,Number.POSITIVE_INFINITY);break;case ErrorDetails1.INTERNAL_EXCEPTION:this.recoverWorkerError(data)}}checkBuffer(){let{media,gapController}=this;if(media&&gapController&&media.readyState){if(this.loadedmetadata||!BufferHelper.getBuffered(media).length){let activeFrag=this.state!==State.IDLE?this.fragCurrent:null;gapController.poll(this.lastCurrentTime,activeFrag)}this.lastCurrentTime=media.currentTime}}onFragLoadEmergencyAborted(){this.state=State.IDLE,this.loadedmetadata||(this.startFragRequested=!1,this.nextLoadPosition=this.startPosition),this.tickImmediate()}onBufferFlushed(event,{type}){if(type!==ElementaryStreamTypes.AUDIO||this.audioOnly&&!this.altAudio){let mediaBuffer=(type===ElementaryStreamTypes.VIDEO?this.videoBuffer:this.mediaBuffer)||this.media;this.afterBufferFlushed(mediaBuffer,type,PlaylistLevelType.MAIN),this.tick()}}onLevelsUpdated(event,data){this.level>-1&&this.fragCurrent&&(this.level=this.fragCurrent.level),this.levels=data.levels}swapAudioCodec(){this.audioCodecSwap=!this.audioCodecSwap}seekToStartPos(){let{media}=this;if(!media)return;let currentTime=media.currentTime,startPosition=this.startPosition;if(startPosition>=0&&currentTime<startPosition){if(media.seeking){this.log(`could not seek to ${startPosition}, already seeking at ${currentTime}`);return}let buffered=BufferHelper.getBuffered(media),delta=(buffered.length?buffered.start(0):0)-startPosition;delta>0&&(delta<this.config.maxBufferHole||delta<this.config.maxFragLookUpTolerance)&&(this.log(`adjusting start position by ${delta} to match buffer start`),startPosition+=delta,this.startPosition=startPosition),this.log(`seek to target start position ${startPosition} from current time ${currentTime}`),media.currentTime=startPosition}}_getAudioCodec(currentLevel){let audioCodec=this.config.defaultAudioCodec||currentLevel.audioCodec;return this.audioCodecSwap&&audioCodec&&(this.log("Swapping audio codec"),audioCodec=-1!==audioCodec.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5"),audioCodec}_loadBitrateTestFrag(frag,level){frag.bitrateTest=!0,this._doFragLoad(frag,level).then(data=>{let{hls}=this;if(!data||this.fragContextChanged(frag))return;level.fragmentError=0,this.state=State.IDLE,this.startFragRequested=!1,this.bitrateTest=!1;let stats=frag.stats;stats.parsing.start=stats.parsing.end=stats.buffering.start=stats.buffering.end=self.performance.now(),hls.trigger(Events1.FRAG_LOADED,data),frag.bitrateTest=!1})}_handleTransmuxComplete(transmuxResult){var _id3$samples;let id="main",{hls}=this,{remuxResult,chunkMeta}=transmuxResult,context=this.getCurrentContext(chunkMeta);if(!context){this.resetWhenMissingContext(chunkMeta);return}let{frag,part,level}=context,{video,text,id3,initSegment}=remuxResult,{details}=level,audio=this.altAudio?void 0:remuxResult.audio;if(this.fragContextChanged(frag)){this.fragmentTracker.removeFragment(frag);return}if(this.state=State.PARSING,initSegment){if(null!=initSegment&&initSegment.tracks){let mapFragment=frag.initSegment||frag;this._bufferInitSegment(level,initSegment.tracks,mapFragment,chunkMeta),hls.trigger(Events1.FRAG_PARSING_INIT_SEGMENT,{frag:mapFragment,id,tracks:initSegment.tracks})}let initPTS=initSegment.initPTS,timescale=initSegment.timescale;isFiniteNumber(initPTS)&&(this.initPTS[frag.cc]={baseTime:initPTS,timescale},hls.trigger(Events1.INIT_PTS_FOUND,{frag,id,initPTS,timescale}))}if(video&&details&&"initSegment"!==frag.sn){let prevFrag=details.fragments[frag.sn-1-details.startSN],isFirstFragment=frag.sn===details.startSN,isFirstInDiscontinuity=!prevFrag||frag.cc>prevFrag.cc;if(!1!==remuxResult.independent){let{startPTS,endPTS,startDTS,endDTS}=video;if(part)part.elementaryStreams[video.type]={startPTS,endPTS,startDTS,endDTS};else if(video.firstKeyFrame&&video.independent&&1===chunkMeta.id&&!isFirstInDiscontinuity&&(this.couldBacktrack=!0),video.dropped&&video.independent){let bufferInfo=this.getMainFwdBufferInfo(),targetBufferTime=(bufferInfo?bufferInfo.end:this.getLoadPosition())+this.config.maxBufferHole,startTime=video.firstKeyFramePTS?video.firstKeyFramePTS:startPTS;if(isFirstFragment||!(targetBufferTime<startTime-this.config.maxBufferHole)||isFirstInDiscontinuity)isFirstInDiscontinuity&&(frag.gap=!0);else{this.backtrack(frag);return}frag.setElementaryStreamInfo(video.type,frag.start,endPTS,frag.start,endDTS,!0)}else isFirstFragment&&startPTS>2&&(frag.gap=!0);frag.setElementaryStreamInfo(video.type,startPTS,endPTS,startDTS,endDTS),this.backtrackFragment&&(this.backtrackFragment=frag),this.bufferFragmentData(video,frag,part,chunkMeta,isFirstFragment||isFirstInDiscontinuity)}else if(isFirstFragment||isFirstInDiscontinuity)frag.gap=!0;else{this.backtrack(frag);return}}if(audio){let{startPTS,endPTS,startDTS,endDTS}=audio;part&&(part.elementaryStreams[ElementaryStreamTypes.AUDIO]={startPTS,endPTS,startDTS,endDTS}),frag.setElementaryStreamInfo(ElementaryStreamTypes.AUDIO,startPTS,endPTS,startDTS,endDTS),this.bufferFragmentData(audio,frag,part,chunkMeta)}if(details&&null!=id3&&null!=(_id3$samples=id3.samples)&&_id3$samples.length){let emittedID3={id,frag,details,samples:id3.samples};hls.trigger(Events1.FRAG_PARSING_METADATA,emittedID3)}if(details&&text){let emittedText={id,frag,details,samples:text.samples};hls.trigger(Events1.FRAG_PARSING_USERDATA,emittedText)}}_bufferInitSegment(currentLevel,tracks,frag,chunkMeta){if(this.state!==State.PARSING)return;this.audioOnly=!!tracks.audio&&!tracks.video,this.altAudio&&!this.audioOnly&&delete tracks.audio;let{audio,video,audiovideo}=tracks;if(audio){let audioCodec=currentLevel.audioCodec,ua=navigator.userAgent.toLowerCase();if(this.audioCodecSwitch){audioCodec&&(audioCodec=-1!==audioCodec.indexOf("mp4a.40.5")?"mp4a.40.2":"mp4a.40.5");let audioMetadata=audio.metadata;audioMetadata&&"channelCount"in audioMetadata&&1!==(audioMetadata.channelCount||1)&&-1===ua.indexOf("firefox")&&(audioCodec="mp4a.40.5")}audioCodec&&-1!==audioCodec.indexOf("mp4a.40.5")&&-1!==ua.indexOf("android")&&"audio/mpeg"!==audio.container&&(audioCodec="mp4a.40.2",this.log(`Android: force audio codec to ${audioCodec}`)),currentLevel.audioCodec&&currentLevel.audioCodec!==audioCodec&&this.log(`Swapping manifest audio codec "${currentLevel.audioCodec}" for "${audioCodec}"`),audio.levelCodec=audioCodec,audio.id="main",this.log(`Init audio buffer, container:${audio.container}, codecs[selected/level/parsed]=[${audioCodec||""}/${currentLevel.audioCodec||""}/${audio.codec}]`)}video&&(video.levelCodec=currentLevel.videoCodec,video.id="main",this.log(`Init video buffer, container:${video.container}, codecs[level/parsed]=[${currentLevel.videoCodec||""}/${video.codec}]`)),audiovideo&&this.log(`Init audiovideo buffer, container:${audiovideo.container}, codecs[level/parsed]=[${currentLevel.codecs}/${audiovideo.codec}]`),this.hls.trigger(Events1.BUFFER_CODECS,tracks),Object.keys(tracks).forEach(trackName=>{let initSegment=tracks[trackName].initSegment;null!=initSegment&&initSegment.byteLength&&this.hls.trigger(Events1.BUFFER_APPENDING,{type:trackName,data:initSegment,frag,part:null,chunkMeta,parent:frag.type})}),this.tickImmediate()}getMainFwdBufferInfo(){return this.getFwdBufferInfo(this.mediaBuffer?this.mediaBuffer:this.media,PlaylistLevelType.MAIN)}backtrack(frag){this.couldBacktrack=!0,this.backtrackFragment=frag,this.resetTransmuxer(),this.flushBufferGap(frag),this.fragmentTracker.removeFragment(frag),this.fragPrevious=null,this.nextLoadPosition=frag.start,this.state=State.IDLE}checkFragmentChanged(){let video=this.media,fragPlayingCurrent=null;if(video&&video.readyState>1&&!1===video.seeking){let currentTime=video.currentTime;if(BufferHelper.isBuffered(video,currentTime)?fragPlayingCurrent=this.getAppendedFrag(currentTime):BufferHelper.isBuffered(video,currentTime+.1)&&(fragPlayingCurrent=this.getAppendedFrag(currentTime+.1)),fragPlayingCurrent){this.backtrackFragment=null;let fragPlaying=this.fragPlaying,fragCurrentLevel=fragPlayingCurrent.level;fragPlaying&&fragPlayingCurrent.sn===fragPlaying.sn&&fragPlaying.level===fragCurrentLevel||(this.fragPlaying=fragPlayingCurrent,this.hls.trigger(Events1.FRAG_CHANGED,{frag:fragPlayingCurrent}),fragPlaying&&fragPlaying.level===fragCurrentLevel||this.hls.trigger(Events1.LEVEL_SWITCHED,{level:fragCurrentLevel}))}}}get nextLevel(){let frag=this.nextBufferedFrag;return frag?frag.level:-1}get currentFrag(){let media=this.media;return media?this.fragPlaying||this.getAppendedFrag(media.currentTime):null}get currentProgramDateTime(){let media=this.media;if(media){let currentTime=media.currentTime,frag=this.currentFrag;if(frag&&isFiniteNumber(currentTime)&&isFiniteNumber(frag.programDateTime))return new Date(frag.programDateTime+(currentTime-frag.start)*1e3)}return null}get currentLevel(){let frag=this.currentFrag;return frag?frag.level:-1}get nextBufferedFrag(){let frag=this.currentFrag;return frag?this.followingBufferedFrag(frag):null}get forceStartLoad(){return this._forceStartLoad}}class Hls{static get version(){return"1.5.13"}static isMSESupported(){return isMSESupported()}static isSupported(){return isSupported()}static getMediaSource(){return getMediaSource()}static get Events(){return Events1}static get ErrorTypes(){return ErrorTypes1}static get ErrorDetails(){return ErrorDetails1}static get DefaultConfig(){return Hls.defaultConfig?Hls.defaultConfig:hlsDefaultConfig}static set DefaultConfig(defaultConfig){Hls.defaultConfig=defaultConfig}constructor(userConfig={}){this.config=void 0,this.userConfig=void 0,this.coreComponents=void 0,this.networkControllers=void 0,this.started=!1,this._emitter=new EventEmitter,this._autoLevelCapping=-1,this._maxHdcpLevel=null,this.abrController=void 0,this.bufferController=void 0,this.capLevelController=void 0,this.latencyController=void 0,this.levelController=void 0,this.streamController=void 0,this.audioTrackController=void 0,this.subtitleTrackController=void 0,this.emeController=void 0,this.cmcdController=void 0,this._media=null,this.url=null,this.triggeringException=void 0,enableLogs(userConfig.debug||!1,"Hls instance");let config=this.config=mergeConfig(Hls.DefaultConfig,userConfig);this.userConfig=userConfig,config.progressive&&enableStreamingMode(config);let{abrController:ConfigAbrController,bufferController:ConfigBufferController,capLevelController:ConfigCapLevelController,errorController:ConfigErrorController,fpsController:ConfigFpsController}=config,errorController=new ConfigErrorController(this),abrController=this.abrController=new ConfigAbrController(this),bufferController=this.bufferController=new ConfigBufferController(this),capLevelController=this.capLevelController=new ConfigCapLevelController(this),fpsController=new ConfigFpsController(this),playListLoader=new PlaylistLoader(this),id3TrackController=new ID3TrackController(this),ConfigContentSteeringController=config.contentSteeringController,contentSteering=ConfigContentSteeringController?new ConfigContentSteeringController(this):null,levelController=this.levelController=new LevelController(this,contentSteering),fragmentTracker=new FragmentTracker(this),keyLoader=new KeyLoader(this.config),streamController=this.streamController=new StreamController(this,fragmentTracker,keyLoader);capLevelController.setStreamController(streamController),fpsController.setStreamController(streamController);let networkControllers=[playListLoader,levelController,streamController];contentSteering&&networkControllers.splice(1,0,contentSteering),this.networkControllers=networkControllers;let coreComponents=[abrController,bufferController,capLevelController,fpsController,id3TrackController,fragmentTracker];this.audioTrackController=this.createController(config.audioTrackController,networkControllers);let AudioStreamControllerClass=config.audioStreamController;AudioStreamControllerClass&&networkControllers.push(new AudioStreamControllerClass(this,fragmentTracker,keyLoader)),this.subtitleTrackController=this.createController(config.subtitleTrackController,networkControllers);let SubtitleStreamControllerClass=config.subtitleStreamController;SubtitleStreamControllerClass&&networkControllers.push(new SubtitleStreamControllerClass(this,fragmentTracker,keyLoader)),this.createController(config.timelineController,coreComponents),keyLoader.emeController=this.emeController=this.createController(config.emeController,coreComponents),this.cmcdController=this.createController(config.cmcdController,coreComponents),this.latencyController=this.createController(LatencyController,coreComponents),this.coreComponents=coreComponents,networkControllers.push(errorController);let onErrorOut=errorController.onErrorOut;"function"==typeof onErrorOut&&this.on(Events1.ERROR,onErrorOut,errorController)}createController(ControllerClass,components){if(ControllerClass){let controllerInstance=new ControllerClass(this);return components&&components.push(controllerInstance),controllerInstance}return null}on(event,listener,context=this){this._emitter.on(event,listener,context)}once(event,listener,context=this){this._emitter.once(event,listener,context)}removeAllListeners(event){this._emitter.removeAllListeners(event)}off(event,listener,context=this,once){this._emitter.off(event,listener,context,once)}listeners(event){return this._emitter.listeners(event)}emit(event,name,eventObject){return this._emitter.emit(event,name,eventObject)}trigger(event,eventObject){if(this.config.debug)return this.emit(event,event,eventObject);try{return this.emit(event,event,eventObject)}catch(error){if(logger.error("An internal error happened while handling event "+event+'. Error message: "'+error.message+'". Here is a stacktrace:',error),!this.triggeringException){this.triggeringException=!0;let fatal=event===Events1.ERROR;this.trigger(Events1.ERROR,{type:ErrorTypes1.OTHER_ERROR,details:ErrorDetails1.INTERNAL_EXCEPTION,fatal,event,error}),this.triggeringException=!1}}return!1}listenerCount(event){return this._emitter.listenerCount(event)}destroy(){logger.log("destroy"),this.trigger(Events1.DESTROYING,void 0),this.detachMedia(),this.removeAllListeners(),this._autoLevelCapping=-1,this.url=null,this.networkControllers.forEach(component=>component.destroy()),this.networkControllers.length=0,this.coreComponents.forEach(component=>component.destroy()),this.coreComponents.length=0;let config=this.config;config.xhrSetup=config.fetchSetup=void 0,this.userConfig=null}attachMedia(media){logger.log("attachMedia"),this._media=media,this.trigger(Events1.MEDIA_ATTACHING,{media:media})}detachMedia(){logger.log("detachMedia"),this.trigger(Events1.MEDIA_DETACHING,void 0),this._media=null}loadSource(url){this.stopLoad();let media=this.media,loadedSource=this.url,loadingSource=this.url=urlToolkitExports.buildAbsoluteURL(self.location.href,url,{alwaysNormalize:!0});this._autoLevelCapping=-1,this._maxHdcpLevel=null,logger.log(`loadSource:${loadingSource}`),media&&loadedSource&&(loadedSource!==loadingSource||this.bufferController.hasSourceTypes())&&(this.detachMedia(),this.attachMedia(media)),this.trigger(Events1.MANIFEST_LOADING,{url:url})}startLoad(startPosition=-1){logger.log(`startLoad(${startPosition})`),this.started=!0,this.networkControllers.forEach(controller=>{controller.startLoad(startPosition)})}stopLoad(){logger.log("stopLoad"),this.started=!1,this.networkControllers.forEach(controller=>{controller.stopLoad()})}resumeBuffering(){this.started&&this.networkControllers.forEach(controller=>{"fragmentLoader"in controller&&controller.startLoad(-1)})}pauseBuffering(){this.networkControllers.forEach(controller=>{"fragmentLoader"in controller&&controller.stopLoad()})}swapAudioCodec(){logger.log("swapAudioCodec"),this.streamController.swapAudioCodec()}recoverMediaError(){logger.log("recoverMediaError");let media=this._media;this.detachMedia(),media&&this.attachMedia(media)}removeLevel(levelIndex){this.levelController.removeLevel(levelIndex)}get levels(){return this.levelController.levels||[]}get currentLevel(){return this.streamController.currentLevel}set currentLevel(newLevel){logger.log(`set currentLevel:${newLevel}`),this.levelController.manualLevel=newLevel,this.streamController.immediateLevelSwitch()}get nextLevel(){return this.streamController.nextLevel}set nextLevel(newLevel){logger.log(`set nextLevel:${newLevel}`),this.levelController.manualLevel=newLevel,this.streamController.nextLevelSwitch()}get loadLevel(){return this.levelController.level}set loadLevel(newLevel){logger.log(`set loadLevel:${newLevel}`),this.levelController.manualLevel=newLevel}get nextLoadLevel(){return this.levelController.nextLoadLevel}set nextLoadLevel(level){this.levelController.nextLoadLevel=level}get firstLevel(){return Math.max(this.levelController.firstLevel,this.minAutoLevel)}set firstLevel(newLevel){logger.log(`set firstLevel:${newLevel}`),this.levelController.firstLevel=newLevel}get startLevel(){let startLevel=this.levelController.startLevel;return -1===startLevel&&this.abrController.forcedAutoLevel>-1?this.abrController.forcedAutoLevel:startLevel}set startLevel(newLevel){logger.log(`set startLevel:${newLevel}`),-1!==newLevel&&(newLevel=Math.max(newLevel,this.minAutoLevel)),this.levelController.startLevel=newLevel}get capLevelToPlayerSize(){return this.config.capLevelToPlayerSize}set capLevelToPlayerSize(shouldStartCapping){let newCapLevelToPlayerSize=!!shouldStartCapping;newCapLevelToPlayerSize!==this.config.capLevelToPlayerSize&&(newCapLevelToPlayerSize?this.capLevelController.startCapping():(this.capLevelController.stopCapping(),this.autoLevelCapping=-1,this.streamController.nextLevelSwitch()),this.config.capLevelToPlayerSize=newCapLevelToPlayerSize)}get autoLevelCapping(){return this._autoLevelCapping}get bandwidthEstimate(){let{bwEstimator}=this.abrController;return bwEstimator?bwEstimator.getEstimate():NaN}set bandwidthEstimate(abrEwmaDefaultEstimate){this.abrController.resetEstimator(abrEwmaDefaultEstimate)}get ttfbEstimate(){let{bwEstimator}=this.abrController;return bwEstimator?bwEstimator.getEstimateTTFB():NaN}set autoLevelCapping(newLevel){this._autoLevelCapping!==newLevel&&(logger.log(`set autoLevelCapping:${newLevel}`),this._autoLevelCapping=newLevel,this.levelController.checkMaxAutoUpdated())}get maxHdcpLevel(){return this._maxHdcpLevel}set maxHdcpLevel(value){isHdcpLevel(value)&&this._maxHdcpLevel!==value&&(this._maxHdcpLevel=value,this.levelController.checkMaxAutoUpdated())}get autoLevelEnabled(){return -1===this.levelController.manualLevel}get manualLevel(){return this.levelController.manualLevel}get minAutoLevel(){let{levels,config:{minAutoBitrate}}=this;if(!levels)return 0;let len=levels.length;for(let i=0;i<len;i++)if(levels[i].maxBitrate>=minAutoBitrate)return i;return 0}get maxAutoLevel(){let maxAutoLevel;let{levels,autoLevelCapping,maxHdcpLevel}=this;if(maxAutoLevel=-1===autoLevelCapping&&null!=levels&&levels.length?levels.length-1:autoLevelCapping,maxHdcpLevel)for(let i=maxAutoLevel;i--;){let hdcpLevel=levels[i].attrs["HDCP-LEVEL"];if(hdcpLevel&&hdcpLevel<=maxHdcpLevel)return i}return maxAutoLevel}get firstAutoLevel(){return this.abrController.firstAutoLevel}get nextAutoLevel(){return this.abrController.nextAutoLevel}set nextAutoLevel(nextLevel){this.abrController.nextAutoLevel=nextLevel}get playingDate(){return this.streamController.currentProgramDateTime}get mainForwardBufferInfo(){return this.streamController.getMainFwdBufferInfo()}setAudioOption(audioOption){var _this$audioTrackContr;return null==(_this$audioTrackContr=this.audioTrackController)?void 0:_this$audioTrackContr.setAudioOption(audioOption)}setSubtitleOption(subtitleOption){var _this$subtitleTrackCo;return null==(_this$subtitleTrackCo=this.subtitleTrackController)||_this$subtitleTrackCo.setSubtitleOption(subtitleOption),null}get allAudioTracks(){let audioTrackController=this.audioTrackController;return audioTrackController?audioTrackController.allAudioTracks:[]}get audioTracks(){let audioTrackController=this.audioTrackController;return audioTrackController?audioTrackController.audioTracks:[]}get audioTrack(){let audioTrackController=this.audioTrackController;return audioTrackController?audioTrackController.audioTrack:-1}set audioTrack(audioTrackId){let audioTrackController=this.audioTrackController;audioTrackController&&(audioTrackController.audioTrack=audioTrackId)}get allSubtitleTracks(){let subtitleTrackController=this.subtitleTrackController;return subtitleTrackController?subtitleTrackController.allSubtitleTracks:[]}get subtitleTracks(){let subtitleTrackController=this.subtitleTrackController;return subtitleTrackController?subtitleTrackController.subtitleTracks:[]}get subtitleTrack(){let subtitleTrackController=this.subtitleTrackController;return subtitleTrackController?subtitleTrackController.subtitleTrack:-1}get media(){return this._media}set subtitleTrack(subtitleTrackId){let subtitleTrackController=this.subtitleTrackController;subtitleTrackController&&(subtitleTrackController.subtitleTrack=subtitleTrackId)}get subtitleDisplay(){let subtitleTrackController=this.subtitleTrackController;return!!subtitleTrackController&&subtitleTrackController.subtitleDisplay}set subtitleDisplay(value){let subtitleTrackController=this.subtitleTrackController;subtitleTrackController&&(subtitleTrackController.subtitleDisplay=value)}get lowLatencyMode(){return this.config.lowLatencyMode}set lowLatencyMode(mode){this.config.lowLatencyMode=mode}get liveSyncPosition(){return this.latencyController.liveSyncPosition}get latency(){return this.latencyController.latency}get maxLatency(){return this.latencyController.maxLatency}get targetLatency(){return this.latencyController.targetLatency}get drift(){return this.latencyController.drift}get forceStartLoad(){return this.streamController.forceStartLoad}}Hls.defaultConfig=void 0;var KeySystemFormats=emptyEs.KeySystemFormats,KeySystems=emptyEs.KeySystems,SubtitleStreamController=emptyEs.SubtitleStreamController,TimelineController=emptyEs.TimelineController}}]);