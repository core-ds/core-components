import { promises as fs } from 'fs';
import path from 'path';

/**
 * Парсит CSS-файл с переменными, которые могут быть однострочными или многострочными,
 * и сохраняет их в виде объекта в TypeScript-файл.
 * Имя выходного файла генестрируется автоматически (например, src/dark.css -> src/dark-map.ts).
 * @param {string} filePath Путь к CSS-файлу для парсинга.
 * @returns {Promise<void>}
 */
export const parseCssVariables = async (filePath) => {
    try {
        await fs.access(filePath);

        const fileExtension = path.extname(filePath);
        const fileName = path.basename(filePath, fileExtension);
        const fileDir = path.dirname(filePath);
        const outputFilePath = path.join(fileDir, `${fileName}-map.ts`);

        const data = await fs.readFile(filePath, 'utf8');

        /*
         * Единое регулярное выражение, которое ищет имя переменной и её значение до первой точки с запятой
         * с флагом 's' для работы с многострочным текстом.
         */
        const regex = /^\s*(--[\w-]+):\s*((?:(?!;).)*)/gms;
        const parsedData = {};
        let match;

        // eslint-disable-next-line no-cond-assign
        while ((match = regex.exec(data)) !== null) {
            const key = match[1];
            // Удаляем лишние пробелы, табуляции и переносы строк, чтобы получить чистое значение
            let value = match[2].replace(/\s+/g, ' ').trim();

            // Проверяем, является ли значение ссылкой на другую переменную.
            if (value.startsWith('var(') && value.endsWith(')')) {
                // Извлекаем имя переменной из var(...)
                value = value.substring(4, value.length - 1).trim();
            }

            // Оборачиваем значение в кавычки для TS-файла.
            parsedData[key] = `'${value}'`;
        }

        const tsContent = `// THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
export default {\n${Object.entries(parsedData)
            .map(([key, value]) => `  '${key}': ${value},`)
            .join('\n')}\n};\n`;

        await fs.writeFile(outputFilePath, tsContent, 'utf8');
        console.log(`Данные успешно сохранены в файл: ${outputFilePath}`);
    } catch (err) {
        console.error('Ошибка в процессе работы:', err);
    }
};
