name: snapshot-release

on: workflow_dispatch

concurrency: ${{ github.workflow }}-${{ github.ref }}

jobs:
    snapshot-release:
        name: snapshot-release
        if: ${{ github.repository == 'hextion/core-components' }}
        runs-on: ubuntu-latest
        outputs:
            published: ${{ steps.snapshot-release.outputs.published }}
            published-packages: ${{ steps.snapshot-release.outputs.published-packages }}
        steps:
            - uses: actions/checkout@v4

            - uses: ./.github/actions/ci-setup

            - uses: ./.github/actions/snapshot-release
              id: snapshot-release
              with:
                  version: 'yarn version-packages:snapshot'
                  publish: 'yarn release:snapshot'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

    comment:
        name: comment
        needs: snapshot-release
        if: ${{ needs.snapshot-release.outputs.published == 'true' }}
        runs-on: ubuntu-latest
        steps:
            - name: find open pr
              uses: jwalton/gh-find-current-pr@v1
              id: find-pr
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: text
              if: ${{ steps.find-pr.outputs.number != '' }}
              id: text
              uses: actions/github-script@v7
              with:
                  result-encoding: string
                  script: |
                      const run = require('./tools/gh-actions/snapshot-release/prepare-comment.js');
                      const inputs = ${{ toJson(needs.snapshot-release.outputs) }};

                      return await run({ github, context, core, glob, io, exec, inputs });

            - name: comment
              if: ${{ steps.find-pr.outputs.number != '' }}
              uses: peter-evans/create-or-update-comment@v3
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  issue-number: ${{ steps.find-pr.outputs.number }}
                  body: ${{ steps.text.outputs.result }}
                  reactions: rocket
