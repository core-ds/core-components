name: snapshot-release

on:
    - workflow_dispatch
    - workflow_call

concurrency: ${{ github.workflow }}-${{ github.ref }}

defaults:
    run:
        shell: bash

jobs:
    variant:
        uses: ./.github/workflows/variant.yml

    snapshot-release:
        name: snapshot release
        if: ${{ github.repository == 'core-ds/core-components' }}
        needs: [variant]
        strategy:
            matrix:
                include: ${{ fromJson(needs.variant.outputs.result) }}
        runs-on: ubuntu-latest
        outputs:
            published: ${{ steps.snapshot-release.outputs.published }}
            published-packages: ${{ steps.snapshot-release.outputs.published-packages }}
        env:
            CORE_COMPONENTS_VARIANT: ${{ matrix.variant }}
        steps:
            - uses: actions/checkout@v5

            - name: apply patch
              run: |
                  PATCH_SOURCE='variants/${{ matrix.variant }}.patch'

                  if [ -f "$PATCH_SOURCE" ]; then
                      git apply "$PATCH_SOURCE"
                  fi

            - uses: ./.github/actions/ci-setup

            - id: snapshot-release
              uses: core-ds/changesets-snapshot-release@v1
              with:
                  version: 'yarn version-packages:snapshot'
                  publish: 'yarn release:snapshot'
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  NPM_TOKEN: ${{ secrets.NPM_TOKEN }}

    pull-request:
        name: find pull request
        runs-on: ubuntu-latest
        outputs:
            number: ${{ steps.pull-request.outputs.number }}
        steps:
            - name: find pull request
              uses: jwalton/gh-find-current-pr@v1
              id: pull-request
              with:
                  github-token: ${{ secrets.GITHUB_TOKEN }}

    comment:
        name: comment
        needs: [snapshot-release, pull-request]
        if: ${{ needs.snapshot-release.outputs.published == 'true' && needs.pull-request.outputs.number != '' }}
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v5

            - name: prepare comment
              id: prepare-comment
              uses: actions/github-script@v8
              with:
                  result-encoding: string
                  script: |
                      const run = require('./tools/gh-actions/changesets-snapshot-release/prepare-comment.js');
                      const inputs = ${{ toJson(needs.snapshot-release.outputs) }};

                      return await run({ github, context, core, glob, io, exec, inputs });

            - name: create comment
              uses: peter-evans/create-or-update-comment@v3
              with:
                  token: ${{ secrets.GITHUB_TOKEN }}
                  issue-number: ${{ needs.pull-request.outputs.number }}
                  body: |
                      ## Snapshot release (${{ matrix.variant }})

                      Successfully released the following packages:

                      ${{ steps.prepare-comment.outputs.result }}
                  reactions: rocket
