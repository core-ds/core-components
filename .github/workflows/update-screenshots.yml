name: update screenshots

on: workflow_dispatch

jobs:
    update:
        name: update screenshots
        runs-on: ubuntu-latest
        steps:
            - uses: actions/checkout@v4
              with:
                  lfs: true
                  token: ${{ github.repository == 'hextion/core-components' && secrets.GH_TOKEN || secrets.GITHUB_TOKEN }}

            - uses: ./.github/actions/ci-setup

            - name: update screenshots
              shell: bash
              run: |
                  yarn test:screenshots -u

            - name: check git status
              id: git-status
              uses: actions/github-script@v7
              with:
                  result-encoding: string
                  script: |
                      const { stdout } = await exec.getExecOutput('git', ['status', '--porcelain']);

                      return stdout.split('\n').some(line => /^\s+M\s+.*\.png$/.test(line));

            - name: setup git user
              if: ${{ github.repository == 'hextion/core-components' && steps.git-status.outputs.result == 'true' }}
              uses: ./.github/actions/setup-git-user
              with:
                  name: 'hextion'
                  email: '100ishundred@gmail.com'

            - name: update branch
              if: ${{ steps.git-status.outputs.result == 'true' }}
              uses: ./.github/actions/commit-and-push
              with:
                  setup-git-user: ${{ github.repository != 'hextion/core-components' }}
                  message: 'test: updated screenshots'
