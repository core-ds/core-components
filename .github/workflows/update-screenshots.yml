name: update-screenshots

on:
    workflow_dispatch:
        inputs:
            variant:
                description: Variant of core components
                required: false
                type: choice
                default: default
                options:
                    - default
                    - alfasans

concurrency:
    group: ${{ github.workflow }}-${{ github.ref }}-${{ inputs.variant }}
    cancel-in-progress: true

defaults:
    run:
        shell: bash

jobs:
    build-demo:
        uses: ./.github/workflows/build-demo.yml
        secrets: inherit
        with:
            variant: ${{ inputs.variant }}
            artifact-name: ${{ inputs.variant }}

    update:
        name: update screenshots (${{ inputs.variant }})
        runs-on: ubuntu-latest
        needs: [build-demo]
        env:
            CORE_COMPONENTS_VARIANT: ${{ inputs.variant }}
        if: ${{ github.repository == 'core-ds/core-components' }}
        steps:
            - uses: actions/checkout@v5
              with:
                  # used GH_TOKEN to trigger github actions on branch update
                  # GITHUB_TOKEN doesn't trigger any action
                  # https://github.com/orgs/community/discussions/55906
                  token: ${{ secrets.GH_TOKEN }}
                  lfs: true

            - uses: ./.github/actions/ci-setup

            - name: download build
              uses: actions/download-artifact@v5
              with:
                  name: ${{ inputs.variant }}
                  path: build
                  run-id: ${{ needs.build-demo.outputs.run-id }}
                  github-token: ${{ secrets.GITHUB_TOKEN }}

            - name: update screenshots
              run: |
                  yarn test:screenshots -u

            - name: check git status
              id: git-status
              uses: actions/github-script@v8
              with:
                  script: |
                      const { stdout } = await exec.getExecOutput('git', ['status', '--porcelain']);

                      return stdout.trim().length > 0;

            - name: update branch
              if: ${{ steps.git-status.outputs.result == 'true' }}
              uses: ./.github/actions/commit-and-push
              with:
                  message: 'test: updated screenshots'
